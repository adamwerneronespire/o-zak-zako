*----------------------------------------------------------------------*
***INCLUDE /ZAK/LFUNCTIONSF01 .
*----------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  get_last_day_of_period
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_I_GJAHR  text
*      -->P_I_MONAT  text
*      <--P_V_LAST_DATE  text
*----------------------------------------------------------------------*
 FORM GET_LAST_DAY_OF_PERIOD USING    $GJAHR
                                      $MONAT
*++PTGSZLAA #01. 2014.03.03
                                      $BTYPE
*--PTGSZLAA #01. 2014.03.03
                              CHANGING V_LAST_DATE.

   DATA: L_DATE1 TYPE DATUM,
         L_DATE2 TYPE DATUM.
*++PTGSZLAA #01. 2014.03.03
   DATA: L_WEEK TYPE KWEEK.
*--PTGSZLAA #01. 2014.03.03


   CLEAR V_LAST_DATE.
*++PTGSZLAA #01. 2014.03.03
   IF $BTYPE EQ C_BTYPE_PTGSZLAA.
     CONCATENATE $GJAHR $MONAT INTO L_WEEK.
     CALL FUNCTION 'WEEK_GET_FIRST_DAY'
       EXPORTING
         WEEK = L_WEEK
       IMPORTING
         DATE = V_LAST_DATE
*      EXCEPTIONS
*        WEEK_INVALID       = 1
*        OTHERS             = 2
       .
     IF SY-SUBRC <> 0.
       CLEAR V_LAST_DATE.
     ELSE.
       ADD 6 TO V_LAST_DATE.
     ENDIF.
   ELSE.
*--PTGSZLAA #01. 2014.03.03

     CONCATENATE $GJAHR $MONAT '01' INTO L_DATE1.

     CALL FUNCTION 'LAST_DAY_OF_MONTHS' "#EC CI_USAGE_OK[2296016]
       EXPORTING
         DAY_IN            = L_DATE1
       IMPORTING
         LAST_DAY_OF_MONTH = L_DATE2
       EXCEPTIONS
         DAY_IN_NO_DATE    = 1
         OTHERS            = 2.

     IF SY-SUBRC = 0.
       V_LAST_DATE = L_DATE2.
     ENDIF.
*++PTGSZLAA #01. 2014.03.03
   ENDIF.
*--PTGSZLAA #01. 2014.03.03
 ENDFORM.                    " get_last_day_of_period
*&---------------------------------------------------------------------*
*&      Form  read_bevall
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_I_BUKRS  text
*      -->P_I_BTYPE  text
*      -->P_V_LAST_DATE  text
*----------------------------------------------------------------------*
 FORM READ_BEVALL USING    $BUKRS
                           $BTYPE
                           $LAST_DATE.

   CLEAR W_/ZAK/BEVALL.
   SELECT * UP TO 1 ROWS INTO W_/ZAK/BEVALL FROM  /ZAK/BEVALL
       WHERE     BUKRS  = $BUKRS
          AND    BTYPE  = $BTYPE
          AND    DATBI  >= $LAST_DATE.
   ENDSELECT.

 ENDFORM.                    " read_bevall
*&---------------------------------------------------------------------*
*&      Form  read_bevallb
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_I_BUKRS  text
*      -->P_I_BTYPE  text
*      -->P_ENDFUNCTION  text
*----------------------------------------------------------------------*
 FORM READ_BEVALLB USING  $BEVALLO LIKE I_/ZAK/BEVALLALV[]
                          $BTYPE.
   REFRESH I_/ZAK/BEVALLB.

*++1365 2013.01.22 Balázs Gábor (Ness)
**++BG 2006/05/24
*   IF  W_/ZAK/BEVALL-BTYPART EQ C_BTYPART_SZJA.
*--1365 2013.01.22 Balázs Gábor (Ness)
   SELECT * INTO TABLE I_/ZAK/BEVALLB FROM /ZAK/BEVALLB
       WHERE BTYPE  EQ W_/ZAK/BEVALL-BTYPE.
*++1365 2013.01.22 Balázs Gábor (Ness)
*   ELSE.
** csak az összegzendő sorokat dolgozom fel!
*     SELECT * INTO TABLE I_/ZAK/BEVALLB FROM /ZAK/BEVALLB
*         FOR ALL ENTRIES IN $BEVALLO
*         WHERE BTYPE  EQ $BEVALLO-BTYPE AND
*               ABEVAZ EQ $BEVALLO-ABEVAZ.
**             AND SUM_ABEVAZ NE SPACE.
*   ENDIF.
**--BG 2006/05/24
*--1365 2013.01.22 Balázs Gábor (Ness)

   SORT I_/ZAK/BEVALLB BY SUM_ABEVAZ DESCENDING.

 ENDFORM.                    " read_bevallb
*&---------------------------------------------------------------------*
*&      Form  calc_abev
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM CALC_ABEV TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                       T_BEVALLB STRUCTURE /ZAK/BEVALLB
                       T_ADOAZON STRUCTURE /ZAK/ONR_ADOAZON
*++ BG 2007.06.22
                       T_ADOAZON_ALL STRUCTURE /ZAK/ADOAZONLPSZ
*-- BG 2007.06.22
                USING  $LAST_DATE LIKE SY-DATUM
                       $INDEX.

   CASE W_/ZAK/BEVALL-BTYPART.

* SJJA Calculated fields
     WHEN C_BTYPART_SZJA.

       PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                    T_BEVALLB
                             USING  $LAST_DATE.


       IF W_/ZAK/BEVALL-BTYPE EQ C_0608.


*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_0608 TABLES T_BEVALLO
                                                  T_BEVALLB
                                                  T_ADOAZON
                                           USING  $INDEX
                                                  $LAST_DATE.
*        Normal calculations
         PERFORM CALC_ABEV_SZJA_0608 TABLES T_BEVALLO
                                            T_BEVALLB
                                     USING  $LAST_DATE.
*++ BG 2007.06.22
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_0608 TABLES T_BEVALLO
                                              T_ADOAZON_ALL.
*-- BG 2007.06.22

       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_06082.


*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_06082 TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.
*        Normal calculations
         PERFORM CALC_ABEV_SZJA_06082  TABLES T_BEVALLO
                                              T_BEVALLB
                                      USING  $LAST_DATE.
*++ BG 2007.06.22
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_06082 TABLES T_BEVALLO
                                               T_ADOAZON_ALL.
*-- BG 2007.06.22

       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_0708.


*++BG 2008/01/14
*       START card calculations
*       it must be calculated sooner for the self-revision because it is already
*       use the fields (eg: A0EC0156CA), but only that
*       current posting is required
         PERFORM CALC_ABEV_SZJA_START_0708 TABLES T_BEVALLO
                                                  T_BEVALLB
                                                  T_ADOAZON
                                           USING  $INDEX
                                                  $LAST_DATE.

*--BG 2008/01/14

*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_0708  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.

*        Normal calculations
         PERFORM CALC_ABEV_SZJA_0708  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
*++BG 2007/01/16
                                             $INDEX
*--BG 2007/01/16
                                             .
*++ BG 2007.06.22
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_0708  TABLES T_BEVALLO
                                               T_ADOAZON_ALL.
*-- BG 2007.06.22
*++0808 BG 2008.01.28
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_0808.
*++BG 2008.03.06
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_0808 TABLES T_BEVALLO
                                              T_BEVALLB.
*--BG 2008.03.06

*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_0808 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.

         ENDIF.

*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_0808  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.

*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_0808 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
*        You have to recalculate because of the special fields.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.

*        Normal calculations
         PERFORM CALC_ABEV_SZJA_0808  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.

*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_0808  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
*++0908 2009.02.27 BG
                                        USING  SPACE. "Normál mezőre
*--0908 2009.02.27 BG

*--0808 BG 2008.01.28
*++0908 2009.01.20 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_0908.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_0908 TABLES T_BEVALLO
                                              T_BEVALLB.

*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_0908 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.

         ENDIF.

*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_0908  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.

*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_0908 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.

*        You have to recalculate because of the special fields.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.

*        Normal calculations
         PERFORM CALC_ABEV_SZJA_0908  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_0908  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
*++0908 2009.02.27 BG
                                        USING  SPACE  "Normál mezőre
*++0908/2 2009.12.09 BG
                                               $LAST_DATE.
*--0908/2 2009.12.09 BG
*--0908 2009.02.27 BG

*--0908 2009.01.20 BG

*++1008 2010.01.20 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1008.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_1008 TABLES T_BEVALLO
                                              T_BEVALLB
                                              T_ADOAZON_ALL
                                       USING  $INDEX
                                              $LAST_DATE.
*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_1008 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.
         ENDIF.

*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_1008  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.

*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_1008 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.


*        Normal calculations "A"
         PERFORM CALC_ABEV_SZJA_1008  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.

*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_1008  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
                                        USING  SPACE  "Normál mezőre
                                               $LAST_DATE.
*--1008 2010.01.20 BG
*++1108 2010.01.24 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1108.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_1108 TABLES T_BEVALLO
                                              T_BEVALLB
                                              T_ADOAZON_ALL
                                       USING  $INDEX
                                              $LAST_DATE.
*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_1108 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.
         ENDIF.

*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_1108  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.

*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_1108 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*
*
*        Normal calculations "A"
         PERFORM CALC_ABEV_SZJA_1108  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.

*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_1108  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
                                        USING  SPACE  "Normál mezőre
                                               $LAST_DATE
                                               $INDEX.
*--1108 2010.01.24 BG
*++1208 2012.02.01 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1208.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_1208 TABLES T_BEVALLO
                                              T_BEVALLB
                                              T_ADOAZON_ALL
                                       USING  $INDEX
                                              $LAST_DATE.
*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_1208 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.
*          We need a summary because there is such a special field
*          which must be totaled!!!! ONLY 1208 have applied so far
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.

         ENDIF.

*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_1208  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.
*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_1208 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.

*        Normal calculations "A"
         PERFORM CALC_ABEV_SZJA_1208  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_1208  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
                                        USING  SPACE  "Normál mezőre
                                               $LAST_DATE
                                               $INDEX.

*--1208 2012.02.01
*++1308 2013.02.05 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1308.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_1308 TABLES T_BEVALLO
                                              T_BEVALLB
                                              T_ADOAZON_ALL
                                       USING  $INDEX
                                              $LAST_DATE.
*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_1308 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.
*          We need a summary because there is such a special field
*          which must be totaled!!!! ONLY 1208 have applied so far
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.

*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_1308  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.

*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_1308 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.

*        Normal calculations "A"
         PERFORM CALC_ABEV_SZJA_1308  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_1308  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
                                        USING  SPACE  "Normál mezőre
                                               $LAST_DATE
                                               $INDEX.
*--1308 2013.02.05 BG
*++1408 2014.01.29 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1408.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_1408 TABLES T_BEVALLO
                                              T_BEVALLB
                                              T_ADOAZON_ALL
                                       USING  $INDEX
                                              $LAST_DATE.

*++1408 #02. 2014.03.05 BG
*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_1408 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.
*          We need a summary because there is such a special field
*          which must be totaled!!!! ONLY 1208 have applied so far
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.

*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_1408  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.
**--1408 #02. 2014.03.05 BG
*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_1408 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*
*        Normal calculations "A"
         PERFORM CALC_ABEV_SZJA_1408  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_1408  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
                                        USING  SPACE  "Normál mezőre
                                               $LAST_DATE
                                               $INDEX.
*--1408 2014.01.29 BG
*++1508 #01. 2015.02.02
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1508.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_1508 TABLES T_BEVALLO
                                              T_BEVALLB
                                              T_ADOAZON_ALL
                                       USING  $INDEX
                                              $LAST_DATE.
*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_1508 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.
*          We need a summary because there is such a special field
*          which must be totaled!!!! ONLY 1208 have applied so far
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_1508  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.
*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_1508 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Normal calculations "A"
         PERFORM CALC_ABEV_SZJA_1508  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_1508  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
                                        USING  SPACE  "Normál mezőre
                                               $LAST_DATE
                                               $INDEX.
*--1508 #01. 2015.02.02
*++1608 #01. 2015.02.01
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1608.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_1608 TABLES T_BEVALLO
                                              T_BEVALLB
                                              T_ADOAZON_ALL
                                       USING  $INDEX
                                              $LAST_DATE.
*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_1608 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.
*          We need a summary because there is such a special field
*          which must be totaled!!!! ONLY 1208 have applied so far
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_1608  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.
*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_1608 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Normal calculations "A"
         PERFORM CALC_ABEV_SZJA_1608  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_1608  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
                                        USING  SPACE  "Normál mezőre
                                               $LAST_DATE
                                               $INDEX.


*--1608 #01. 2015.02.01
*++1708 #01. 2017.01.31
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1708.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_1708 TABLES T_BEVALLO
                                              T_BEVALLB
                                              T_ADOAZON_ALL
                                       USING  $INDEX
                                              $LAST_DATE.
*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_1708 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.
*          We need a summary because there is such a special field
*          which must be totaled!!!! ONLY 1208 have applied so far
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_1708  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.
*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_1708 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Normal calculations "A"
         PERFORM CALC_ABEV_SZJA_1708  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_1708  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
                                        USING  SPACE  "Normál mezőre
                                               $LAST_DATE
                                               $INDEX.
*--1708 #01. 2017.01.31
*++1808 #01. 2018.01.30
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1808.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_1808 TABLES T_BEVALLO
                                              T_BEVALLB
                                              T_ADOAZON_ALL
                                       USING  $INDEX
                                              $LAST_DATE.
*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_1808 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.
*          We need a summary because there is such a special field
*          which must be totaled!!!! ONLY 1208 have applied so far
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_1808  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.
*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_1808 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Normal calculations "A"
         PERFORM CALC_ABEV_SZJA_1808  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_1808  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
                                        USING  SPACE  "Normál mezőre
                                               $LAST_DATE
                                               $INDEX.
*--1808 #01. 2018.01.30
*++1908 #01. 2019.01.29
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1908.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_1908 TABLES T_BEVALLO
                                              T_BEVALLB
                                              T_ADOAZON_ALL
                                       USING  $INDEX
                                              $LAST_DATE.
*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_1908 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.
*          We need a summary because there is such a special field
*          which must be totaled!!!! ONLY 1208 have applied so far
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_1908  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.
*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_1908 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Normal calculations "A"
         PERFORM CALC_ABEV_SZJA_1908  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_1908  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
                                        USING  SPACE  "Normál mezőre
                                               $LAST_DATE
                                               $INDEX.
*--1908 #01. 2019.01.29
*++2008 #01. 2020.01.27
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_2008.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_2008 TABLES T_BEVALLO
           T_BEVALLB
           T_ADOAZON_ALL
         USING  $INDEX
               $LAST_DATE.
*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_2008 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.
*          We need a summary because there is such a special field
*          which must be totaled!!!! ONLY 1208 have applied so far
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_2008  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.
*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_2008 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Normal calculations "A"
         PERFORM CALC_ABEV_SZJA_2008  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_2008  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
                                        USING  SPACE  "Normál mezőre
                                               $LAST_DATE
                                               $INDEX.
*--2008 #01. 2020.01.27
*++2108 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_2108.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_2108 TABLES T_BEVALLO
                                              T_BEVALLB
                                              T_ADOAZON_ALL
                                       USING  $INDEX
                                              $LAST_DATE.
*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*++2108 #06.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_2108 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.
**          Kell egy összesítés, mivel van olyan speciális mező
**          amit összesíteni kell!!!! CSAK 1208-nál jelentkezett eddig
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
*--2108 #06.
         ENDIF.
*++2108 #06.
*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_2108  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.
*--2108 #06.
*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_2108 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Normal calculations "A"
         PERFORM CALC_ABEV_SZJA_2108  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_2108  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
                                        USING  SPACE  "Normál mezőre
                                               $LAST_DATE
                                               $INDEX.
*--2108 #01.
*++2208 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_2208.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_2208 TABLES T_BEVALLO
                                              T_BEVALLB
                                              T_ADOAZON_ALL
                                       USING  $INDEX
                                              $LAST_DATE.
*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
*++2208 #04.
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_2208 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.
**          Kell egy összesítés, mivel van olyan speciális mező
**          amit összesíteni kell!!!! CSAK 1208-nál jelentkezett eddig
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_2208  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.
*--2208 #04.
*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_2208 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Normal calculations "A"
         PERFORM CALC_ABEV_SZJA_2208  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_2208  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
                                        USING  SPACE  "Normál mezőre
                                               $LAST_DATE
                                               $INDEX.
*--2208 #01.
*++2308 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_2308.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_2308 TABLES T_BEVALLO
                                              T_BEVALLB
                                              T_ADOAZON_ALL
                                       USING  $INDEX
                                              $LAST_DATE.
*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_2308 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.
**          Kell egy összesítés, mivel van olyan speciális mező
**          amit összesíteni kell!!!! CSAK 1208-nál jelentkezett eddig
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_2308  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.
*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_2308 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Normal calculations "A"
         PERFORM CALC_ABEV_SZJA_2308  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_2308  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
                                        USING  SPACE  "Normál mezőre
                                               $LAST_DATE
                                               $INDEX.
*--2308 #01
*++2408 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_2408.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_2408 TABLES T_BEVALLO
                                              T_BEVALLB
                                              T_ADOAZON_ALL
                                       USING  $INDEX
                                              $LAST_DATE.
*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_2408 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.
**          Kell egy összesítés, mivel van olyan speciális mező
**          amit összesíteni kell!!!! CSAK 1208-nál jelentkezett eddig
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_2408  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.
*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_2408 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Normal calculations "A"
         PERFORM CALC_ABEV_SZJA_2408  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_2408  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
                                        USING  SPACE  "Normál mezőre
                                               $LAST_DATE
                                               $INDEX.
*--2408 #01.
*++2508 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_2508.
*        We need a special summary of M's ABEVs
*        summarizes it into technical ABEVs
         PERFORM CALC_ABEV_M_SZJA_2508 TABLES T_BEVALLO
                                              T_BEVALLB
                                              T_ADOAZON_ALL
                                       USING  $INDEX
                                              $LAST_DATE.
*        For self-revision, the total amount is determined in the normal field
*        and then in the self-revision fields, the information about the self-revision
         IF $INDEX NE '000'.
*          Special calculations (START card + EG-biz + Pension)
           PERFORM CALC_ABEV_SZJA_SPECIAL_2508 TABLES T_BEVALLO
                                                      T_BEVALLB
                                                      T_ADOAZON
                                               USING  '000'
                                                      $LAST_DATE.
**          Kell egy összesítés, mivel van olyan speciális mező
**          amit összesíteni kell!!!! CSAK 1208-nál jelentkezett eddig
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Self-revision
         PERFORM CALC_ABEV_ONREV_SZJA_2508  TABLES T_BEVALLO
                                                   T_BEVALLB
                                                   T_ADOAZON
                                            USING  $INDEX
                                                   $LAST_DATE.
*        Special calculations (START card + EG-biz + Pension)
         PERFORM CALC_ABEV_SZJA_SPECIAL_2508 TABLES T_BEVALLO
                                                    T_BEVALLB
                                                    T_ADOAZON
                                             USING  $INDEX
                                                    $LAST_DATE.
         IF $INDEX EQ '000'.
           PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE.
         ENDIF.
*        Normal calculations "A"
         PERFORM CALC_ABEV_SZJA_2508  TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE
                                             $INDEX.
*        Management of 0 fields
         PERFORM CALC_ABEV_0_SZJA_2508  TABLES T_BEVALLO
                                               T_ADOAZON_ALL
                                        USING  SPACE  "Normál mezőre
                                               $LAST_DATE
                                               $INDEX.
*--2508 #01.
       ENDIF.

* VAT Calculated fields
     WHEN C_BTYPART_AFA.

       IF W_/ZAK/BEVALL-BTYPE EQ C_0865.
         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
*++2009.02.02 BG
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_347
                                        "Előző időszak áthozott
                                        C_ABEVAZ_357.
         "Köv.idsz. átviendő
*--2009.02.02 BG

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_0865 TABLES T_BEVALLO
                                           T_BEVALLB
                                   USING  $LAST_DATE.
*++0965 2009.02.02 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_0965.
         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_8273
                                        "Előző időszak áthozott
                                        C_ABEVAZ_8283.
         "Köv.idsz. átviendő

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_0965 TABLES T_BEVALLO
                                           T_BEVALLB
                                   USING  $LAST_DATE.

*--0965 2009.02.02 BG
*++1065 2010.01.27 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1065.

         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_8273
                                        "Előző időszak áthozott
                                        C_ABEVAZ_8283.
         "Köv.idsz. átviendő

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_1065 TABLES T_BEVALLO
                                           T_BEVALLB
                                   USING  $LAST_DATE.

*--1065 2010.01.27 BG
*++1165 2011.02.07 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1165.

         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_8273 "Előző idős.áth.
                                        C_ABEVAZ_8283."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_1165 TABLES T_BEVALLO
                                           T_BEVALLB
                                   USING  $LAST_DATE.


*--1165 2011.02.07 BG
*++1265 2012.01.31 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1265.

         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_8273 "Előző idős.áth.
                                        C_ABEVAZ_8283."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_1265 TABLES T_BEVALLO
                                           T_BEVALLB
                                   USING  $LAST_DATE.

*--1265 2012.01.31 BG
       ENDIF.
* Condominium Calculated fields
     WHEN C_BTYPART_TARS.
       PERFORM CALC_ABEV_TARS.

* Holiday check Calculated fields
     WHEN C_BTYPART_UCS.
       PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                    T_BEVALLB
                             USING  $LAST_DATE.
       PERFORM CALC_ABEV_UCS.

* Pass-through Calculated fields
     WHEN C_BTYPART_ATV.
       PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                    T_BEVALLB
                             USING  $LAST_DATE.
       PERFORM CALC_ABEV_ATV.
*++0004 BG 2007.04.04
* Summary report
     WHEN C_BTYPART_ONYB.
       IF W_/ZAK/BEVALL-BTYPE EQ C_0761.
         PERFORM CALC_ABEV_ONYB_0761 TABLES T_BEVALLO
                                            T_BEVALLB
                                     USING  $LAST_DATE.
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_08A60.
         PERFORM CALC_ABEV_ONYB_08A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.
*++09A60 2009.04.02 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_09A60.
         PERFORM CALC_ABEV_ONYB_09A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.

*--09A60 2009.04.02 BG
*++10A60 2010.02.11 RN
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_10A60.
         PERFORM CALC_ABEV_ONYB_10A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.

*--10A60 2010.02.11 RN
*++11A60 2011.02.07 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_11A60.
         PERFORM CALC_ABEV_ONYB_11A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.

*--11A60 2011.02.07 BG
*++12A60 2012.02.06 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_12A60.
         PERFORM CALC_ABEV_ONYB_12A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.

*--12A60 2011.02.06 BG
       ENDIF.
*--0004 BG 2007.04.04
   ENDCASE.

 ENDFORM.                    " calc_abev

*&---------------------------------------------------------------------*
*&      Form  calc_abev
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_AFA TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                           T_BEVALLB STRUCTURE /ZAK/BEVALLB
                           T_ADOAZON STRUCTURE /ZAK/ONR_ADOAZON
                           T_AFA_SZLA_SUM STRUCTURE /ZAK/AFA_SZLASUM
                    USING  $LAST_DATE LIKE SY-DATUM
                           $INDEX.

   CASE W_/ZAK/BEVALL-BTYPART.
* VAT Calculated fields
     WHEN C_BTYPART_AFA.
       IF W_/ZAK/BEVALL-BTYPE EQ C_0865.
         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
*++2009.02.02 BG
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_347
                                        "Előző időszak áthozott
                                        C_ABEVAZ_357.
         "Köv.idsz. átviendő
*--2009.02.02 BG

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_0865 TABLES T_BEVALLO
                                           T_BEVALLB
                                   USING  $LAST_DATE.
*++0965 2009.02.02 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_0965.
         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_8273
                                        "Előző időszak áthozott
                                        C_ABEVAZ_8283.
         "Köv.idsz. átviendő

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_0965 TABLES T_BEVALLO
                                           T_BEVALLB
                                   USING  $LAST_DATE.

*--0965 2009.02.02 BG
*++1065 2010.01.27 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1065.

         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_8273
                                        "Előző időszak áthozott
                                        C_ABEVAZ_8283.
         "Köv.idsz. átviendő

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_1065 TABLES T_BEVALLO
                                           T_BEVALLB
                                   USING  $LAST_DATE.

*--1065 2010.01.27 BG
*++1165 2011.02.07 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1165.

         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_8273 "Előző idős.áth.
                                        C_ABEVAZ_8283."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_1165 TABLES T_BEVALLO
                                           T_BEVALLB
                                   USING  $LAST_DATE.


*--1165 2011.02.07 BG
*++1265 2012.01.31 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1265.

         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_8273 "Előző idős.áth.
                                        C_ABEVAZ_8283."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_1265 TABLES T_BEVALLO
                                           T_BEVALLB
                                   USING  $LAST_DATE.

*--1265 2012.01.31 BG
*++1365 2013.01.10 Balázs Gábor (Ness)
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1365.

         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_A0DD0082CA "Előző idős.áth.
                                        C_ABEVAZ_A0DD0086CA."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_1365 TABLES T_BEVALLO
                                           T_BEVALLB
                                           T_ADOAZON
                                           T_AFA_SZLA_SUM
                                    USING  $LAST_DATE
                                           $INDEX
                                           W_/ZAK/BEVALL-OMREL
*++1665 #06.
                                           W_/ZAK/BEVALL-KIUTALAS.
*--1665 #06.
*--1365 2013.01.10 Balázs Gábor (Ness)
*++1465 #01. 2013.02.04 Balázs Gábor (Ness)
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1465.

         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_A0DD0082CA "Előző idős.áth.
                                        C_ABEVAZ_A0DD0086CA."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_1465 TABLES T_BEVALLO
                                           T_BEVALLB
                                           T_ADOAZON
                                           T_AFA_SZLA_SUM
                                    USING  $LAST_DATE
                                           $INDEX
                                           W_/ZAK/BEVALL-OMREL
*++1665 #06.
                                           W_/ZAK/BEVALL-KIUTALAS.
*--1665 #06.
*--1465 #01. 2013.02.04 Balázs Gábor (Ness)
*++1765 #28.
*        Management of 0 fields
         PERFORM CALC_ABEV_0_AFA_1465  TABLES T_BEVALLO.
*--1765 #28.
*++1565 #01. 2015.01.26
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1565.

         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_A0DD0082CA "Előző idős.áth.
                                        C_ABEVAZ_A0DD0086CA."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_1565 TABLES T_BEVALLO
                                           T_BEVALLB
                                           T_ADOAZON
                                           T_AFA_SZLA_SUM
                                    USING  $LAST_DATE
                                           $INDEX
                                           W_/ZAK/BEVALL-OMREL
*++1665 #06.
                                           W_/ZAK/BEVALL-KIUTALAS.
*--1665 #06.
*--1565 #01. 2015.01.26
*++1665 #01. 2015.02.02
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1665.
         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_A0DD0082CA "Előző idős.áth.
                                        C_ABEVAZ_A0DD0086CA."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_1665 TABLES T_BEVALLO
                                           T_BEVALLB
                                           T_ADOAZON
                                           T_AFA_SZLA_SUM
                                    USING  $LAST_DATE
                                           $INDEX
                                           W_/ZAK/BEVALL-OMREL
*++1665 #06.
                                           W_/ZAK/BEVALL-KIUTALAS.
*--1665 #06.
*--1665 #01. 2015.02.02
*++1765 #01. 2017.01.31
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1765.
         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_A0DD0082CA "Előző idős.áth.
                                        C_ABEVAZ_A0DD0086CA."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_1765 TABLES T_BEVALLO
                                           T_BEVALLB
                                           T_ADOAZON
                                           T_AFA_SZLA_SUM
                                    USING  $LAST_DATE
                                           $INDEX
                                           W_/ZAK/BEVALL-OMREL
                                           W_/ZAK/BEVALL-KIUTALAS.
*--1765 #01. 2017.01.31
*++1865 #01. 2018.01.30
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1865.
ENHANCEMENT-POINT /ZAK/ZAK_CORP_LAST_DATE SPOTS /ZAK/FUNCTIONS_ES .
         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_A0DD0082CA "Előző idős.áth.
                                        C_ABEVAZ_A0DD0086CA."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_1865 TABLES T_BEVALLO
                                           T_BEVALLB
                                           T_ADOAZON
                                           T_AFA_SZLA_SUM
                                    USING  $LAST_DATE
                                           $INDEX
                                           W_/ZAK/BEVALL-OMREL
                                           W_/ZAK/BEVALL-KIUTALAS.
*--1865 #01. 2018.01.30
*++1965 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1965.
         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_A0DD0082CA "Előző idős.áth.
                                        C_ABEVAZ_A0DD0086CA."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_1965 TABLES T_BEVALLO
                                           T_BEVALLB
                                           T_ADOAZON
                                           T_AFA_SZLA_SUM
                                    USING  $LAST_DATE
                                           $INDEX
                                           W_/ZAK/BEVALL-OMREL
                                           W_/ZAK/BEVALL-KIUTALAS.

*--1965 #01.
*++2065 #01.
*++2065 #09.
*       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_2065.
       ELSEIF W_/ZAK/BEVALL-BTYPE(4) EQ C_2065.
*++2065 #09.
         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_A0DD0082CA "Előző idős.áth.
                                        C_ABEVAZ_A0DD0086CA."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_2065 TABLES T_BEVALLO
                                           T_BEVALLB
                                           T_ADOAZON
                                           T_AFA_SZLA_SUM
                                    USING  $LAST_DATE
                                           $INDEX
                                           W_/ZAK/BEVALL-OMREL
                                           W_/ZAK/BEVALL-KIUTALAS.
*--2065 #01.
*++2165 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE(4) EQ C_2165.
         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_A0DD0082CA "Előző idős.áth.
                                        C_ABEVAZ_A0DD0086CA."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_2165 TABLES T_BEVALLO
                                           T_BEVALLB
                                           T_ADOAZON
                                           T_AFA_SZLA_SUM
                                    USING  $LAST_DATE
                                           $INDEX
                                           W_/ZAK/BEVALL-OMREL
                                           W_/ZAK/BEVALL-KIUTALAS.

*--2165 #01.
*++2265 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE(4) EQ C_2265.
         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_A0DD0082CA "Előző idős.áth.
                                        C_ABEVAZ_A0DD0086CA."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_2265 TABLES T_BEVALLO
                                           T_BEVALLB
                                           T_ADOAZON
                                           T_AFA_SZLA_SUM
                                    USING  $LAST_DATE
                                           $INDEX
                                           W_/ZAK/BEVALL-OMREL
                                           W_/ZAK/BEVALL-KIUTALAS.
*--2265 #01.
*++2365 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE(4) EQ C_2365.
         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_A0DD0082CA "Előző idős.áth.
                                        C_ABEVAZ_A0DD0086CA."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_2365 TABLES T_BEVALLO
                                           T_BEVALLB
                                           T_ADOAZON
                                           T_AFA_SZLA_SUM
                                    USING  $LAST_DATE
                                           $INDEX
                                           W_/ZAK/BEVALL-OMREL
                                           W_/ZAK/BEVALL-KIUTALAS.
*--2365 #01.
*++2465 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE(4) EQ C_2465.
         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_A0DD0082CA "Előző idős.áth.
                                        C_ABEVAZ_A0DD0086CA."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_2465 TABLES T_BEVALLO
                                           T_BEVALLB
                                           T_ADOAZON
                                           T_AFA_SZLA_SUM
                                    USING  $LAST_DATE
                                           $INDEX
                                           W_/ZAK/BEVALL-OMREL
                                           W_/ZAK/BEVALL-KIUTALAS.
*--2465 #01.
*++2565 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE(4) EQ C_2565.
         PERFORM CALC_ABEV_EIDSZ TABLES T_BEVALLO
                                        T_BEVALLB
                                 USING  $LAST_DATE
                                        W_/ZAK/BEVALL-BTYPE
                                        C_ABEVAZ_A0DD0082CA "Előző idős.áth.
                                        C_ABEVAZ_A0DD0086CA."Köv.idsz. átvi.

         PERFORM CALC_ABEV_SUM TABLES T_BEVALLO
                                      T_BEVALLB
                               USING  $LAST_DATE.

         PERFORM CALC_ABEV_AFA_2565 TABLES T_BEVALLO
                                           T_BEVALLB
                                           T_ADOAZON
                                           T_AFA_SZLA_SUM
                                    USING  $LAST_DATE
                                           $INDEX
                                           W_/ZAK/BEVALL-OMREL
                                           W_/ZAK/BEVALL-KIUTALAS.
*--2565 #01.
       ENDIF.
* Summary report
     WHEN C_BTYPART_ONYB.
       IF W_/ZAK/BEVALL-BTYPE EQ C_0761.
         PERFORM CALC_ABEV_ONYB_0761 TABLES T_BEVALLO
                                            T_BEVALLB
                                     USING  $LAST_DATE.
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_08A60.
         PERFORM CALC_ABEV_ONYB_08A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.
*++09A60 2009.04.02 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_09A60.
         PERFORM CALC_ABEV_ONYB_09A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.

*--09A60 2009.04.02 BG
*++10A60 2010.02.11 RN
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_10A60.
         PERFORM CALC_ABEV_ONYB_10A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.

*--10A60 2010.02.11 RN
*++11A60 2011.02.07 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_11A60.
         PERFORM CALC_ABEV_ONYB_11A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.

*--11A60 2011.02.07 BG
*++12A60 2012.02.06 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_12A60.
         PERFORM CALC_ABEV_ONYB_12A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.

*--12A60 2011.02.06 BG
*++13A60 2013.01.28 BG
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_13A60.
         PERFORM CALC_ABEV_ONYB_13A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.
*--13A60 2013.01.28 BG
*++14A60 #01. 2014.02.04 Balázs Gábor (Ness)
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_14A60.
         PERFORM CALC_ABEV_ONYB_14A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.
*--14A60 #01. 2014.02.04 Balázs Gábor (Ness)
*++15A60 #01. 2015.01.26
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_15A60.
         PERFORM CALC_ABEV_ONYB_15A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.
*--15A60 #01. 2015.01.26
*++16A60 #01. 2015.02.02
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_16A60.
         PERFORM CALC_ABEV_ONYB_16A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.
*--16A60 #01. 2015.02.02
*++17A60 #01. 2017.01.31
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_17A60.
         PERFORM CALC_ABEV_ONYB_17A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.
*--17A60 #01. 2017.01.31
*++18A60 #01. 2018.01.30
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_18A60.
ENHANCEMENT-POINT /ZAK/ZAK_CORP_LAST_DATE_18A60 SPOTS /ZAK/FUNCTIONS_ES .

         PERFORM CALC_ABEV_ONYB_18A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.
*--18A60 #01. 2018.01.30
*++19A60 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_19A60.
         PERFORM CALC_ABEV_ONYB_19A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.
*--19A60 #01.
*++20A60 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_20A60.
         PERFORM CALC_ABEV_ONYB_20A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.
*--20A60 #01.
*++21A60 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_21A60.
         PERFORM CALC_ABEV_ONYB_21A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.
*--21A60 #01.
*++22A60 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_22A60.
         PERFORM CALC_ABEV_ONYB_22A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.
*--22A60 #01.
*++23A60 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_23A60.
         PERFORM CALC_ABEV_ONYB_23A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.
*--23A60 #01.
*++24A60 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_24A60.
         PERFORM CALC_ABEV_ONYB_24A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.
*--24A60 #01.
*++25A60 #01.
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_25A60.
         PERFORM CALC_ABEV_ONYB_25A60 TABLES T_BEVALLO
                                             T_BEVALLB
                                      USING  $LAST_DATE.
*--25A60 #01.
       ENDIF.
*--0004 BG 2007.04.04
*++PTGSZLAA #01. 2014.03.03
     WHEN C_BTYPART_PTG.
*++PTGSZLAH #01. 2015.01.16
       IF W_/ZAK/BEVALL-BTYPE EQ C_BTYPE_PTGSZLAA.
*--PTGSZLAH #01. 2015.01.16
         PERFORM CALC_ABEV_PTGSZLAA TABLES T_BEVALLO
                                           T_BEVALLB
                                     USING $LAST_DATE
                                           $INDEX.
*++PTGSZLAH #01. 2015.01.16
       ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_BTYPE_PTGSZLAH.
         PERFORM CALC_ABEV_PTGSZLAA TABLES T_BEVALLO
                                           T_BEVALLB
                                     USING $LAST_DATE
                                           $INDEX.
       ENDIF.
       PERFORM CALC_ABEV_PTGSZLAH TABLES T_BEVALLO
                                         T_BEVALLB
                                   USING $LAST_DATE
                                         $INDEX.
*--PTGSZLAH #01. 2015.01.16
*--PTGSZLAA #01. 2014.03.03
   ENDCASE.

 ENDFORM.                    " calc_abev


*&---------------------------------------------------------------------*
*&      Form  calc_abev_szja_0608
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SZJA_0608 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                 T_BEVALLB STRUCTURE /ZAK/BEVALLB
                          USING  $DATE.

   DATA: L_SUM      LIKE /ZAK/BEVALLO-FIELD_N,
         L_SUM_203  LIKE /ZAK/BEVALLO-FIELD_N,
         L_KAMAT    LIKE /ZAK/BEVALLO-FIELD_N,
         L_ABEV_SUM LIKE /ZAK/BEVALLO-FIELD_N.
   DATA: L_KAM_KEZD  TYPE DATUM,
         L_KAM_VEG   TYPE DATUM,
         L_ROUND(20) TYPE C,
         L_TABIX     LIKE SY-TABIX,
         L_UPD.

   DATA: BEGIN OF I_ADOAZON OCCURS 0,
           ADOAZON TYPE /ZAK/ADOAZON,
         END OF I_ADOAZON.
   DATA: L_BEVALLO TYPE /ZAK/BEVALLO.
************************************************************************
* Special abev fields
************************************************************************


   SORT T_BEVALLB BY ABEVAZ  .
* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE  ABEVAZ EQ     C_ABEVAZ_A0AC028A  OR
            ABEVAZ EQ     C_ABEVAZ_A0AC029A  OR
            ABEVAZ EQ     C_ABEVAZ_A0AC034A  OR
            ABEVAZ EQ     C_ABEVAZ_M0BB001A  OR
            ABEVAZ EQ     C_ABEVAZ_M0CB001A  OR
            ABEVAZ EQ     C_ABEVAZ_M0DB001A  OR
            ABEVAZ EQ     C_ABEVAZ_M0EB001A  OR
            ABEVAZ EQ     C_ABEVAZ_M0FB001A  OR
            ABEVAZ EQ     C_ABEVAZ_M0GB001A  OR
            ABEVAZ EQ     C_ABEVAZ_M0HB001A  OR
            ABEVAZ EQ     C_ABEVAZ_M0IB001A  OR
            ABEVAZ EQ     C_ABEVAZ_M0JB001A
            .


     CLEAR : L_SUM,W_/ZAK/BEVALLO.
* this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
*++BG 2006/05/24
     CHECK SY-SUBRC EQ 0.
*--BG 2006/05/24
     V_TABIX = SY-TABIX .
     CLEAR: W_/ZAK/BEVALLO-FIELD_N,
            W_/ZAK/BEVALLO-FIELD_NR,
            W_/ZAK/BEVALLO-FIELD_NRK.
     CASE W_/ZAK/BEVALLB-ABEVAZ.

       WHEN C_ABEVAZ_A0AC028A.
* always A0AC028A = first day from period
* Havi
         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* A year old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'E'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+4(4) = '0101'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* He is four years old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.

           L_KAM_KEZD = $DATE.
           IF L_KAM_KEZD+4(2) >= '01' AND
              L_KAM_KEZD+4(2) <= '03'.

             L_KAM_KEZD+4(4) = '0101'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '04' AND
              L_KAM_KEZD+4(2) <= '06'.

             L_KAM_KEZD+4(4) = '0401'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '07' AND
              L_KAM_KEZD+4(2) <= '09'.

             L_KAM_KEZD+4(4) = '0701'.
           ENDIF.


           IF L_KAM_KEZD+4(2) >= '10' AND
              L_KAM_KEZD+4(2) <= '12'.

             L_KAM_KEZD+4(4) = '1001'.
           ENDIF.

           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ELSE.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ENDIF.

         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
* always A0AC029A = last day until period
       WHEN C_ABEVAZ_A0AC029A.
         W_/ZAK/BEVALLO-FIELD_C = $DATE.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

* Number of taxpayers = Tax numbers
       WHEN C_ABEVAZ_A0AC034A.


         REFRESH I_ADOAZON.
         LOOP AT T_BEVALLO INTO L_BEVALLO.
           CHECK NOT L_BEVALLO-ADOAZON IS INITIAL.
           MOVE L_BEVALLO-ADOAZON TO I_ADOAZON.
           COLLECT I_ADOAZON.
         ENDLOOP.

         DESCRIBE TABLE I_ADOAZON LINES SY-TFILL.

*++BG 2006.12.11
         IF NOT SY-TFILL IS INITIAL.
*--BG 2006.12.11
           W_/ZAK/BEVALLO-FIELD_C = SY-TFILL.
*++BG 2006.12.11
         ELSE.
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
         ENDIF.
*--BG 2006.12.11

         CONDENSE W_/ZAK/BEVALLO-FIELD_C.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

* Dynamic page number
       WHEN C_ABEVAZ_M0BB001A  OR
            C_ABEVAZ_M0CB001A  OR
            C_ABEVAZ_M0DB001A  OR
            C_ABEVAZ_M0EB001A  OR
            C_ABEVAZ_M0FB001A  OR
            C_ABEVAZ_M0GB001A  OR
            C_ABEVAZ_M0HB001A  OR
            C_ABEVAZ_M0IB001A  OR
            C_ABEVAZ_M0JB001A.

         W_/ZAK/BEVALLO-FIELD_C = W_/ZAK/BEVALLO-LAPSZ.
         PERFORM ALPHA_CONV_OUT CHANGING W_/ZAK/BEVALLO-FIELD_C.
         CONDENSE W_/ZAK/BEVALLO-FIELD_C.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

     ENDCASE.
   ENDLOOP.

 ENDFORM.                    " calc_abev_szja_0608

*&---------------------------------------------------------------------*
*&      Form  calc_abev_szja_06082
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SZJA_06082
                    TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                            T_BEVALLB STRUCTURE /ZAK/BEVALLB
                     USING  $DATE.

   DATA: L_SUM      LIKE /ZAK/BEVALLO-FIELD_N,
         L_SUM_203  LIKE /ZAK/BEVALLO-FIELD_N,
         L_KAMAT    LIKE /ZAK/BEVALLO-FIELD_N,
         L_ABEV_SUM LIKE /ZAK/BEVALLO-FIELD_N.
   DATA: L_KAM_KEZD  TYPE DATUM,
         L_KAM_VEG   TYPE DATUM,
         L_ROUND(20) TYPE C,
         L_TABIX     LIKE SY-TABIX,
         L_UPD.

   DATA: BEGIN OF I_ADOAZON OCCURS 0,
           ADOAZON TYPE /ZAK/ADOAZON,
         END OF I_ADOAZON.
   DATA: L_BEVALLO TYPE /ZAK/BEVALLO.
************************************************************************
* Special abev fields
************************************************************************


   SORT T_BEVALLB BY ABEVAZ  .
* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE  ABEVAZ EQ     C_ABEVAZ_A0AC028A  OR
            ABEVAZ EQ     C_ABEVAZ_A0AC029A  OR
            ABEVAZ EQ     C_ABEVAZ_A0AC034A  OR
            ABEVAZ EQ     C_ABEVAZ_M0BB001A  OR
            ABEVAZ EQ     C_ABEVAZ_M0CB001A  OR
            ABEVAZ EQ     C_ABEVAZ_M0DB001A  OR
            ABEVAZ EQ     C_ABEVAZ_M0EB001A  OR
            ABEVAZ EQ     C_ABEVAZ_M0FB001A  OR
            ABEVAZ EQ     C_ABEVAZ_M0GB001A  OR
            ABEVAZ EQ     C_ABEVAZ_M0HB001A  OR
            ABEVAZ EQ     C_ABEVAZ_M0IB001A  OR
            ABEVAZ EQ     C_ABEVAZ_M0JB001A
            .


     CLEAR : L_SUM,W_/ZAK/BEVALLO.
* this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
*++BG 2006/05/24
     CHECK SY-SUBRC EQ 0.
*--BG 2006/05/24
     V_TABIX = SY-TABIX .
     CLEAR: W_/ZAK/BEVALLO-FIELD_N,
            W_/ZAK/BEVALLO-FIELD_NR,
            W_/ZAK/BEVALLO-FIELD_NRK.
     CASE W_/ZAK/BEVALLB-ABEVAZ.

       WHEN C_ABEVAZ_A0AC028A.
* always A0AC028A = first day from period
* Havi
         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* A year old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'E'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+4(4) = '0101'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* He is four years old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.

           L_KAM_KEZD = $DATE.
           IF L_KAM_KEZD+4(2) >= '01' AND
              L_KAM_KEZD+4(2) <= '03'.

             L_KAM_KEZD+4(4) = '0101'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '04' AND
              L_KAM_KEZD+4(2) <= '06'.

             L_KAM_KEZD+4(4) = '0401'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '07' AND
              L_KAM_KEZD+4(2) <= '09'.

             L_KAM_KEZD+4(4) = '0701'.
           ENDIF.


           IF L_KAM_KEZD+4(2) >= '10' AND
              L_KAM_KEZD+4(2) <= '12'.

             L_KAM_KEZD+4(4) = '1001'.
           ENDIF.

           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ELSE.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ENDIF.

         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
* always A0AC029A = last day until period
       WHEN C_ABEVAZ_A0AC029A.
         W_/ZAK/BEVALLO-FIELD_C = $DATE.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

* Number of taxpayers = Tax numbers
       WHEN C_ABEVAZ_A0AC034A.


         REFRESH I_ADOAZON.
         LOOP AT T_BEVALLO INTO L_BEVALLO.
           CHECK NOT L_BEVALLO-ADOAZON IS INITIAL.
           MOVE L_BEVALLO-ADOAZON TO I_ADOAZON.
           COLLECT I_ADOAZON.
         ENDLOOP.


         DESCRIBE TABLE I_ADOAZON LINES SY-TFILL.
*++BG 2006.12.11
         IF NOT SY-TFILL IS INITIAL.
*--BG 2006.12.11
           W_/ZAK/BEVALLO-FIELD_C = SY-TFILL.
*++BG 2006.12.11
         ELSE.
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
         ENDIF.
*--BG 2006.12.11

         CONDENSE W_/ZAK/BEVALLO-FIELD_C.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.


* Dynamic page number
       WHEN C_ABEVAZ_M0BB001A  OR
            C_ABEVAZ_M0CB001A  OR
            C_ABEVAZ_M0DB001A  OR
            C_ABEVAZ_M0EB001A  OR
            C_ABEVAZ_M0FB001A  OR
            C_ABEVAZ_M0GB001A  OR
            C_ABEVAZ_M0HB001A  OR
            C_ABEVAZ_M0IB001A  OR
            C_ABEVAZ_M0JB001A.

         W_/ZAK/BEVALLO-FIELD_C = W_/ZAK/BEVALLO-LAPSZ.
         PERFORM ALPHA_CONV_OUT CHANGING W_/ZAK/BEVALLO-FIELD_C.
         CONDENSE W_/ZAK/BEVALLO-FIELD_C.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

     ENDCASE.
   ENDLOOP.

 ENDFORM.                    " calc_abev_szja_06082

*&---------------------------------------------------------------------*
*&      Form  calc_abev_szja_0708
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SZJA_0708
                    TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                            T_BEVALLB STRUCTURE /ZAK/BEVALLB
                     USING  $DATE
*++BG 2007/01/16
                            $INDEX
*--BG 2007/01/16
                            .

   DATA: L_SUM      LIKE /ZAK/BEVALLO-FIELD_N,
         L_SUM_203  LIKE /ZAK/BEVALLO-FIELD_N,
         L_KAMAT    LIKE /ZAK/BEVALLO-FIELD_N,
         L_ABEV_SUM LIKE /ZAK/BEVALLO-FIELD_N.
   DATA: L_KAM_KEZD  TYPE DATUM,
         L_KAM_VEG   TYPE DATUM,
         L_ROUND(20) TYPE C,
         L_TABIX     LIKE SY-TABIX,
         L_UPD.

   DATA: BEGIN OF I_ADOAZON OCCURS 0,
           ADOAZON TYPE /ZAK/ADOAZON,
         END OF I_ADOAZON.
   DATA: L_BEVALLO TYPE /ZAK/BEVALLO.

*++BG 2007/01/16
   FIELD-SYMBOLS: <FIELD_N>, <FIELD_NR>, <FIELD_NRK>.

   DEFINE LM_GET_FIELD.
     IF &1 EQ '000'.
       ASSIGN W_/ZAK/BEVALLO-FIELD_N   TO <FIELD_N>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_NR  TO <FIELD_NR>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_NRK TO <FIELD_NRK>.
     ELSE.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ON   TO <FIELD_N>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ONR  TO <FIELD_NR>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ONRK TO <FIELD_NRK>.
     ENDIF.
     CLEAR: <FIELD_N>, <FIELD_NR>, <FIELD_NRK>.

   END-OF-DEFINITION.
*--BG 2007/01/16


*++BG 2007.12.08
   DATA L_M0KB011A_BEVALLO TYPE /ZAK/BEVALLO.

   DEFINE LM_GET_SPEC_SUM1.

     LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ = &1.
*    Field M0KB011A must be defined based on the tax number
       READ TABLE T_BEVALLO INTO L_M0KB011A_BEVALLO
                WITH KEY ABEVAZ  = 'M0KB011A'
                         ADOAZON = L_BEVALLO-ADOAZON
                          LAPSZ  = L_BEVALLO-LAPSZ
                          BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         CONDENSE L_M0KB011A_BEVALLO-FIELD_C.
         IF L_M0KB011A_BEVALLO-FIELD_C EQ &2 OR
            L_M0KB011A_BEVALLO-FIELD_C EQ &3.
*++BG 2007/01/16
*          ADD L_BEVALLO-FIELD_N TO W_/ZAK/BEVALLO-FIELD_N.
           ADD L_BEVALLO-FIELD_N TO <FIELD_N>.
*--BG 2007/01/16
         ENDIF.
       ENDIF.
     ENDLOOP.
   END-OF-DEFINITION.
*--BG 2007.12.08


************************************************************************
* Special abev fields
************************************************************************

   SORT T_BEVALLB BY ABEVAZ  .

* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE  ABEVAZ EQ     C_ABEVAZ_A0AC028A OR
            ABEVAZ EQ     C_ABEVAZ_A0AC029A OR
            ABEVAZ EQ     C_ABEVAZ_A0AC037A OR
*++BG 2007.12.08
            ABEVAZ EQ     C_ABEVAZ_A0EC0155CA OR
            ABEVAZ EQ     C_ABEVAZ_A0EC0156CA OR
            ABEVAZ EQ     C_ABEVAZ_A0EC50071A OR
            ABEVAZ EQ     C_ABEVAZ_A0EC50070A OR
            ABEVAZ EQ     C_ABEVAZ_A0EC50069A.
*--BG 2007.12.08

     CLEAR : L_SUM,W_/ZAK/BEVALLO.
* this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
*++BG 2006/05/24
     CHECK SY-SUBRC EQ 0.
*--BG 2006/05/24
     V_TABIX = SY-TABIX .
*++BG 2007/01/16
*     CLEAR: W_/ZAK/BEVALLO-FIELD_N,
*            W_/ZAK/BEVALLO-FIELD_NR,
*            W_/ZAK/BEVALLO-FIELD_NRK.
*--BG 2007/01/16

     CASE W_/ZAK/BEVALLB-ABEVAZ.
       WHEN C_ABEVAZ_A0AC028A.
* always A0AC028A = first day from period
* Havi
         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* A year old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'E'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+4(4) = '0101'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* He is four years old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.

           L_KAM_KEZD = $DATE.
           IF L_KAM_KEZD+4(2) >= '01' AND
              L_KAM_KEZD+4(2) <= '03'.

             L_KAM_KEZD+4(4) = '0101'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '04' AND
              L_KAM_KEZD+4(2) <= '06'.

             L_KAM_KEZD+4(4) = '0401'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '07' AND
              L_KAM_KEZD+4(2) <= '09'.

             L_KAM_KEZD+4(4) = '0701'.
           ENDIF.


           IF L_KAM_KEZD+4(2) >= '10' AND
              L_KAM_KEZD+4(2) <= '12'.

             L_KAM_KEZD+4(4) = '1001'.
           ENDIF.

           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ELSE.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ENDIF.

         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

* always A0AC029A = last day until period
       WHEN C_ABEVAZ_A0AC029A.
         W_/ZAK/BEVALLO-FIELD_C = $DATE.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
* Number of taxpayers = Tax numbers
       WHEN C_ABEVAZ_A0AC037A.


         REFRESH I_ADOAZON.
         LOOP AT T_BEVALLO INTO L_BEVALLO.
           CHECK NOT L_BEVALLO-ADOAZON IS INITIAL.
           MOVE L_BEVALLO-ADOAZON TO I_ADOAZON.
           COLLECT I_ADOAZON.
         ENDLOOP.


         DESCRIBE TABLE I_ADOAZON LINES SY-TFILL.
*++BG 2006.12.11
         IF NOT SY-TFILL IS INITIAL.
*--BG 2006.12.11
           W_/ZAK/BEVALLO-FIELD_C = SY-TFILL.
*++BG 2006.12.11
         ELSE.
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
         ENDIF.
*--BG 2006.12.11

         CONDENSE W_/ZAK/BEVALLO-FIELD_C.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

* Special calculations
* START card obligation
* The value is defined for a normal period in FIELD_N
* for self-revisions, it must be done in the FIELD_ON field.
       WHEN C_ABEVAZ_A0EC0155CA.
*++BG 2007/01/16
*         CLEAR W_/ZAK/BEVALLO-FIELD_N.
*         LM_GET_SPEC_SUM1 'M0KC0649CA' '01' '07'.
*         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
*                      W_/ZAK/BEVALLB-ROUND
*                      W_/ZAK/BEVALLO-WAERS
*             CHANGING W_/ZAK/BEVALLO-FIELD_NR
*                      W_/ZAK/BEVALLO-FIELD_NRK.
*         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KC0649CA' '01' '07'.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*--BG 2007/01/16
       WHEN C_ABEVAZ_A0EC50071A.
*++BG 2007/01/16
*         CLEAR W_/ZAK/BEVALLO-FIELD_N.
*         LM_GET_SPEC_SUM1 'M0KC0649CA' '11' '12'.
*         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
*                      W_/ZAK/BEVALLB-ROUND
*                      W_/ZAK/BEVALLO-WAERS
*             CHANGING W_/ZAK/BEVALLO-FIELD_NR
*                      W_/ZAK/BEVALLO-FIELD_NRK.
*         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KC0649CA' '11' '12'.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*--BG 2007/01/16
       WHEN C_ABEVAZ_A0EC50069A.
*++BG 2007/01/16
*         CLEAR W_/ZAK/BEVALLO-FIELD_N.
*         LM_GET_SPEC_SUM1 'M0KC0649CA' '13' '14'.
*         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
*                      W_/ZAK/BEVALLB-ROUND
*                      W_/ZAK/BEVALLO-WAERS
*             CHANGING W_/ZAK/BEVALLO-FIELD_NR
*                      W_/ZAK/BEVALLO-FIELD_NRK.
*         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KC0649CA' '13' '14'.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*--BG 2007/01/16
       WHEN C_ABEVAZ_A0EC0156CA.
*++BG 2007/01/16
*         CLEAR W_/ZAK/BEVALLO-FIELD_N.
*         LM_GET_SPEC_SUM1 'M0KC0650CA' '01' '07'.
*         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
*                      W_/ZAK/BEVALLB-ROUND
*                      W_/ZAK/BEVALLO-WAERS
*             CHANGING W_/ZAK/BEVALLO-FIELD_NR
*                      W_/ZAK/BEVALLO-FIELD_NRK.
*         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KC0650CA' '01' '07'.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*--BG 2007/01/16
       WHEN C_ABEVAZ_A0EC50070A.
*++BG 2007/01/16
*         CLEAR W_/ZAK/BEVALLO-FIELD_N.
*         LM_GET_SPEC_SUM1 'M0KC0650CA' '11' '12'.
*         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
*                      W_/ZAK/BEVALLB-ROUND
*                      W_/ZAK/BEVALLO-WAERS
*             CHANGING W_/ZAK/BEVALLO-FIELD_NR
*                      W_/ZAK/BEVALLO-FIELD_NRK.
*         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KC0650CA' '11' '12'.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*--BG 2007/01/16
     ENDCASE.
   ENDLOOP.

 ENDFORM.                    " calc_abev_szja_0708

*&---------------------------------------------------------------------*
*&      Form  calc_abev_afa_0865
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_AFA_0865 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                T_BEVALLB STRUCTURE /ZAK/BEVALLB
                         USING  $DATE.

   DATA: L_SUM      LIKE /ZAK/BEVALLO-FIELD_N,
         L_SUM_203  LIKE /ZAK/BEVALLO-FIELD_N,
*++ BG 2009.06.17
         L_SUM_SAVE LIKE /ZAK/BEVALLO-FIELD_N,
*-- BG 2009.06.17
         L_KAMAT    LIKE /ZAK/BEVALLO-FIELD_N,
         L_ABEV_SUM LIKE /ZAK/BEVALLO-FIELD_N.
   DATA: L_KAM_KEZD  TYPE DATUM,
         L_KAM_VEG   TYPE DATUM,
         L_ROUND(20) TYPE C,
         L_TABIX     LIKE SY-TABIX,
         L_UPD.
************************************************************************
* Special abev fields

******************************************************** CSAK ÁFA normál
* the type of period determines the value! monthly, yearly, etc
* havi 6503 = 'X'
* negyed 6504 = 'X'
* year 6505 = 'X'
* VAT self-audit ONLY
*  6511 = 'X'

* MUST RUN AFTER abev CALCULATION
* (normal and self-revision)
* considering the period before the current return
* , at the last closed index
* eg (monthly): 005 revision for 06 months --> I am looking for the previous 05 months
* for the previous closed period

* eg: four-year-olds must watch 03-->12
* current 347 = former 357

* the entry for the index period preceding the current return if
* there is a self-auditor
* the current 360 = the previous 347
* the current 361 = the former 349
* the current 362 = the previous 351
* the current 363 = the previous 353
* the current 364 = the former 355
* the current 365 = the former 357

* corrr 2006.03.29
* EZ MINDRE IGAZ ha 349 < 0
* 351 = 0
* ha abs(353) > abs(349) akkor 355 = 0.
* ha abs(353) < abs(349) akkor 355 = abs(349) - abs(353).
* 357 = abs(349) - 355

   DATA: W_SZ TYPE /ZAK/BEVALLB.



   SORT T_BEVALLB BY ABEVAZ  .
* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE  ABEVAZ EQ     C_ABEVAZ_107  OR
            ABEVAZ EQ     C_ABEVAZ_351  OR
            ABEVAZ EQ     C_ABEVAZ_349  OR
            ABEVAZ EQ     C_ABEVAZ_355  OR
            ABEVAZ EQ     C_ABEVAZ_353  OR
            ABEVAZ EQ     C_ABEVAZ_6503 OR
            ABEVAZ EQ     C_ABEVAZ_6504 OR
            ABEVAZ EQ     C_ABEVAZ_6505 OR
            ABEVAZ EQ     C_ABEVAZ_6506 OR
            ABEVAZ EQ     C_ABEVAZ_6511 OR
            ABEVAZ EQ     C_ABEVAZ_357  OR
            ABEVAZ EQ     C_ABEVAZ_6509 OR
            ABEVAZ EQ     C_ABEVAZ_6507 OR
            ABEVAZ EQ     C_ABEVAZ_5286 OR
            ABEVAZ EQ     C_ABEVAZ_5287 OR
            ABEVAZ EQ     C_ABEVAZ_347  OR
            ABEVAZ EQ     C_ABEVAZ_360  OR
            ABEVAZ EQ     C_ABEVAZ_361  OR
            ABEVAZ EQ     C_ABEVAZ_362  OR
            ABEVAZ EQ     C_ABEVAZ_363  OR
            ABEVAZ EQ     C_ABEVAZ_364  OR
            ABEVAZ EQ     C_ABEVAZ_365  OR
*++ BG 2007.01.31
            ABEVAZ EQ     C_ABEVAZ_5303 OR
            ABEVAZ EQ     C_ABEVAZ_5271 OR
            ABEVAZ EQ     C_ABEVAZ_5274
*-- BG 2007.01.31
            .

     CLEAR : L_SUM,W_/ZAK/BEVALLO.
* this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
     V_TABIX = SY-TABIX .
     CLEAR: W_/ZAK/BEVALLO-FIELD_N,
            W_/ZAK/BEVALLO-FIELD_NR,
            W_/ZAK/BEVALLO-FIELD_NRK.


     CASE W_/ZAK/BEVALLB-ABEVAZ.

       WHEN C_ABEVAZ_351.
* 351  = 349
* ha 349 < 0 akkor 351 = 0
         CLEAR L_SUM.
         READ TABLE T_BEVALLO INTO W_SUM
         WITH KEY ABEVAZ = C_ABEVAZ_349.
         IF SY-SUBRC = 0.
           IF W_SUM-FIELD_N > 0.
             L_SUM = W_SUM-FIELD_NRK.
             W_/ZAK/BEVALLO-FIELD_N = L_SUM.
           ELSE.
             CLEAR W_/ZAK/BEVALLO-FIELD_N.
           ENDIF.
           L_UPD = 'X'.
         ENDIF.

*++BG 2006/06/23
*  At the request of the tax department, the 81.D recoverable tax amount
*  I would like to enter it manually, so the calculation has been canceled.
*  23.06.2006 Gáborné Bedő, Attila Pleskó, Gábor Balázs
*       WHEN C_ABEVAZ_355.
** 355  = 349 - 353
*         LOOP AT T_BEVALLO INTO W_SUM
*                 WHERE ABEVAZ EQ C_ABEVAZ_349 OR
*                       ABEVAZ EQ C_ABEVAZ_353.
*
*           IF W_SUM-ABEVAZ EQ C_ABEVAZ_349.
*             IF W_SUM-FIELD_NRK > 0.
*               CLEAR L_SUM.
*               L_UPD = 'X'.
*               EXIT.
*             ENDIF.
*             L_SUM = L_SUM + ABS( W_SUM-FIELD_NRK ).
*           ELSE.
*             L_SUM = L_SUM - ABS( W_SUM-FIELD_NRK ).
*           ENDIF.
*           L_UPD = 'X'.
*         ENDLOOP.
*         IF L_SUM < 0.
*           CLEAR L_SUM.
*         ENDIF.
*         W_/ZAK/BEVALLO-FIELD_N = L_SUM.
*--BG 2006/06/23

       WHEN C_ABEVAZ_357.
* 357 = abs(349) - 355
         CLEAR L_SUM.
         LOOP AT T_BEVALLO INTO W_SUM
                 WHERE ABEVAZ EQ C_ABEVAZ_349 OR
                       ABEVAZ EQ C_ABEVAZ_355.

           IF W_SUM-ABEVAZ EQ C_ABEVAZ_349.
             IF W_SUM-FIELD_NRK > 0.
               CLEAR L_SUM.
               L_UPD = 'X'.
               EXIT.
             ENDIF.
             L_SUM = L_SUM + ABS( W_SUM-FIELD_NRK ).
           ELSE.
             L_SUM = L_SUM -  W_SUM-FIELD_NRK .
           ENDIF.
           L_UPD = 'X'.
         ENDLOOP.
         W_/ZAK/BEVALLO-FIELD_N = ABS( L_SUM ).

       WHEN C_ABEVAZ_6503.
* 6503
* H - Havi
         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           IF W_/ZAK/BEVALLO-ZINDEX EQ '000'.
             W_/ZAK/BEVALLO-FIELD_C = 'X'.
             MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
           ENDIF.
         ENDIF.

       WHEN C_ABEVAZ_6504.
* 6504
* N - Quarterly
         IF W_/ZAK/BEVALL-BIDOSZ = 'N'.
           IF W_/ZAK/BEVALLO-ZINDEX EQ '000'.
             W_/ZAK/BEVALLO-FIELD_C = 'X'.
             MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
           ENDIF.
         ENDIF.

       WHEN C_ABEVAZ_6505.
* 6505
* E - Year old
         IF W_/ZAK/BEVALL-BIDOSZ = 'E'.
           IF W_/ZAK/BEVALLO-ZINDEX EQ '000'.
             W_/ZAK/BEVALLO-FIELD_C = 'X'.
             MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
           ENDIF.
         ENDIF.

       WHEN C_ABEVAZ_6506.
* only for quarter 6506 = '1' v '2' v '3' v '4'
         IF W_/ZAK/BEVALL-BIDOSZ = 'N'.
           IF W_/ZAK/BEVALLO-MONAT EQ '03'.
             W_/ZAK/BEVALLO-FIELD_C = '1'.
           ELSEIF W_/ZAK/BEVALLO-MONAT EQ '06'.
             W_/ZAK/BEVALLO-FIELD_C = '2'.
           ELSEIF W_/ZAK/BEVALLO-MONAT EQ '09'.
             W_/ZAK/BEVALLO-FIELD_C = '3'.
           ELSEIF W_/ZAK/BEVALLO-MONAT EQ '12'.
             W_/ZAK/BEVALLO-FIELD_C = '4'.
           ENDIF.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.

       WHEN C_ABEVAZ_6511.
* 6511
* only need to be filled in for self-revision!
         IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
           W_/ZAK/BEVALLO-FIELD_C = 'X'.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.

       WHEN C_ABEVAZ_6509.
* 6509 = gjahr
* only need to be filled in for self-revision!
         IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
           W_/ZAK/BEVALLO-FIELD_C = W_/ZAK/BEVALLO-GJAHR.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.

       WHEN C_ABEVAZ_6507.
* only for monthly 6507 = monat
         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           W_/ZAK/BEVALLO-FIELD_C = W_/ZAK/BEVALLO-MONAT.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.

       WHEN C_ABEVAZ_5286.
* always 5286 = first day from period
*         L_KAM_KEZD = $DATE.
*         L_KAM_KEZD+6(2) = '01'.
*         W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
*         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*

         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* A year old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'E'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+4(4) = '0101'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* He is four years old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.

           L_KAM_KEZD = $DATE.
           IF L_KAM_KEZD+4(2) >= '01' AND
              L_KAM_KEZD+4(2) <= '03'.

             L_KAM_KEZD+4(4) = '0101'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '04' AND
              L_KAM_KEZD+4(2) <= '06'.

             L_KAM_KEZD+4(4) = '0401'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '07' AND
              L_KAM_KEZD+4(2) <= '09'.

             L_KAM_KEZD+4(4) = '0701'.
           ENDIF.


           IF L_KAM_KEZD+4(2) >= '10' AND
              L_KAM_KEZD+4(2) <= '12'.

             L_KAM_KEZD+4(4) = '1001'.
           ENDIF.

           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ELSE.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ENDIF.

         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.




       WHEN C_ABEVAZ_5287.
* always 5287 = last day until period
         W_/ZAK/BEVALLO-FIELD_C = $DATE.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

       WHEN C_ABEVAZ_360.
* the current 360 = 347 with the previous index
         PERFORM SET_BEVALLO USING C_ABEVAZ_347
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
       WHEN C_ABEVAZ_361.
* the current 361 = 349 with the previous index
         PERFORM SET_BEVALLO USING C_ABEVAZ_349
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.

       WHEN C_ABEVAZ_362.
* the current 362 = 351 with the previous index
         PERFORM SET_BEVALLO USING C_ABEVAZ_351
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.

       WHEN C_ABEVAZ_363.
* the current 363 = 353 with the previous index
         PERFORM SET_BEVALLO USING C_ABEVAZ_353
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.

       WHEN C_ABEVAZ_364.
* the current 364 = 355 with the previous index
         PERFORM SET_BEVALLO USING C_ABEVAZ_355
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.

       WHEN C_ABEVAZ_365.
* the current 365 = 357 with the previous index
         PERFORM SET_BEVALLO USING C_ABEVAZ_357
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.

*++ BG 2007.01.31
       WHEN C_ABEVAZ_5303.
* 5303 = sy-datum
         W_/ZAK/BEVALLO-FIELD_C = SY-DATUM.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

* 5271 and 5274 'X' if 355 is not blank
       WHEN C_ABEVAZ_5271 OR C_ABEVAZ_5274.
         READ TABLE T_BEVALLO INTO W_SUM
              WITH KEY ABEVAZ = C_ABEVAZ_355.
         IF SY-SUBRC EQ 0 AND W_SUM-FIELD_N NE 0.
           W_/ZAK/BEVALLO-FIELD_C = C_X.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ELSEIF SY-SUBRC EQ 0 AND W_SUM-FIELD_N EQ 0.
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
*-- BG 2007.01.31


     ENDCASE.

* fill in all numerical values ​​for calculated fields!
* the procedure for forming an amount is as follows:
* pl: ABEV3 field_n = ABEV1 field_nrk + ABEV2 field_nrk
* then apply the default rounding rule!
     IF NOT W_/ZAK/BEVALLB-COLLECT IS INITIAL AND
        L_UPD EQ 'X'.
       CLEAR L_ROUND.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                   W_/ZAK/BEVALLB-ROUND
                   W_/ZAK/BEVALLO-WAERS
          CHANGING W_/ZAK/BEVALLO-FIELD_NR
                   W_/ZAK/BEVALLO-FIELD_NRK.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       CLEAR: L_SUM,L_UPD.
     ENDIF.
     CLEAR: L_UPD,L_SUM,L_ROUND.
   ENDLOOP.
ENHANCEMENT-POINT /ZAK/ZAK_0865_RG_01 SPOTS /ZAK/FUNCTIONS_ES .

***********************************************************-
* calculation of self-check allowance 203 = 351 - 362 + 364 - 355 if > 0
* 203 calculation
* if 351 - 362 > 0 then this value
* if not then the next condition
* (357 - 365) < 0 then the calculated value is minus
* (357 - 365) > 0 akkor 0
* 355 - 364 < 0 then the calculated value is minus
* 355 - 364 > 0 akkor 0

   IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
* if 351 - 362 > 0 then this value, otherwise 0
     LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
       WHERE  ABEVAZ EQ     C_ABEVAZ_203.
       CLEAR: L_SUM,L_SUM_203.
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_362  OR
                ABEVAZ EQ     C_ABEVAZ_351.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_362.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM < 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_203 = L_SUM_203 + L_SUM.
       CLEAR L_SUM.
* (357 - 365) < 0 then the calculated value is minus
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_357  OR
                ABEVAZ EQ     C_ABEVAZ_365.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_365.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM > 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_203 = L_SUM_203 - L_SUM.
       CLEAR L_SUM.
* 355 - 364 < 0 then the calculated value is minus
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_355  OR
                ABEVAZ EQ     C_ABEVAZ_364.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_364.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM > 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_203 = L_SUM_203 - L_SUM.
       CLEAR L_SUM.
*       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
*         WHERE  ABEVAZ EQ     C_ABEVAZ_362  OR
*                ABEVAZ EQ     C_ABEVAZ_351  OR
*                ABEVAZ EQ     C_ABEVAZ_364  OR
*                ABEVAZ EQ     C_ABEVAZ_355.
*         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_362 OR
*            W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_355.
*           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
*         ELSE.
*           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
*         ENDIF.
*       ENDLOOP.
*++BG 2008.05.23
*     If 347-360 < 0, it must be reduced by this amount
*     az L_SUM_203-at.
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                            WITH KEY ABEVAZ = C_ABEVAZ_347.
       IF SY-SUBRC EQ 0.
         L_SUM = W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                            WITH KEY ABEVAZ = C_ABEVAZ_360.
       IF SY-SUBRC EQ 0.
         L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       IF L_SUM < 0.
*++ BG 2009.06.17
         L_SUM_SAVE = ABS( L_SUM ).
*-- BG 2009.06.17
         ADD L_SUM TO L_SUM_203.
       ENDIF.
*--BG 2008.05.23

       IF L_SUM_203 < 0.
*++ BG 2009.06.17
         ADD L_SUM_203 TO L_SUM_SAVE.
*-- BG 2009.06.17
         CLEAR L_SUM_203.
       ENDIF.
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
       WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
       V_TABIX = SY-TABIX .
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING L_SUM_203
                     W_/ZAK/BEVALLB-ROUND
                     W_/ZAK/BEVALLO-WAERS
            CHANGING W_/ZAK/BEVALLO-FIELD_NR
                     W_/ZAK/BEVALLO-FIELD_NRK.
         W_/ZAK/BEVALLO-FIELD_N = L_SUM_203.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       ENDIF.
     ENDLOOP.
ENHANCEMENT-POINT /ZAK/ZAK_0865_RG_02 SPOTS /ZAK/FUNCTIONS_ES .

* determination of self-control allowance
* Calculation of ABEV 205 based on 203, if the index is 2 or greater, then x1.5

     IF W_/ZAK/BEVALLO-ZINDEX NE '000'.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_205.
       IF SY-SUBRC EQ 0.
         CLEAR L_SUM.
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                              WITH KEY ABEVAZ = C_ABEVAZ_203.
         IF SY-SUBRC = 0.
           L_SUM = W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
* period definition
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                              WITH KEY ABEVAZ = C_ABEVAZ_5299.
         IF SY-SUBRC EQ 0 AND
         NOT W_/ZAK/BEVALLO-FIELD_C IS INITIAL .
* determining the deadline for calculating the allowance! the 104
* I don't need a tax for the /ZAK/ADONEM table key !!

           SELECT SINGLE FIZHAT INTO W_/ZAK/ADONEM-FIZHAT FROM /ZAK/ADONEM
                                 WHERE BUKRS  EQ W_/ZAK/BEVALLO-BUKRS AND
                                                  ADONEM EQ C_ADONEM_104
                                                  .
           IF SY-SUBRC EQ 0.
* start date of allowance calculation
             CLEAR L_KAM_KEZD.
             L_KAM_KEZD = $DATE + 1 + W_/ZAK/ADONEM-FIZHAT.
* end date of allowance calculation in the character field of row 5299 above
             CLEAR L_KAM_VEG.
             CALL FUNCTION 'CONVERSION_EXIT_IDATE_INPUT'
               EXPORTING
                 INPUT  = W_/ZAK/BEVALLO-FIELD_C
               IMPORTING
                 OUTPUT = L_KAM_VEG.
*++2012.01.06 BG
*             L_KAM_VEG = L_KAM_VEG - 15 .
*--2012.01.06 BG
* allowance calculation
             PERFORM CALC_POTLEK USING    W_/ZAK/BEVALLO-BUKRS
*++BG 2006/06/08
                                          W_/ZAK/BEVALLO-ZINDEX
*--BG 2006/06/08
                                 CHANGING L_KAM_KEZD
                                          L_KAM_VEG
                                          L_SUM
                                          L_KAMAT. " 203 --> 205
*++BG 2006/06/08
*  Berakva a CALC_POTLEK rutinba
** ++ CST 2006.06.04: 1,5 szörös kamat érték.
*             IF W_/ZAK/BEVALLO-ZINDEX >= '002'.
*               L_KAMAT = L_KAMAT * '1.5'.
*             ENDIF.
** -- CST 2006.06.04
*--BG 2006/06/08
             READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                                  WITH KEY ABEVAZ = C_ABEVAZ_205.
             V_TABIX = SY-TABIX.
             IF SY-SUBRC = 0.
               W_/ZAK/BEVALLO-FIELD_N = L_KAMAT.
               PERFORM CALC_FIELD_NRK USING L_KAMAT
                          W_/ZAK/BEVALLB-ROUND
                          W_/ZAK/BEVALLO-WAERS
                 CHANGING W_/ZAK/BEVALLO-FIELD_NR
                          W_/ZAK/BEVALLO-FIELD_NRK.
*++BG 2009.05.18
*              The value of the 0 flag must be handled in the form control
*              miatt:
               IF NOT W_/ZAK/BEVALLO-FIELD_N IS INITIAL AND
                  W_/ZAK/BEVALLO-FIELD_NRK IS INITIAL.
                 W_/ZAK/BEVALLO-NULL_FLAG = 'X'.
               ENDIF.
*--BG 2009.05.18
               MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
             ENDIF.
           ENDIF.
         ENDIF.
       ENDIF.
*++ BG 2009.06.17
*      If there is a value, 203 must be corrected.
       IF NOT L_SUM_SAVE IS INITIAL.
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
         WITH KEY ABEVAZ = C_ABEVAZ_203.
         V_TABIX = SY-TABIX .
         IF SY-SUBRC EQ 0.
           ADD L_SUM_SAVE TO W_/ZAK/BEVALLO-FIELD_N.
           READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                WITH KEY ABEVAZ = C_ABEVAZ_203.
           IF SY-SUBRC EQ 0.
             PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                         W_/ZAK/BEVALLB-ROUND
                         W_/ZAK/BEVALLO-WAERS
                CHANGING W_/ZAK/BEVALLO-FIELD_NR
                         W_/ZAK/BEVALLO-FIELD_NRK.
             MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
           ENDIF.
         ENDIF.
       ENDIF.
*-- BG 2009.06.17
     ENDIF.
   ENDIF.

*++ BG 2009.06.17
*  0 flag field management
* If field1 is not 0 or field2 is not 0 or field3 is not 0 or field4 is not 0
* or field 5 not 0 then 0 flag setting
   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_205
                              "0-flag beállítás
                                     C_ABEVAZ_203           "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6
*-- BG 2009.06.17

 ENDFORM.                    " calc_abev_afa_0865
*&---------------------------------------------------------------------*
*&      Form  calc_abev_tars
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_TARS.

 ENDFORM.                    " calc_abev_tars
*&---------------------------------------------------------------------*
*&      Form  calc_abev_ucs
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_UCS.

 ENDFORM.                    " calc_abev_ucs
*&---------------------------------------------------------------------*
*&      Form  calc_abev_atv
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ATV.

 ENDFORM.                    " calc_abev_atv
*&---------------------------------------------------------------------*
*&      Form  get_eva_stcd1
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_W_/ZAK/ANALITIKA_STCD1  text
*      <--P_L_TRUE  text
*----------------------------------------------------------------------*
 FORM GET_EVA_STCD1 USING    $STCD1
                    CHANGING $TRUE.
   TYPES: BEGIN OF L_ITAB_TYPE,
            TEXT(20),
          END   OF L_ITAB_TYPE.

   DATA  L_ITAB TYPE STANDARD TABLE OF L_ITAB_TYPE INITIAL SIZE 0.
   DATA  LW_ITAB TYPE L_ITAB_TYPE.

   CLEAR $TRUE.
*  We'll try to break it down at the hyphens
   SPLIT $STCD1 AT '-' INTO TABLE L_ITAB.
*++1665 #05.
**  Ebben az esetben a második résznek kell tartalmaznia az EVA jellemzőt
*   IF SY-SUBRC EQ 0.
*     READ TABLE L_ITAB INTO LW_ITAB INDEX 2.
*     IF LW_ITAB(1) EQ '3'.
*       MOVE 'X' TO $TRUE.
*     ENDIF.
**  Nem tagolt az adószám ebben az esetben a 9. karakter-t kell vizsgálni
*   ELSE.
*     IF $STCD1+8(1) EQ '3'.
*       MOVE 'X' TO $TRUE.
*     ENDIF.
*   ENDIF.
   READ TABLE L_ITAB INTO LW_ITAB INDEX 2.
   IF SY-SUBRC EQ 0 AND LW_ITAB(1) EQ '3'.
     MOVE 'X' TO $TRUE.
   ELSEIF $STCD1+8(1) EQ '3'.
     MOVE 'X' TO $TRUE.
   ENDIF.
*--1665 #05.

 ENDFORM.                    " get_eva_stcd1
*&---------------------------------------------------------------------*
*&      Form  get_abev
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_W_/ZAK/ANALITIKA_ABEV  text
*      <--P_W_/ZAK/ANALITIKA_ITEM  text
*----------------------------------------------------------------------*
 FORM GET_ABEV TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                      T_BEVALLB STRUCTURE /ZAK/BEVALLB.

   DATA: L_BEVALLO TYPE /ZAK/BEVALLO.
   DATA: L_BEVALLB TYPE /ZAK/BEVALLB.
   DATA: L_INDEX   TYPE SY-TABIX.


*   CLEAR L_BEVALLO.
*
*   SORT T_BEVALLB BY ABEVAZ  .
*
*   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
*       WHERE NOT GET_ABEVAZ IS INITIAL.
*
** Forrás ABEV jellemzői
*     READ TABLE T_BEVALLB INTO L_BEVALLB
*          WITH KEY ABEVAZ = W_/ZAK/BEVALLB-GET_ABEVAZ.
*     IF SY-SUBRC =  0.
*
** Forrás ABEV nem adószám köteles
*       IF L_BEVALLB-ASZKOT = SPACE.
*
** Forrás adat beolvasása
*         READ TABLE T_BEVALLO INTO L_BEVALLO
*           WITH KEY ABEVAZ = W_/ZAK/BEVALLB-GET_ABEVAZ.
*
*         IF SY-SUBRC = 0.
** Cél adatok módosítása
*           LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
*              WHERE ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
*
*             W_/ZAK/BEVALLO-FIELD_C   = L_BEVALLO-FIELD_C.
*             W_/ZAK/BEVALLO-FIELD_N   = L_BEVALLO-FIELD_N.
*             W_/ZAK/BEVALLO-FIELD_NR  = L_BEVALLO-FIELD_NR.
*             W_/ZAK/BEVALLO-FIELD_NRK = L_BEVALLO-FIELD_NRK.
*             MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO.
*
*           ENDLOOP.
*         ENDIF.
*
** Forrás ABEV adószám köteles
*       ELSE.
*
** Forrás adatok beolvasása
*         LOOP AT T_BEVALLO INTO L_BEVALLO
*           WHERE ABEVAZ = W_/ZAK/BEVALLB-GET_ABEVAZ.
*
** Cél adatok módosítása
*           LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
*              WHERE ABEVAZ  = W_/ZAK/BEVALLB-ABEVAZ
*                AND ADOAZON = L_BEVALLO-ADOAZON.
*
*             W_/ZAK/BEVALLO-FIELD_C   = L_BEVALLO-FIELD_C.
*             W_/ZAK/BEVALLO-FIELD_N   = L_BEVALLO-FIELD_N.
*             W_/ZAK/BEVALLO-FIELD_NR  = L_BEVALLO-FIELD_NR.
*             W_/ZAK/BEVALLO-FIELD_NRK = L_BEVALLO-FIELD_NRK.
*             MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO.
*
*           ENDLOOP.
*         ENDLOOP.
*       ENDIF.
*     ENDIF.
*
*   ENDLOOP.


*++ Új algoritmus optimalizálás miatt BG 2006/05/23
   CLEAR L_INDEX.
   SORT T_BEVALLO.
   LOOP AT T_BEVALLO INTO  W_/ZAK/BEVALLO
                     WHERE NOT GET_ABEVAZ IS INITIAL.

*    Dialog run for insurance
     PERFORM PROCESS_IND_ITEM USING '100000'
                                    L_INDEX
                                    TEXT-P01.

* Source ABEV characteristics
     READ TABLE T_BEVALLB INTO L_BEVALLB
          WITH KEY ABEVAZ = W_/ZAK/BEVALLO-GET_ABEVAZ.

     IF L_BEVALLB-ASZKOT = SPACE.
*      Read original line
       READ TABLE T_BEVALLO INTO L_BEVALLO
                          WITH KEY  ABEVAZ   = W_/ZAK/BEVALLO-GET_ABEVAZ
*                                   ADOAZON  = W_/ZAK/BEVALLO-ADOAZON
                                    BINARY SEARCH.
     ELSE.
*    Read original line
*++ BG 2007.06.25
*      It must be interpreted by page number, because otherwise it is bigger than one
*      also transfers the value of sheet 001 to sheet:
*-- BG 2007.06.25
       READ TABLE T_BEVALLO INTO L_BEVALLO
                          WITH KEY ABEVAZ  = W_/ZAK/BEVALLO-GET_ABEVAZ
                                   ADOAZON = W_/ZAK/BEVALLO-ADOAZON
*++ BG 2007.06.25
                                   LAPSZ   = W_/ZAK/BEVALLO-LAPSZ
*-- BG 2007.06.25
                                   BINARY SEARCH.
     ENDIF.
     IF SY-SUBRC EQ 0.
*++BG 2008.02.06
       READ TABLE T_BEVALLB INTO L_BEVALLB
            WITH KEY ABEVAZ = W_/ZAK/BEVALLO-ABEVAZ.
*--BG 2008.02.06
       W_/ZAK/BEVALLO-FIELD_C   = L_BEVALLO-FIELD_C.
       W_/ZAK/BEVALLO-FIELD_N   = L_BEVALLO-FIELD_N.
*++BG 2008.02.06
*       W_/ZAK/BEVALLO-FIELD_NR  = L_BEVALLO-FIELD_NR.
*       W_/ZAK/BEVALLO-FIELD_NRK = L_BEVALLO-FIELD_NRK.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                    L_BEVALLB-ROUND
                    L_BEVALLO-WAERS
           CHANGING W_/ZAK/BEVALLO-FIELD_NR
                    W_/ZAK/BEVALLO-FIELD_NRK.
       W_/ZAK/BEVALLO-WAERS = L_BEVALLO-WAERS.
*--BG 2008.02.06
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO.
     ENDIF.
   ENDLOOP.
*-- Új algoritmus optimalizálás miatt BG 2006/05/23



 ENDFORM.                    " get_abev

*&---------------------------------------------------------------------*
*&      Form  get_abev
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_W_/ZAK/ANALITIKA_ABEV  text
*      <--P_W_/ZAK/ANALITIKA_ITEM  text
*----------------------------------------------------------------------*
 FORM GET_ONREV_ABEV TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLALV
                            T_BEVALLB STRUCTURE /ZAK/BEVALLB.

   DATA: L_BEVALLO TYPE /ZAK/BEVALLALV.
   DATA: L_BEVALLB TYPE /ZAK/BEVALLB.
   DATA: L_INDEX   TYPE SY-TABIX.
   DATA: LW_/ZAK/BEVALLALV LIKE /ZAK/BEVALLALV.

   CLEAR L_INDEX.
   SORT T_BEVALLO.
   LOOP AT T_BEVALLO INTO  LW_/ZAK/BEVALLALV
                     WHERE NOT GET_ABEVAZ IS INITIAL.

*    Dialog run for insurance
     PERFORM PROCESS_IND_ITEM USING '100000'
                                    L_INDEX
                                    TEXT-P01.

*    Source ABEV characteristics
     READ TABLE T_BEVALLB INTO L_BEVALLB
          WITH KEY ABEVAZ = LW_/ZAK/BEVALLALV-GET_ABEVAZ.

     IF L_BEVALLB-ASZKOT = SPACE.
*      Read original line
       READ TABLE T_BEVALLO INTO L_BEVALLO
                          WITH KEY  ABEVAZ   =
                          LW_/ZAK/BEVALLALV-GET_ABEVAZ
*ADOAZON  = LW_/ZAK/BEVALLALV-ADOAZON
                                    BINARY SEARCH.
     ELSE.
*    Read original line
       READ TABLE T_BEVALLO INTO L_BEVALLO
                          WITH KEY ABEVAZ  =
                          LW_/ZAK/BEVALLALV-GET_ABEVAZ
                                   ADOAZON = LW_/ZAK/BEVALLALV-ADOAZON
                                   LAPSZ   = LW_/ZAK/BEVALLALV-LAPSZ
                                   BINARY SEARCH.
     ENDIF.
     IF SY-SUBRC EQ 0 AND L_BEVALLO-OFLAG EQ 'X'.
       READ TABLE T_BEVALLB INTO L_BEVALLB
            WITH KEY ABEVAZ = LW_/ZAK/BEVALLALV-ABEVAZ.

       LW_/ZAK/BEVALLALV-FIELD_ON   = L_BEVALLO-FIELD_ON.
       PERFORM CALC_FIELD_NRK USING LW_/ZAK/BEVALLALV-FIELD_ON
                    L_BEVALLB-ROUND
                    L_BEVALLO-WAERS
           CHANGING LW_/ZAK/BEVALLALV-FIELD_ONR
                    LW_/ZAK/BEVALLALV-FIELD_ONRK.
       LW_/ZAK/BEVALLALV-WAERS = L_BEVALLO-WAERS.
       LW_/ZAK/BEVALLALV-OFLAG = 'X'.
       MODIFY T_BEVALLO FROM LW_/ZAK/BEVALLALV.
     ENDIF.
   ENDLOOP.
 ENDFORM.                    " get_abev


*&---------------------------------------------------------------------*
*&      Form  read_/zak/szja_cust
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_I_/ZAK/SZJA_CUST  text
*      -->P_I_BUKRS  text
*      -->P_I_BTYPE  text
*      -->P_I_BSZNUM  text
*      -->P_I_ABEVAZ  text
*----------------------------------------------------------------------*
 FORM READ_/ZAK/SZJA_CUST TABLES $I_/ZAK/SZJA_CUST STRUCTURE /ZAK/SZJA_CUST
                                $I_/ZAK/ZAK_CUST_KEY  STRUCTURE /ZAK/SZJA_CUST
                                                           USING  $BUKRS
                                                                  $BTYPE
                                                                 $BSZNUM
                                                                  $SUBRC
                                                                  .
*++1908 #10.
   FIELD-SYMBOLS <SZJA_CUST> TYPE /ZAK/SZJA_CUST.

   DEFINE LM_DATE.
     &1(2)   = '20'.
     &1+2(2) = &2(2).
     &1+4(2) = &3.
     &1+6(2) = &4.
   END-OF-DEFINITION.
*--1908 #10.

   SELECT * INTO TABLE $I_/ZAK/SZJA_CUST
            FROM /ZAK/SZJA_CUST
            FOR ALL ENTRIES IN $I_/ZAK/ZAK_CUST_KEY
            WHERE BUKRS  = $I_/ZAK/ZAK_CUST_KEY-BUKRS
              AND BTYPE  = $I_/ZAK/ZAK_CUST_KEY-BTYPE
              AND BSZNUM = $I_/ZAK/ZAK_CUST_KEY-BSZNUM
              AND ABEVAZ = $I_/ZAK/ZAK_CUST_KEY-ABEVAZ.
   $SUBRC = SY-SUBRC.
*++1908 #10.
   LOOP AT $I_/ZAK/SZJA_CUST ASSIGNING <SZJA_CUST> WHERE DATAB IS INITIAL
                                                     OR DATBI IS INITIAL.
*    Filling in empty date fields
     IF <SZJA_CUST>-DATAB IS INITIAL.
*++1908 #11.
       SELECT SINGLE DATAB INTO <SZJA_CUST>-DATAB
                           FROM /ZAK/BEVALL
                          WHERE BUKRS EQ <SZJA_CUST>-BUKRS
                            AND BTYPE EQ <SZJA_CUST>-BTYPE.
*--1908 #11.
     ENDIF.
     IF <SZJA_CUST>-DATBI IS INITIAL.
*++1908 #11.
       SELECT SINGLE DATBI INTO <SZJA_CUST>-DATBI
                           FROM /ZAK/BEVALL
                          WHERE BUKRS EQ <SZJA_CUST>-BUKRS
                            AND BTYPE EQ <SZJA_CUST>-BTYPE.
*--1908 #11.
     ENDIF.
   ENDLOOP.
*--1908 #10.

 ENDFORM.                    " read_/zak/szja_cust
*&---------------------------------------------------------------------*
*&      Form  read_/zak/szja_abev
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_I_/ZAK/SZJA_ABEV  text
*      -->P_I_BUKRS  text
*      -->P_I_BTYPE  text
*----------------------------------------------------------------------*
 FORM READ_/ZAK/SZJA_ABEV TABLES $I_/ZAK/SZJA_ABEV STRUCTURE /ZAK/SZJA_ABEV
                                                         USING    $BUKRS
                                                                  $BTYPE
                                                         CHANGING $SUBRC
                                                         .
   SELECT * INTO TABLE $I_/ZAK/SZJA_ABEV
            FROM /ZAK/SZJA_ABEV
            WHERE BUKRS  = $BUKRS
              AND BTYPE  = $BTYPE
*             A WL  nem kell (nem itt kell)
              AND FIELDNAME <> 'WL'.
   $SUBRC = SY-SUBRC.


 ENDFORM.                    " read_/zak/szja_abev
*&---------------------------------------------------------------------*
*&      Form  aufnr_feltolt
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_R_AUFNR  text
*      -->P_W_/ZAK/SZJA_CUST_AUFNR  text
*----------------------------------------------------------------------*
 FORM AUFNR_FELTOLT TABLES   $R_AUFNR STRUCTURE R_AUFNR
                    USING    $AUFNR.
   CLEAR $R_AUFNR. REFRESH $R_AUFNR.
*    It makes the order a condition for the selection
   IF NOT $AUFNR IS INITIAL.
     $R_AUFNR = 'IEQ'.
     $R_AUFNR-LOW = $AUFNR.
     APPEND  $R_AUFNR.
   ENDIF.


 ENDFORM.                    " aufnr_feltolt
*&---------------------------------------------------------------------*
*&      Form  saknr_feltolt
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_R_SAKNR  text
*      -->P_W_/ZAK/SZJA_CUST_SAKNR  text
*----------------------------------------------------------------------*
 FORM SAKNR_FELTOLT TABLES   $R_SAKNR STRUCTURE R_SAKNR
                    USING    $SAKNR.
   CLEAR $R_SAKNR. REFRESH  $R_SAKNR.
*    Makes the ledger a condition for the selection
   IF NOT $SAKNR IS INITIAL.
     $R_SAKNR = 'IEQ'.
     $R_SAKNR-LOW = $SAKNR.
     APPEND  $R_SAKNR.
   ENDIF.


 ENDFORM.                    " saknr_feltolt
*&---------------------------------------------------------------------*
*&      Form  /zak/analitika_tolt
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_O_/ZAK/ANALITIKA  text
*      -->P_W_I_/ZAK/ANALITIKA  text
*      -->P_<FS_MEZO>  text
*      -->P_W_/ZAK/SZJA_ABEV_ABEVAZ  text
*----------------------------------------------------------------------*
 FORM /ZAK/ANALITIKA_TOLT TABLES $O_/ZAK/ANALITIKA STRUCTURE /ZAK/ANALITIKA
                         USING  $I_/ZAK/ANALITIKA STRUCTURE /ZAK/ANALITIKA
                                                               $SZAZALEK
                                                                 $ABEVAZ
                                                                 .
   DATA : L_W_/ZAK/ANALITIKA TYPE  /ZAK/ANALITIKA.

   L_W_/ZAK/ANALITIKA = $I_/ZAK/ANALITIKA.
   L_W_/ZAK/ANALITIKA-FIELD_N = L_W_/ZAK/ANALITIKA-FIELD_N *
                               ( $SZAZALEK / 100 ).

   L_W_/ZAK/ANALITIKA-ABEVAZ  = $ABEVAZ.
   L_W_/ZAK/ANALITIKA-BOOK    = 'M'. "Könyvelésre jelölve
*  When we are done with all this, you can go to the board
   APPEND L_W_/ZAK/ANALITIKA TO $O_/ZAK/ANALITIKA.

 ENDFORM.                    " /zak/analitika_tolt
*&---------------------------------------------------------------------*
*&      Form  CALC_POTLEK
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_L_KAM_KEZD  text
*      -->P_L_KAM_VEG  text
*      <--P_L_SUM  text
*----------------------------------------------------------------------*
 FORM CALC_POTLEK USING    $BUKRS  TYPE BUKRS
                           $ZINDEX TYPE /ZAK/BEVALLO-ZINDEX
                  CHANGING $KEZD   TYPE DATUM
                           $VEG    TYPE DATUM
                           $SUM    LIKE /ZAK/BEVALLO-FIELD_N
                           $KAMAT  LIKE /ZAK/BEVALLO-FIELD_N.
*++2508 #11.
   CALL FUNCTION '/ZAK/CALC_POTLEK'
     EXPORTING
       I_BUKRS     = $BUKRS
       I_ZINDEX    = $ZINDEX
       I_KAM_KEZD  = $KEZD
       I_KAM_VEG   = $VEG
       I_FIELD_NRK = $SUM
     IMPORTING
       E_KAMAT     = $KAMAT.
*
*   TABLES: T056P.
*   DATA: BEGIN OF L_KAMAT OCCURS 0,
*           DATUM TYPE DATUM,
*           ZSOLL LIKE T056P-ZSOLL,
*           KAMAT LIKE /ZAK/BEVALLO-FIELD_N,
*         END OF L_KAMAT.
*   DATA: L_KEZD TYPE DATAB_INV,
*         L_VEG  TYPE DATAB_INV.
*   DATA: LW_T056P TYPE T056P.
*   DATA: L_T056P   TYPE STANDARD TABLE OF T056P INITIAL SIZE 0.
**++1908 #01. 2019.01.29
*   DATA  L_REFER TYPE REFERENZ.
**--1908 #01. 2019.01.29
*
** programban nem működik a konverzió ISB_T056P_READ funkcióselemnél
** ezért kell így megoldani !!!!
*
*   PERFORM CONV_DATUM_T056P USING $KEZD
*                            CHANGING L_KEZD .
*   PERFORM CONV_DATUM_T056P USING $VEG
*                            CHANGING L_VEG .
**++1908 #01. 2019.01.29
**   SELECT * INTO TABLE L_T056P FROM T056P
**            WHERE REFERENZ EQ C_REFER AND
**                  DATAB <= L_KEZD AND
**                  DATAB >= L_VEG.
*   CLEAR L_REFER.
*   SELECT SINGLE REFERENZ INTO L_REFER
*                          FROM /ZAK/START
*                         WHERE BUKRS EQ $BUKRS.
*   IF SY-SUBRC EQ 0 AND NOT L_REFER IS INITIAL.
*     SELECT * INTO TABLE L_T056P FROM T056P
*              WHERE REFERENZ EQ L_REFER AND
*                    DATAB <= L_KEZD AND
*                    DATAB >= L_VEG.
*   ENDIF.
**--1908 #01. 2019.01.29
** létrehozok egy belső táblát, ami csak a dátumokhoz
** tartozó pótlék százalékokat tartalmazza!
*   LOOP AT L_T056P INTO LW_T056P.
*     PERFORM INVDT_OUTPUT USING LW_T056P-DATAB
*                          CHANGING L_KAMAT-DATUM.
*     L_KAMAT-ZSOLL = LW_T056P-ZSOLL.
*     APPEND L_KAMAT.
*   ENDLOOP.
** pótlék számítása!!
*   DO .
*     IF SY-INDEX EQ 1.
*       SELECT        * FROM  T056P UP TO 1 ROWS
**++1908 #01. 2019.01.29
**              WHERE  REFERENZ     = C_REFER
*              WHERE  REFERENZ     = L_REFER
**--1908 #01. 2019.01.29
*              AND    DATAB       >= L_KEZD ORDER BY PRIMARY KEY.
*       ENDSELECT.
*       PERFORM INVDT_OUTPUT USING T056P-DATAB
*                            CHANGING L_KAMAT-DATUM.
*       L_KAMAT-ZSOLL = T056P-ZSOLL.
*     ELSE.
*       READ TABLE L_KAMAT WITH KEY DATUM = $KEZD.
*     ENDIF.
** dátumhoz tartozó kamat meghatározása
** a kezdő tátumot megelőző
*     IF SY-SUBRC <> 0.
*
*     ENDIF.
*     IF $KEZD > $VEG.
*       EXIT.
*     ELSE.
**---------------------------------------------------------------------*
** pótlék számítás                                                     *
** Formel:                                                             *
**                    napszám * kamat                                  *
**         zins   = --------------------                               *
**                        év napszám                                   *
** év napszám  - napszám                                               *
**            360 - im Bankkalender und im franz. Kalender             *
**            365 - im gregorianischen Kalender, sofern kein Schaltjahr*
**            366 - im gregorianischen Kalender, sofern ein Schaltjahr *
** INTEREST_RATE_COMPUTE ????
**---------------------------------------------------------------------*
**++2165 #11.
**       DATA: ZINSEN(16) TYPE P,
**             ZINS       TYPE P.
*       DATA: ZINSEN(16) TYPE P DECIMALS 3,
*             ZINS       TYPE P DECIMALS 3.
**       ZINSEN   = $SUM * L_KAMAT-ZSOLL.
*       ZINSEN   = $SUM * ( L_KAMAT-ZSOLL / 100 ).
**--2165 #11.
*       ZINSEN   = ZINSEN   / 365.
**       ZINS = ZINSEN   / 10000000.
*
*       ZINS = ZINS + ZINSEN.
**       ( $SUM * ( L_KAMAT-ZSOLL / 100 ) ).
*       $KEZD = $KEZD + 1.
*     ENDIF.
*   ENDDO.
**++2165 #11.
**   $KAMAT = ZINS / 100.
*   $KAMAT = ZINS.
**--2165 #11.
*
** ++ CST 2006.06.04: 1,5 szörös kamat érték.
*   IF W_/ZAK/BEVALLO-ZINDEX >= '002'.
*     $KAMAT = $KAMAT * '1.5'.
*   ENDIF.
** -- CST 2006.06.04
*--2508 #11.
 ENDFORM.                    " CALC_POTLEK
*&---------------------------------------------------------------------*
*&      Form  get_abev_kulcs
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_I_/ZAK/ANALITIKA  text
*      -->P_I_ABEVAZON  text
*----------------------------------------------------------------------*
 FORM GET_ABEV_KULCS TABLES   $I_/ZAK/ANALITIKA STRUCTURE /ZAK/ANALITIKA
                              $I_/ZAK/ZAK_CUST_KEY  STRUCTURE /ZAK/SZJA_CUST
                       USING  $BUKRS
                              $BTYPE
                              $BSZNUM.
   LOOP AT  $I_/ZAK/ANALITIKA INTO W_/ZAK/ANALITIKA
                             WHERE BUKRS  = $BUKRS
                               AND BTYPE  = $BTYPE
                               AND BSZNUM = $BSZNUM.
     $I_/ZAK/ZAK_CUST_KEY-BUKRS = W_/ZAK/ANALITIKA-BUKRS.
     $I_/ZAK/ZAK_CUST_KEY-BTYPE = W_/ZAK/ANALITIKA-BTYPE.
     $I_/ZAK/ZAK_CUST_KEY-BSZNUM = W_/ZAK/ANALITIKA-BSZNUM.
     $I_/ZAK/ZAK_CUST_KEY-ABEVAZ = W_/ZAK/ANALITIKA-ABEVAZ.
     APPEND  $I_/ZAK/ZAK_CUST_KEY.

   ENDLOOP.
   SORT $I_/ZAK/ZAK_CUST_KEY .
   DELETE ADJACENT DUPLICATES FROM $I_/ZAK/ZAK_CUST_KEY.

 ENDFORM.                    " get_abev_kulcs
*&---------------------------------------------------------------------*
*&      Form  ABEV_SUM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_W_/ZAK/BEVALLB  text
*      <--P_L_SUM  text
*----------------------------------------------------------------------*
 FORM ABEV_SUM TABLES   T_BEVALLO STRUCTURE /ZAK/BEVALLO
                        T_BEVALLB STRUCTURE /ZAK/BEVALLB
               USING    $BEVALLB LIKE /ZAK/BEVALLB
                        $ELOJEL LIKE /ZAK/BEVALLB-ELOJEL
               CHANGING $SUM LIKE /ZAK/BEVALLO-FIELD_N.
   DATA: WA_BEVALLB TYPE /ZAK/BEVALLB.
*++BG 2006/05/29
   DATA: WWA_BEVALLB TYPE /ZAK/BEVALLB.
*--BG 2006/05/29
   LOOP AT T_BEVALLB INTO WA_BEVALLB
                     WHERE SUM_ABEVAZ EQ $BEVALLB-ABEVAZ.
     IF $ELOJEL EQ 'X' AND WA_BEVALLB-ELOJEL EQ 'X'.
       CLEAR WA_BEVALLB-ELOJEL.
     ELSEIF $ELOJEL EQ 'X' AND WA_BEVALLB-ELOJEL EQ ' '.
       WA_BEVALLB-ELOJEL = 'X'.
     ENDIF.
     IF NOT WA_BEVALLB-COLLECT IS INITIAL.
       PERFORM ABEV_SUM TABLES T_BEVALLO
                               T_BEVALLB
                        USING WA_BEVALLB
                              WA_BEVALLB-ELOJEL
                        CHANGING $SUM.
     ELSE.
* not a calculated field
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
               WHERE ABEVAZ EQ WA_BEVALLB-ABEVAZ.
         CLEAR W_SUM.
         MOVE-CORRESPONDING W_/ZAK/BEVALLO TO W_SUM.
         CLEAR: W_SUM-ABEVAZ_DISP.
         W_SUM-ABEVAZ  = W_/ZAK/BEVALLB-SUM_ABEVAZ.
         IF  WA_BEVALLB-ELOJEL IS INITIAL.
           W_SUM-FIELD_N = W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           W_SUM-FIELD_N = W_/ZAK/BEVALLO-FIELD_NRK * -1.
         ENDIF.
         PERFORM CALC_FIELD_NRK USING W_SUM-FIELD_N
                           WA_BEVALLB-ROUND
                           W_/ZAK/BEVALLO-WAERS
                  CHANGING W_SUM-FIELD_NR
                           W_SUM-FIELD_NRK.
*         W_SUM-FIELD_N = W_/ZAK/BEVALLO-FIELD_NRK.
*++BG 2006/05/29
         READ TABLE T_BEVALLB INTO WWA_BEVALLB WITH KEY
                                   ABEVAZ = W_SUM-ABEVAZ.
         IF SY-SUBRC EQ 0 AND WWA_BEVALLB-ASZKOT IS INITIAL AND
            NOT W_SUM-ADOAZON IS INITIAL.
           CLEAR W_SUM-ADOAZON.
           W_SUM-LAPSZ = '0001'.
         ENDIF.
*--BG 2006/05/29
*++1008 2010.03.03 BG
*        Self-revision flag does not matter here
         CLEAR W_SUM-OFLAG.
*--1008 2010.03.03 BG
         COLLECT W_SUM INTO I_SUM.
       ENDLOOP.
     ENDIF.
   ENDLOOP.
* due to special rules!!
   IF SY-SUBRC NE 0.
     LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
             WHERE ABEVAZ EQ W_/ZAK/BEVALLB-ABEVAZ.
       CLEAR W_SUM.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO W_SUM.
       CLEAR: W_SUM-ABEVAZ_DISP.
       W_SUM-ABEVAZ  = W_/ZAK/BEVALLB-SUM_ABEVAZ.
       IF  W_/ZAK/BEVALLB-ELOJEL IS INITIAL.
         W_SUM-FIELD_N = W_/ZAK/BEVALLO-FIELD_NRK.
       ELSE.
         W_SUM-FIELD_N = W_/ZAK/BEVALLO-FIELD_NRK * -1.
       ENDIF.
       PERFORM CALC_FIELD_NRK USING W_SUM-FIELD_N
                         W_/ZAK/BEVALLB-ROUND
                         W_/ZAK/BEVALLO-WAERS
                CHANGING W_SUM-FIELD_NR
                         W_SUM-FIELD_NRK.
*         W_SUM-FIELD_N = W_/ZAK/BEVALLO-FIELD_NRK.
*++BG 2006/05/29
       READ TABLE T_BEVALLB INTO WWA_BEVALLB WITH KEY
                                 ABEVAZ = W_SUM-ABEVAZ.
       IF SY-SUBRC EQ 0 AND WWA_BEVALLB-ASZKOT IS INITIAL AND
          NOT W_SUM-ADOAZON IS INITIAL.
         CLEAR W_SUM-ADOAZON.
         W_SUM-LAPSZ = '0001'.
       ENDIF.
*--BG 2006/05/29
*++1008 2010.03.03 BG
*      Self-revision flag does not matter here
       CLEAR W_SUM-OFLAG.
*--1008 2010.03.03 BG
       COLLECT W_SUM INTO I_SUM.
     ENDLOOP.
   ENDIF.
 ENDFORM.                    " ABEV_SUM
*&---------------------------------------------------------------------*
*&      Form  READ_BEVALLDEF
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_I_BTYPE  text
*----------------------------------------------------------------------*
*++ BG 2007.05.17
 FORM READ_BEVALLDEF TABLES $R_DISP_BTYPE STRUCTURE R_DISP_BTYPE
                     USING $BUKRS.
*                          $BTYPE
*-- BG 2007.05.17


   REFRESH I_/ZAK/BEVALLDEF.

   SELECT * INTO TABLE I_/ZAK/BEVALLDEF FROM /ZAK/BEVALLDEF
       WHERE BUKRS  EQ $BUKRS AND
*++ BG 2007.05.17
*            BTYPE  EQ $BTYPE.
             BTYPE  IN $R_DISP_BTYPE.
*-- BG 2007.05.17


 ENDFORM.                    " READ_BEVALLDEF

*&---------------------------------------------------------------------*
*&      Form  SET_DEFAULT_ABEV
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_I_/ZAK/BEVALLO  text
*      -->P_I_/ZAK/BEVALLDEF  text
*----------------------------------------------------------------------*
 FORM SET_DEFAULT_ABEV TABLES   T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                T_BEVALLDEF STRUCTURE /ZAK/BEVALLDEF
                       USING    $GJAHR
                                $MONAT
                                $INDEX
                                $BUKRS
*++BG 2007.10.10
                                $LAST_DATE
*--BG 2007.10.10
                                .
   DATA: W_T001 TYPE T001.
* currency definition
   SELECT SINGLE * FROM T001 INTO W_T001
                             WHERE BUKRS EQ $BUKRS.

   LOOP AT T_BEVALLDEF INTO W_/ZAK/BEVALLDEF
                       WHERE FIELD_C NE SPACE.
*++BG 2007.10.10
     IF NOT W_/ZAK/BEVALLDEF-DATBI IS INITIAL.
       CHECK W_/ZAK/BEVALLDEF-DATBI GE $LAST_DATE.
     ENDIF.
*--BG 2007.10.10
*++ BG 2007.05.17
*     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
*          WITH KEY ABEVAZ = W_/ZAK/BEVALLDEF-ABEVAZ.
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
          WITH KEY BTYPE_DISP  = W_/ZAK/BEVALLDEF-BTYPE
                   ABEVAZ_DISP = W_/ZAK/BEVALLDEF-ABEVAZ.
*-- BG 2007.05.17
     IF SY-SUBRC EQ 0 AND
*++ BG 2007.11.09
*       W_/ZAK/BEVALLO-FIELD_C EQ SPACE.
        ( W_/ZAK/BEVALLO-FIELD_C EQ SPACE OR
          NOT W_/ZAK/BEVALLDEF-OVERWRITE IS INITIAL ).
*-- BG 2007.11.09

* there is no value for the abev code, you can enter the default value!
*++ BG 2007.05.17
*      MOVE-CORRESPONDING W_/ZAK/BEVALLDEF TO W_/ZAK/BEVALLO.
       MOVE W_/ZAK/BEVALLDEF-FIELD_C TO W_/ZAK/BEVALLO-FIELD_C.
*      MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO  INDEX SY-TABIX.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO  INDEX SY-TABIX TRANSPORTING
       FIELD_C.
*-- BG 2007.05.17

     ENDIF.
   ENDLOOP.
 ENDFORM.                    " SET_DEFAULT_ABEV
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_sum
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SUM TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                           T_BEVALLB STRUCTURE /ZAK/BEVALLB
                     USING  $DATE.

   DATA: L_SUM      LIKE /ZAK/BEVALLO-FIELD_N,
         L_ABEV_SUM LIKE /ZAK/BEVALLO-FIELD_N.
   DATA: L_KAM_KEZD TYPE DATUM,
         L_KAM_VEG  TYPE DATUM,
         L_ABEVAZ   TYPE /ZAK/ABEVAZ.
   DATA: L_INDEX LIKE SY-TABIX.

   DATA: W_SZ TYPE /ZAK/BEVALLB.

* insert empty calculated abev rows
*******************************************
   DATA: W_UPD_BEVALLO TYPE /ZAK/BEVALLO.

   DATA:
     W_SUM  TYPE /ZAK/BEVALLO,
     W_ID   TYPE /ZAK/BEVALLO,
     W_SZAM TYPE /ZAK/BEVALLO.
   REFRESH I_SUM.
   SORT T_BEVALLB BY SUM_ABEVAZ DESCENDING COLLECT DESCENDING.

   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
                     WHERE SUM_ABEVAZ NE SPACE.
     CLEAR: W_SUM,L_SUM.
* characteristics of the ABEV code to be summarized
     READ TABLE T_BEVALLB INTO W_X
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-SUM_ABEVAZ.
     IF SY-SUBRC EQ 0.
       IF NOT W_/ZAK/BEVALLB-COLLECT IS INITIAL.
* calculated field
         PERFORM ABEV_SUM TABLES T_BEVALLO
                                 T_BEVALLB
                          USING  W_/ZAK/BEVALLB
                                 W_/ZAK/BEVALLB-ELOJEL
                          CHANGING L_SUM.
       ELSE.
         CLEAR L_INDEX.
* not a calculated field
         LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                 WHERE ABEVAZ EQ W_/ZAK/BEVALLB-ABEVAZ.

*          Dialog run for insurance
           PERFORM PROCESS_IND_ITEM USING '100000'
                                          L_INDEX
                                          TEXT-P01.

           CLEAR W_SUM.
           MOVE-CORRESPONDING W_/ZAK/BEVALLO TO W_SUM.
           CLEAR: W_SUM-ABEVAZ_DISP.
           W_SUM-FIELD_N = W_/ZAK/BEVALLO-FIELD_NRK.
           IF  W_/ZAK/BEVALLB-ELOJEL IS INITIAL.
             W_SUM-FIELD_N = W_/ZAK/BEVALLO-FIELD_NRK.
           ELSE.
             W_SUM-FIELD_N = W_/ZAK/BEVALLO-FIELD_NRK * -1.
           ENDIF.
           PERFORM CALC_FIELD_NRK USING W_SUM-FIELD_N
                             W_/ZAK/BEVALLB-ROUND
                             W_/ZAK/BEVALLO-WAERS
                    CHANGING W_SUM-FIELD_NR
                             W_SUM-FIELD_NRK.
           W_SUM-ABEVAZ  = W_/ZAK/BEVALLB-SUM_ABEVAZ.
*++BG 2006/05/29
*          If the field does not require a tax number, we will remove it
           IF W_X-ASZKOT IS INITIAL AND NOT W_SUM-ADOAZON IS INITIAL.
             CLEAR W_SUM-ADOAZON.
*            Page number is always 0001
             W_SUM-LAPSZ = '0001'.
           ENDIF.
*--BG 2006/05/29
           COLLECT W_SUM INTO I_SUM.
         ENDLOOP.
       ENDIF.
     ENDIF.
   ENDLOOP.

   SORT I_SUM BY ABEVAZ ADOAZON.

   CLEAR L_INDEX.

* insert aggregate rows!
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
                     WHERE COLLECT NE SPACE.

*    Dialog run for insurance
     PERFORM PROCESS_IND_ITEM USING '100'
                                    L_INDEX
                                    TEXT-P07.

     CLEAR L_SUM.
     IF NOT W_/ZAK/BEVALLB-ASZKOT IS INITIAL.
       DELETE T_BEVALLO WHERE ABEVAZ EQ W_/ZAK/BEVALLB-ABEVAZ AND
                              ADOAZON EQ SPACE.
       DELETE I_SUM WHERE ABEVAZ EQ W_/ZAK/BEVALLB-ABEVAZ AND
                              ADOAZON EQ SPACE.
     ELSE.
       LOOP AT I_SUM INTO W_SUM WHERE ABEVAZ EQ W_/ZAK/BEVALLB-ABEVAZ.

         L_SUM = L_SUM + W_SUM-FIELD_NRK.
       ENDLOOP.
       IF SY-SUBRC EQ 0.
         DELETE I_SUM WHERE ABEVAZ EQ W_/ZAK/BEVALLB-ABEVAZ.
         CLEAR W_SUM-ADOAZON.
         W_SUM-FIELD_N = L_SUM.
         PERFORM CALC_FIELD_NRK USING W_SUM-FIELD_N
                    W_/ZAK/BEVALLB-ROUND
                    W_SUM-WAERS
           CHANGING W_SUM-FIELD_NR
                    W_SUM-FIELD_NRK.
* begin of insert kdenes 2006.04.20.
* I write back the ABEVAZ_DISP field!
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
         WITH KEY ABEVAZ = W_SUM-ABEVAZ.
         IF SY-SUBRC EQ 0.
           W_SUM-ABEVAZ_DISP = W_/ZAK/BEVALLO-ABEVAZ_DISP.
           W_SUM-BTYPE_DISP  = W_/ZAK/BEVALLO-BTYPE_DISP.
         ENDIF.
* end of insert 2006.04.20
*++1008 2010.03.03 BG
*        Self-revision flag does not matter here
         CLEAR W_SUM-OFLAG.
*--1008 2010.03.03 BG
*++2208 #09.
         IF W_SUM-ABEVAZ_DISP IS INITIAL.
           W_SUM-ABEVAZ_DISP = W_SUM-ABEVAZ.
         ENDIF.
         IF W_SUM-BTYPE_DISP IS INITIAL.
           W_SUM-BTYPE_DISP = W_SUM-BTYPE.
         ENDIF.
*--2208 #09.
         APPEND W_SUM TO I_SUM.
         DELETE T_BEVALLO WHERE ABEVAZ EQ W_/ZAK/BEVALLB-ABEVAZ.
       ENDIF.
     ENDIF.
   ENDLOOP.

*++1008 2010.02.04 BG
* you need the calculated data for the summation according to the special rules
* hand over for processing!

* If there is already a record, we will modify it
*  APPEND LINES OF I_SUM TO T_BEVALLO.
   SORT T_BEVALLO.
   LOOP AT I_SUM INTO W_SUM.
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
          WITH KEY BUKRS = W_SUM-BUKRS
                   BTYPE = W_SUM-BTYPE
                   GJAHR = W_SUM-GJAHR
                   MONAT = W_SUM-MONAT
                   ZINDEX = W_SUM-ZINDEX
                   ABEVAZ = W_SUM-ABEVAZ
                   ADOAZON = W_SUM-ADOAZON
                   LAPSZ = W_SUM-LAPSZ
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       L_INDEX = SY-TABIX.
       MODIFY T_BEVALLO FROM W_SUM INDEX L_INDEX.
     ELSE.
       APPEND W_SUM TO T_BEVALLO.
     ENDIF.
   ENDLOOP.
*--1008 2010.02.04 BG

*++0808 BG 2008.02.07
   SORT T_BEVALLO.
*--0808 BG 2008.02.07

 ENDFORM.                    " CALC_ABEV_sum
*&---------------------------------------------------------------------*
*&      Form  SET_BEVALLO
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_W_/ZAK/BEVALLO  text
*----------------------------------------------------------------------*
 FORM SET_BEVALLO USING    $ABEVAZ
                  CHANGING $/ZAK/BEVALLO STRUCTURE /ZAK/BEVALLO.
*++2011.12.08 BG (Ness)
   V_INDEX = $/ZAK/BEVALLO-ZINDEX.
*--2011.12.08 BG (Ness)

   IF $/ZAK/BEVALLO-ZINDEX NE '000'.
*++2011.12.08 BG (Ness)
*     V_INDEX = $/ZAK/BEVALLO-ZINDEX - 1.
     DO.
       SUBTRACT 1 FROM V_INDEX.
*--2011.12.08 BG (Ness)
       SELECT SINGLE * INTO W_SUM FROM /ZAK/BEVALLO
              WHERE BUKRS EQ $/ZAK/BEVALLO-BUKRS AND
                    BTYPE EQ $/ZAK/BEVALLO-BTYPE AND
                    GJAHR EQ $/ZAK/BEVALLO-GJAHR AND
                    MONAT EQ $/ZAK/BEVALLO-MONAT AND
                    ZINDEX EQ V_INDEX AND
                    ABEVAZ EQ $ABEVAZ AND
                    ADOAZON EQ $/ZAK/BEVALLO-ADOAZON AND
                    LAPSZ   EQ $/ZAK/BEVALLO-LAPSZ.
       IF SY-SUBRC EQ 0.
         $/ZAK/BEVALLO-FIELD_N   = W_SUM-FIELD_NRK.
         $/ZAK/BEVALLO-WAERS     = W_SUM-WAERS.
         EXIT.
       ENDIF.
*++2011.12.08 BG (Ness)
*      If we reach '000', exit
       IF V_INDEX EQ '000'.
         EXIT.
       ENDIF.
     ENDDO.
*--2011.12.08 BG (Ness)
   ENDIF.
 ENDFORM.                    " SET_BEVALLO
*&---------------------------------------------------------------------*
*&      Form  CALC_FIELD_NRK
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_W_/ZAK/BEVALLO_FIELD_N  text
*      -->P_W_/ZAK/BEVALLO_ROUND  text
*      <--P_W_/ZAK/BEVALLO_FIELD_NR  text
*      <--P_W_/ZAK/BEVALLO_FIELD_NRK  text
*----------------------------------------------------------------------*
*++1565 #11.
* FORM CALC_FIELD_NRK USING    $FIELD_N   LIKE /ZAK/BEVALLO-FIELD_N
*                              $ROUND     LIKE /ZAK/BEVALLO-ROUND
*                              $WAERS
*                     CHANGING $FIELD_NR  LIKE /ZAK/BEVALLO-FIELD_NR
*                              $FIELD_NRK LIKE /ZAK/BEVALLO-FIELD_NRK.
 FORM CALC_FIELD_NRK USING    $FIELD_N
                              $ROUND
                              $WAERS
                     CHANGING $FIELD_NR
                              $FIELD_NRK.
*--1565 #11.
   DATA: L_ROUND(20) TYPE C.
*++1465 #04.
   DATA: L_CURRDEC TYPE CURRDEC.

   READ TABLE I_TCURX WITH KEY CURRKEY = $WAERS.
   IF SY-SUBRC NE 0.
     SELECT * APPENDING TABLE I_TCURX
                     FROM TCURX
                    WHERE CURRKEY = $WAERS.
     IF SY-SUBRC NE 0.
       I_TCURX-CURRKEY = $WAERS.
       I_TCURX-CURRDEC = 2.
       APPEND I_TCURX.
     ENDIF.

     READ TABLE I_TCURX WITH KEY CURRKEY = $WAERS.
   ENDIF.

   L_CURRDEC =  I_TCURX-CURRDEC + $ROUND.
*--1465 #04.
   CLEAR L_ROUND.
   WRITE $FIELD_N TO L_ROUND
*++1465 #04.
*       ROUND $ROUND NO-GROUPING.
       ROUND L_CURRDEC NO-GROUPING.
*--1465 #04.
   REPLACE ',' WITH '.'
                        INTO L_ROUND.
   $FIELD_NR = L_ROUND.
*++1465 #04.
   IF NOT I_TCURX-CURRDEC IS INITIAL.
     $FIELD_NR = $FIELD_NR * ( 10 ** I_TCURX-CURRDEC ).
   ENDIF.
*--1465 #04.
   $FIELD_NRK = $FIELD_NR * ( 10 ** $ROUND ).

 ENDFORM.                    " CALC_FIELD_NRK
*&---------------------------------------------------------------------*
*&      Form  conv_datum_t056p
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_$KEZD  text
*      <--P_L_KEZD  text
*----------------------------------------------------------------------*
 FORM CONV_DATUM_T056P USING    $KEZD  TYPE DATUM
                       CHANGING $L_KEZD TYPE DATAB_INV.

   CALL FUNCTION 'CONVERSION_EXIT_INVDT_INPUT'
     EXPORTING
       INPUT  = $KEZD
     IMPORTING
       OUTPUT = $L_KEZD.
 ENDFORM.                    " conv_datum_t056p
*&---------------------------------------------------------------------*
*&      Form  INVDT_OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LW_T056P_DATAB  text
*      <--P_L_KAMAT_DATUM  text
*----------------------------------------------------------------------*
 FORM INVDT_OUTPUT USING    $DATAB
                   CHANGING $DATUM.
   DATA: L_DAT(10) TYPE C.
   CALL FUNCTION 'CONVERSION_EXIT_INVDT_OUTPUT'
     EXPORTING
       INPUT  = $DATAB
     IMPORTING
       OUTPUT = L_DAT.
   CALL FUNCTION 'CONVERSION_EXIT_IDATE_INPUT'
     EXPORTING
       INPUT  = L_DAT
     IMPORTING
       OUTPUT = $DATUM.
 ENDFORM.                    " INVDT_OUTPUT
*&---------------------------------------------------------------------*
*&      Form  calc_abev_eidsz
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_EIDSZ TABLES   T_BEVALLO STRUCTURE /ZAK/BEVALLO
                               T_BEVALLB STRUCTURE /ZAK/BEVALLB
                        USING  $DATE
                               $BTYPE
                               $ABEVAZ_1
                               $ABEVAZ_2.
   DATA: L_GJAHR TYPE GJAHR,
         L_MONAT TYPE MONAT.
*++BG 2007.02.20
   DATA: L_BTYPE TYPE /ZAK/BTYPE.
*--BG 2007.02.20

*++BG 2008.04.16
   DATA: BEGIN OF LI_BUKRS OCCURS 0,
           GJAHR TYPE GJAHR,
           MONAT TYPE MONAT,
           BUKRS TYPE BUKRS,
         END OF LI_BUKRS.
   DATA  LW_BUKRSN TYPE /ZAK/BUKRSN.
   DATA  L_DATUM LIKE SY-DATUM.
*--BG 2008.04.16

*++0965 2009.02.09 BG
   DATA LI_CONTACT LIKE /ZAK/ABEVCONTACT OCCURS 0 WITH HEADER LINE.
   DATA L_ABEVAZ TYPE /ZAK/ABEVAZ.
*--0965 2009.02.09 BG
*++2011.12.08 BG
   DATA L_ZINDEX TYPE NUMC3.
*--2011.12.08 BG

** (normál és önrevízió)
** a mostani bevallás elötti időszak figyelembe véve az időszakot
** , utolsó lezárt indexnél
** pl (havi): 005 revizió 06 hónapra --> megelőző 05 hónapot keresek az
** előző lezárt időszakra
** pl:negyedévesnél 03-->12 kell nézni
** a mostani 347 = a korábbi 357
   CLEAR: L_GJAHR,L_MONAT.
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
*++2009.02.02 BG
*    WHERE  ABEVAZ EQ     C_ABEVAZ_347.
     WHERE  ABEVAZ EQ     $ABEVAZ_1.
*--2009.02.02 BG
** ezt a sort kell módosítani!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
     V_TABIX = SY-TABIX .
*++BG 2008.04.16
     CLEAR W_/ZAK/BEVALLO-FIELD_N.
*--BG 2008.04.16
* PERIOD conversion!
* E - Year old
     L_GJAHR = W_/ZAK/BEVALLO-GJAHR.
     L_MONAT = W_/ZAK/BEVALLO-MONAT.

     IF W_/ZAK/BEVALL-BIDOSZ = 'E'.
       L_GJAHR = W_/ZAK/BEVALLO-GJAHR - 1.
* N - Quarterly
     ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.
       IF W_/ZAK/BEVALLO-MONAT EQ '03'.
         L_GJAHR = W_/ZAK/BEVALLO-GJAHR - 1.
         L_MONAT = '12'.
       ELSEIF W_/ZAK/BEVALLO-MONAT EQ '06' OR
              W_/ZAK/BEVALLO-MONAT EQ '09' OR
              W_/ZAK/BEVALLO-MONAT EQ '12'.
*++BG 2006/07/14
*        L_MONAT = W_/ZAK/BEVALLO-MONAT - 1.
         L_MONAT = W_/ZAK/BEVALLO-MONAT - 3.
*--BG 2006/07/14
       ENDIF.
     ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'H'.
       IF W_/ZAK/BEVALLO-MONAT EQ '01'.
         L_GJAHR = W_/ZAK/BEVALLO-GJAHR - 1.
         L_MONAT = '12'.
       ELSE.
         L_MONAT = W_/ZAK/BEVALLO-MONAT - 1.
       ENDIF.
*++2365 #03.
       CLEAR L_DATUM.
     ELSEIF  W_/ZAK/BEVALL-BIDOSZ = 'S'.
*   The beginning of the special period must be determined
       SELECT SINGLE DATAB INTO L_DATUM
                       FROM /ZAK/BEVALL
                      WHERE BUKRS EQ W_/ZAK/BEVALLO-BUKRS
                        AND BTYPE EQ W_/ZAK/BEVALLO-BTYPE
                        AND DATBI GE $DATE
                        AND DATAB LE $DATE.
       IF SY-SUBRC EQ 0.
         SUBTRACT 1 FROM L_DATUM.
         L_GJAHR = L_DATUM(4).
         L_MONAT = L_DATUM+4(2).
       ENDIF.
*--2365 #03.
     ENDIF.
* index
*++BG 2007.02.20
*We determine the BTYPE according to the year because it might not be
*with current
*kell olvasnunk.
     CLEAR L_BTYPE.
     CALL FUNCTION '/ZAK/GET_BTYPE_FROM_BTYPART'
       EXPORTING
         I_BUKRS     = W_/ZAK/BEVALLO-BUKRS
         I_BTYPART   = C_BTYPART_AFA
         I_GJAHR     = L_GJAHR
         I_MONAT     = L_MONAT
       IMPORTING
         E_BTYPE     = L_BTYPE
       EXCEPTIONS
         ERROR_MONAT = 1
         ERROR_BTYPE = 2
         OTHERS      = 3.
     IF SY-SUBRC <> 0.
       MESSAGE E208(/ZAK/ZAK) WITH C_BTYPART_AFA L_GJAHR L_MONAT.
*      Declaration type cannot be defined! (Type: &, Year: &, Month: &)
     ENDIF.
*--BG 2007.02.20

*++BG 2008.04.16
* We upload what must be run
     CLEAR LI_BUKRS.
     MOVE L_GJAHR TO LI_BUKRS-GJAHR.
     MOVE L_MONAT TO LI_BUKRS-MONAT.
     MOVE W_/ZAK/BEVALLO-BUKRS TO LI_BUKRS-BUKRS.
     APPEND LI_BUKRS.
*    We define data in the company turnover
     SELECT * INTO LW_BUKRSN                            "#EC CI_NOFIELD
              FROM /ZAK/BUKRSN
             WHERE FI_BUKRS EQ W_/ZAK/BEVALLO-BUKRS.
       IF NOT LW_BUKRSN-FDATE IS INITIAL.
         L_DATUM =  LW_BUKRSN-FDATE - 1.
         CLEAR LI_BUKRS.
         MOVE L_DATUM(4)   TO LI_BUKRS-GJAHR.
         MOVE L_DATUM+4(2) TO LI_BUKRS-MONAT.
         MOVE LW_BUKRSN-AD_BUKRS TO LI_BUKRS-BUKRS.
         APPEND LI_BUKRS.
       ENDIF.
     ENDSELECT.

     SORT LI_BUKRS.
     DELETE ADJACENT DUPLICATES FROM LI_BUKRS.
*--BG 2008.04.16


*++BG 2008.04.16
     LOOP AT LI_BUKRS WHERE GJAHR EQ L_GJAHR
                        AND MONAT EQ L_MONAT.
*--BG 2008.04.16

*     IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
       SELECT * INTO W_/ZAK/BEVALLI FROM /ZAK/BEVALLI
       UP TO 1 ROWS
       WHERE
*++BG 2008.04.16
*           BUKRS EQ W_/ZAK/BEVALLO-BUKRS AND
              BUKRS EQ LI_BUKRS-BUKRS AND
*--BG 2008.04.16
*++BG 2007.02.20
*           BTYPE EQ W_/ZAK/BEVALLO-BTYPE AND
              BTYPE EQ L_BTYPE AND
*--BG 2007.02.20
              GJAHR EQ L_GJAHR AND
              MONAT EQ L_MONAT AND
              FLAG IN ('Z','X') ORDER BY ZINDEX DESCENDING.
*++0965 2009.02.09 BG
         IF SY-SUBRC NE 0.
           CONTINUE.
         ENDIF.

         CALL FUNCTION '/ZAK/ABEV_CONTACT'
           EXPORTING
             I_BUKRS        = LI_BUKRS-BUKRS
             I_BTYPE        = $BTYPE
             I_ABEVAZ       = $ABEVAZ_2
             I_GJAHR        = L_GJAHR
             I_MONAT        = L_MONAT
           TABLES
             T_ABEV_CONTACT = LI_CONTACT
           EXCEPTIONS
             ERROR_BTYPE    = 1
             ERROR_MONAT    = 2
             ERROR_ABEVAZ   = 3
             OTHERS         = 4.

         IF SY-SUBRC <> 0.
           MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
                   WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
         ENDIF.

         DESCRIBE TABLE LI_CONTACT LINES SY-TFILL.
         READ TABLE LI_CONTACT INDEX SY-TFILL.
         IF SY-SUBRC = 0.
           L_ABEVAZ = LI_CONTACT-ABEVAZ.
         ENDIF.
*--0965 2009.02.09 BG
*--0965 2009.02.09 BG
*++2011.12.08 BG
*        read until we find a value up to '000'.
         L_ZINDEX = W_/ZAK/BEVALLI-ZINDEX + 1.
         DO.
           SUBTRACT 1 FROM L_ZINDEX.
           SELECT SINGLE * INTO W_SUM FROM /ZAK/BEVALLO
*++BG 2008.04.16
*             WHERE BUKRS EQ W_/ZAK/BEVALLO-BUKRS AND
                  WHERE BUKRS EQ LI_BUKRS-BUKRS AND
*--BG 2008.04.16
*++BG 2007.02.20
*                     BTYPE EQ W_/ZAK/BEVALLO-BTYPE AND
                        BTYPE EQ L_BTYPE AND
*--BG 2007.02.20
                        GJAHR EQ L_GJAHR AND
                        MONAT EQ L_MONAT AND
*                      ZINDEX EQ W_/ZAK/BEVALLI-ZINDEX AND
                        ZINDEX EQ L_ZINDEX AND
*++0965 2009.02.09 BG
*                     ABEVAZ EQ C_ABEVAZ_357.
                        ABEVAZ EQ L_ABEVAZ.
*--0965 2009.02.09 BG
           IF SY-SUBRC EQ 0.
*++BG 2008.04.16
             ADD W_SUM-FIELD_NRK TO W_/ZAK/BEVALLO-FIELD_N.
*         W_/ZAK/BEVALLO-FIELD_N   = W_SUM-FIELD_NRK.
             W_/ZAK/BEVALLO-WAERS     = W_SUM-WAERS.
*         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
*                     W_/ZAK/BEVALLB-ROUND
*                     W_/ZAK/BEVALLO-WAERS
*            CHANGING W_/ZAK/BEVALLO-FIELD_NR
*                     W_/ZAK/BEVALLO-FIELD_NRK.
*         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
             EXIT.
*--BG 2008.04.16
           ENDIF.
           IF L_ZINDEX EQ '000'.
             EXIT.
           ENDIF.
         ENDDO.
*--2011.12.08 BG
       ENDSELECT.
*     ENDIF.
*++BG 2008.04.16
     ENDLOOP.
     PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                 W_/ZAK/BEVALLB-ROUND
                 W_/ZAK/BEVALLO-WAERS
        CHANGING W_/ZAK/BEVALLO-FIELD_NR
                 W_/ZAK/BEVALLO-FIELD_NRK.
     MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*--BG 2008.04.16
   ENDLOOP.
 ENDFORM.                    " calc_abev_eidsz
*&---------------------------------------------------------------------*
*&      Form  count_abev
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_I_/ZAK/BEVALLO  text
*      -->P_I_/ZAK/BEVALLB  text
*----------------------------------------------------------------------*
 FORM COUNT_ABEV TABLES   T_BEVALLO STRUCTURE /ZAK/BEVALLO
                          T_BEVALLB STRUCTURE /ZAK/BEVALLB.

   SORT T_BEVALLB BY ABEVAZ  .
* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE  ABEVAZ EQ     C_ABEVAZ_M0AC017A  OR
            ABEVAZ EQ     C_ABEVAZ_M0AC018A  OR
            ABEVAZ EQ     C_ABEVAZ_M0AC019A  OR
            ABEVAZ EQ     C_ABEVAZ_M0AC020A  OR
            ABEVAZ EQ     C_ABEVAZ_M0AC021A  OR
            ABEVAZ EQ     C_ABEVAZ_M0AC022A  OR
            ABEVAZ EQ     C_ABEVAZ_M0AC023A  OR
            ABEVAZ EQ     C_ABEVAZ_M0AC024A  OR
            ABEVAZ EQ     C_ABEVAZ_M0AC025A.


* this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
     V_TABIX = SY-TABIX .
     CLEAR: W_/ZAK/BEVALLO-FIELD_N,
            W_/ZAK/BEVALLO-FIELD_NR,
            W_/ZAK/BEVALLO-FIELD_NRK.

     CASE W_/ZAK/BEVALLB-ABEVAZ.
       WHEN C_ABEVAZ_M0AC017A.
*         W_/ZAK/BEVALLO-FIELD_C = sy-tfill.
*         condense W_/ZAK/BEVALLO-FIELD_C.
*         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       WHEN C_ABEVAZ_M0AC018A.
       WHEN C_ABEVAZ_M0AC019A.
       WHEN C_ABEVAZ_M0AC020A.
       WHEN C_ABEVAZ_M0AC021A.
       WHEN C_ABEVAZ_M0AC022A.
       WHEN C_ABEVAZ_M0AC023A.
       WHEN C_ABEVAZ_M0AC024A.
       WHEN C_ABEVAZ_M0AC025A.


     ENDCASE.

   ENDLOOP.
 ENDFORM.                    " count_abev
*&---------------------------------------------------------------------*
*&      Form  PROCESS_IND
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_TEXT_P01  text
*----------------------------------------------------------------------*
 FORM PROCESS_IND USING $TEXT.
   CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
     EXPORTING
*      PERCENTAGE = 0
       TEXT = $TEXT.

 ENDFORM.                    " process_ind
*&---------------------------------------------------------------------*
*&      Form  process_ind_item
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_L_INDEX  text
*----------------------------------------------------------------------*
 FORM PROCESS_IND_ITEM USING   $VALUE
                               $INDEX
                               $TEXT.
*  Only when running dialog
   CHECK SY-BATCH IS INITIAL.
   ADD 1 TO $INDEX.
   IF $INDEX EQ $VALUE.
     PERFORM PROCESS_IND USING $TEXT.
     CLEAR $INDEX.
     COMMIT WORK.
   ENDIF.

 ENDFORM.                    " process_ind_item
*&---------------------------------------------------------------------*
*&      Form  call_mlapsz
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_R_M0AC017A  text
*      -->P_L_ALV  text
*      -->P_C_ABEVAZ_M0AC017A  text
*----------------------------------------------------------------------*
 FORM CALL_MLAPSZ TABLES   $RANGE STRUCTURE  R_M0AC017A
                  USING    $BEVALLO   STRUCTURE  /ZAK/BEVALLO
                           $ABEVAZ.

   IF $BEVALLO-ABEVAZ IN $RANGE AND
      ( NOT $BEVALLO-FIELD_C IS INITIAL OR
        NOT $BEVALLO-FIELD_N IS INITIAL ).
     CLEAR W_MLAP.
     MOVE $BEVALLO-ADOAZON TO W_MLAP-ADOAZON.
     MOVE $ABEVAZ      TO W_MLAP-ABEVAZ.
     MOVE $BEVALLO-LAPSZ   TO W_MLAP-LAPSZ.
     COLLECT W_MLAP INTO I_MLAP.
   ENDIF.

 ENDFORM.                    " call_mlapsz
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_LAPSZ
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_LAPSZ TABLES   T_BEVALLO STRUCTURE /ZAK/BEVALLALV.

* SZJA return to determine the tax identification page number
   TYPES: BEGIN OF LT_MLAPSZ,
            ADOAZON LIKE /ZAK/BEVALLALV-ADOAZON,
            ABEVAZ  LIKE /ZAK/BEVALLALV-ABEVAZ,
            NUMBER  TYPE I,
          END OF  LT_MLAPSZ.

   DATA LI_MLAPSZ TYPE HASHED TABLE OF LT_MLAPSZ
                                WITH UNIQUE KEY ADOAZON
                                                ABEVAZ
                                INITIAL SIZE 0.
   DATA LW_MLAPSZ TYPE LT_MLAPSZ.

   DATA L_BEVALLO_ALV LIKE /ZAK/BEVALLALV.


   SORT I_MLAP.

   CHECK NOT I_MLAP[] IS INITIAL.

*  We determine the page numbers.
   LOOP AT I_MLAP INTO W_MLAP.
     CLEAR LW_MLAPSZ.
     MOVE W_MLAP-ADOAZON TO LW_MLAPSZ-ADOAZON.
     MOVE W_MLAP-ABEVAZ  TO LW_MLAPSZ-ABEVAZ.
     MOVE 1 TO LW_MLAPSZ-NUMBER.
     COLLECT LW_MLAPSZ INTO LI_MLAPSZ.
   ENDLOOP.

*  Rewriting page numbers
   LOOP AT LI_MLAPSZ INTO LW_MLAPSZ.
     READ TABLE T_BEVALLO INTO L_BEVALLO_ALV
                          WITH KEY ABEVAZ  = LW_MLAPSZ-ABEVAZ
                                   ADOAZON = LW_MLAPSZ-ADOAZON
                          BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE LW_MLAPSZ-NUMBER TO L_BEVALLO_ALV-FIELD_C.
       CONDENSE L_BEVALLO_ALV-FIELD_C.
       MODIFY T_BEVALLO FROM L_BEVALLO_ALV INDEX SY-TABIX
                             TRANSPORTING FIELD_C.
     ENDIF.
   ENDLOOP.

 ENDFORM.                    " CALC_ABEV_LAPSZ

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_ONREV_SZJA_0608
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$INDEX  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONREV_SZJA_0608 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                       T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                       T_ADOAZON STRUCTURE
                                                     /ZAK/ONR_ADOAZON
                               USING   $INDEX
                                       $LAST_DATE.

   DATA LI_LAST_BEVALLO LIKE /ZAK/BEVALLO OCCURS 0 WITH HEADER LINE.
   DATA L_LAST_INDEX LIKE /ZAK/BEVALLO-ZINDEX.
   DATA L_TABIX LIKE SY-TABIX.
   DATA L_TRUE.

   RANGES LR_ONREV_ABEVAZ FOR /ZAK/BEVALLB-ABEVAZ.
   DATA   L_ABEVAZ LIKE /ZAK/BEVALLB-ABEVAZ.

   DATA: L_KAM_KEZD TYPE DATUM,
         L_KAM_VEG  TYPE DATUM.
   DATA   L_KAMAT LIKE /ZAK/BEVALLO-FIELD_N.
   DATA   L_KAMAT_SUM LIKE /ZAK/BEVALLO-FIELD_N.

*  To upload fields to be summarized
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.


*  If self-revision
   CHECK $INDEX NE '000'.

   SORT T_BEVALLB BY ABEVAZ.

*  Let's read the 'A' abev identifiers of the previous period
   READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO INDEX 1.
   CHECK SY-SUBRC EQ 0.
   L_LAST_INDEX = $INDEX - 1.

   CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
     EXPORTING
       INPUT  = L_LAST_INDEX
     IMPORTING
       OUTPUT = L_LAST_INDEX.


   SELECT * INTO TABLE LI_LAST_BEVALLO
                 FROM  /ZAK/BEVALLO
                WHERE  BUKRS   EQ W_/ZAK/BEVALLO-BUKRS
                  AND  BTYPE   EQ W_/ZAK/BEVALLO-BTYPE
                  AND  GJAHR   EQ W_/ZAK/BEVALLO-GJAHR
                  AND  MONAT   EQ W_/ZAK/BEVALLO-MONAT
                  AND  ZINDEX  EQ L_LAST_INDEX
                  AND  ADOAZON EQ ''.

   SORT LI_LAST_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ.


*  We delete those records that have a tax number but not
*  nothing came of it
   LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                     WHERE NOT ADOAZON IS INITIAL.
     READ TABLE T_ADOAZON WITH KEY ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                                   BINARY SEARCH.
*    Nem kell a rekord.
     IF SY-SUBRC NE 0.
       DELETE T_BEVALLO.
       CONTINUE.
     ENDIF.

*  M 11 Mark with H if your declaration is considered a correction
     IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_M0AC015A.
       MOVE 'H' TO W_/ZAK/BEVALLO-FIELD_C.
     ENDIF.

*    A-12-000-e Repeated self-check
     IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_A0DB005A AND
        $INDEX > '001'.
       MOVE C_X TO W_/ZAK/BEVALLO-FIELD_C.
     ENDIF.
     MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO.
   ENDLOOP.

   SORT T_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ.

*  A 12a Mark with H if your declaration is considered a correction
   READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0AC030A.
   IF SY-SUBRC EQ 0.
     MOVE SY-TABIX TO L_TABIX.
     MOVE 'H' TO W_/ZAK/BEVALLO-FIELD_C.
     MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
   ENDIF.

*  Calculation algorithm FOR SELF-REVISION:
*  A-12-301-d Total personal income tax (difference in liability)
*  A0DC0301DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0301DA   "Módosított mező
                                 C_ABEVAZ_A0CC0033AA        "Forrás 1
                                 C_ABEVAZ_A0BD0016CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A-12-303-d From line 302, the pension commission charged to the employer. contribution
*(18%) (obligation difference
*A0DC0303DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0303DA   "Módosított mező
                                 C_ABEVAZ_A0CC0034AA        "Forrás 1
                                 C_ABEVAZ_A0BD0027CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A-12-304-d Pension contribution deducted from line 302 from the insured (8.5%)
*(obligation difference
*A0DC0304DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0304DA   "Módosított mező
                                 C_ABEVAZ_A0CC0035AA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A-12-305-d Pension contribution deducted from line 302 from the insured (0.5%) *
*(obligation difference
*A0DC0305DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0305DA   "Módosított mező
                                 C_ABEVAZ_A0CC0036AA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A-12-306-d Pension contribution paid after service fee from line 302
*(15%) (obligation difference
*A0DC0306DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0306DA   "Módosított mező
                                 C_ABEVAZ_A0CC0037AA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A-12-308-d From line 307, the employer's health insurance. contribution
* (11%) (obligation separately
*A0DC0308DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0308DA   "Módosított mező
                                 C_ABEVAZ_A0CC0039AA        "Forrás 1
                                 C_ABEVAZ_A0BD0028CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A-12-309-d The health insurance contribution deducted from the insured person from line 307
* (11%) (obligation separately
*A0DC0309DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0309DA   "Módosított mező
                                 C_ABEVAZ_A0CC0040AA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A-12-310-d Accident contribution from line 307 for the partnership
* (5%) (obligation otherwise
*A0DC0310DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0310DA   "Módosított mező
                                 C_ABEVAZ_A0CC0041AA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A-12-311-d Employer contribution (difference in liability)
*A0DC0311DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0311DA   "Módosított mező
                                 C_ABEVAZ_A0CC0043AA        "Forrás 1
                                 C_ABEVAZ_A0BD0026CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A-12-312-d Employee contribution (difference in liability)
*A0DC0312DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0312DA   "Módosított mező
                                 C_ABEVAZ_A0CC0044AA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A-12-313-d Entrepreneur's contribution (difference in liability)
*A0DC0313DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0313DA   "Módosított mező
                                 C_ABEVAZ_A0CC0045AA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A-12-314-d Percentage health contribution (obligation
*difference)
*A0DC0314DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0314DA   "Módosított mező
                                 C_ABEVAZ_A0CC0048AA        "Forrás 1
                                 C_ABEVAZ_A0BD0029CA        "Forrás 2
                                 C_ABEVAZ_A0BD0030CA        "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A-12-315-d Itemized medical contribution (obligation
*difference)
*A0DC0315DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0315DA   "Módosított mező
                                 C_ABEVAZ_A0CC0049AA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A-12-316-d The 15% charge for START card holders.
* (obligation difference)
*A0DC0316DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0316DA   "Módosított mező
                                 C_ABEVAZ_A0CC0046AA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A-12-317-d The 25% charge for START card holders.
* (obligation difference)
*A0DC0317DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0317DA   "Módosított mező
                                 C_ABEVAZ_A0CC0047AA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A-12-318-d The simplified public burden on the payer.
*20% (obligation difference
*A0DC0318DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0318DA   "Módosított mező
                                 C_ABEVAZ_A0CC0050AA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A-12-319-d The simplified public burden burdening the private
*11% (obligation difference
*A0DC0319DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0319DA   "Módosított mező
                                 C_ABEVAZ_A0CC0051AA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A-12-320-d The simplified public burden burdening the private
*11.1% (obligation difference
*A0DC0320DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0320DA   "Módosított mező
                                 C_ABEVAZ_A0CC0052AA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A-12-321-d The simplified public burden burdening the private
*15% (obligation difference
*A0DC0321DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0DC0321DA   "Módosított mező
                                 C_ABEVAZ_A0CC0053AA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*++BG 2006/12/06

* A0DC0313CA = A0DC0313DA / 0,04
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0DC0313CA   "Módosított mező
                                C_ABEVAZ_A0DC0313DA
                                '0.04'.

* A0DC0316CA = A0DC0316DA / 0,15
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0DC0316CA   "Módosított mező
                                C_ABEVAZ_A0DC0316DA
                                '0.04'.

* A0DC0317CA = A0DC0317DA / 0,25
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0DC0317CA   "Módosított mező
                                C_ABEVAZ_A0DC0317DA
                                '0.25'.

* A0DC0318CA = A0DC0318DA / 0,20
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0DC0318CA   "Módosított mező
                                C_ABEVAZ_A0DC0318DA
                                '0.2'.

* A0DC0319CA = A0DC0319DA / 0,11
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0DC0319CA   "Módosított mező
                                C_ABEVAZ_A0DC0319DA
                                '0.11'.

* A0DC0320CA = A0DC0320DA / 0,111
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0DC0320CA   "Módosított mező
                                C_ABEVAZ_A0DC0320DA
                                '0.111'.

* A0DC0321CA = A0DC0321DA / 0,15
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0DC0321CA   "Módosított mező
                                C_ABEVAZ_A0DC0321DA
                                '0.15'.

*--BG 2006/12/06


*Summaries
*A-12-302-d Pension Commission. Total contributions due to the fund
*(obligation difference)
*A0DC0302DA
   REFRESH LR_ABEVAZ.
*++0002 BG 2006/11/29
*  M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0DC0303DA C_ABEVAZ_A0DC0306DA.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0303DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0304DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0305DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0306DA SPACE.
*--0002 BG 2006/11/29

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0DC0302DA.

*A-12-307-d Total contributions due to the Health Insurance Fund
*(obligation difference
*A0DC0307DA
   REFRESH LR_ABEVAZ.
*++0002 BG 2006/11/29
*  M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0DC0308DA C_ABEVAZ_A0DC0310DA.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0308DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0309DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0310DA SPACE.
*--0002 BG 2006/11/29
   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0DC0307DA.

*A-12-322-d Total data of lines 301, 302 and 307, as well as 311-321.
*(obligation difference
*A0DC0322DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0301DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0302DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0307DA SPACE.
*++0002 BG 2006/11/29
*  M_DEF  LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0DC0311DA C_ABEVAZ_A0DC0321DA.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0311DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0312DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0313DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0314DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0315DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0316DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0317DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0318DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0319DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0320DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0321DA SPACE.
*--0002 BG 2006/11/29
   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0DC0322DA.

* A 13a Mark with an X if the corrector's declaration is a self-check
* qualifies
* A0AC032A
   LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO WHERE ABEVAZ IN LR_ABEVAZ.
     IF NOT W_/ZAK/BEVALLO-FIELD_N IS INITIAL.
       MOVE 'X' TO L_TRUE.
       EXIT.
     ENDIF.
   ENDLOOP.

   IF NOT L_TRUE IS INITIAL.
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                              WITH KEY ABEVAZ = C_ABEVAZ_A0AC032A.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE C_X TO W_/ZAK/BEVALLO-FIELD_C.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
   ENDIF.

*++BG 2006/12/06

* A0DC0302CA 302c=(303c+...+306c)
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0303CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0304CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0305CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0306CA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0DC0302CA.



*  A0DC0307CA 307c=(308c+309c+310c)
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0308CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0309CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0310CA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0DC0307CA.

* A0DC0307CA 322c=(301c+302c+307c+311c+...314c+316c+321c)
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0301CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0302CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0303CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0304CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0305CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0306CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0307CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0308CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0309CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0310CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0311CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0312CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0313CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0314CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0315CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0316CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0317CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0318CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0319CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0320CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0321CA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0DC0322CA.

*--BG 2006/12/06


 ENDFORM.                    " CALC_ABEV_ONREV_SZJA

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_ONREV_SZJA_06082
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$INDEX  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONREV_SZJA_06082
                           TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                   T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                   T_ADOAZON STRUCTURE /ZAK/ONR_ADOAZON
                           USING   $INDEX
                                   $LAST_DATE.

   DATA LI_LAST_BEVALLO LIKE /ZAK/BEVALLO OCCURS 0 WITH HEADER LINE.
   DATA L_LAST_INDEX LIKE /ZAK/BEVALLO-ZINDEX.
   DATA L_TABIX LIKE SY-TABIX.
   DATA L_TRUE.

   RANGES LR_ONREV_ABEVAZ FOR /ZAK/BEVALLB-ABEVAZ.
   DATA   L_ABEVAZ LIKE /ZAK/BEVALLB-ABEVAZ.

   DATA: L_KAM_KEZD TYPE DATUM,
         L_KAM_VEG  TYPE DATUM.
   DATA   L_KAMAT LIKE /ZAK/BEVALLO-FIELD_N.
   DATA   L_KAMAT_SUM LIKE /ZAK/BEVALLO-FIELD_N.

*  To upload fields to be summarized
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.


*  If self-revision
   CHECK $INDEX NE '000'.

   SORT T_BEVALLB BY ABEVAZ.

*  Let's read the 'A' abev identifiers of the previous period
   READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO INDEX 1.
   CHECK SY-SUBRC EQ 0.
   L_LAST_INDEX = $INDEX - 1.

   CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
     EXPORTING
       INPUT  = L_LAST_INDEX
     IMPORTING
       OUTPUT = L_LAST_INDEX.


   SELECT * INTO TABLE LI_LAST_BEVALLO
                 FROM  /ZAK/BEVALLO
                WHERE  BUKRS   EQ W_/ZAK/BEVALLO-BUKRS
                  AND  BTYPE   EQ W_/ZAK/BEVALLO-BTYPE
                  AND  GJAHR   EQ W_/ZAK/BEVALLO-GJAHR
                  AND  MONAT   EQ W_/ZAK/BEVALLO-MONAT
                  AND  ZINDEX  EQ L_LAST_INDEX
                  AND  ADOAZON EQ ''.

   SORT LI_LAST_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ.


*  We delete those records that have a tax number but not
*  nothing came of it
   LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                     WHERE NOT ADOAZON IS INITIAL.
     READ TABLE T_ADOAZON WITH KEY ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                                   BINARY SEARCH.
*    Nem kell a rekord.
     IF SY-SUBRC NE 0.
       DELETE T_BEVALLO.
       CONTINUE.
     ENDIF.

*  M 11 Mark with H if your declaration is considered a correction
     IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_M0AC018A.
       MOVE 'H' TO W_/ZAK/BEVALLO-FIELD_C.
     ENDIF.

*    A-12-000-e Repeated self-check
     IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_A0FB005A AND
        $INDEX > '001'.
       MOVE C_X TO W_/ZAK/BEVALLO-FIELD_C.
     ENDIF.
     MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO.
   ENDLOOP.

   SORT T_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ.

*  A 12a Mark with H if your declaration is considered a correction
   READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0AC030A.
   IF SY-SUBRC EQ 0.
     MOVE SY-TABIX TO L_TABIX.
     MOVE 'H' TO W_/ZAK/BEVALLO-FIELD_C.
     MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
   ENDIF.

**  Számítási algoritmus ÖNREVÍZIÓHOZ:

* A0FC0411DA
* A-12-411-d Total personal income tax (difference in liability)
*(This return is A0CC0044CA+A0BD0017CA (amount in HUF)) - (previous
* the return for the period A0CC0044CA+A0BD0017CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0411DA   "Módosított mező
                                 C_ABEVAZ_A0DC0044CA        "Forrás 1
                                 C_ABEVAZ_A0CC0017CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

* A0FC0413DA
* A-12-413-d From line 412, Tbj. R-5/D (1) paragraph b) (obligation
* better.)
*(This declaration is A0BC0003CA (amount in HUF)) - (previous for this period
* tax return A0BC0003CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0413DA   "Módosított mező
                                 C_ABEVAZ_A0BC0003CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

* A0FC0414DA
*A-12-414-d From line 412, the pension commission charged to the employer. contribution
*(18%) (obligation difference
*(This declaration is A0DC0047CA+A0CC0030CA (amount in HUF)) - (previous
* return for the period A0DC0047CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0414DA   "Módosított mező
                                 C_ABEVAZ_A0DC0047CA        "Forrás 1
                                 C_ABEVAZ_A0CC0030CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

* A0FC0415DA
*A-12-415-d Pension contribution deducted from line 412 from the insured (8.5%)
*(obligation difference
*(This return is A0DC0048CA (amount in HUF)) - (previous for this period
*tax return A0DC0048CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0415DA   "Módosított mező
                                 C_ABEVAZ_A0DC0048CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

* A0FC0416DA
*A-12-416-d Pension contribution deducted from line 412 from the insured (0.5%)
*(obligation difference
*(This return is A0DC0049CA (amount in HUF)) - (previous for this period
*tax return A0DC0049CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0416DA   "Módosított mező
                                 C_ABEVAZ_A0DC0049CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

* A0FC0417DA
*A-12-417-d Pension contribution paid after service fee from line 412
*(15%) (obligation difference
*(This return is A0DC0050CA (amount in HUF)) - (previous for this period
*rain declaration A0DC0050CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0417DA   "Módosított mező
                                 C_ABEVAZ_A0DC0050CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

* A0FC0419DA
*A-12-420-d From line 418, Tbj. R-5/D (1) paragraph a) (obligation
*better.)
*(This return is A0BC0005CA (amount in HUF)) - (previous for this period
*tax return A0BC0005CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0419DA   "Módosított mező
                                 C_ABEVAZ_A0BC0005CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

* A0FC0420DA
*A-12-420-d From line 418, the employer's health insurance. contribution
*(11%) (obligation separately
* (This return is A0DC0053CA (amount in HUF)) - (previous for this period
* tax return A0DC0053CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0420DA   "Módosított mező
                                 C_ABEVAZ_A0DC0053CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0FC0421DA
* A-12-421-d From line 418, the payment in kind of the employer.
*commission contribution (7%) (obligation
*(This return is A0DC0054CA+A0CC0031CA (amount in HUF)) - (previous
* return for the period A0DC0054CA+A0CC0031CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0421DA   "Módosított mező
                                 C_ABEVAZ_A0DC0054CA        "Forrás 1
                                 C_ABEVAZ_A0CC0031CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0FC0422DA
*A-12-422-d From line 418, the financial insurance for the employer.
*contribution (4%) (vol. misc.)
*(This return is A0DC0055CA+A0CC0032CA (amount in HUF)) - (previous
* return for the period A0DC0055CA+A0CC0032CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0422DA   "Módosított mező
                                 C_ABEVAZ_A0DC0055CA        "Forrás 1
                                 C_ABEVAZ_A0CC0032CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0FC0423DA
*A-12-423-d Health insurance contribution deducted from line 418 from the insured
*(4%) (obligation separately
*(This return is A0DC0056CA (amount in HUF)) - (previous for this period
*tax return A0DC0056CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0423DA   "Módosított mező
                                 C_ABEVAZ_A0DC0056CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

* A0FC0424DA
*A-12-424-d Production income tax deducted from line 418 from the insured.
*contribution (4%) (obligation
* (This return is A0DC0057CA (amount in HUF)) - (previous for this period
* tax return A0DC0057CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0424DA   "Módosított mező
                                 C_ABEVAZ_A0DC0057CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0FC0425DA
*A-12-425-d Cash health insurance deducted from line 418 from the insured.
*contribution (2%) (obligation
*(This return is A0DC0058CA (amount in HUF)) - (previous for this period
*tax return A0DC0058CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0425DA   "Módosított mező
                                 C_ABEVAZ_A0DC0058CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0FC0426DA
* A-12-426-d From line 418, the accident burdening the partnership
*contribution (5%) (obligation separately
* (This return is A0DC0059CA (amount in HUF)) - (previous for this period
* tax return A0DC0059CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0426DA   "Módosított mező
                                 C_ABEVAZ_A0DC0059CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

* A0FC0427DA
*A-12-427-d Accident contribution from line 418 for the partnership
* (10%) (obligation separately
* (This declaration is A0CC0060CA (amount in HUF)) - (previous for this period
* tax return A0CC0060CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0427DA   "Módosított mező
                                 C_ABEVAZ_A0CC0060CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0FC0428DA
*A-12-428-d Employer contribution (difference in liability)
*(This return is A0EC0067CA+A0CC0029CA (amount in HUF)) - (previous
* return for the period A0EC0067CA+A0CC0029CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0428DA   "Módosított mező
                                 C_ABEVAZ_A0EC0067CA        "Forrás 1
                                 C_ABEVAZ_A0CC0029CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0FC0429DA
*A-12-429-d Employee contribution (1%) (difference in liability)
*(This return is A0EC0068CA (amount in HUF)) - (previous for this period
*tax return A0EC0068CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0429DA   "Módosított mező
                                 C_ABEVAZ_A0EC0068CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0FC0430DA
*A-12-430-d Employee contribution (1.5%) (difference in liability)
*(This declaration is A0EC0069CA (amount in HUF)) - (previous for this period
*tax return A0EC0069CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0430DA   "Módosított mező
                                 C_ABEVAZ_A0EC0069CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

* A0FC0431DA
*A-12-431-d Entrepreneur's contribution (difference in liability)

*++BG 2006/11/10
*(This return is A0EC0070CA+A0CC0033CA (amount in HUF)) - (previous
* for a period
*rain declaration A0EC0070CA+A0CC0033CA (amount in HUF))
*--BG 2006/11/10

   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0431DA   "Módosított mező
                                 C_ABEVAZ_A0EC0070CA        "Forrás 1
*++BG 2006/11/22
**++BG 2006/11/10
*                                C_ABEVAZ_A0CC0033CA "Source 2
                                 SPACE                      "Forrás 2
**--BG 2006/11/10
*--BG 2006/11/22
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

* A0FC0432DA
*A-12-432-d Percentage health contribution (obligation
*difference)
*(This return is A0EC0073CA (amount in HUF)) - (previous for this period
* tax return A0EC0073CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0432DA   "Módosított mező
                                 C_ABEVAZ_A0EC0073CA        "Forrás 1
*++BG 2006/11/22
                                 C_ABEVAZ_A0CC0033CA        "Forrás 2
                                 C_ABEVAZ_A0CC0034CA        "Forrás 3
*--BG 2006/11/22
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0FC0433DA
* A-12-433-d Itemized medical contribution (obligation
*difference)
*(This return is A0EC0074CA (amount in HUF)) - (previous for this period
* tax return A0EC0074CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0433DA   "Módosított mező
                                 C_ABEVAZ_A0EC0074CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0FC0434DA
*A-12-434-d The 15% charge for START card holders.
*(obligation difference)
*(This declaration is A0EC0071CA (amount in HUF)) - (previous for this period
*tax return A0EC0071CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0434DA   "Módosított mező
                                 C_ABEVAZ_A0EC0071CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0FC0435DA
*A-12-435-d The 25% charge for START card holders.
* (obligation difference)
*(This declaration is A0EC0072CA (amount in HUF)) - (previous for this period
* tax return A0EC0072CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0435DA   "Módosított mező
                                 C_ABEVAZ_A0EC0072CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0FC0436DA
*A-12-436-d The simplified public charge burdening the payer.
*20% (obligation difference
*(This declaration is A0EC0075CA (amount in HUF)) - (previous for this period
*tax return A0EC0075CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0436DA   "Módosított mező
                                 C_ABEVAZ_A0EC0075CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0FC0437DA
*A-12-437-d The simplified public burden burdening the private
*11% (obligation difference
*(This return is A0EC0076CA (amount in HUF)) - (previous for this period
* tax return A0EC0076CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0437DA   "Módosított mező
                                 C_ABEVAZ_A0EC0076CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0FC0438DA
* A-12-438-d The simplified public burden burdening the private
* 11.1% (obligation difference
* (This return is A0EC0077CA (amount in HUF)) - (previous for this period
* tax return A0EC0077CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0438DA   "Módosított mező
                                 C_ABEVAZ_A0EC0077CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

* A0FC0439DA
*A-12-439-d The simplified public burden burdening the private
*15% (obligation difference
*(This return is A0EC0078CA (amount in HUF)) - (previous for this period
*tax return A0EC0078CA (amount in HUF))
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0439DA   "Módosított mező
                                 C_ABEVAZ_A0EC0078CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*++BG 2006/12/06
* A0FC0414CA = A0FC0414DA / 0,18
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0414CA   "Módosított mező
                                C_ABEVAZ_A0FC0414DA
                                '0.18'.


* A0FC0415CA = A0FC0415DA / 0,085
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0415CA   "Módosított mező
                                C_ABEVAZ_A0FC0415DA
                                '0.085'.

* A0FC0416CA = A0FC0416DA / 0,005
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0416CA   "Módosított mező
                                C_ABEVAZ_A0FC0416DA
                                '0.005'.

* A0FC0417CA = A0FC0417DA / 0,15
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0417CA   "Módosított mező
                                C_ABEVAZ_A0FC0417DA
                                '0.15'.

* A0FC0420CA = A0FC0420DA / 0,11
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0420CA   "Módosított mező
                                C_ABEVAZ_A0FC0420DA
                                '0.11'.

* A0FC0421CA = A0FC0421DA / 0,07
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0421CA   "Módosított mező
                                C_ABEVAZ_A0FC0421DA
                                '0.07'.

* A0FC0422CA = A0FC0422DA / 0,04
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0422CA   "Módosított mező
                                C_ABEVAZ_A0FC0422DA
                                '0.04'.

* A0FC0424CA = A0FC0424DA / 0,04
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0424CA   "Módosított mező
                                C_ABEVAZ_A0FC0424DA
                                '0.04'.

* A0FC0425CA = A0FC0425DA / 0,02
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0425CA   "Módosított mező
                                C_ABEVAZ_A0FC0425DA
                                '0.02'.

* A0FC0426CA = A0FC0426DA / 0,05
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0426CA   "Módosított mező
                                C_ABEVAZ_A0FC0426DA
                                '0.05'.

* A0FC0427CA = A0FC0427DA / 0,1
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0427CA   "Módosított mező
                                C_ABEVAZ_A0FC0427DA
                                '0.1'.

* A0FC0428CA = A0FC0428DA / 0,03
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0428CA   "Módosított mező
                                C_ABEVAZ_A0FC0428DA
                                '0.03'.

* A0FC0429CA = A0FC0429DA / 0,01
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0429CA   "Módosított mező
                                C_ABEVAZ_A0FC0429DA
                                '0.01'.

* A0FC0430CA = A0FC0430DA / 0,015
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0430CA   "Módosított mező
                                C_ABEVAZ_A0FC0430DA
                                '0.015'.

* A0FC0431CA = A0FC0431DA / 0,04
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0431CA   "Módosított mező
                                C_ABEVAZ_A0FC0431DA
                                '0.04'.

* A0FC0434CA = A0FC0434DA / 0,15
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0434CA   "Módosított mező
                                C_ABEVAZ_A0FC0434DA
                                '0.15'.

* A0FC0435CA = A0FC0435DA / 0,25
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0435CA   "Módosított mező
                                C_ABEVAZ_A0FC0435DA
                                '0.25'.

* A0FC0436CA = A0FC0436DA / 0,2
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0436CA   "Módosított mező
                                C_ABEVAZ_A0FC0436DA
                                '0.2'.

* A0FC0437CA = A0FC0437DA / 0,11
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0437CA   "Módosított mező
                                C_ABEVAZ_A0FC0437DA
                                '0.11'.

* A0FC0438CA = A0FC0438DA / 0,111
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0438CA   "Módosított mező
                                C_ABEVAZ_A0FC0438DA
                                '0.111'.

*  A0FC0439CA = A0FC0439DA / 0,15
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0439CA   "Módosított mező
                                C_ABEVAZ_A0FC0439DA
                                '0.15'.


*--BG 2006/12/06

**ÖSSZEGZÉSEK
**A-12-322-d A 301, 302 és a 307, valamint a 311-321 sorok aladata össz.
**(kötelezettség különbözet
**A0DC0322DA
*   REFRESH LR_ABEVAZ.
*   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0301DA SPACE.
*   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0302DA SPACE.
*   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0307DA SPACE.
*   M_DEF  LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0DC0311DA C_ABEVAZ_A0DC0321DA.
*
*   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
*                                LR_ABEVAZ
*                                T_BEVALLB
*                         USING  C_ABEVAZ_A0DC0322DA.


* A0FC0412DA
* A-12-412-d Pension Commission. Total contributions due to the fund
*(obligation difference)
* A0FC0413DA+A0FC0414DA+A0FC0415DA+A0FC0416DA+A0FC0417DA
   REFRESH LR_ABEVAZ.
*++0002 BG 2006/11/29
*  M_DEF  LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0FC0413DA C_ABEVAZ_A0FC0417DA.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0413DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0414DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0415DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0416DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0417DA SPACE.
*--0002 BG 2006/11/29
   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0412DA.

* A0FC0418DA
* A-12-418-d Total contributions due to the Health Insurance Fund
*(obligation difference
* A0FC0419DA+A0FC0420DA+A0FC0421DA+A0FC0422DA+A0FC0423DA+A0FC0424DA+
* +A0FC0425DA+A0FC0426DA+A0FC0427DA
   REFRESH LR_ABEVAZ.
*++0002 BG 2006/11/29
*  M_DEF  LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0FC0419DA C_ABEVAZ_A0FC0427DA.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0419DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0420DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0421DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0422DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0423DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0424DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0425DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0426DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0427DA SPACE.
*--0002 BG 2006/11/29

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0418DA.

*++0003 BG 2006/12/06
*  412c=(413c+...+417c)
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0413CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0414CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0415CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0416CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0417CA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0412CA.


*  418c=(419c+...+427c)
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0419CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0420CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0421CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0422CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0423CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0424CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0425CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0426CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0427CA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0418CA.

*--0003 BG 2006/12/06

* A0FC0440CA
* A-12-440-c Total data for lines 411, 412 and 418, as well as 428-439.
* (basis of obligation)
* A0FC0411CA+A0FC0412CA+A0FC0418CA+A0FC0428CA+A0FC0429CA+A0FC0430CA+
*+A0FC0431CA+A0FC0432CA+A0FC0434CA+A0FC0435CA+A0FC0436CA+A0FC0437CA+
*+A0FC0438CA+A0FC0439CA
   REFRESH LR_ABEVAZ.
*++0002 BG 2006/11/29
*  M_DEF  LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0FC0411CA C_ABEVAZ_A0FC0412CA.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0411CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0412CA SPACE.
*--0002 BG 2006/11/29
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0418CA SPACE.
*++0002 BG 2006/11/29
*  M_DEF  LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0FC0428CA C_ABEVAZ_A0FC0432CA.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0428CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0429CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0430CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0431CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0432CA SPACE.
*  M_DEF  LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0FC0434CA C_ABEVAZ_A0FC0439CA.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0434CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0435CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0436CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0437CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0438CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0439CA SPACE.
*--0002 BG 2006/11/29

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0440CA.

* A0FC0440DA
* A-12-440-d Total data of lines 411, 412 and 418, as well as 428-439.
* (obligation difference
*  A0FC0411DA+A0FC0412DA+A0FC0418DA+A0FC0428DA+A0FC0429DA+A0FC0430DA+
* +A0FC0431DA+A0FC0432DA+A0FC0433DA+A0FC0434DA+A0FC0435DA+A0FC0436DA+
* +A0FC0437DA+A0FC0438DA+A0FC0439DA
   REFRESH LR_ABEVAZ.
*++0002 BG 2006/11/29*
*  M_DEF  LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0FC0411DA C_ABEVAZ_A0FC0412DA.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0411DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0412DA SPACE.
*--0002 BG 2006/11/29
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0418DA SPACE.
*++0002 BG 2006/11/29
*  M_DEF  LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0FC0428DA C_ABEVAZ_A0FC0432DA.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0428DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0429DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0430DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0431DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0432DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0433DA SPACE.
*  M_DEF  LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0FC0434DA C_ABEVAZ_A0FC0439DA.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0434DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0435DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0436DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0437DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0438DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC0439DA SPACE.
*--0002 BG 2006/11/29

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0440DA.


* A 13a Mark with an X if the corrector's declaration is a self-check
* qualifies
* A0AC032A
   LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO WHERE ABEVAZ IN LR_ABEVAZ.
     IF NOT W_/ZAK/BEVALLO-FIELD_N IS INITIAL.
       MOVE 'X' TO L_TRUE.
       EXIT.
     ENDIF.
   ENDLOOP.

   IF NOT L_TRUE IS INITIAL.
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                              WITH KEY ABEVAZ = C_ABEVAZ_A0AC032A.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE C_X TO W_/ZAK/BEVALLO-FIELD_C.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
   ENDIF.

 ENDFORM.                    " CALC_ABEV_ONREV_SZJA_06082


*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_ONREV_SZJA_0708
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$INDEX  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONREV_SZJA_0708
                           TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                   T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                   T_ADOAZON STRUCTURE /ZAK/ONR_ADOAZON
                           USING   $INDEX
                                   $LAST_DATE.

   DATA LI_LAST_BEVALLO LIKE /ZAK/BEVALLO OCCURS 0 WITH HEADER LINE.

   DATA L_LAST_INDEX LIKE /ZAK/BEVALLO-ZINDEX.
   DATA L_TABIX LIKE SY-TABIX.
   DATA L_TRUE.

   RANGES LR_ONREV_ABEVAZ FOR /ZAK/BEVALLB-ABEVAZ.
   DATA   L_ABEVAZ LIKE /ZAK/BEVALLB-ABEVAZ.

   DATA: L_KAM_KEZD TYPE DATUM,
         L_KAM_VEG  TYPE DATUM.
   DATA   L_KAMAT LIKE /ZAK/BEVALLO-FIELD_N.
   DATA   L_KAMAT_SUM LIKE /ZAK/BEVALLO-FIELD_N.

*  To upload fields to be summarized
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.

*  If self-revision
   CHECK $INDEX NE '000'.

   SORT T_BEVALLB BY ABEVAZ.

*  Let's read the 'A' abev identifiers of the previous period
   READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO INDEX 1.
   CHECK SY-SUBRC EQ 0.
   L_LAST_INDEX = $INDEX - 1.

   CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
     EXPORTING
       INPUT  = L_LAST_INDEX
     IMPORTING
       OUTPUT = L_LAST_INDEX.


   SELECT * INTO TABLE LI_LAST_BEVALLO
                 FROM  /ZAK/BEVALLO
                WHERE  BUKRS   EQ W_/ZAK/BEVALLO-BUKRS
                  AND  BTYPE   EQ W_/ZAK/BEVALLO-BTYPE
                  AND  GJAHR   EQ W_/ZAK/BEVALLO-GJAHR
                  AND  MONAT   EQ W_/ZAK/BEVALLO-MONAT
                  AND  ZINDEX  EQ L_LAST_INDEX
                  AND  ADOAZON EQ ''.

   SORT LI_LAST_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ.

*  We delete records that are not in the given period
*  adtak fel.
   LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                     WHERE NOT ADOAZON IS INITIAL.
     READ TABLE T_ADOAZON WITH KEY ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                                   BINARY SEARCH.
*    Nem kell a rekord.
     IF SY-SUBRC NE 0.
       DELETE T_BEVALLO.
       CONTINUE.
     ENDIF.
*  M 11 Mark with H if your declaration is considered a correction
     IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_M0AC018A.
*++BG 2007.03.22 Az ABEV program hibát jelez a "H"-ra "X"-el kell
*to fill out
*      MOVE 'H' TO W_/ZAK/BEVALLO-FIELD_C.
       MOVE C_X TO W_/ZAK/BEVALLO-FIELD_C.
*--BG 2007.03.22
     ENDIF.
*    A00-016-000-e Repeated self-check
     IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_A0AC036A AND
        $INDEX > '001'.
       MOVE C_X TO W_/ZAK/BEVALLO-FIELD_C.
     ENDIF.
     MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO.
   ENDLOOP.

   SORT T_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ.

*  Mark 13a with an X if your return is considered a correction
   READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0AC032A.
   IF SY-SUBRC EQ 0.
     MOVE SY-TABIX TO L_TABIX.
     MOVE 'X' TO W_/ZAK/BEVALLO-FIELD_C.
     MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
   ENDIF.

**  Számítási algoritmus ÖNREVÍZIÓHOZ:

*A0HC0240DA
*07-241-c Pension Commission. Total contributions due to the fund (fund
*difference)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0240DA   "Módosított mező
                                 C_ABEVAZ_A0BC0001CA        "Forrás 1
                                 C_ABEVAZ_A0CC0027CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5


*A0HC0243CA
*A 07-243-c From line 241, the pension commission charged to the employer. contribution
*(18%) (base difference)
   PERFORM GET_CLEAR_ABEVAZ TABLES T_BEVALLO
                                   T_BEVALLB
                             USING C_ABEVAZ_A0HC0243CA.
*A0HC0243DA
*A 07-243-d From line 241, the pension commission charged to the employer. contribution
*(18%) (obligation difference
   PERFORM GET_CLEAR_ABEVAZ TABLES T_BEVALLO
                                   T_BEVALLB
                             USING C_ABEVAZ_A0HC0243DA.

*A0HC0244DA
*A 07-244-d From line 241, the pension commission charged to the employer. contribution
*(21%) (obligation difference
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0244DA   "Módosított mező
                                 C_ABEVAZ_A0DC0122CA        "Forrás 1
                                 C_ABEVAZ_A0CC0040CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5


*A 07-244-c From line 241, the pension commission charged to the employer. contribution
*(21%) (base difference)
* A0HC0244CA = A0HC0244DA value / 21%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0244CA   "Módosított mező
                                C_ABEVAZ_A0HC0244DA
                                '0.21'.



*A0HC0245DA
*A 07-245-d Pension contribution deducted from the insured person from line 241 (8.5%)
*(obligation difference
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0245DA   "Módosított mező
                                 C_ABEVAZ_A0DC0123CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0245CA
*A 07-245-c Pension contribution deducted from the insured person from line 241 (8.5%)
*(base difference)
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0245CA   "Módosított mező
                                C_ABEVAZ_A0HC0245DA
                                '0.085'.

*A0HC0246DA
*A 07-246-d Pension contribution deducted from the insured person from line 241 (0.5%)
*(obligation difference
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0246DA   "Módosított mező
                                 C_ABEVAZ_A0DC0124CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0246CA
*A0HC0246DA value / 0.5%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0246CA   "Módosított mező
                                C_ABEVAZ_A0HC0246DA
                                '0.005'.


*A0HC0247DA
*A 07-247-d Pension contribution paid after service fee from line 241
*(15%) (obligation difference
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0247DA   "Módosított mező
                                 C_ABEVAZ_A0DC0125CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0247CA
*A0HC0247DA value / 15%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0247CA   "Módosított mező
                                C_ABEVAZ_A0HC0247DA
                                '0.15'.




*A0HC0241CA
*07-241-c Pension Commission. Total contributions due to the fund (fund
*difference)
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0242CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0243CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0244CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0245CA SPACE.
*++BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0246CA SPACE.
*--BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0247CA SPACE.
   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0241CA.

*A0HC0241DA
*07-241-d Pension Commission. Total contributions due to the fund
*(obligation difference)
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0242DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0243DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0244DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0245DA SPACE.
*++BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0246DA SPACE.
*--BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0247DA SPACE.
   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0241DA.



*A0HC0250DA
*A 07-250-d From line 248, the employer's health insurance. contribution
*(11%) (obligation separately
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0250DA   "Módosított mező
                                 C_ABEVAZ_A0DC0132CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0250CA
*of A0HC0250DA value / 11%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0250CA   "Módosított mező
                                C_ABEVAZ_A0HC0250DA
                                '0.11'.

*A0HC0251DA
*A 07-251-d From line 248 in kind for the employer
*eg.committee contribution (7%) (excl. obligation)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0251DA   "Módosított mező
                                 C_ABEVAZ_A0DC0133CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0251CA
*of A0HC0251DA value / 7%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0251CA   "Módosított mező
                                C_ABEVAZ_A0HC0251DA
                                '0.07'.

*A0HC0252DA
*A 07-252-d From line 248, in kind charged to the employer
*eg.committee contribution (5%) (excl. obligation)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0252DA   "Módosított mező
                                 C_ABEVAZ_A0DC0135CA        "Forrás 1
                                 C_ABEVAZ_A0CC0041CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0252CA
*of A0HC0252DA value / 5%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0252CA   "Módosított mező
                                C_ABEVAZ_A0HC0252DA
                                '0.05'.

*A0HC0253DA
*A 07-253-d From line 248, the employer's financial insurance.
*contribution (4%) (vol. misc.)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0253DA   "Módosított mező
                                 C_ABEVAZ_A0DC0134CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0253CA
*of A0HC0253DA value / 4%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0253CA   "Módosított mező
                                C_ABEVAZ_A0HC0253DA
                                '0.04'.

*A0HC0254DA
*A 07-254-d From line 248, the employer's financial insurance.
*contribution (3%) (vol. misc.)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0254DA   "Módosított mező
                                 C_ABEVAZ_A0DC0136CA        "Forrás 1
                                 C_ABEVAZ_A0CC0042CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0254CA
*of A0HC0254DA value / 3%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0254CA   "Módosított mező
                                C_ABEVAZ_A0HC0254DA
                                '0.03'.
*A0HC0255DA
*A 07-255-d The health insurance contribution deducted from the insured person from line 248
*(4%) (obligation separately
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0255DA   "Módosított mező
                                 C_ABEVAZ_A0DC0137CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0255CA
*of A0HC0255DA value / 4%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0255CA   "Módosított mező
                                C_ABEVAZ_A0HC0255DA
                                '0.04'.

*A0HC0256DA
*Deducted from line 248 of 07-256-d from the insured
*contribution to the Productivity Commission (4%) (separate liability
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0256DA   "Módosított mező
                                 C_ABEVAZ_A0DC0138CA        "Forrás 1
                                 C_ABEVAZ_A0DC0140CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0256CA
*of A0HC0256DA value / 4%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0256CA   "Módosított mező
                                C_ABEVAZ_A0HC0256DA
                                '0.04'.

*A0HC0257DA
*A 07-257-d In cash deducted from the insured from line 248
*health insurance contribution (2%) (separate obligation
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0257DA   "Módosított mező
                                 C_ABEVAZ_A0DC0139CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0257CA
*of A0HC0257DA value / 2%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0257CA   "Módosított mező
                                C_ABEVAZ_A0HC0257DA
                                '0.02'.
*A0HC0258DA
*A 07-258-d In cash deducted from the insured from line 248
*health insurance contribution (3%) (separate obligation
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0258DA   "Módosított mező
                                 C_ABEVAZ_A0DC0141CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0258CA
*of A0HC0258DA value / 3%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0258CA   "Módosított mező
                                C_ABEVAZ_A0HC0258DA
                                '0.03'.

*A0HC0259DA
*A 07-259-d From line 248, the accident contribution charged to the social enterprise
*(5%) (obligation otherwise
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0259DA   "Módosított mező
                                 C_ABEVAZ_A0DC0142CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0259CA
*of A0HC0259DA value / 5%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0259CA   "Módosított mező
                                C_ABEVAZ_A0HC0259DA
                                '0.05'.

*A0HC0248CA
*Total contributions due to the Health Insurance Fund 07-248-c (fund
*difference)
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0249CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0250CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0251CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0252CA SPACE.
*++BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0253CA SPACE.
*--BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0254CA SPACE.
*++BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0255CA SPACE.
*--BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0256CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0257CA SPACE.
*++BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0258CA SPACE.
*--BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0259CA SPACE.
*++BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0260CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0261CA SPACE.
*--BG 2007.03.22



   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0248CA.

*A0HC0248DA
*Total contributions due to the Health Insurance Fund 07-248-d
*(obligation difference
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0249DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0250DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0251DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0252DA SPACE.
*++BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0253DA SPACE.
*--BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0254DA SPACE.
*++BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0255DA SPACE.
*--BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0256DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0257DA SPACE.
*++BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0258DA SPACE.
*--BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0259DA SPACE.
*++BG 2007.03.22
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0260DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0261DA SPACE.
*--BG 2007.03.22


   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0248DA.


*A0HC0261DA
*A 07-261-d From line 248, the accident contribution charged to the social enterprise
*(obligation otherwise
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0261DA   "Módosított mező
                                 C_ABEVAZ_A0DC0143CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5



*A0IC0262DA
*A 08-262-d Employer's contribution (difference in liability)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0262DA   "Módosított mező
                                 C_ABEVAZ_A0BC0007CA        "Forrás 1
                                 C_ABEVAZ_A0CC0039CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*++BG 2007.03.22
*A0IC0262CA
* Employer contribution
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC0262CA   "Módosított mező
                                C_ABEVAZ_A0IC0262DA
                                '0.03'.
*--BG 2007.03.22

*A0IC0263DA
*A 08-263-d Employee contribution (1%) (difference in liability)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0263DA   "Módosított mező
                                 C_ABEVAZ_A0EC0152CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0IC0263CA
*of A0IC0263DA value / 1%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC0263CA   "Módosított mező
                                C_ABEVAZ_A0IC0263DA
                                '0.01'.

*A0IC0264DA
*Employee contribution 08-264-d (1.5%) (difference in liability)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0264DA   "Módosított mező
                                 C_ABEVAZ_A0EC0153CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0IC0264CA
*of A0IC0264DA value / 1.5%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC0264CA   "Módosított mező
                                C_ABEVAZ_A0IC0264DA
                                '0.015'.

*A0IC0265DA
*A 08-265-d Entrepreneur's contribution (difference in liability)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0265DA   "Módosított mező
                                 C_ABEVAZ_A0BC0009CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0IC0265CA
*of A0IC0265DA value / 4%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
              T_BEVALLB
       USING  C_ABEVAZ_A0IC0265CA   "Módosított mező
              C_ABEVAZ_A0IC0265DA
              '0.04'.

*A0IC0266DA
*A 08-266-d Percentage health contribution (obligation
*difference)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0266DA   "Módosított mező
                                 C_ABEVAZ_A0BC0010CA        "Forrás 1
                                 C_ABEVAZ_A0CC0043CA        "Forrás 2
                                 C_ABEVAZ_A0CC0044CA        "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5



*A0IC0267DA
*08-267-d Itemized medical contribution (obligation
*difference)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0267DA   "Módosított mező
                                 C_ABEVAZ_A0BC0011CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0IC0268DA
*08-268-d A 15% charge for START card holders.
*(obligation difference)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0268DA   "Módosított mező
                                 C_ABEVAZ_A0EC0155CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0IC0268CA
*of the value of A0IC0268DA / 15%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
              T_BEVALLB
       USING  C_ABEVAZ_A0IC0268CA   "Módosított mező
              C_ABEVAZ_A0IC0268DA
              '0.15'.

*A0IC0269DA
*08-269-d A 25% contract for START card holders.
*(obligation difference)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0269DA   "Módosított mező
                                 C_ABEVAZ_A0EC0156CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0IC0269CA
*of the value of A0IC0269DA / 25%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
              T_BEVALLB
       USING  C_ABEVAZ_A0IC0269CA   "Módosított mező
              C_ABEVAZ_A0IC0269DA
              '0.25'.

*A0IC0270DA
*The 08-270-d A simplified public burden burdening the payer.
*20% (obligation difference
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0270DA   "Módosított mező
                                 C_ABEVAZ_A0EC0159CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0IC0270CA
*of the value of A0IC0270DA / 20%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
              T_BEVALLB
       USING  C_ABEVAZ_A0IC0270CA   "Módosított mező
              C_ABEVAZ_A0IC0270DA
              '0.20'.

*A0IC0271DA
*The 08-271-d A simplified public burden burdening private no.
*11% (obligation difference
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0271DA   "Módosított mező
                                 C_ABEVAZ_A0EC0160CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0IC0271CA
*of the value of A0IC0271DA / 11%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
              T_BEVALLB
       USING  C_ABEVAZ_A0IC0271CA   "Módosított mező
              C_ABEVAZ_A0IC0271DA
              '0.11'.

*A0IC0272DA
*The 08-272-d A ​​simplified public burden burdening private no.
*11.1% (obligation difference
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0272DA   "Módosított mező
                                 C_ABEVAZ_A0EC0161CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0IC0272CA
*of A0IC0272DA value / 11.1%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
              T_BEVALLB
       USING  C_ABEVAZ_A0IC0272CA   "Módosított mező
              C_ABEVAZ_A0IC0272DA
              '0.111'.

*A0IC0273DA
*A 08-273-d A chargeable to the private sector - not mnyptár - EKHO 15% (obligation
*difference)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0273DA   "Módosított mező
                                 C_ABEVAZ_A0EC0162CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0IC0273CA
*of the value of A0IC0273DA / 15%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
              T_BEVALLB
       USING  C_ABEVAZ_A0IC0273CA   "Módosított mező
              C_ABEVAZ_A0IC0273DA
              '0.15'.

*A0IC0274DA
*A 08-274-d A mnyptár member charged to private member - EKHO 15% (obligation
*difference)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0274DA   "Módosított mező
                                 C_ABEVAZ_A0EC0163CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0IC0274CA
*of the value of A0IC0274DA / 15%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
              T_BEVALLB
       USING  C_ABEVAZ_A0IC0274CA   "Módosított mező
              C_ABEVAZ_A0IC0274DA
              '0.15'.

*++BG 2007.04.05
*A0IC50068A
*Calculation of special tax
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC50068A   "Módosított mező
                                 C_ABEVAZ_A0BC0002CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*--BG 2007.04.05

*++CST 2007.04.11
*A0IC50067A
*Calculation of the special tax base
*of A0IC50068A / 4%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC50067A   "Módosított mező
                                C_ABEVAZ_A0IC50068A
                                '0.04'.

*--CST 2007.04.11

*++BG 2008/01/14
* 15% for holders of the 08-276-d A START PLUSZ card
* size vol. (obligation otherwise)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC50072A   "Módosított mező
                                 C_ABEVAZ_A0EC50071A        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*The 08-276-c is 15% for holders of the START PLUSZ card
* size vol. (basis of obligation)
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC50073A   "Módosított mező
                                C_ABEVAZ_A0IC50072A
                                '0.15'.

*08-277-d 25% for holders of the START PLUSZ card
*size vol. (obligation otherwise)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC50074A   "Módosított mező
                                 C_ABEVAZ_A0EC50070A        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*08-277-c 25% for START PLUS card holders
*size vol. (basis of obligation)
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC50075A   "Módosított mező
                                C_ABEVAZ_A0IC50074A
                                '0.25'.

* 08-278-d 15% for holders of the START EXTRA card
* size vol. (obligation otherwise)
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC50076A   "Módosított mező
                                 C_ABEVAZ_A0EC50069A        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5


*The 08-278-c is 15% for holders of the START EXTRA card
*size vol. (basis of obligation)
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC50076A   "Módosított mező
                                C_ABEVAZ_A0IC50075A
                                '0.15'.

*--BG 2008/01/14


*A0IC0275CA
*++0004 BG 2007.04.04
*08-275-c Total data of lines 240, 241 and 248, as well as 262-275.
*(basis of obligation
*--0004 BG 2007.04.04
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0240CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0241CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0248CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0262CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0263CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0264CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0265CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0266CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0268CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0269CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0270CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0271CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0272CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0273CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0274CA SPACE.
*++0004 BG 2007.04.04
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC50067A SPACE.
*--0004 BG 2007.04.04
*++BG 2008/01/14
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC50073A SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC50075A SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC50077A SPACE.
*--BG 2008/01/14


   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC0275CA.

*A0IC0275DA
*++0004 BG 2007.04.04
*08-275-c Total data of lines 240, 241 and 248, as well as 262-274.
*(commitment difference)
*--0004 BG 2007.04.04
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0240DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0241DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0248DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0262DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0263DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0264DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0265DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0266DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0267DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0268DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0269DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0270DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0271DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0272DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0273DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0274DA SPACE.
*++0004 BG 2007.04.04
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC50068A SPACE.
*--0004 BG 2007.04.04
*++BG 2008/01/14
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC50072A SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC50074A SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC50076A SPACE.
*--BG 2008/01/14


   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC0275DA.


* A 14a Mark with an X if the corrector's declaration is a self-check
* qualifies
* A0AC033A
   LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO WHERE ABEVAZ IN LR_ABEVAZ.
     IF NOT W_/ZAK/BEVALLO-FIELD_N IS INITIAL.
       MOVE 'X' TO L_TRUE.
       EXIT.
     ENDIF.
   ENDLOOP.

   IF NOT L_TRUE IS INITIAL.
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                              WITH KEY ABEVAZ = C_ABEVAZ_A0AC033A.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE C_X TO W_/ZAK/BEVALLO-FIELD_C.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
   ENDIF.


*A0ID0281BA
*08-281-b Self-inspection supplement based on Art. 28/B §
   PERFORM GET_CLEAR_ABEVAZ TABLES T_BEVALLO
                                   T_BEVALLB
                             USING C_ABEVAZ_A0ID0281BA.

*A0ID0282BA
*The 08-282-b Self-inspection allowance in total (line 280+281)
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0ID0281BA SPACE.
*++FI 20070309
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0ID0280BA SPACE.
*--FI 20070309

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ID0282BA.

*++BG 2007/01/21
*  A0BC0012CA
*  It must be aggregated here as well because at the aggregator ABEVAZ
*  no value yet.
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0155CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0156CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC50070A SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC50071A SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0BC0012CA.

*--BG 2007/01/21


 ENDFORM.                    " CALC_ABEV_ONREV_SZJA_0708


*&---------------------------------------------------------------------
*
*&      Form  CALC_ABEV_ONREV_SZJA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$INDEX  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONREV_POTL_SZJA TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                        T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                        T_ADOAZON STRUCTURE
                                                   /ZAK/ONR_ADOAZON
                                 USING   $INDEX
                                         $LAST_DATE.

   DATA LI_LAST_BEVALLO LIKE /ZAK/BEVALLO OCCURS 0 WITH HEADER LINE.
   DATA L_LAST_INDEX LIKE /ZAK/BEVALLO-ZINDEX.
   DATA L_TABIX LIKE SY-TABIX.
   DATA L_TRUE.

   RANGES LR_ONREV_ABEVAZ FOR /ZAK/BEVALLB-ABEVAZ.
   DATA   L_ABEVAZ LIKE /ZAK/BEVALLB-ABEVAZ.

   DATA: L_KAM_KEZD TYPE DATUM,
         L_KAM_VEG  TYPE DATUM.
   DATA: L_KAM_KEZD_TEMP TYPE DATUM,
         L_KAM_VEG_TEMP  TYPE DATUM.

   DATA   L_KAMAT LIKE /ZAK/BEVALLO-FIELD_N.
   DATA   L_KAMAT_SUM LIKE /ZAK/BEVALLO-FIELD_N.

*++2009.11.09 BG (Ness)
   DATA: BEGIN OF LI_KAMAT OCCURS 0,
           BUKRS     TYPE BUKRS,
           ZINDEX    TYPE /ZAK/INDEX,
           ADONEM    TYPE /ZAK/ADON_ONR,
           FIELD_NRK TYPE /ZAK/FIELDNRK,
*++2408 #03.
           KAMAT     TYPE /ZAK/FIELDN,
           ABEVAZ    TYPE /ZAK/ABEVAZ,
*--2408 #03.
         END OF LI_KAMAT.
*--2009.11.09 BG (Ness)
*++2408 #03.
   DATA LI_ADONEM_ONR TYPE STANDARD TABLE OF /ZAK/ADONEM_ONR INITIAL SIZE 0.
   DATA LS_ADONEM_ONR TYPE /ZAK/ADONEM_ONR.

   DATA: BEGIN OF LI_KAMAT_ABEV OCCURS 0,
           ABEVAZ TYPE /ZAK/ABEVAZ,
           KAMAT  TYPE /ZAK/FIELDN,
         END OF LI_KAMAT_ABEV.
*--2408 #03.

* Defining a macro for range upload
*   DEFINE M_DEF.
*     MOVE: 'I'     TO &1-SIGN,
*           &2      TO &1-OPTION,
*           &3      TO &1-LOW,
*           &4      TO &1-HIGH.
*     APPEND &1.
*   END-OF-DEFINITION.

*  To upload fields to be summarized
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.


*  If self-revision and SZJA
   CHECK $INDEX NE '000' AND W_/ZAK/BEVALL-BTYPART EQ C_BTYPART_SZJA.

*  Determination of self-auditing allowances
*  Determination of self-revision ABEV identifiers
   REFRESH LR_ONREV_ABEVAZ.
   CLEAR   LR_ONREV_ABEVAZ.

   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
                    WHERE NOT ADONEM_ONR IS INITIAL
*++BG 2008.03.10
*  We only charge a self-revision allowance where it is checked
*  because from 0808 there is a self-auditing tax type where HR submits
*  but that is already a calculated allowance, so with the old principle a
*  we would also expect an allowance for an allowance.
                      AND NOT ONRPOTL IS INITIAL
*--BG 2008.03.10
                    .
     M_DEF LR_ONREV_ABEVAZ 'I' 'EQ' W_/ZAK/BEVALLB-ABEVAZ SPACE.
   ENDLOOP.

* determining the deadline for calculating the allowance! the 103
* I don't need a tax for the /ZAK/ADONEM table key !!
   SELECT SINGLE FIZHAT INTO W_/ZAK/ADONEM-FIZHAT FROM /ZAK/ADONEM
*++ FI 20070312
*                         WHERE BUKRS  EQ W_/ZAK/BEVALLO-BUKRS AND
                         WHERE BUKRS  EQ W_/ZAK/BEVALL-BUKRS AND
*-- FI 20070312
                                          ADONEM EQ C_ADONEM_103.
   IF SY-SUBRC EQ 0.
* start date of allowance calculation
     CLEAR L_KAM_KEZD.
     L_KAM_KEZD = $LAST_DATE + 1 + W_/ZAK/ADONEM-FIZHAT.
   ENDIF.

* the end date of allowance calculation is the ABEV identifier specified in ESDAT_FLAG
* value
   READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                       WITH KEY  ESDAT_FLAG = 'X'.
   IF SY-SUBRC EQ 0.
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                         WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
     IF SY-SUBRC EQ 0.
       CLEAR L_KAM_VEG.

*       CALL FUNCTION 'CONVERSION_EXIT_IDATE_INPUT'
*            EXPORTING
*                 INPUT  = W_/ZAK/BEVALLO-FIELD_C
*            IMPORTING
*                 OUTPUT = L_KAM_VEG.

       CALL FUNCTION 'CONVERT_DATE_TO_INTERNAL'
         EXPORTING
           DATE_EXTERNAL            = W_/ZAK/BEVALLO-FIELD_C
         IMPORTING
           DATE_INTERNAL            = L_KAM_VEG
         EXCEPTIONS
           DATE_EXTERNAL_IS_INVALID = 1
           OTHERS                   = 2.
       IF SY-SUBRC <> 0.
         IF SY-BATCH IS INITIAL.
           MESSAGE I179(/ZAK/ZAK) WITH W_/ZAK/BEVALLO-FIELD_C.
*        Error when converting the self-revision due date! (&)
         ELSE.
           MESSAGE E179(/ZAK/ZAK) WITH W_/ZAK/BEVALLO-FIELD_C.
*        Error when converting the self-revision due date! (&)
         ENDIF.
         EXIT.
       ENDIF.
*++2012.01.06 BG
*       L_KAM_VEG = L_KAM_VEG - 15 .
*--2012.01.06 BG
     ENDIF.
   ENDIF.

*  Interest calculation
*++2009.11.09 BG (Ness)
*  Lines with the value '-' on the line must also be taken into account
*  but overall '+'. Therefore, we first collect them by tax type
*  the values ​​and if it is '+', then we calculate the interest.
*   CLEAR L_KAMAT_SUM.
*   LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
*                    WHERE ABEVAZ IN LR_ONREV_ABEVAZ
*                      AND FIELD_N > 0.
*
*     CLEAR: L_KAMAT, L_KAM_KEZD_TEMP, L_KAM_VEG_TEMP.
*     MOVE L_KAM_KEZD TO L_KAM_KEZD_TEMP.
*     MOVE L_KAM_VEG  TO L_KAM_VEG_TEMP.
*
*     PERFORM CALC_POTLEK USING    W_/ZAK/BEVALLO-BUKRS
*                                  W_/ZAK/BEVALLO-ZINDEX
*                         CHANGING L_KAM_KEZD_TEMP
*                                  L_KAM_VEG_TEMP
*                                  W_/ZAK/BEVALLO-FIELD_N
*                                  L_KAMAT.
*     ADD L_KAMAT TO L_KAMAT_SUM.
*   ENDLOOP.

   LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                     WHERE ABEVAZ IN LR_ONREV_ABEVAZ
                      AND  NOT FIELD_NRK IS INITIAL.
     READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                           WITH KEY ABEVAZ = W_/ZAK/BEVALLO-ABEVAZ.
     IF SY-SUBRC EQ 0.
       CLEAR LI_KAMAT.
       LI_KAMAT-BUKRS     = W_/ZAK/BEVALLO-BUKRS.
       LI_KAMAT-ZINDEX    = W_/ZAK/BEVALLO-ZINDEX.
       LI_KAMAT-ADONEM    = W_/ZAK/BEVALLB-ADONEM_ONR.
       LI_KAMAT-FIELD_NRK = W_/ZAK/BEVALLO-FIELD_NRK.
       COLLECT LI_KAMAT.
     ENDIF.
   ENDLOOP.
*++2408 #03.
*  Let's read the tax-exempt ABEV assignment
   IF LI_ADONEM_ONR[] IS INITIAL AND NOT W_/ZAK/BEVALLO-BTYPE IS INITIAL.
     SELECT * INTO TABLE LI_ADONEM_ONR
              FROM /ZAK/ADONEM_ONR
             WHERE BTYPE EQ  W_/ZAK/BEVALLO-BTYPE.
   ENDIF.
*--2408 #03.
   CLEAR L_KAMAT_SUM.
   LOOP AT LI_KAMAT WHERE FIELD_NRK > 0.
     CLEAR: L_KAMAT, L_KAM_KEZD_TEMP, L_KAM_VEG_TEMP.
     MOVE L_KAM_KEZD TO L_KAM_KEZD_TEMP.
     MOVE L_KAM_VEG  TO L_KAM_VEG_TEMP.

     PERFORM CALC_POTLEK USING    LI_KAMAT-BUKRS
                                  LI_KAMAT-ZINDEX
                         CHANGING L_KAM_KEZD_TEMP
                                  L_KAM_VEG_TEMP
                                  LI_KAMAT-FIELD_NRK
                                  L_KAMAT.
     ADD L_KAMAT TO L_KAMAT_SUM.
*++2408 #03.
     LI_KAMAT-KAMAT = L_KAMAT.
     MODIFY LI_KAMAT.
     READ TABLE LI_ADONEM_ONR INTO LS_ADONEM_ONR
                        WITH KEY ADONEM_ONR = LI_KAMAT-ADONEM.
     IF SY-SUBRC EQ 0.
       LI_KAMAT_ABEV-ABEVAZ = LS_ADONEM_ONR-ABEVAZ.
       LI_KAMAT_ABEV-KAMAT  = L_KAMAT.
       COLLECT LI_KAMAT_ABEV.
     ENDIF.
*--2408 #03.
   ENDLOOP.
*--2009.11.09 BG (Ness)

*++BG 2006/09/22
   IF W_/ZAK/BEVALL-BTYPE EQ C_0608.
*--BG 2006/09/22

*  writeback of interest
*  A-12-323-b Amount of self-check allowance
*A0DD0323BA
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0DD0323BA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0DD0323BA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*++BG 2006/09/22
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_06082.
* A0FD0441BA
*  A-12-441-b Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0FD0441BA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0FD0441BA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_0708.
* A0ID0280BA
*  A-08-280-b Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0ID0280BA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0ID0280BA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*++ FI 20070312
*A0ID0282BA
*The 08-282-b Self-inspection allowance in total (line 280+281)
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0ID0281BA SPACE.
*++FI 20070309
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0ID0280BA SPACE.
*--FI 20070309

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  C_ABEVAZ_A0ID0282BA.
*++BG 2008.03.06
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_0808.
* A0ID0270BA
*  A-08-280-b Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0ID0270BA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0ID0270BA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*A0ID0272BA
*The 08-282-b Self-inspection allowance in total (line 270+271)
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0ID0270BA SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0ID0271BA SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  C_ABEVAZ_A0ID0272BA.

*++ FI 20070312
*++0908 2009.01.20 BG
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_0908.
* A0ID0270BA
*  A-08-280-b Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0HD0270BA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0HD0270BA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*A0ID0272BA
*The 08-282-b Self-inspection allowance in total (line 270+271)
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HD0270BA SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HD0271BA SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  C_ABEVAZ_A0HD0272BA.


*--0908 2009.01.20 BG
*++1008 2010.01.20 BG
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1008.
*    A0HD0220BA
*    A-08-280-b Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0HD0220BA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0HD0220BA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*    A0HD0222BA
*    Total self-check allowance
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HD0220BA SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HD0221BA SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  C_ABEVAZ_A0HD0222BA.
*--1008 2010.01.20 BG
*++1108 2010.01.24 BG
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1108.
*    A0HD0210BA
*    A-08-280-b Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0HD0210CA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0HD0210CA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*    A0HD0212CA
*    Total self-check allowance
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HD0210CA SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HD0211CA SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  C_ABEVAZ_A0HD0212CA.
*--1108 2010.01.24 BG
*++1208 2012.02.01 BG
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1208.
*    A0FD0160CA
*    A-08-280-b Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0FD0160CA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0FD0160CA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*    A0FD0162CA
*    Total self-check allowance
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FD0160CA SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FD0161CA SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  C_ABEVAZ_A0FD0162CA.
*--1208 2012.02.01 BG
*++1308 2013.02.05 BG
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1308.
*    A0FD0160CA
*    A-08-280-b Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0GC0190CA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0GC0190CA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*    A0FD0162CA
*    Total self-check allowance
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0190CA SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0191CA SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  C_ABEVAZ_A0GC0192CA.
*--1308 2013.02.05 BG
*++1408 #02. 2014.03.05 BG
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1408.
*    Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0HC0190CA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0HC0190CA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*    Total self-check allowance
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0190CA SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0191CA SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  C_ABEVAZ_A0HC0192CA.

*--1408 #02. 2014.03.05 BG
*++1508 #01. 2015.02.02
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1508.
*    Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0HC0190CA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0HC0190CA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*    Total self-check allowance
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0190CA SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0191CA SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  C_ABEVAZ_A0HC0192CA.

*--1508 #01. 2015.02.02
*++1608 #01. 2015.02.01
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1608.
*    Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0HC0240CA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0HC0240CA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*    Total self-check allowance
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0240CA SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0241CA SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  C_ABEVAZ_A0HC0242CA.
*--1608 #01. 2015.02.01
*++1708 #01. 2017.01.31
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1708.
*    Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0HC0240CA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0HC0240CA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*    Total self-check allowance
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0240CA SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0241CA SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  C_ABEVAZ_A0HC0242CA.
*--1708 #01. 2017.01.31
*++1808 #01. 2018.01.30
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1808.
*    Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0HC0240CA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0HC0240CA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*    Total self-check allowance
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0240CA SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0241CA SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  C_ABEVAZ_A0HC0242CA.
*--1808 #01. 2018.01.30
*++1908 #01. 2019.01.29
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_1908.
*    Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0IC0240CA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0IC0240CA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*    Total self-check allowance
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0240CA SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0241CA SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  C_ABEVAZ_A0IC0242CA.
*--1908 #01. 2019.01.29
*++2008 #01. 2020.01.27
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_2008.
*    Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0IC0240CA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0IC0240CA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*    Total self-check allowance
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0240CA SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0IC0241CA SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  C_ABEVAZ_A0IC0242CA.

*--2008 #01. 2020.01.27
*++2108 #01.
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_2108.
*    Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0JC0240CA.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0JC0240CA
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*    Total self-check allowance
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0JC0240CA SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0JC0241CA SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  C_ABEVAZ_A0JC0242CA.
*--2108 #01.
*++2208 #01.
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_2208.
*    Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
*++2208 #07.
*                            WITH KEY ABEVAZ = 'A0IC0241CA'.
                             WITH KEY ABEVAZ = 'A0IC0240CA'.
*--2208 #07.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = 'A0IC0240CA'
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*    Total self-check allowance
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' 'A0IC0240CA' SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' 'A0IC0241CA' SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  'A0IC0242CA'.
*--2208 #01.
*++2308 #08.
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_2308.
*    Amount of self-check allowance
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = 'A0HC0240CA'.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = 'A0HC0240CA'
                            BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*    Total self-check allowance
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' 'A0HC0240CA' SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' 'A0HC0241CA' SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  'A0HC0242CA'.
*--2308 #08.
*++2408 #02.
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_2408.
*    Amount of self-check allowance
*++2408 #03.
     IF LI_KAMAT_ABEV[] IS INITIAL.
       CLEAR LI_KAMAT_ABEV.
       LI_KAMAT_ABEV-ABEVAZ = 'A0HC0240CA'.
       LI_KAMAT_ABEV-KAMAT  = L_KAMAT_SUM.
       APPEND LI_KAMAT_ABEV.
     ENDIF.
*     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
*                             WITH KEY ABEVAZ = 'A0HC0240CA'.
*     IF SY-SUBRC EQ 0.
*       MOVE SY-TABIX TO L_TABIX.
*       MOVE L_KAMAT_SUM TO W_/ZAK/BEVALLO-FIELD_N.
*
*       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
*                            WITH KEY ABEVAZ = 'A0HC0240CA'
*                            BINARY SEARCH.
*       IF SY-SUBRC EQ 0.
*         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
*                      W_/ZAK/BEVALLB-ROUND
*                      W_/ZAK/BEVALLO-WAERS
*             CHANGING W_/ZAK/BEVALLO-FIELD_NR
*                      W_/ZAK/BEVALLO-FIELD_NRK.
*       ENDIF.
*
*       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
*     ENDIF.
     LOOP AT LI_KAMAT_ABEV.
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                               WITH KEY ABEVAZ = LI_KAMAT_ABEV-ABEVAZ.
       IF SY-SUBRC EQ 0.
         MOVE SY-TABIX TO L_TABIX.
         MOVE LI_KAMAT_ABEV-KAMAT TO W_/ZAK/BEVALLO-FIELD_N.

         READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                              WITH KEY ABEVAZ = LI_KAMAT_ABEV-ABEVAZ
                              BINARY SEARCH.
         IF SY-SUBRC EQ 0.
           PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                        W_/ZAK/BEVALLB-ROUND
                        W_/ZAK/BEVALLO-WAERS
               CHANGING W_/ZAK/BEVALLO-FIELD_NR
                        W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.

         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
       ENDIF.
     ENDLOOP.
*--2408 #03.

*    Total self-check allowance
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' 'A0HC0240CA' SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' 'A0HC0241CA' SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  'A0HC0242CA'.
*--2408 #02.
*++2508 #02.
   ELSEIF W_/ZAK/BEVALL-BTYPE EQ C_2508.
*    Amount of self-check allowance
     IF LI_KAMAT_ABEV[] IS INITIAL.
       CLEAR LI_KAMAT_ABEV.
       LI_KAMAT_ABEV-ABEVAZ = 'A0IC0240CA'.
       LI_KAMAT_ABEV-KAMAT  = L_KAMAT_SUM.
       APPEND LI_KAMAT_ABEV.
     ENDIF.
     LOOP AT LI_KAMAT_ABEV.
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                               WITH KEY ABEVAZ = LI_KAMAT_ABEV-ABEVAZ.
       IF SY-SUBRC EQ 0.
         MOVE SY-TABIX TO L_TABIX.
         MOVE LI_KAMAT_ABEV-KAMAT TO W_/ZAK/BEVALLO-FIELD_N.

         READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                              WITH KEY ABEVAZ = LI_KAMAT_ABEV-ABEVAZ
                              BINARY SEARCH.
         IF SY-SUBRC EQ 0.
           PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                        W_/ZAK/BEVALLB-ROUND
                        W_/ZAK/BEVALLO-WAERS
               CHANGING W_/ZAK/BEVALLO-FIELD_NR
                        W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.

         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
       ENDIF.
     ENDLOOP.
*    Total self-check allowance
     REFRESH LR_ABEVAZ.
     M_DEF  LR_ABEVAZ 'I' 'EQ' 'A0IC0240CA' SPACE.
     M_DEF  LR_ABEVAZ 'I' 'EQ' 'A0IC0241CA' SPACE.

     PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                  LR_ABEVAZ
                                  T_BEVALLB
                           USING  'A0IC0242CA'.
*--2508 #02.
   ENDIF.
*--BG 2006/09/22
 ENDFORM.                    " CALC_ABEV_ONREV_POTL_SZJA


*&---------------------------------------------------------------------*
*&      Form  GET_ONREV_CALC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_LI_LAST_BEVALLO  text
*      -->P_C_ABEVAZ_A0DC0301DA  text
*      -->P_C_ABEVAZ_A0CC0033AA  text
*      -->P_C_ABEVAZ_A0BD0016CA  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*----------------------------------------------------------------------*
 FORM GET_ONREV_CALC TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                              $T_LAST_BEVALLO STRUCTURE /ZAK/BEVALLO
                              $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                     USING    $ABEV_MOD
                              $ABEV_F1
                              $ABEV_F2
                              $ABEV_F3
                              $ABEV_F4
                              $ABEV_F5.

   DATA L_SUM       LIKE /ZAK/BEVALLO-FIELD_NRK.
   DATA L_SUM_LAST  LIKE /ZAK/BEVALLO-FIELD_NRK.
   DATA L_FIELD_NRK LIKE /ZAK/BEVALLO-FIELD_NRK.
   DATA L_TABIX LIKE SY-TABIX.

   DEFINE M_BEVALLO_READ.
*     READ TABLE &1 INTO W_/ZAK/BEVALLO
*                           WITH KEY ABEVAZ = &2
*                           BINARY SEARCH.
*     IF SY-SUBRC EQ 0.
*       ADD W_/ZAK/BEVALLO-FIELD_NRK TO &3.
*     ENDIF.
     LOOP AT &1 INTO W_/ZAK/BEVALLO WHERE ABEVAZ = &2.
       ADD W_/ZAK/BEVALLO-FIELD_NRK TO &3.
     ENDLOOP.

   END-OF-DEFINITION.


*  Reading a current tax return
   IF NOT $ABEV_F1 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F1 L_SUM.
   ENDIF.

   IF NOT $ABEV_F2 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F2 L_SUM.
   ENDIF.

   IF NOT $ABEV_F3 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F3 L_SUM.
   ENDIF.

   IF NOT $ABEV_F4 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F4 L_SUM.
   ENDIF.

   IF NOT $ABEV_F5 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F5 L_SUM.
   ENDIF.

* Read previous period
   IF NOT $ABEV_F1 IS INITIAL.
     M_BEVALLO_READ $T_LAST_BEVALLO $ABEV_F1 L_SUM_LAST.
   ENDIF.

   IF NOT $ABEV_F2 IS INITIAL.
     M_BEVALLO_READ $T_LAST_BEVALLO $ABEV_F2 L_SUM_LAST.
   ENDIF.

   IF NOT $ABEV_F3 IS INITIAL.
     M_BEVALLO_READ $T_LAST_BEVALLO $ABEV_F3 L_SUM_LAST.
   ENDIF.

   IF NOT $ABEV_F4 IS INITIAL.
     M_BEVALLO_READ $T_LAST_BEVALLO $ABEV_F4 L_SUM_LAST.
   ENDIF.

   IF NOT $ABEV_F5 IS INITIAL.
     M_BEVALLO_READ $T_LAST_BEVALLO $ABEV_F5 L_SUM_LAST.
   ENDIF.

*  Calculation of difference
   L_FIELD_NRK = L_SUM - L_SUM_LAST.

*  Modify a calculated field
   READ TABLE $T_BEVALLO INTO W_/ZAK/BEVALLO
                         WITH KEY ABEVAZ = $ABEV_MOD.
   IF SY-SUBRC EQ 0.
     MOVE SY-TABIX TO L_TABIX.
     MOVE L_FIELD_NRK TO W_/ZAK/BEVALLO-FIELD_N.
     READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                           WITH KEY ABEVAZ = $ABEV_MOD
                           BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                    W_/ZAK/BEVALLB-ROUND
                    W_/ZAK/BEVALLO-WAERS
           CHANGING W_/ZAK/BEVALLO-FIELD_NR
                    W_/ZAK/BEVALLO-FIELD_NRK.
     ENDIF.

     MODIFY $T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.

   ENDIF.


 ENDFORM.                    " GET_ONREV_CALC


*&---------------------------------------------------------------------*
*&      Form  GET_ONREV_SUM
*&---------------------------------------------------------------------*
 FORM GET_CLEAR_ABEVAZ TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                        USING   $CLEAR_ABEVAZ.

   DATA L_TABIX LIKE SY-TABIX.

*  Search field
   READ TABLE $T_BEVALLO INTO W_/ZAK/BEVALLO
                         WITH KEY ABEVAZ = $CLEAR_ABEVAZ.
   IF SY-SUBRC EQ 0.
     MOVE SY-TABIX TO L_TABIX.
     READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                           WITH KEY ABEVAZ = $CLEAR_ABEVAZ
                           BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       IF W_/ZAK/BEVALLB-FIELDTYPE = 'C'.
         CLEAR W_/ZAK/BEVALLO-FIELD_C.
       ELSEIF W_/ZAK/BEVALLB-FIELDTYPE = 'N'.
         CLEAR: W_/ZAK/BEVALLO-FIELD_N,
                W_/ZAK/BEVALLO-FIELD_NR,
                W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.
       MODIFY $T_BEVALLO INDEX L_TABIX FROM W_/ZAK/BEVALLO.
     ENDIF.
   ENDIF.


 ENDFORM.                    "GET_CLEAR_ABEVAZ

*&---------------------------------------------------------------------*
*&      Form  GET_ONREV_SUM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_LR_ABEVAZ  text
*      -->P_C_ABEVAZ_A0DC0302DA  text
*----------------------------------------------------------------------*
 FORM GET_ONREV_SUM TABLES  $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                            $R_ABEVAZ  STRUCTURE /ZAK/RANGE_C17
                            $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                    USING   $ABEVAZ_MOD.

   DATA L_SUM LIKE /ZAK/BEVALLO-FIELD_N.
   DATA L_TABIX LIKE SY-TABIX.

   LOOP AT $T_BEVALLO INTO W_/ZAK/BEVALLO
                     WHERE ABEVAZ IN $R_ABEVAZ.
     ADD W_/ZAK/BEVALLO-FIELD_NRK TO L_SUM.
   ENDLOOP.

   READ TABLE $T_BEVALLO INTO W_/ZAK/BEVALLO
                         WITH KEY ABEVAZ = $ABEVAZ_MOD
                         BINARY SEARCH.
   IF SY-SUBRC EQ 0.
     MOVE SY-TABIX TO L_TABIX.
     MOVE L_SUM TO W_/ZAK/BEVALLO-FIELD_N.

     READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                           WITH KEY ABEVAZ = $ABEVAZ_MOD
                           BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                    W_/ZAK/BEVALLB-ROUND
                    W_/ZAK/BEVALLO-WAERS
           CHANGING W_/ZAK/BEVALLO-FIELD_NR
                    W_/ZAK/BEVALLO-FIELD_NRK.
     ENDIF.

     MODIFY $T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
   ENDIF.


 ENDFORM.                    " GET_ONREV_SUM
*++2408 #01.
*&---------------------------------------------------------------------*
*&      Form  GET_ONREV_SIGN_SUM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_LR_ABEVAZ  text
*      -->P_C_ABEVAZ_A0DC0302DA  text
*----------------------------------------------------------------------*
 FORM GET_ONREV_SIGN_SUM TABLES  $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                 $R_ABEVAZ  STRUCTURE /ZAK/RANGE_C17
                                 $R_ABEVAZ_MIN STRUCTURE /ZAK/RANGE_C17
                                 $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                         USING   $ABEVAZ_MOD.

   DATA L_SUM LIKE /ZAK/BEVALLO-FIELD_N.
   DATA L_TABIX LIKE SY-TABIX.

   LOOP AT $T_BEVALLO INTO W_/ZAK/BEVALLO
                     WHERE ABEVAZ IN $R_ABEVAZ.
     ADD W_/ZAK/BEVALLO-FIELD_NRK TO L_SUM.
   ENDLOOP.

   LOOP AT $T_BEVALLO INTO W_/ZAK/BEVALLO
                     WHERE ABEVAZ IN $R_ABEVAZ_MIN.
     MULTIPLY W_/ZAK/BEVALLO-FIELD_NRK BY -1.
     ADD W_/ZAK/BEVALLO-FIELD_NRK TO L_SUM.
   ENDLOOP.

   READ TABLE $T_BEVALLO INTO W_/ZAK/BEVALLO
                         WITH KEY ABEVAZ = $ABEVAZ_MOD
                         BINARY SEARCH.
   IF SY-SUBRC EQ 0.
     MOVE SY-TABIX TO L_TABIX.
     MOVE L_SUM TO W_/ZAK/BEVALLO-FIELD_N.

     READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                           WITH KEY ABEVAZ = $ABEVAZ_MOD
                           BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                    W_/ZAK/BEVALLB-ROUND
                    W_/ZAK/BEVALLO-WAERS
           CHANGING W_/ZAK/BEVALLO-FIELD_NR
                    W_/ZAK/BEVALLO-FIELD_NRK.
     ENDIF.

     MODIFY $T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
   ENDIF.


 ENDFORM.                    " GET_ONREV_SUM
*--2408 #01.
*&---------------------------------------------------------------------*
*&      Form  GET_LAP_SZ_0608
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM GET_LAP_SZ_0608 TABLES T_BEVALLO STRUCTURE  /ZAK/BEVALLALV.

   DATA L_ALV LIKE /ZAK/BEVALLALV.
   DATA L_INDEX LIKE SY-TABIX.
   DATA L_TABIX LIKE SY-TABIX.

   CLEAR L_INDEX.

* Upload RANKS for SZJA tax identification page number management
   M_DEF R_M0AC017A 'I' 'BT' 'M0BC0000000000000' 'M0BZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC018A 'I' 'BT' 'M0CC0000000000000' 'M0CZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC019A 'I' 'BT' 'M0DC0000000000000' 'M0DZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC020A 'I' 'BT' 'M0EC0000000000000' 'M0EZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC021A 'I' 'BT' 'M0FC0000000000000' 'M0FZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC022A 'I' 'BT' 'M0GC0000000000000' 'M0GZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC023A 'I' 'BT' 'M0HC0000000000000' 'M0HZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC024A 'I' 'BT' 'M0IC0000000000000' 'M0IZZZZZZZZZZZZZZ'.
*++BG 2006/06/27

* Exclusion of ABEV identifiers
*M-10-267-a Duration of time spent in insurance other than the subject period
   M_DEF R_M0AC024A 'E' 'EQ' 'M0ID0267AA' SPACE.
*M-10-267-c Duration of time spent in insurance other than the subject period
   M_DEF R_M0AC024A 'E' 'EQ' 'M0ID0267CA' SPACE.
*--BG 2006/06/27

   M_DEF R_M0AC025A 'I' 'GE' 'M0JB008A'  SPACE.


   LOOP AT I_/ZAK/BEVALLO INTO W_/ZAK/BEVALLO.
     L_TABIX = SY-TABIX.

*   Dialog run for insurance
     PERFORM PROCESS_IND_ITEM USING '100000'
                                    L_INDEX
                                    TEXT-P01.


*   Csak SZJA-nal
     IF  W_/ZAK/BEVALL-BTYPART EQ C_BTYPART_SZJA.
*   Collections for tax identification number
*   Fields 17-25
       PERFORM CALL_MLAPSZ: TABLES R_M0AC017A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC017A,
                            TABLES R_M0AC018A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC018A,
                            TABLES R_M0AC019A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC019A,
                            TABLES R_M0AC020A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC020A,
                            TABLES R_M0AC021A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC021A,
                            TABLES R_M0AC022A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC022A,
                            TABLES R_M0AC023A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC023A,
                            TABLES R_M0AC024A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC024A,
                            TABLES R_M0AC025A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC025A.
     ENDIF.

     READ TABLE T_BEVALLO INTO L_ALV WITH KEY
                   BUKRS   = W_/ZAK/BEVALLO-BUKRS
                   BTYPE   = W_/ZAK/BEVALLO-BTYPE
                   GJAHR   = W_/ZAK/BEVALLO-GJAHR
                   MONAT   = W_/ZAK/BEVALLO-MONAT
                   ZINDEX  = W_/ZAK/BEVALLO-ZINDEX
                   ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ
                   ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                   LAPSZ   = W_/ZAK/BEVALLO-LAPSZ
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
       MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX
                       TRANSPORTING FIELD_C FIELD_N FIELD_NR FIELD_NRK
*                                   ABEVAZ_DISP
                                     .
     ELSE.
       READ TABLE I_/ZAK/BEVALLB INTO W_/ZAK/BEVALLB
       WITH KEY ABEVAZ = W_/ZAK/BEVALLO-ABEVAZ.
       MOVE-CORRESPONDING W_/ZAK/BEVALLB TO L_ALV.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
       SELECT SINGLE ABEVTEXT INTO L_ALV-ABEVTEXT
         FROM  /ZAK/BEVALLBT
              WHERE  LANGU   = SY-LANGU
              AND    BTYPE   = W_/ZAK/BEVALLO-BTYPE
              AND    ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ.
       L_ALV-ABEVTEXT_DISP = L_ALV-ABEVTEXT.
       APPEND L_ALV TO T_BEVALLO.
       SORT T_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ ADOAZON
            LAPSZ.
     ENDIF.
     DELETE I_/ZAK/BEVALLO.
   ENDLOOP.

 ENDFORM.                    " GET_LAP_SZ_0608
*&---------------------------------------------------------------------*
*&      Form  GET_LAP_SZ
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM GET_LAP_SZ_06082  TABLES T_BEVALLO STRUCTURE  /ZAK/BEVALLALV.

   DATA L_ALV LIKE /ZAK/BEVALLALV.
   DATA L_INDEX LIKE SY-TABIX.
   DATA L_TABIX LIKE SY-TABIX.

   CLEAR L_INDEX.

*  Upload RANKS for SZJA tax identification page number management
   M_DEF R_M0AC020A 'I' 'BT' 'M0BC0000000000000' 'M0BZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC021A 'I' 'BT' 'M0CC0000000000000' 'M0CZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC022A 'I' 'BT' 'M0DC0000000000000' 'M0DZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC023A 'I' 'BT' 'M0EC0000000000000' 'M0EZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC024A 'I' 'BT' 'M0FC0000000000000' 'M0FZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC025A 'I' 'BT' 'M0GC0000000000000' 'M0GZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC026A 'I' 'BT' 'M0HC0000000000000' 'M0HZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC027A 'I' 'BT' 'M0IC0000000000000' 'M0IZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC028A 'I' 'BT' 'M0JC0000000000000' 'M0JZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC029A 'I' 'BT' 'M0KC0000000000000' 'M0KZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC030A 'I' 'BT' 'M0LC0000000000000' 'M0LZZZZZZZZZZZZZZ'.


** ABEV azonosítók kizárása
**M-10-267-a Tárgyidőszaktól eltérő biztosításban töltött idő
*time content
*   M_DEF R_M0AC024A 'E' 'EQ' 'M0ID0267AA' SPACE.
**--BG 2006/06/27

*++BG 2006.10.11
*  Application quality is still needed due to the number of pages
   M_DEF R_M0AC023A 'I' 'EQ' 'M0EB008A'  SPACE.
   M_DEF R_M0AC024A 'I' 'EQ' 'M0FB008A'  SPACE.
   M_DEF R_M0AC025A 'I' 'EQ' 'M0GB008A'  SPACE.
   M_DEF R_M0AC026A 'I' 'EQ' 'M0HB008A'  SPACE.
   M_DEF R_M0AC023A 'I' 'EQ' 'M0EB008A'  SPACE.
   M_DEF R_M0AC028A 'I' 'EQ' 'M0JB008A'  SPACE.
   M_DEF R_M0AC029A 'I' 'EQ' 'M0KB008A'  SPACE.
   M_DEF R_M0AC030A 'I' 'EQ' 'M0LB008A'  SPACE.
*--BG 2006.10.11 BG

   LOOP AT I_/ZAK/BEVALLO INTO W_/ZAK/BEVALLO.
     L_TABIX = SY-TABIX.

*   Dialog run for insurance
     PERFORM PROCESS_IND_ITEM USING '100000'
                                    L_INDEX
                                    TEXT-P01.


*   Csak SZJA-nal
     IF  W_/ZAK/BEVALL-BTYPART EQ C_BTYPART_SZJA.
*   Collections for tax identification number
*   Fields 17-25
       PERFORM CALL_MLAPSZ: TABLES R_M0AC020A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC020A,
                            TABLES R_M0AC021A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC021A,
                            TABLES R_M0AC022A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC022A,
                            TABLES R_M0AC023A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC023A,
                            TABLES R_M0AC024A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC024A,
                            TABLES R_M0AC025A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC025A,
                            TABLES R_M0AC026A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC026A,
                            TABLES R_M0AC027A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC027A,
                            TABLES R_M0AC028A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC028A,
                            TABLES R_M0AC029A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC029A,
                            TABLES R_M0AC030A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC030A.
     ENDIF.

     READ TABLE T_BEVALLO INTO L_ALV WITH KEY
                   BUKRS   = W_/ZAK/BEVALLO-BUKRS
                   BTYPE   = W_/ZAK/BEVALLO-BTYPE
                   GJAHR   = W_/ZAK/BEVALLO-GJAHR
                   MONAT   = W_/ZAK/BEVALLO-MONAT
                   ZINDEX  = W_/ZAK/BEVALLO-ZINDEX
                   ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ
                   ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                   LAPSZ   = W_/ZAK/BEVALLO-LAPSZ
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
       MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX
                       TRANSPORTING FIELD_C FIELD_N FIELD_NR FIELD_NRK
*                                   ABEVAZ_DISP
                                     .
     ELSE.
       READ TABLE I_/ZAK/BEVALLB INTO W_/ZAK/BEVALLB
       WITH KEY ABEVAZ = W_/ZAK/BEVALLO-ABEVAZ.
       MOVE-CORRESPONDING W_/ZAK/BEVALLB TO L_ALV.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
       SELECT SINGLE ABEVTEXT INTO L_ALV-ABEVTEXT
         FROM  /ZAK/BEVALLBT
              WHERE  LANGU   = SY-LANGU
              AND    BTYPE   = W_/ZAK/BEVALLO-BTYPE
              AND    ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ.
       L_ALV-ABEVTEXT_DISP = L_ALV-ABEVTEXT.
       APPEND L_ALV TO T_BEVALLO.
       SORT T_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ ADOAZON
            LAPSZ.
     ENDIF.
     DELETE I_/ZAK/BEVALLO.
   ENDLOOP.

 ENDFORM.                    " GET_LAP_SZ_06082
*&---------------------------------------------------------------------*
*&      Form  GET_LAP_SZ
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM GET_LAP_SZ_0708  TABLES T_BEVALLO STRUCTURE  /ZAK/BEVALLALV.

   DATA L_ALV LIKE /ZAK/BEVALLALV.
   DATA L_INDEX LIKE SY-TABIX.
   DATA L_TABIX LIKE SY-TABIX.

   CLEAR L_INDEX.

*  Upload RANKS for SZJA tax identification page number management
   M_DEF R_M0AC020A 'I' 'BT' 'M0BC0000000000000' 'M0BZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC021A 'I' 'BT' 'M0CC0000000000000' 'M0CZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC022A 'I' 'BT' 'M0DC0000000000000' 'M0DZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC023A 'I' 'BT' 'M0EC0000000000000' 'M0EZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC024A 'I' 'BT' 'M0FC0000000000000' 'M0FZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC025A 'I' 'BT' 'M0GC0000000000000' 'M0GZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC026A 'I' 'BT' 'M0HC0000000000000' 'M0HZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC027A 'I' 'BT' 'M0IC0000000000000' 'M0IZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC028A 'I' 'BT' 'M0JC0000000000000' 'M0JZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC029A 'I' 'BT' 'M0KC0000000000000' 'M0KZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC030A 'I' 'BT' 'M0LC0000000000000' 'M0LZZZZZZZZZZZZZZ'.

   M_DEF R_M0AC031A 'I' 'BT' 'M0MC0000000000000' 'M0MZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC032A 'I' 'BT' 'M0NC0000000000000' 'M0NZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC033A 'I' 'BT' 'M0OC0000000000000' 'M0OZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC034A 'I' 'BT' 'M0PC0000000000000' 'M0PZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC035A 'I' 'BT' 'M0QC0000000000000' 'M0QZZZZZZZZZZZZZZ'.




** ABEV azonosítók kizárása
**M-10-267-a Tárgyidőszaktól eltérő biztosításban töltött idő
*time content
*   M_DEF R_M0AC024A 'E' 'EQ' 'M0ID0267AA' SPACE.
**--BG 2006/06/27

*++BG 2006.10.11
*  Application quality is still needed due to the number of pages
   M_DEF R_M0AC023A 'I' 'EQ' 'M0EB008A'  SPACE.

*   M_DEF R_M0AC023A 'I' 'EQ' 'M0EB008A'  SPACE.

   M_DEF R_M0AC024A 'I' 'EQ' 'M0FB008A'  SPACE.
   M_DEF R_M0AC024A 'I' 'EQ' 'M0FB009A'  SPACE.
   M_DEF R_M0AC024A 'I' 'EQ' 'M0FB010A'  SPACE.

   M_DEF R_M0AC025A 'I' 'EQ' 'M0GB008A'  SPACE.
   M_DEF R_M0AC025A 'I' 'EQ' 'M0GB009A'  SPACE.
   M_DEF R_M0AC025A 'I' 'EQ' 'M0GB010A'  SPACE.

   M_DEF R_M0AC026A 'I' 'EQ' 'M0HB008A'  SPACE.
   M_DEF R_M0AC026A 'I' 'EQ' 'M0HB009A'  SPACE.
   M_DEF R_M0AC026A 'I' 'EQ' 'M0HB010A'  SPACE.

   M_DEF R_M0AC027A 'I' 'EQ' 'M0IB008A'  SPACE.
   M_DEF R_M0AC027A 'I' 'EQ' 'M0IB009A'  SPACE.
   M_DEF R_M0AC027A 'I' 'EQ' 'M0IB010A'  SPACE.


   M_DEF R_M0AC028A 'I' 'EQ' 'M0JB008A'  SPACE.
   M_DEF R_M0AC028A 'I' 'EQ' 'M0JB009A'  SPACE.
   M_DEF R_M0AC028A 'I' 'EQ' 'M0JB010A'  SPACE.

   M_DEF R_M0AC029A 'I' 'EQ' 'M0KB008A'  SPACE.
   M_DEF R_M0AC029A 'I' 'EQ' 'M0KB009A'  SPACE.
   M_DEF R_M0AC029A 'I' 'EQ' 'M0KB010A'  SPACE.

   M_DEF R_M0AC030A 'I' 'EQ' 'M0LB008A'  SPACE.
   M_DEF R_M0AC030A 'I' 'EQ' 'M0LB009A'  SPACE.
   M_DEF R_M0AC030A 'I' 'EQ' 'M0LB010A'  SPACE.


   M_DEF R_M0AC031A 'I' 'EQ' 'M0MB008A'  SPACE.
   M_DEF R_M0AC031A 'I' 'EQ' 'M0MB009A'  SPACE.
   M_DEF R_M0AC031A 'I' 'EQ' 'M0MB010A'  SPACE.

   M_DEF R_M0AC032A 'I' 'EQ' 'M0NB008A'  SPACE.
   M_DEF R_M0AC032A 'I' 'EQ' 'M0NB009A'  SPACE.
   M_DEF R_M0AC032A 'I' 'EQ' 'M0NB010A'  SPACE.

   M_DEF R_M0AC033A 'I' 'EQ' 'M0OB008A'  SPACE.
   M_DEF R_M0AC033A 'I' 'EQ' 'M0OB009A'  SPACE.
   M_DEF R_M0AC033A 'I' 'EQ' 'M0OB010A'  SPACE.

   M_DEF R_M0AC034A 'I' 'EQ' 'M0PB008A'  SPACE.
   M_DEF R_M0AC034A 'I' 'EQ' 'M0PB009A'  SPACE.
   M_DEF R_M0AC034A 'I' 'EQ' 'M0PB010A'  SPACE.

   M_DEF R_M0AC035A 'I' 'EQ' 'M0QB008A'  SPACE.

*--BG 2006.10.11 BG

   LOOP AT I_/ZAK/BEVALLO INTO W_/ZAK/BEVALLO.
     L_TABIX = SY-TABIX.

*   Dialog run for insurance
     PERFORM PROCESS_IND_ITEM USING '100000'
                                    L_INDEX
                                    TEXT-P01.


*   Csak SZJA-nal
     IF  W_/ZAK/BEVALL-BTYPART EQ C_BTYPART_SZJA.
*   Collections for tax identification number
*   Fields 17-25
       PERFORM CALL_MLAPSZ: TABLES R_M0AC020A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC020A,
                            TABLES R_M0AC021A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC021A,
                            TABLES R_M0AC022A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC022A,
                            TABLES R_M0AC023A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC023A,
                            TABLES R_M0AC024A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC024A,
                            TABLES R_M0AC025A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC025A,
                            TABLES R_M0AC026A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC026A,
                            TABLES R_M0AC027A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC027A,
                            TABLES R_M0AC028A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC028A,
                            TABLES R_M0AC029A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC029A,
                            TABLES R_M0AC030A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC030A,
                            TABLES R_M0AC031A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC031A,
                            TABLES R_M0AC032A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC032A,
                            TABLES R_M0AC033A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC033A,
                            TABLES R_M0AC034A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC034A,
                            TABLES R_M0AC035A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC035A.
     ENDIF.

     READ TABLE T_BEVALLO INTO L_ALV WITH KEY
                   BUKRS   = W_/ZAK/BEVALLO-BUKRS
                   BTYPE   = W_/ZAK/BEVALLO-BTYPE
                   GJAHR   = W_/ZAK/BEVALLO-GJAHR
                   MONAT   = W_/ZAK/BEVALLO-MONAT
                   ZINDEX  = W_/ZAK/BEVALLO-ZINDEX
                   ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ
                   ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                   LAPSZ   = W_/ZAK/BEVALLO-LAPSZ
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
*++BG 2007/01/16
       IF L_ALV-OFLAG IS INITIAL.
*--BG 2007/01/16
         MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX
                         TRANSPORTING FIELD_C FIELD_N FIELD_NR FIELD_NRK
**++FI 20070309
*oflag   FIELD_oN FIELD_oNR FIELD_oNRK
**--FI 20070309
*                                   ABEVAZ_DISP
*++ BG 2007.06.22
                                      NULL_FLAG
*-- BG 2007.06.22
                                       .
*++BG 2007/01/16
       ELSE.
         MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX
                         TRANSPORTING FIELD_C FIELD_N  FIELD_NR
                         FIELD_NRK
                                      OFLAG   FIELD_ON FIELD_ONR
                                      FIELD_ONRK
                                      NULL_FLAG.
*++BG 2007/01/21
*        Stacking
         PERFORM SUM_ONR TABLES T_BEVALLO
                         USING  L_ALV
                                L_ALV-FIELD_ON
                                L_ALV-FIELD_ONR
                                L_ALV-FIELD_ONRK.
*--BG 2007/01/21

       ENDIF.
*--BG 2007/01/16

     ELSE.
       READ TABLE I_/ZAK/BEVALLB INTO W_/ZAK/BEVALLB
       WITH KEY ABEVAZ = W_/ZAK/BEVALLO-ABEVAZ.
       MOVE-CORRESPONDING W_/ZAK/BEVALLB TO L_ALV.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
       SELECT SINGLE ABEVTEXT INTO L_ALV-ABEVTEXT
         FROM  /ZAK/BEVALLBT
              WHERE  LANGU   = SY-LANGU
              AND    BTYPE   = W_/ZAK/BEVALLO-BTYPE
              AND    ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ.
       L_ALV-ABEVTEXT_DISP = L_ALV-ABEVTEXT.
       APPEND L_ALV TO T_BEVALLO.
       SORT T_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ ADOAZON
            LAPSZ.
     ENDIF.
     DELETE I_/ZAK/BEVALLO.
   ENDLOOP.

 ENDFORM.                    " GET_LAP_SZ_0708
*&---------------------------------------------------------------------*
*&      Form  GET_NEW_ONR_SUM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*----------------------------------------------------------------------*
 FORM GET_NEW_ONR_SUM TABLES   T_BEVALLO STRUCTURE /ZAK/BEVALLALV
                               T_ADOAZON_ALL STRUCTURE /ZAK/ADOAZONLPSZ
                      USING    $BTYPE
                               $INDEX
*++0908/2 2009.12.09 BG
                               $LAST_DATE.
*--0908/2 2009.12.09 BG

   RANGES LR_ABEV_DELTA FOR /ZAK/BEVALLB-ABEVAZ.
   DATA   LW_BEVALLO LIKE /ZAK/BEVALLALV.

   DATA   LW_LAST_BEVALLO LIKE /ZAK/BEVALLO.
   DATA   L_LAST_INDEX LIKE /ZAK/BEVALLO-ZINDEX.

*++0908 2009.02.27 BG
   DATA   LI_BEVALLO LIKE /ZAK/BEVALLO OCCURS 0 WITH HEADER LINE.
   DATA   L_TABIX LIKE SY-TABIX.
*--0908 2009.02.27 BG
*++BG 2009.07.08
   DATA   LW_BEVALLO_HEAD LIKE /ZAK/BEVALLALV.
*--BG 2009.07.08



*++BG 2007.03.22
*  ABEV identifiers defined in this range are not needed for 0708
   RANGES LR_ABEV_NOT FOR /ZAK/BEVALLB-ABEVAZ.


*We define those ABEV identifiers for which ONR is not used
*training
   IF W_/ZAK/BEVALL-BTYPE = C_0708.
*    168-197-ig
     M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0FC0168CA C_ABEVAZ_A0FC0197CA.
*    198-227-ig
     M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0GC0198CA C_ABEVAZ_A0GC0227CA.
*    285-312-ig
*++BG 2007.05.25
*    M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0JC0285CA C_ABEVAZ_A0JC0312CA.
     M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0JC0285CA C_ABEVAZ_A0JC0312EA.
*--BG 2007.05.25
*    313-340-ig
*++BG 2007.05.25
*    M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0KC0313CA C_ABEVAZ_A0KC0340CA.
     M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0KC0313CA C_ABEVAZ_A0KC0340EA.
*--BG 2007.05.25
*    341-364-ig
*++BG 2007.05.25
*    M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0LC0341CA C_ABEVAZ_A0LC0364CA.
     M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0LC0341CA C_ABEVAZ_A0LC0364EA.
*--BG 2007.05.25
*++0808 BG 2008.02.07
   ELSEIF W_/ZAK/BEVALL-BTYPE = C_0808.
*    130-159-ig
     M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0FC0130CA C_ABEVAZ_A0FC0159CA.
*    160-189-ig
     M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0GC0160CA C_ABEVAZ_A0GC0189CA.
*    280-307-ig
     M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0JC0280CA C_ABEVAZ_A0JC0307EA.
*    308-335-ig
     M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0KC0308CA C_ABEVAZ_A0KC0335EA.
*    336-359-ig
     M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0LC0336CA C_ABEVAZ_A0LC0359EA.
*--0808 BG 2008.02.07
*++0908 2009.01.20 BG
   ELSEIF W_/ZAK/BEVALL-BTYPE = C_0908.
*    110-129-ig
     M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0FC0110BA C_ABEVAZ_A0FC0129EA.
*    284-303-ig
     M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0IC0284BA C_ABEVAZ_A0IC0303HA.
*--0908 2009.01.20 BG
*++1008 2010.03.03 BG
   ELSEIF W_/ZAK/BEVALL-BTYPE = C_1008.
*    110-128-ig
     M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0FC0110BA C_ABEVAZ_A0FC0128EA.
*    284-302-ig
     M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0IC0284BA C_ABEVAZ_A0IC0302HA.
*--1008 2010.03.03 BG
*++1108 2011.02.18 BG
   ELSEIF W_/ZAK/BEVALL-BTYPE = C_1108.
*    130-148-ig
     M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0FC0130CA C_ABEVAZ_A0FC0148FA.
*    230-248-ig
     M_DEF LR_ABEV_NOT 'E' 'BT' C_ABEVAZ_A0IC0230CA C_ABEVAZ_A0IC0248IA.
*--1108 2011.02.18 BG
   ENDIF.
*--BG 2007.03.22


*  Only for self-revision
   CHECK $INDEX NE '000'.
*  It is necessary to define those ABEV identifiers with "A" which
*  they are uncalculated and numerical.
*  Since their sums include all periods, it is necessary to
*  subtract from the previous one.
   LOOP AT I_/ZAK/BEVALLB INTO W_/ZAK/BEVALLB
                        WHERE ABEVAZ(1) EQ 'A'
*++BG 2007.03.22
                          AND ABEVAZ IN LR_ABEV_NOT
*--BG 2007.03.22
                          AND COLLECT   IS INITIAL
*++BG 2008.03.06
                          AND ACTREAD   IS INITIAL
*--BG 2008.03.06
                          AND FIELDTYPE EQ 'N'.
     M_DEF LR_ABEV_DELTA 'I' 'EQ' W_/ZAK/BEVALLB-ABEVAZ SPACE.
   ENDLOOP.

*++BG 2008.03.06
*  loop at
*--BG 2008.03.06


*  Define previous index
   L_LAST_INDEX = $INDEX - 1.

   CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
     EXPORTING
       INPUT  = L_LAST_INDEX
     IMPORTING
       OUTPUT = L_LAST_INDEX.


   LOOP AT T_BEVALLO INTO LW_BEVALLO.
*++BG 2009.07.08
     IF LW_BEVALLO_HEAD IS INITIAL.
       MOVE LW_BEVALLO TO LW_BEVALLO_HEAD.
     ENDIF.
*--BG 2009.07.08
*    Delta training
     IF LW_BEVALLO-ABEVAZ IN LR_ABEV_DELTA.
       CLEAR LW_LAST_BEVALLO.
       SELECT SINGLE * INTO LW_LAST_BEVALLO
                     FROM  /ZAK/BEVALLO
                    WHERE  BUKRS   EQ LW_BEVALLO-BUKRS
                      AND  BTYPE   EQ LW_BEVALLO-BTYPE
                      AND  GJAHR   EQ LW_BEVALLO-GJAHR
                      AND  MONAT   EQ LW_BEVALLO-MONAT
                      AND  ZINDEX  EQ L_LAST_INDEX
                      AND  ABEVAZ  EQ LW_BEVALLO-ABEVAZ.
*      New value
       LW_BEVALLO-OFLAG = 'X'.
*++BG 2008.05.09
*      At 0808, ABS does not need to be handled in summer because it is ABEV
*      can already handle negative numbers.
       IF LW_BEVALLO-BTYPE EQ C_0808
*++0908 2009.01.20 BG
          OR LW_BEVALLO-BTYPE EQ C_0908
*--0908 2009.01.20 BG
*++1008 2010.03.03 BG
          OR LW_BEVALLO-BTYPE EQ C_1008
*--1008 2010.03.03 BG
*++1108 2011.02.18 BG
          OR LW_BEVALLO-BTYPE EQ C_1108
*--1108 2011.02.18 BG
*++1208 2012.03.08 BG
          OR LW_BEVALLO-BTYPE EQ C_1208
*--1208 2012.03.08 BG
*++1308 2013.03.01 BG
          OR LW_BEVALLO-BTYPE EQ C_1308.
*--1308 2013.03.01 BG

         LW_BEVALLO-FIELD_ON = LW_BEVALLO-FIELD_NRK -
                               LW_LAST_BEVALLO-FIELD_NRK.
       ELSE.
*--BG 2008.05.09
*++BG 2007.03.22 Ha az összeg negatív, akkor az ABEV hibát jelez
*                therefore, we store it in the ABS value
         LW_BEVALLO-FIELD_ON = ABS( LW_BEVALLO-FIELD_NRK -
                                    LW_LAST_BEVALLO-FIELD_NRK ).
*--BG 2007.03.22
       ENDIF.
     ELSE.
       LW_BEVALLO-FIELD_ON = LW_BEVALLO-FIELD_NRK.
     ENDIF.

     READ TABLE I_/ZAK/BEVALLB INTO W_/ZAK/BEVALLB
                        WITH KEY BTYPE  = LW_BEVALLO-BTYPE
                                 ABEVAZ = LW_BEVALLO-ABEVAZ
                                 BINARY SEARCH.
*    Sign translation
     IF NOT W_/ZAK/BEVALLB-ELOJEL IS INITIAL.
       MULTIPLY LW_BEVALLO-FIELD_ON BY -1.
     ENDIF.

     PERFORM CALC_FIELD_NRK USING LW_BEVALLO-FIELD_ON
                                  W_/ZAK/BEVALLB-ROUND
                                  LW_BEVALLO-WAERS
                         CHANGING LW_BEVALLO-FIELD_ONR
                                  LW_BEVALLO-FIELD_ONRK.

     MODIFY T_BEVALLO FROM LW_BEVALLO.
*    Stacking
     PERFORM SUM_ONR TABLES T_BEVALLO
                     USING  LW_BEVALLO
                            LW_BEVALLO-FIELD_ON
                            LW_BEVALLO-FIELD_ONR
                            LW_BEVALLO-FIELD_ONRK.

   ENDLOOP.
*  We mark those records that are summative and
*  not marked yet
   REFRESH LR_ABEV_DELTA.
   LOOP AT I_/ZAK/BEVALLB INTO W_/ZAK/BEVALLB
                        WHERE NOT SUM_ABEVAZ IS INITIAL.
     M_DEF LR_ABEV_DELTA 'I' 'EQ' W_/ZAK/BEVALLB-ABEVAZ SPACE.
*++BG 2008.03.06
*    We also mark the ones we summarize into, because it is not certain
*    data came in, but we have to treat it as a self-revision.
     M_DEF LR_ABEV_DELTA 'I' 'EQ' W_/ZAK/BEVALLB-SUM_ABEVAZ SPACE.
*--BG 2008.03.06
   ENDLOOP.

*++BG 2009.07.08
*  We also mark those that will be taken over from ABEV and those
*  are subject to self-revision calculation:
   LOOP AT I_/ZAK/BEVALLB INTO W_/ZAK/BEVALLB
                        WHERE NOT GET_ABEVAZ IS INITIAL.

     READ TABLE T_BEVALLO INTO LW_BEVALLO
                          WITH KEY BUKRS  = LW_BEVALLO_HEAD-BUKRS
                                   BTYPE  = LW_BEVALLO_HEAD-BTYPE
                                   GJAHR  = LW_BEVALLO_HEAD-GJAHR
                                   MONAT  = LW_BEVALLO_HEAD-MONAT
                                   ZINDEX = LW_BEVALLO_HEAD-ZINDEX
                                   ABEVAZ = W_/ZAK/BEVALLB-GET_ABEVAZ
                                   BINARY SEARCH.
     IF SY-SUBRC EQ 0 AND NOT LW_BEVALLO-OFLAG IS INITIAL.
       M_DEF LR_ABEV_DELTA 'I' 'EQ' W_/ZAK/BEVALLB-ABEVAZ SPACE.
     ENDIF.
   ENDLOOP.
*--BG 2009.07.08
   LOOP AT T_BEVALLO INTO LW_BEVALLO.
     IF LW_BEVALLO-ABEVAZ IN LR_ABEV_DELTA
        AND LW_BEVALLO-OFLAG IS INITIAL.
       MOVE 'X' TO LW_BEVALLO-OFLAG.
     ENDIF.

     IF LW_BEVALLO-ABEVAZ(1) EQ 'M' AND NOT
        LW_BEVALLO-OFLAG IS INITIAL.
       CLEAR LW_BEVALLO-OFLAG.
     ENDIF.
*++0908 2009.02.27 BG
     IF NOT LW_BEVALLO-OFLAG IS INITIAL AND
        NOT LW_BEVALLO-NULL_FLAG IS INITIAL.
       CLEAR  LW_BEVALLO-NULL_FLAG.
     ENDIF.
*--0908 2009.02.27 BG

     MODIFY T_BEVALLO FROM LW_BEVALLO TRANSPORTING OFLAG NULL_FLAG.


   ENDLOOP.

*++0908 2009.02.27 BG
*  Only for ABEVs marked during self-revisions
*  the 0-flag must be handled again:
   REFRESH LI_BEVALLO.
   LOOP AT T_BEVALLO INTO LW_BEVALLO WHERE NOT OFLAG IS INITIAL.
     CLEAR LI_BEVALLO.
*    We delete the value of the 0-flag for self-revisions
     IF NOT LW_BEVALLO-NULL_FLAG IS INITIAL.
       CLEAR LW_BEVALLO-NULL_FLAG.
     ENDIF.
     MOVE-CORRESPONDING LW_BEVALLO TO LI_BEVALLO.
     APPEND LI_BEVALLO.
   ENDLOOP.

   IF $BTYPE EQ C_0808.
*    Management of 0 fields for self-revision
     PERFORM CALC_ABEV_0_SZJA_0808  TABLES LI_BEVALLO
                                           T_ADOAZON_ALL
                                    USING  'X'. "Önrevíziós mezőre

   ELSEIF $BTYPE EQ C_0908.
*    Management of 0 fields for self-revision
     PERFORM CALC_ABEV_0_SZJA_0908  TABLES LI_BEVALLO
                                           T_ADOAZON_ALL
                                    USING  'X'  "Önrevíziós mezőre
*++0908/2 2009.12.09 BG
                                           $LAST_DATE.
*--0908/2 2009.12.09 BG
*++1008 2010.03.03 BG
   ELSEIF $BTYPE EQ C_1008.
*    Management of 0 fields for self-revision
     PERFORM CALC_ABEV_0_SZJA_1008  TABLES LI_BEVALLO
                                           T_ADOAZON_ALL
                                    USING  'X'  "Önrevíziós mezőre
                                           $LAST_DATE.
*--1008 2010.03.03 BG
*++1108 2011.02.18 BG
   ELSEIF $BTYPE EQ C_1108.
*    Management of 0 fields for self-revision
     PERFORM CALC_ABEV_0_SZJA_1108  TABLES LI_BEVALLO
                                           T_ADOAZON_ALL
                                    USING  'X'  "Önrevíziós mezőre
                                           $LAST_DATE
                                           $INDEX.

*--1108 2011.02.18 BG
*++1208 2012.03.08 BG
   ELSEIF $BTYPE EQ C_1208.
*    Management of 0 fields for self-revision
     PERFORM CALC_ABEV_0_SZJA_1208  TABLES LI_BEVALLO
                                           T_ADOAZON_ALL
                                    USING  'X'  "Önrevíziós mezőre
                                           $LAST_DATE
                                           $INDEX.

*--1208 2012.03.08 BG
   ENDIF.

*  Write back NULL_FLAG values:
   LOOP AT LI_BEVALLO WHERE NOT OFLAG IS INITIAL
                        AND NOT NULL_FLAG IS INITIAL.
     READ TABLE T_BEVALLO INTO LW_BEVALLO
                      WITH KEY BUKRS = LI_BEVALLO-BUKRS
                               BTYPE = LI_BEVALLO-BTYPE
                               GJAHR = LI_BEVALLO-GJAHR
                               MONAT = LI_BEVALLO-MONAT
                               ZINDEX  = LI_BEVALLO-ZINDEX
                               ABEVAZ = LI_BEVALLO-ABEVAZ
                               BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       L_TABIX = SY-TABIX.
       LW_BEVALLO-NULL_FLAG = C_X.
       MODIFY T_BEVALLO FROM LW_BEVALLO
                        INDEX L_TABIX TRANSPORTING NULL_FLAG.
     ENDIF.
   ENDLOOP.
   FREE LI_BEVALLO.
*--0908 2009.02.27 BG


 ENDFORM.                    " GET_NEW_ONR_SUM
*&---------------------------------------------------------------------*
*&      Form  SUM_ONR
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_LW_BEVALLO  text
*----------------------------------------------------------------------*
*++BG 2007.05.30
**++FI 20070309
** FORM SUM_ONR TABLES   T_BEVALLO STRUCTURE /ZAK/BEVALLALV
**              USING    W_BEVALLO STRUCTURE /ZAK/BEVALLALV
* FORM SUM_ONR TABLES   T_BEVALLO STRUCTURE /ZAK/BEVALLO
*              USING    W_BEVALLO STRUCTURE /ZAK/BEVALLO
*--FI 20070309
 FORM SUM_ONR TABLES   T_BEVALLO STRUCTURE /ZAK/BEVALLALV
              USING    W_BEVALLO STRUCTURE /ZAK/BEVALLALV
*--BG 2007.05.30

                       FIELD_ON
                       FIELD_ONR
                       FIELD_ONRK.

*++FI 20070309
   DATA LW_BEVALLO LIKE /ZAK/BEVALLALV.
*   DATA LW_BEVALLO LIKE /ZAK/BEVALLO .
*--FI 20070309
   DATA L_TABIX LIKE SY-TABIX.



   READ TABLE I_/ZAK/BEVALLB INTO W_/ZAK/BEVALLB
                      WITH KEY BTYPE  = W_BEVALLO-BTYPE
                               ABEVAZ = W_BEVALLO-ABEVAZ
                               BINARY SEARCH.

   IF SY-SUBRC EQ 0 AND NOT W_/ZAK/BEVALLB-SUM_ABEVAZ IS INITIAL.
     READ TABLE T_BEVALLO INTO LW_BEVALLO
                          WITH KEY BUKRS  = W_BEVALLO-BUKRS
                                   BTYPE  = W_BEVALLO-BTYPE
                                   GJAHR  = W_BEVALLO-GJAHR
                                   MONAT  = W_BEVALLO-MONAT
                                   ZINDEX = W_BEVALLO-ZINDEX
                                   ABEVAZ = W_/ZAK/BEVALLB-SUM_ABEVAZ
*++BG 2007.05.30
*                                  Due to performance increase
                                   BINARY SEARCH
*--BG 2007.05.30
                                   .
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE 'X' TO LW_BEVALLO-OFLAG.
*++BG 2007.07.10
*    The addition is always done in absolute value because
*    otherwise, the sign translation will spoil it
*    ADD FIELD_ON TO LW_BEVALLO-FIELD_ON.
*--BG 2007.07.10

       READ TABLE I_/ZAK/BEVALLB INTO W_/ZAK/BEVALLB
                         WITH KEY BTYPE  = W_BEVALLO-BTYPE
                                  ABEVAZ = W_/ZAK/BEVALLB-SUM_ABEVAZ
                                  BINARY SEARCH.
*      Sign translation
       IF NOT W_/ZAK/BEVALLB-ELOJEL IS INITIAL.
*++BG 2007.07.10
*      The sign translation is not performed on the field to be aggregated
*      but on the aggregate!
*        MULTIPLY LW_BEVALLO-FIELD_ON BY -1.
         MULTIPLY FIELD_ON BY -1.
*--BG 2007.07.10
       ENDIF.

       ADD FIELD_ON TO LW_BEVALLO-FIELD_ON.

       PERFORM CALC_FIELD_NRK USING LW_BEVALLO-FIELD_ON
                                    W_/ZAK/BEVALLB-ROUND
                                    LW_BEVALLO-WAERS
                           CHANGING LW_BEVALLO-FIELD_ONR
                                    LW_BEVALLO-FIELD_ONRK.

       MODIFY T_BEVALLO FROM LW_BEVALLO INDEX L_TABIX.

       PERFORM SUM_ONR TABLES T_BEVALLO
                       USING  LW_BEVALLO
                              FIELD_ON
                              FIELD_ONR
                              FIELD_ONRK.
     ENDIF.
   ELSE.
     EXIT.
   ENDIF.

 ENDFORM.                    " SUM_ONR
*&---------------------------------------------------------------------*
*&      Form  GET_ONREV_DIV
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_C_ABEVAZ_A0FC0414CA  text
*      -->P_C_ABEVAZ_A0FC0414DA  text
*      -->P_5153   text
*----------------------------------------------------------------------*
 FORM GET_ONREV_DIV TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                             $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                      USING  $ABEV_MOD
                             $ABEV_F1
                             $DIV.


   DATA L_FIELD_NRK LIKE /ZAK/BEVALLO-FIELD_NRK.
   DATA L_TABIX LIKE SY-TABIX.
*++BG 2008.06.24
   DATA L_SUBRC LIKE SY-SUBRC.
*--BG 2008.06.24

*  Let's read the basis of the calculation
   READ TABLE $T_BEVALLO INTO W_/ZAK/BEVALLO
                         WITH KEY ABEVAZ = $ABEV_F1.
   IF SY-SUBRC EQ 0.

*++BG 2008.06.24
     READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                           WITH KEY ABEVAZ = $ABEV_MOD
                           BINARY SEARCH.
     MOVE SY-SUBRC TO L_SUBRC.
*--BG 2008.06.24

*    Calculate the ratio
     CATCH SYSTEM-EXCEPTIONS  BCD_FIELD_OVERFLOW  = 1
                              BCD_OVERFLOW        = 2
                              BCD_ZERODIVIDE      = 3
                              COMPUTE_BCD_OVERFLOW = 4.
*++BG 2008.06.24
       IF L_SUBRC EQ 0 AND NOT W_/ZAK/BEVALLB-COLLN IS INITIAL
*++BG 2008.07.09
*      We only count in this way if the rounded unfolded is not 0
          AND NOT W_/ZAK/BEVALLO-FIELD_NRK IS INITIAL.
*--BG 2008.07.09
         L_FIELD_NRK = W_/ZAK/BEVALLO-FIELD_N / $DIV.
       ELSE.
*--BG 2008.06.24
         L_FIELD_NRK = W_/ZAK/BEVALLO-FIELD_NRK / $DIV.
*++BG 2008.06.24
       ENDIF.
*--BG 2008.06.24
     ENDCATCH.
     IF SY-SUBRC EQ 0.
*  Modify a calculated field
       READ TABLE $T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = $ABEV_MOD.
       IF SY-SUBRC EQ 0.
         MOVE SY-TABIX TO L_TABIX.
         MOVE L_FIELD_NRK TO W_/ZAK/BEVALLO-FIELD_N.
*++BG 2008.06.24
*         READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
*                               WITH KEY ABEVAZ = $ABEV_MOD
*                               BINARY SEARCH.
*         IF SY-SUBRC EQ 0 AND W_/ZAK/BEVALLB-FIELDTYPE EQ 'N'.
         IF L_SUBRC EQ 0 AND W_/ZAK/BEVALLB-FIELDTYPE EQ 'N'.
*--BG 2008.06.24

           PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                        W_/ZAK/BEVALLB-ROUND
                        W_/ZAK/BEVALLO-WAERS
               CHANGING W_/ZAK/BEVALLO-FIELD_NR
                        W_/ZAK/BEVALLO-FIELD_NRK.
           MODIFY $T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
         ENDIF.
       ENDIF.
     ENDIF.
   ENDIF.
 ENDFORM.                    " GET_ONREV_DIV
*&---------------------------------------------------------------------*
*&      Form  GET_ONELL_DIV
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_C_ABEVAZ_A0FC0414CA  text
*      -->P_C_ABEVAZ_A0FC0414DA  text
*      -->P_5153   text
*----------------------------------------------------------------------*
 FORM GET_ONELL_DIV TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLALV
                             $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                      USING  $ABEV_MOD
                             $ABEV_F1
                             $DIV.

   DATA LW_/ZAK/BEVALLALV LIKE /ZAK/BEVALLALV.


   DATA L_FIELD_ONRK LIKE /ZAK/BEVALLO-FIELD_ONRK.
   DATA L_TABIX LIKE SY-TABIX.

*  Let's read the basis of the calculation
   READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                         WITH KEY ABEVAZ = $ABEV_F1.
   IF SY-SUBRC EQ 0.

*    Calculate the ratio
     CATCH SYSTEM-EXCEPTIONS  BCD_FIELD_OVERFLOW  = 1
                              BCD_OVERFLOW        = 2
                              BCD_ZERODIVIDE      = 3
                              COMPUTE_BCD_OVERFLOW = 4.
       L_FIELD_ONRK = LW_/ZAK/BEVALLALV-FIELD_ONRK / $DIV.
     ENDCATCH.
     IF SY-SUBRC EQ 0.
*  Modify a calculated field
       READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                             WITH KEY ABEVAZ = $ABEV_MOD.
       IF SY-SUBRC EQ 0.
         MOVE SY-TABIX TO L_TABIX.
         ADD L_FIELD_ONRK TO LW_/ZAK/BEVALLALV-FIELD_N.
         READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                               WITH KEY ABEVAZ = $ABEV_MOD
                               BINARY SEARCH.
         IF SY-SUBRC EQ 0 AND W_/ZAK/BEVALLB-FIELDTYPE EQ 'N'.
           PERFORM CALC_FIELD_NRK USING LW_/ZAK/BEVALLALV-FIELD_N
                        W_/ZAK/BEVALLB-ROUND
                        LW_/ZAK/BEVALLALV-WAERS
               CHANGING LW_/ZAK/BEVALLALV-FIELD_NR
                        LW_/ZAK/BEVALLALV-FIELD_NRK.
*          MOVE 'X' TO LW_/ZAK/BEVALLALV-OFLAG.
           MODIFY $T_BEVALLO FROM LW_/ZAK/BEVALLALV INDEX L_TABIX.
         ENDIF.
       ENDIF.
     ENDIF.
   ENDIF.
 ENDFORM.                    " GET_ONELL_DIV

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_ONYB_0761
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONYB_0761 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                 T_BEVALLB STRUCTURE /ZAK/BEVALLB
                         USING  $LAST_DATE.


   DATA L_TABIX LIKE SY-TABIX.

   DATA L_GJAHR TYPE GJAHR.
   DATA L_MONAT TYPE MONAT.
   DATA L_BEGIN_DAY LIKE SY-DATUM.

   CLEAR: L_GJAHR,L_MONAT.


   L_GJAHR = $LAST_DATE(4).
   L_MONAT = $LAST_DATE+4(2).
*++0004 BG 2007.05.24
*   IF W_/ZAK/BEVALL-BIDOSZ = 'E'.
*     L_GJAHR = L_GJAHR - 1.
** N - Negyedéves
*   ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.
*     IF L_MONAT EQ '03'.
*       L_GJAHR = L_GJAHR - 1.
*       L_MONAT = '12'.
*     ELSEIF L_MONAT EQ '06' OR
*            L_MONAT EQ '09' OR
*            L_MONAT EQ '12'.
**++BG 2007.05.24
**      L_MONAT = L_MONAT - 3.
*       L_MONAT = L_MONAT - 2.
**--BG 2007.05.24
*     ENDIF.
*   ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'H'.
*     IF W_/ZAK/BEVALLO-MONAT EQ '01'.
*       L_GJAHR = L_GJAHR - 1.
*       L_MONAT = '12'.
*     ELSE.
*       L_MONAT = W_/ZAK/BEVALLO-MONAT - 1.
*     ENDIF.
*   ENDIF.

* E - Year old
   IF W_/ZAK/BEVALL-BIDOSZ = 'E'.
     L_MONAT = '01'.
* N - Quarterly
   ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.
     SUBTRACT 2 FROM L_MONAT.
* H - Havi
   ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'H'.

   ENDIF.
*--0004 BG 2007.05.24

   CONCATENATE L_GJAHR L_MONAT '01' INTO L_BEGIN_DAY.

* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE  ABEVAZ EQ     C_ABEVAZ_24
        OR  ABEVAZ EQ     C_ABEVAZ_17
        OR  ABEVAZ EQ     C_ABEVAZ_20
*++0004 BG 2007.05.24
        OR  ABEVAZ EQ     C_ABEVAZ_14
        OR  ABEVAZ EQ     C_ABEVAZ_15.
*--0004 BG 2007.05.24

* this line must be modified!
*     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
*     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
*     CHECK SY-SUBRC EQ 0.
*     MOVE SY-TABIX  TO L_TABIX.
     LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                       WHERE ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.

       CASE W_/ZAK/BEVALLB-ABEVAZ.

*    Signature date (sy-datum)
         WHEN  C_ABEVAZ_24.
           W_/ZAK/BEVALLO-FIELD_C = SY-DATUM.
*    PERIOD start date
         WHEN  C_ABEVAZ_17.
           W_/ZAK/BEVALLO-FIELD_C = L_BEGIN_DAY.
*    PERIOD closing date
         WHEN  C_ABEVAZ_20.
           W_/ZAK/BEVALLO-FIELD_C = $LAST_DATE.
*++0004 BG 2007.05.24
*    Loading correction flags
*    We always upload if self-revision:
         WHEN  C_ABEVAZ_14 OR C_ABEVAZ_15.
           IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
             W_/ZAK/BEVALLO-FIELD_C = C_X.
           ENDIF.
*--0004 BG 2007.05.24
       ENDCASE.

*    MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO.
     ENDLOOP.
   ENDLOOP.

 ENDFORM.                    " CALC_ABEV_ONYB_0761
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_ONYB_0761
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONYB_08A60 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                  T_BEVALLB STRUCTURE /ZAK/BEVALLB
                           USING  $LAST_DATE.

   DATA L_TABIX LIKE SY-TABIX.

   DATA L_GJAHR TYPE GJAHR.
   DATA L_MONAT TYPE MONAT.
   DATA L_BEGIN_DAY LIKE SY-DATUM.

   CLEAR: L_GJAHR,L_MONAT.

   L_GJAHR = $LAST_DATE(4).
   L_MONAT = $LAST_DATE+4(2).
* E - Year old
   IF W_/ZAK/BEVALL-BIDOSZ = 'E'.
     L_MONAT = '01'.
* N - Quarterly
   ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.
     SUBTRACT 2 FROM L_MONAT.
* H - Havi
   ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'H'.

   ENDIF.

   CONCATENATE L_GJAHR L_MONAT '01' INTO L_BEGIN_DAY.

* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE  ABEVAZ EQ     C_ABEVAZ_24
        OR  ABEVAZ EQ     C_ABEVAZ_17
        OR  ABEVAZ EQ     C_ABEVAZ_20
        OR  ABEVAZ EQ     C_ABEVAZ_278
        OR  ABEVAZ EQ     C_ABEVAZ_279.

* this line must be modified!
     LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                       WHERE ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.

       CASE W_/ZAK/BEVALLB-ABEVAZ.

*    Signature date (sy-datum)
         WHEN  C_ABEVAZ_24.
           W_/ZAK/BEVALLO-FIELD_C = SY-DATUM.
*    PERIOD start date
         WHEN  C_ABEVAZ_17.
           W_/ZAK/BEVALLO-FIELD_C = L_BEGIN_DAY.
*    PERIOD closing date
         WHEN  C_ABEVAZ_20.
           W_/ZAK/BEVALLO-FIELD_C = $LAST_DATE.
*    Loading correction flags
*    We always upload if self-revision:
         WHEN  C_ABEVAZ_278 OR C_ABEVAZ_279.
           IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
             W_/ZAK/BEVALLO-FIELD_C = C_X.
           ENDIF.
       ENDCASE.

       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO.
     ENDLOOP.
   ENDLOOP.


 ENDFORM.                    " CALC_ABEV_ONYB_08A60

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_ONYB_09A60
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONYB_09A60 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                  T_BEVALLB STRUCTURE /ZAK/BEVALLB
                           USING  $LAST_DATE.

   DATA L_TABIX LIKE SY-TABIX.

   DATA L_GJAHR TYPE GJAHR.
   DATA L_MONAT TYPE MONAT.
   DATA L_BEGIN_DAY LIKE SY-DATUM.

   CLEAR: L_GJAHR,L_MONAT.

   L_GJAHR = $LAST_DATE(4).
   L_MONAT = $LAST_DATE+4(2).
* E - Year old
   IF W_/ZAK/BEVALL-BIDOSZ = 'E'.
     L_MONAT = '01'.
* N - Quarterly
   ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.
     SUBTRACT 2 FROM L_MONAT.
* H - Havi
   ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'H'.

   ENDIF.

   CONCATENATE L_GJAHR L_MONAT '01' INTO L_BEGIN_DAY.

* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE  ABEVAZ EQ     C_ABEVAZ_24
        OR  ABEVAZ EQ     C_ABEVAZ_17
        OR  ABEVAZ EQ     C_ABEVAZ_20
        OR  ABEVAZ EQ     C_ABEVAZ_1078.

* this line must be modified!
     LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                       WHERE ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.

       CASE W_/ZAK/BEVALLB-ABEVAZ.

*    Signature date (sy-datum)
         WHEN  C_ABEVAZ_24.
           W_/ZAK/BEVALLO-FIELD_C = SY-DATUM.
*    PERIOD start date
         WHEN  C_ABEVAZ_17.
           W_/ZAK/BEVALLO-FIELD_C = L_BEGIN_DAY.
*    PERIOD closing date
         WHEN  C_ABEVAZ_20.
           W_/ZAK/BEVALLO-FIELD_C = $LAST_DATE.
*    Loading correction flags
*    We always upload if self-revision:
         WHEN  C_ABEVAZ_1078.
           IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
             W_/ZAK/BEVALLO-FIELD_C = 'H'.
           ENDIF.
       ENDCASE.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO.
     ENDLOOP.
   ENDLOOP.


 ENDFORM.                    " CALC_ABEV_ONYB_09A60

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_ONYB_10A60
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONYB_10A60 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                  T_BEVALLB STRUCTURE /ZAK/BEVALLB
                           USING  $LAST_DATE.

   DATA L_TABIX LIKE SY-TABIX.

   DATA L_GJAHR TYPE GJAHR.
   DATA L_MONAT TYPE MONAT.
   DATA L_BEGIN_DAY LIKE SY-DATUM.

   CLEAR: L_GJAHR,L_MONAT.

   L_GJAHR = $LAST_DATE(4).
   L_MONAT = $LAST_DATE+4(2).
* E - Year old
   IF W_/ZAK/BEVALL-BIDOSZ = 'E'.
     L_MONAT = '01'.
* N - Quarterly
   ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.
     SUBTRACT 2 FROM L_MONAT.
* H - Havi
   ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'H'.

   ENDIF.

   CONCATENATE L_GJAHR L_MONAT '01' INTO L_BEGIN_DAY.

* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE  ABEVAZ EQ     C_ABEVAZ_17
        OR  ABEVAZ EQ     C_ABEVAZ_20
        OR  ABEVAZ EQ     C_ABEVAZ_1078
        OR  ABEVAZ EQ     C_ABEVAZ_10419.

* this line must be modified!
     LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                       WHERE ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.

       CASE W_/ZAK/BEVALLB-ABEVAZ.

*++2010.02.11 RN
* this field is no longer on the 10A60
**    Aláírás dátuma (sy-datum)
*         WHEN  C_ABEVAZ_24.
*           W_/ZAK/BEVALLO-FIELD_C = SY-DATUM.
*--2010.02.11 RN
*    PERIOD start date
         WHEN  C_ABEVAZ_17.
           W_/ZAK/BEVALLO-FIELD_C = L_BEGIN_DAY.
*    PERIOD closing date
         WHEN  C_ABEVAZ_20.
           W_/ZAK/BEVALLO-FIELD_C = $LAST_DATE.
*    Loading correction flags
*    We always upload if self-revision:
         WHEN  C_ABEVAZ_1078.
           IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
             W_/ZAK/BEVALLO-FIELD_C = 'H'.
           ENDIF.
*    Frequency of reporting
         WHEN  C_ABEVAZ_10419.
           IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
             W_/ZAK/BEVALLO-FIELD_C = 'H'.
           ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.
             W_/ZAK/BEVALLO-FIELD_C = 'N'.
           ENDIF.
       ENDCASE.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO.
     ENDLOOP.
   ENDLOOP.


 ENDFORM.                    " CALC_ABEV_ONYB_10A60
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_ONYB_11A60
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONYB_11A60 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                  T_BEVALLB STRUCTURE /ZAK/BEVALLB
                           USING  $LAST_DATE.

   DATA L_TABIX LIKE SY-TABIX.

   DATA L_GJAHR TYPE GJAHR.
   DATA L_MONAT TYPE MONAT.
   DATA L_BEGIN_DAY LIKE SY-DATUM.

   CLEAR: L_GJAHR,L_MONAT.

   L_GJAHR = $LAST_DATE(4).
   L_MONAT = $LAST_DATE+4(2).
* E - Year old
   IF W_/ZAK/BEVALL-BIDOSZ = 'E'.
     L_MONAT = '01'.
* N - Quarterly
   ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.
     SUBTRACT 2 FROM L_MONAT.
* H - Havi
   ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'H'.

   ENDIF.

   CONCATENATE L_GJAHR L_MONAT '01' INTO L_BEGIN_DAY.

* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE  ABEVAZ EQ     C_ABEVAZ_23335
        OR  ABEVAZ EQ     C_ABEVAZ_23336
        OR  ABEVAZ EQ     C_ABEVAZ_23338
        OR  ABEVAZ EQ     C_ABEVAZ_23339.

* this line must be modified!
     LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                       WHERE ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.

       CASE W_/ZAK/BEVALLB-ABEVAZ.

*++2010.02.11 RN
* this field is no longer on the 10A60
**    Aláírás dátuma (sy-datum)
*         WHEN  C_ABEVAZ_24.
*           W_/ZAK/BEVALLO-FIELD_C = SY-DATUM.
*--2010.02.11 RN
*    PERIOD start date
         WHEN  C_ABEVAZ_23335.
           W_/ZAK/BEVALLO-FIELD_C = L_BEGIN_DAY.
*    PERIOD closing date
         WHEN  C_ABEVAZ_23336.
           W_/ZAK/BEVALLO-FIELD_C = $LAST_DATE.
*    Loading correction flags
*    We always upload if self-revision:
         WHEN  C_ABEVAZ_23338.
           IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
             W_/ZAK/BEVALLO-FIELD_C = 'H'.
           ENDIF.
*    Frequency of reporting
         WHEN  C_ABEVAZ_23339.
           IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
             W_/ZAK/BEVALLO-FIELD_C = 'H'.
           ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.
             W_/ZAK/BEVALLO-FIELD_C = 'N'.
           ENDIF.
       ENDCASE.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO.
     ENDLOOP.
   ENDLOOP.

 ENDFORM.                    " CALC_ABEV_ONYB_11A60

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_0_SZJA_0608
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_ADOAZON_ALL  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_0_SZJA_0608  TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                             T_ADOAZON_ALL STRUCTURE /ZAK/ADOAZONLPSZ.



*M0BC0062CA >= M0BC0062BA then M0BC0062DA = 0 and set flag
   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0062CA
                                C_ABEVAZ_M0BC0062BA
                                C_ABEVAZ_M0BC0062DA.




 ENDFORM.                    " CALC_ABEV_0_SZJA0_608
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_0_SZJA_06082
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_ADOAZON_ALL  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_0_SZJA_06082  TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                             T_ADOAZON_ALL STRUCTURE /ZAK/ADOAZONLPSZ.



*M0BC0082CA >= M0BC0082BA then M0BC0082DA = 0 and set flag
   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0082CA
                                C_ABEVAZ_M0BC0082BA
                                C_ABEVAZ_M0BC0082DA.


 ENDFORM.                    " CALC_ABEV_0_SZJA_06082

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_0_SZJA_0708
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_ADOAZON_ALL  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_0_SZJA_0708  TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                             T_ADOAZON_ALL STRUCTURE /ZAK/ADOAZONLPSZ.



*M0BC0082CA >= M0BC0082BA then M0BC0082DA = 0 and set flag
   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0382CA
                                C_ABEVAZ_M0BC0382BA
                                C_ABEVAZ_M0BC0382DA.




 ENDFORM.                    " CALC_ABEV_0_SZJA_0708


*&---------------------------------------------------------------------*
*&      Form  GET_NULL_FLAG
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_ADOAZON_ALL  text
*      -->P_C_ABEVAZ_M0BC0062CA  text
*      -->P_C_ABEVAZ_M0BC0062BA  text
*      -->P_C_ABEVAZ_M0BC0062DA  text
*----------------------------------------------------------------------*
 FORM GET_NULL_FLAG  TABLES   T_BEVALLO     STRUCTURE /ZAK/BEVALLO
                              T_ADOAZON_ALL STRUCTURE /ZAK/ADOAZONLPSZ
                     USING    $ABEV1
                              $ABEV2
                              $ABEV3.

   DATA L_O1 LIKE /ZAK/BEVALLO.
   DATA L_O2 LIKE /ZAK/BEVALLO.
   DATA L_O3 LIKE /ZAK/BEVALLO.

   DATA L_TABIX1 LIKE SY-TABIX.
   DATA L_TABIX2 LIKE SY-TABIX.
   DATA L_TABIX3 LIKE SY-TABIX.

*++0908 2009.02.27 BG
   DATA L_FIELD1 TYPE /ZAK/FIELDN.
   DATA L_FIELD2 TYPE /ZAK/FIELDN.
*--0908 2009.02.27 BG



   DEFINE L_M_GET_VALUE.
     CLEAR &4.
     READ TABLE T_BEVALLO WITH KEY ABEVAZ  = &1
                                   ADOAZON = &2
                                   LAPSZ   = &3
*++BG 2008.06.10
                               BINARY SEARCH.
*--BG 2008.06.10
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX  TO &4.
       MOVE T_BEVALLO TO &5.
     ENDIF.

   END-OF-DEFINITION.

   DEFINE L_M_CLEAR_FIELD_N.
     CLEAR: &1-FIELD_N, &1-FIELD_NR, &1-FIELD_NRK,
            &1-FIELD_ON, &1-FIELD_ONR, &1-FIELD_ONRK.
   END-OF-DEFINITION.

*  Let's read through each tax code
   LOOP AT T_ADOAZON_ALL.
     L_M_GET_VALUE $ABEV1
                 T_ADOAZON_ALL-ADOAZON
                 T_ADOAZON_ALL-LAPSZ
                 L_TABIX1
                 L_O1.
*    If there is no value in the first field, no further investigation is necessary
     CHECK NOT L_TABIX1 IS INITIAL.
     L_M_GET_VALUE $ABEV2
                 T_ADOAZON_ALL-ADOAZON
                 T_ADOAZON_ALL-LAPSZ
                 L_TABIX2
                 L_O2.

*++0908 2009.02.27 BG
     IF V_ONREV IS INITIAL.
       L_FIELD1 = L_O1-FIELD_N.
       L_FIELD2 = L_O2-FIELD_N.
     ELSE.
       L_FIELD1 = L_O1-FIELD_ON.
       L_FIELD2 = L_O2-FIELD_ON.
     ENDIF.

**    Feltétel vizsgálat
*     IF L_O1-FIELD_N GE L_O2-FIELD_N
**++BG 2008.04.09 és nem üres a mező
*        AND NOT L_O1-FIELD_N IS INITIAL
*        AND NOT L_O2-FIELD_N IS INITIAL.
*++BG 2008.04.09

*    Condition examination
     IF L_FIELD1 GE L_FIELD2
        AND NOT L_FIELD1 IS INITIAL
        AND NOT L_FIELD2 IS INITIAL.
*--0908 2009.02.27 BG
       L_M_GET_VALUE $ABEV3
                   T_ADOAZON_ALL-ADOAZON
                   T_ADOAZON_ALL-LAPSZ
                   L_TABIX3
                   L_O3.
*      There is a record value of 0 and it does not need to be deleted
       IF NOT L_TABIX3 IS INITIAL.
         L_M_CLEAR_FIELD_N L_O3.
         MOVE C_X TO L_O3-NULL_FLAG.
         MODIFY T_BEVALLO INDEX L_TABIX3 FROM L_O3
                          TRANSPORTING FIELD_N FIELD_NR FIELD_NRK
                                       FIELD_ON FIELD_ONR FIELD_ONRK
                                       NULL_FLAG.
*      No value needs to be created.
       ELSE.
         CLEAR L_O3.
         MOVE L_O1 TO L_O3.
         MOVE $ABEV3 TO L_O3-ABEVAZ.
         MOVE $ABEV3 TO L_O3-ABEVAZ_DISP.
         L_M_CLEAR_FIELD_N L_O3.
         MOVE C_X TO L_O3-NULL_FLAG.
         APPEND L_O3 TO T_BEVALLO.
         SORT T_BEVALLO.
       ENDIF.
     ENDIF.
   ENDLOOP.

 ENDFORM.                    " GET_NULL_FLAG
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_SZJA_START_0708
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SZJA_START_0708  TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                         T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                         T_ADOAZON STRUCTURE
                                         /ZAK/ONR_ADOAZON
                                  USING  $INDEX
                                         $DATE.

   DATA: L_SUM      LIKE /ZAK/BEVALLO-FIELD_N,
         L_SUM_203  LIKE /ZAK/BEVALLO-FIELD_N,
         L_KAMAT    LIKE /ZAK/BEVALLO-FIELD_N,
         L_ABEV_SUM LIKE /ZAK/BEVALLO-FIELD_N.
   DATA: L_KAM_KEZD  TYPE DATUM,
         L_KAM_VEG   TYPE DATUM,
         L_ROUND(20) TYPE C,
         L_TABIX     LIKE SY-TABIX,
         L_UPD.

   DATA: BEGIN OF I_ADOAZON OCCURS 0,
           ADOAZON TYPE /ZAK/ADOAZON,
         END OF I_ADOAZON.
   DATA: L_BEVALLO TYPE /ZAK/BEVALLO.

*++BG 2007.12.08
   DATA L_M0KB011A_BEVALLO TYPE /ZAK/BEVALLO.

   DEFINE LM_GET_SPEC_SUM1.

     LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ = &1.
*    Field M0KB011A must be defined based on the tax number
       READ TABLE T_BEVALLO INTO L_M0KB011A_BEVALLO
                WITH KEY ABEVAZ  = 'M0KB011A'
                         ADOAZON = L_BEVALLO-ADOAZON
                          LAPSZ  = L_BEVALLO-LAPSZ
                          BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         CONDENSE L_M0KB011A_BEVALLO-FIELD_C.
         IF L_M0KB011A_BEVALLO-FIELD_C EQ &2 OR
            L_M0KB011A_BEVALLO-FIELD_C EQ &3.
           ADD L_BEVALLO-FIELD_N TO W_/ZAK/BEVALLO-FIELD_N.
         ENDIF.
       ENDIF.
     ENDLOOP.
   END-OF-DEFINITION.
*--BG 2007.12.08

   CHECK $INDEX NE '000'.

************************************************************************
* Special abev fields
************************************************************************

   SORT T_BEVALLB BY ABEVAZ  .

* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE
*++BG 2007.12.08
            ABEVAZ EQ     C_ABEVAZ_A0EC0155CA OR
            ABEVAZ EQ     C_ABEVAZ_A0EC0156CA OR
            ABEVAZ EQ     C_ABEVAZ_A0EC50071A OR
            ABEVAZ EQ     C_ABEVAZ_A0EC50070A OR
            ABEVAZ EQ     C_ABEVAZ_A0EC50069A.
*--BG 2007.12.08

     CLEAR : L_SUM,W_/ZAK/BEVALLO.
* this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
*++BG 2006/05/24
     CHECK SY-SUBRC EQ 0.
*--BG 2006/05/24
     V_TABIX = SY-TABIX .
     CLEAR: W_/ZAK/BEVALLO-FIELD_N,
            W_/ZAK/BEVALLO-FIELD_NR,
            W_/ZAK/BEVALLO-FIELD_NRK.

     CASE W_/ZAK/BEVALLB-ABEVAZ.
*++BG 2007.12.08
* Special calculations
* START card obligation
       WHEN C_ABEVAZ_A0EC0155CA.
         CLEAR W_/ZAK/BEVALLO-FIELD_N.
         LM_GET_SPEC_SUM1 'M0KC0649CA' '01' '07'.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

       WHEN C_ABEVAZ_A0EC50071A.
         CLEAR W_/ZAK/BEVALLO-FIELD_N.
         LM_GET_SPEC_SUM1 'M0KC0649CA' '11' '12'.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

       WHEN C_ABEVAZ_A0EC50069A.
         CLEAR W_/ZAK/BEVALLO-FIELD_N.
         LM_GET_SPEC_SUM1 'M0KC0649CA' '13' '14'.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

       WHEN C_ABEVAZ_A0EC0156CA.
         CLEAR W_/ZAK/BEVALLO-FIELD_N.
         LM_GET_SPEC_SUM1 'M0KC0650CA' '01' '07'.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

       WHEN C_ABEVAZ_A0EC50070A.
         CLEAR W_/ZAK/BEVALLO-FIELD_N.
         LM_GET_SPEC_SUM1 'M0KC0650CA' '11' '12'.
         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*--BG 2007.12.08
     ENDCASE.
   ENDLOOP.

 ENDFORM.                    " CALC_ABEV_SZJA_START_0708
*&---------------------------------------------------------------------*
*&      Form  del_bevallo
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_ADOAZON  text
*----------------------------------------------------------------------*
 FORM DEL_BEVALLO  TABLES      T_BEVALLO STRUCTURE /ZAK/BEVALLO
                               T_ADOAZON STRUCTURE /ZAK/ONR_ADOAZON
                   USING       $INDEX.


*++BG 2007/01/16
*  Moved before calculation routines
*  We delete records that are not in the given period
*  adtak fel.
   LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                     WHERE NOT ADOAZON IS INITIAL.
     READ TABLE T_ADOAZON WITH KEY ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                                   BINARY SEARCH.
*    Nem kell a rekord.
     IF SY-SUBRC NE 0.
       DELETE T_BEVALLO.
       CONTINUE.
     ENDIF.
*  M 11 Mark with H if your declaration is considered a correction
     IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_M0AC018A.
*++BG 2007.03.22 Az ABEV program hibát jelez a "H"-ra "X"-el kell
*to fill out
*      MOVE 'H' TO W_/ZAK/BEVALLO-FIELD_C.
       MOVE C_X TO W_/ZAK/BEVALLO-FIELD_C.
*--BG 2007.03.22
     ENDIF.
*    A00-016-000-e Repeated self-check
     IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_A0AC036A AND
        $INDEX > '001'.
       MOVE C_X TO W_/ZAK/BEVALLO-FIELD_C.
     ENDIF.
     MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO.
   ENDLOOP.

   SORT T_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ.
*++BG 2007/01/16

 ENDFORM.                    " del_bevallo
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_SZJA_SPECIAL_0808
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*      -->P_$INDEX  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SZJA_SPECIAL_0808  TABLES T_BEVALLO STRUCTURE
 /ZAK/BEVALLO
                                          T_BEVALLB STRUCTURE
                                          /ZAK/BEVALLB
                                          T_ADOAZON STRUCTURE
                                          /ZAK/ONR_ADOAZON
                                   USING  $INDEX
                                          $DATE.


   DATA LR_COND TYPE RANGE_C2 OCCURS 0 WITH HEADER LINE.
   DATA L_TMP_BEVALLO TYPE /ZAK/BEVALLO.
   DATA L_BEVALLO TYPE /ZAK/BEVALLO.

   FIELD-SYMBOLS: <FIELD_N>, <FIELD_NR>, <FIELD_NRK>.

   DEFINE LM_GET_FIELD.
     IF &1 EQ '000'.
       ASSIGN W_/ZAK/BEVALLO-FIELD_N   TO <FIELD_N>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_NR  TO <FIELD_NR>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_NRK TO <FIELD_NRK>.
     ELSE.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ON   TO <FIELD_N>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ONR  TO <FIELD_NR>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ONRK TO <FIELD_NRK>.
     ENDIF.
     CLEAR: <FIELD_N>, <FIELD_NR>, <FIELD_NRK>.
   END-OF-DEFINITION.

   DEFINE LM_GET_SPEC_SUM1.
     LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ = &1.
*      The ABEV for the condition must be determined
*      ID value
       READ TABLE T_BEVALLO INTO L_TMP_BEVALLO
                WITH KEY ABEVAZ  = &2
                         ADOAZON = L_BEVALLO-ADOAZON
                          LAPSZ  = L_BEVALLO-LAPSZ
                          BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         CONDENSE L_TMP_BEVALLO-FIELD_C.
         IF L_TMP_BEVALLO-FIELD_C IN &3.
           ADD L_BEVALLO-FIELD_N TO <FIELD_N>.
         ENDIF.
       ENDIF.
     ENDLOOP.
   END-OF-DEFINITION.


   SORT T_BEVALLB BY ABEVAZ.


* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE ABEVAZ EQ C_ABEVAZ_A0CC0040CA OR
           ABEVAZ EQ C_ABEVAZ_A0CC0041CA OR
           ABEVAZ EQ C_ABEVAZ_A0CC0042CA OR
           ABEVAZ EQ C_ABEVAZ_A0CC0043CA OR
           ABEVAZ EQ C_ABEVAZ_A0CC0044CA OR
           ABEVAZ EQ C_ABEVAZ_A0CC0045CA OR
           ABEVAZ EQ C_ABEVAZ_A0CC0046CA OR
           ABEVAZ EQ C_ABEVAZ_A0CC0047CA OR
           ABEVAZ EQ C_ABEVAZ_A0CC0048CA OR
           ABEVAZ EQ C_ABEVAZ_A0DC0060CA OR
           ABEVAZ EQ C_ABEVAZ_A0DC0061CA OR
           ABEVAZ EQ C_ABEVAZ_A0DC0062CA OR
           ABEVAZ EQ C_ABEVAZ_A0DC0063CA OR
           ABEVAZ EQ C_ABEVAZ_A0DC0080CA OR
           ABEVAZ EQ C_ABEVAZ_A0DC0081CA OR
           ABEVAZ EQ C_ABEVAZ_A0DC0082CA OR
           ABEVAZ EQ C_ABEVAZ_A0DC0083CA OR
           ABEVAZ EQ C_ABEVAZ_A0DC0084CA OR
           ABEVAZ EQ C_ABEVAZ_A0DC0085CA.

     CLEAR W_/ZAK/BEVALLO.

*    this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
*++BG 2008.06.10
              BINARY SEARCH.
*--BG 2008.06.10

     CHECK SY-SUBRC EQ 0.

     V_TABIX = SY-TABIX .

*    Special calculations
     CASE W_/ZAK/BEVALLB-ABEVAZ.
*      02-40-c The total burden of the pension commission
       WHEN  C_ABEVAZ_A0CC0040CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         M_DEF LR_COND 'E' 'EQ' '94' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0551CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0596CA' 'M0IC004A' LR_COND.

         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      02-41-c The employee is unemployed, the employment circle pays pension insurance
       WHEN  C_ABEVAZ_A0CC0041CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0551CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0596CA' 'M0IC004A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 02-40-c The nursing care fee for the patient pension commission
       WHEN  C_ABEVAZ_A0CC0042CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '94' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0551CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0596CA' 'M0IC004A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 02-43-c The private burden pension
       WHEN  C_ABEVAZ_A0CC0043CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         M_DEF LR_COND 'E' 'EQ' '83' SPACE.
         M_DEF LR_COND 'E' 'EQ' '92' SPACE.
         M_DEF LR_COND 'E' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0558CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0591CA' 'M0IC004A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 02-44-c Private burden unemployment, employment pension
       WHEN  C_ABEVAZ_A0CC0044CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0558CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0591CA' 'M0IC004A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 02-45-c The private sector pays pension after GYED, S, T
       WHEN  C_ABEVAZ_A0CC0045CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '83' SPACE.
         M_DEF LR_COND 'I' 'EQ' '92' SPACE.
         M_DEF LR_COND 'I' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0558CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0591CA' 'M0IC004A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 02-46-c Mnypt member private pension
       WHEN  C_ABEVAZ_A0CC0046CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         M_DEF LR_COND 'E' 'EQ' '83' SPACE.
         M_DEF LR_COND 'E' 'EQ' '92' SPACE.
         M_DEF LR_COND 'E' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0559CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0592CA' 'M0IC004A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 02-47-c Mnypt member private tax unemployment, unemployment pension
       WHEN  C_ABEVAZ_A0CC0047CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0559CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0592CA' 'M0IC004A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      The 02-48-cA Mnypt member pays private tax GYED,S,T pension
       WHEN  C_ABEVAZ_A0CC0048CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '83' SPACE.
         M_DEF LR_COND 'I' 'EQ' '92' SPACE.
         M_DEF LR_COND 'I' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0559CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0592CA' 'M0IC004A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 03-60-c A fogl terh term egbizt
       WHEN  C_ABEVAZ_A0DC0060CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0552CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0597CA' 'M0IC004A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      The 03-61-c The burden of unemployment benefits the employee
       WHEN  C_ABEVAZ_A0DC0061CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0552CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0597CA' 'M0IC004A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      The 03-62-c The prisoner is charged with money insurance
       WHEN  C_ABEVAZ_A0DC0062CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0553CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0598CA' 'M0IC004A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      The 03-63-c The unemployment insurance of the employee
       WHEN  C_ABEVAZ_A0DC0063CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0553CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0598CA' 'M0IC004A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      03-80-c The START card is 15%
       WHEN  C_ABEVAZ_A0DC0080CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '01' SPACE.
         M_DEF LR_COND 'I' 'EQ' '07' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KD0644CA' 'M0KC008A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      03-81-c With the START card, the order is 25%
       WHEN  C_ABEVAZ_A0DC0081CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '01' SPACE.
         M_DEF LR_COND 'I' 'EQ' '07' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KD0645CA' 'M0KC008A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 03-82-c  A START PLUSZ rend 15%-os
       WHEN  C_ABEVAZ_A0DC0082CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '11' SPACE.
         M_DEF LR_COND 'I' 'EQ' '12' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KD0644CA' 'M0KC008A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 03-83-c A START PLUSZ rend 25%-os
       WHEN  C_ABEVAZ_A0DC0083CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '11' SPACE.
         M_DEF LR_COND 'I' 'EQ' '12' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KD0645CA' 'M0KC008A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      With the 03-84-c A START EXTRA card, the order is 0%
       WHEN  C_ABEVAZ_A0DC0084CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '13' SPACE.
         M_DEF LR_COND 'I' 'EQ' '14' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KD0643CA' 'M0KC008A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      With the 03-85-c A START EXTRA card, the rate is 15%
       WHEN  C_ABEVAZ_A0DC0085CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '13' SPACE.
         M_DEF LR_COND 'I' 'EQ' '14' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KD0644CA' 'M0KC008A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

     ENDCASE.

   ENDLOOP.









 ENDFORM.                    " CALC_ABEV_SZJA_SPECIAL_0808
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_ONREV_SZJA_0808
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*      -->P_$INDEX  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONREV_SZJA_0808
                           TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                   T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                   T_ADOAZON STRUCTURE /ZAK/ONR_ADOAZON
                           USING   $INDEX
                                   $LAST_DATE.

   DATA LI_LAST_BEVALLO LIKE /ZAK/BEVALLO OCCURS 0 WITH HEADER LINE.

   DATA L_LAST_INDEX LIKE /ZAK/BEVALLO-ZINDEX.
   DATA L_TABIX LIKE SY-TABIX.
   DATA L_TRUE.

   RANGES LR_ONREV_ABEVAZ FOR /ZAK/BEVALLB-ABEVAZ.
   DATA   L_ABEVAZ LIKE /ZAK/BEVALLB-ABEVAZ.

   DATA: L_KAM_KEZD TYPE DATUM,
         L_KAM_VEG  TYPE DATUM.
   DATA   L_KAMAT LIKE /ZAK/BEVALLO-FIELD_N.
   DATA   L_KAMAT_SUM LIKE /ZAK/BEVALLO-FIELD_N.

*  To upload fields to be summarized
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.

*  If self-revision
   CHECK $INDEX NE '000'.

   SORT T_BEVALLB BY ABEVAZ.

*  Let's read the 'A' abev identifiers of the previous period
   READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO INDEX 1.
   CHECK SY-SUBRC EQ 0.
   L_LAST_INDEX = $INDEX - 1.

   CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
     EXPORTING
       INPUT  = L_LAST_INDEX
     IMPORTING
       OUTPUT = L_LAST_INDEX.


   SELECT * INTO TABLE LI_LAST_BEVALLO
                 FROM  /ZAK/BEVALLO
                WHERE  BUKRS   EQ W_/ZAK/BEVALLO-BUKRS
                  AND  BTYPE   EQ W_/ZAK/BEVALLO-BTYPE
                  AND  GJAHR   EQ W_/ZAK/BEVALLO-GJAHR
                  AND  MONAT   EQ W_/ZAK/BEVALLO-MONAT
                  AND  ZINDEX  EQ L_LAST_INDEX
                  AND  ADOAZON EQ ''.

   SORT LI_LAST_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ.

*  We delete records that are not in the given period
*  adtak fel.
   LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                     WHERE NOT ADOAZON IS INITIAL.
     READ TABLE T_ADOAZON WITH KEY ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                                   BINARY SEARCH.
*    Nem kell a rekord.
     IF SY-SUBRC NE 0.
       DELETE T_BEVALLO.
       CONTINUE.
     ENDIF.
*  M 11 Mark with an X if your declaration is considered a correction
     IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_M0AC018A.
       MOVE C_X TO W_/ZAK/BEVALLO-FIELD_C.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO TRANSPORTING FIELD_C.
     ENDIF.
   ENDLOOP.

*  Mark with an X if your return is considered a correction
   READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                             WITH KEY ABEVAZ = C_ABEVAZ_A0AC033A.
   IF SY-SUBRC EQ 0.
     MOVE SY-TABIX TO L_TABIX.
     MOVE 'X' TO W_/ZAK/BEVALLO-FIELD_C.
     MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
   ENDIF.

**  Számítási algoritmus ÖNREVÍZIÓHOZ:

* A 07-199-d From line 198: personal not linked to a private individual
* income tax
* A0HC0199DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0199DA   "Módosított mező
                                 C_ABEVAZ_A0BC0001CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5


*A 07-200-c From line 198: personal income tax due to an individual
*A0HC0200CA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                LI_LAST_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0200CA   "Módosított mező
*++BG 2008.03.06
                                C_ABEVAZ_A0ZZ000001         "Forrás 1
                                SPACE                       "Forrás 2
                                SPACE                       "Forrás 3
                                SPACE                       "Forrás 4
                                SPACE.                      "Forrás 5
*                               C_ABEVAZ_M0CC0415DA "Source 1
*                               C_ABEVAZ_M0CF0430BA "Source 2
*                               C_ABEVAZ_M0CF0431BA "Source 3
*                               C_ABEVAZ_M0CF0434BA "Source 4
*                               C_ABEVAZ_M0CF0435CA.        "Source 5
*--BG 2008.03.06

*A 07-200-d From line 198: personal related to an individual
*income tax
*A0HC0200DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0200DA   "Módosított mező
                                 C_ABEVAZ_A0CC0035CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*Special Tax 08-201-d (obligation difference)
*A0HC0201DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0201DA   "Módosított mező
                                 C_ABEVAZ_A0CC0039CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5


*Special tax 07-201-c (basis of obligation)
*A0HC0201CA = A0HC0201DA/4%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0201CA   "Módosított mező
                                C_ABEVAZ_A0HC0201DA
                                '0.04'.

*A 07-203-d From line 202, the pension commission charged to the employer.
*contribution (obligation difference
*A0HC0203DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0203DA   "Módosított mező
                                 C_ABEVAZ_A0BC0014CA        "Forrás 1
                                 C_ABEVAZ_A0CC0040CA        "Forrás 2
                                 C_ABEVAZ_A0CC0041CA        "Forrás 3
                                 C_ABEVAZ_A0CC0042CA        "Forrás 4
                                 SPACE.                     "Forrás 5

*A 07-203-c From line 202, the pension commission charged to the employer. contribution
*(base difference)
*A0HC0203CA = A0HC0203DA/24%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0203CA   "Módosított mező
                                C_ABEVAZ_A0HC0203DA
                                '0.24'.

*A 07-204-d The pension contribution deducted from the insured person from line 202
*(obligation difference
*A0HC0204DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0204DA   "Módosított mező
                                 C_ABEVAZ_A0CC0043CA        "Forrás 1
                                 C_ABEVAZ_A0CC0044CA        "Forrás 2
                                 C_ABEVAZ_A0CC0045CA        "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A 07-204-c The pension contribution deducted from the insured person from line 202
*(base difference)
*A0HC0204CA = A0HC0204DA/9,5%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0204CA   "Módosított mező
                                C_ABEVAZ_A0HC0204DA
                                '0.095'.

*A 07-205-d Pension contribution deducted from Mnypt insured person from line 202
*(obligation difference
*A0HC0205DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0205DA   "Módosított mező
                                 C_ABEVAZ_A0CC0046CA        "Forrás 1
                                 C_ABEVAZ_A0CC0047CA        "Forrás 2
                                 C_ABEVAZ_A0CC0048CA        "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A 07-205-c Pension contribution deducted from the Mnypt insured person from line 202
*(base difference)
*A0HC0205CA = A0HC0205DA/1,5%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0205CA   "Módosított mező
                                C_ABEVAZ_A0HC0205DA
                                '0.015'.

*A 07-206-d Retirement commission paid after the service fee from line 202
*contribution (15%) (obligation
*A0HC0206DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0206DA   "Módosított mező
                                 C_ABEVAZ_A0CC0049CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A 07-206-c Retirement commission paid after the service fee from line 202
*contribution (15%) (excl. fund)
*A0HC0206CA = A0HC0206DA/15%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0206CA   "Módosított mező
                                C_ABEVAZ_A0HC0206DA
                                '0.15'.

*A 07-209-d From line 208, in kind charged to the employer
*eg.bizt.
*contribution (obligation
*A0HC0209DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0209DA   "Módosított mező
                                 C_ABEVAZ_A0BC0015CA        "Forrás 1
                                 C_ABEVAZ_A0DC0060CA        "Forrás 2
                                 C_ABEVAZ_A0DC0061CA        "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A 07-209-c From line 208, the in-kind payment burdening the employer.
*commission contribution (fund differ
*A0HC0209CA = A0HC0209DA/4,5%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0209CA   "Módosított mező
                                C_ABEVAZ_A0HC0209DA
                                '0.045'.


*A 07-210-d From line 208, the financial insurance for the employer.
*contribution (vol. misc.)
*A0HC0210DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0210DA   "Módosított mező
                                 C_ABEVAZ_A0BC0016CA        "Forrás 1
                                 C_ABEVAZ_A0DC0062CA        "Forrás 2
                                 C_ABEVAZ_A0DC0063CA        "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A 07-210-c From line 208, the financial insurance for the employer.
*contribution (base difference)
*A0HC0210CA = A0HC0210DA/0,5%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0210CA   "Módosított mező
                                C_ABEVAZ_A0HC0210DA
                                '0.005'.

*A 07-211-c From line 208, the health burden on the social enterprise
*szolg.
*(base difference)
*A0HC0211DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0211DA   "Módosított mező
                                 C_ABEVAZ_A0DC0064CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5


*07-212-d The product deducted from the insured from line 208.  health insurance
*contribution
*(obligation
*A0HC0212DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0212DA   "Módosított mező
                                 C_ABEVAZ_A0DC0065CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*07-212-c The product deducted from the insured from line 208. health insurance
*contribution (base diff
*A0HC0212CA = A0HC0212DA/4%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0212CA   "Módosított mező
                                C_ABEVAZ_A0HC0212DA
                                '0.04'.

*A 07-213-d Deducted from the insured from line 208 in cash
*health insurance contribution
*(obligation
*A0HC0213DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0213DA   "Módosított mező
                                 C_ABEVAZ_A0DC0066CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A 07-213-c Cash health insurance deducted from the insured person from line 208.
*contribution (base difference
*A0HC0213CA = A0HC0213DA/2%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0213CA   "Módosított mező
                                C_ABEVAZ_A0HC0213DA
                                '0.02'.


*A 07-215-d Age discount insurance contribution (difference in liability)
*A0HC0215DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0215DA   "Módosított mező
                                 C_ABEVAZ_A0CC0052CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A 07-215-c Age discount insurance contribution (base difference)
*A0HC0215CA = A0HC0215DA/3,25%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0215CA   "Módosított mező
                                C_ABEVAZ_A0HC0215DA
                                '0.0325'.


*A 07-216-d Employer's contribution (difference in liability)
*A0HC0216DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0216DA   "Módosított mező
                                 C_ABEVAZ_A0BC0013CA        "Forrás 1
                                 C_ABEVAZ_A0DC0077CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A 07-216-c Employer's contribution (base difference)
*A0HC0216CA = A0HC0216DA/3%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0216CA   "Módosított mező
                                C_ABEVAZ_A0HC0216DA
                                '0.03'.

*A 07-217-d Employee contribution (difference in liability)
*A0HC0217DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0217DA   "Módosított mező
                                 C_ABEVAZ_A0DC0078CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A 07-217-c Employee contribution (base difference)
*A0HC0217CA = A0HC0217DA/1,5%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0217CA   "Módosított mező
                                C_ABEVAZ_A0HC0217DA
                                '0.015'.

*A 07-218-d Entrepreneur's contribution (difference in liability)
*A0HC0218DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0218DA   "Módosított mező
                                 C_ABEVAZ_A0DC0079DA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A 07-218-c Entrepreneur's contribution (base difference)
*A0HC0218CA = A0HC0218DA/4%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0218CA   "Módosított mező
                                C_ABEVAZ_A0HC0218DA
                                '0.04'.

*A 07-220-d From line 219 Pertains to START card holders
*15% vol. (distinction)
*A0HC0220DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0220DA   "Módosított mező
                                 C_ABEVAZ_A0DC0080CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A 07-220-c From line 219 The 15% for START card holders
*volume of os. (basis)
*A0HC0220CA = A0HC0220DA/15%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0220CA   "Módosított mező
                                C_ABEVAZ_A0HC0220DA
                                '0.15'.


*A 07-221-d From line 219 Pertains to START card holders
*25% vol. (distinction)
*A0HC0221DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0221DA   "Módosított mező
                                 C_ABEVAZ_A0DC0081CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A 07-221-c From line 219 The 25% for START card holders
*volume of os. (page)
*A0HC0221CA = A0HC0221DA/25%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0221CA   "Módosított mező
                                C_ABEVAZ_A0HC0221DA
                                '0.25'.

*A 07-221-d From line 219 Pertains to START card holders
*25% vol. (distinction)
*A0HC0221DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0222DA   "Módosított mező
                                 C_ABEVAZ_A0DC0082CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A 07-222-c From line 219 concerning START PLUS card holders
*15% vol. (better)
*A0HC0222CA = A0HC0222DA/15%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0222CA   "Módosított mező
                                C_ABEVAZ_A0HC0222DA
                                '0.15'.

*A 07-223-d From line 219 concerning START PLUS card holders
* 25% vol. (basis)
*A0HC0223DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0223DA   "Módosított mező
                                 C_ABEVAZ_A0DC0083CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A 07-223-c From line 219 concerning START PLUS card holders
* 25% vol. (better)
*A0HC0223CA = A0HC0223DA/25%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0223CA   "Módosított mező
                                C_ABEVAZ_A0HC0223DA
                                '0.25'.

*A 07-224-d from line 219 applies to START EXTRA card holders
*15% vol. (basis)
*A0HC0224DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0224DA   "Módosított mező
                                 C_ABEVAZ_A0DC0085CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A 07-224-c From line 219 applies to START EXTRA card holders
* 15% vol. (better)
*A0HC0224CA = A0HC0224DA/15%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0224CA   "Módosított mező
                                C_ABEVAZ_A0HC0224DA
                                '0.15'.

*A 07-225-c Percentage health contribution
*(base difference)
*A0HC0225CA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0225CA   "Módosított mező
*++BG 2008.03.06
                                 C_ABEVAZ_A0ZZ000002        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*                                C_ABEVAZ_M0EC0461CA "Source 1
*                                C_ABEVAZ_M0EC0463CA "Source 2
*                                SPACE "Source 3
*                                SPACE "Source 4
*                                SPACE.                     "Source 5
*--BG 2008.03.06


*A 07-225-d Percentage health contribution
* (obligation difference)
*A0HC0225DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0225DA   "Módosított mező
                                 C_ABEVAZ_A0DC0087CA        "Forrás 1
                                 C_ABEVAZ_A0BC0017CA        "Forrás 2
                                 C_ABEVAZ_A0BC0018CA        "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A 07-227-d From line 226 Item Eho in full time
*(obligation difference)
*A0HC0227DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0227DA   "Módosított mező
                                 C_ABEVAZ_A0DC0088CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A 07-228-d From line 226 Item Eho in part-time work
*(obligation difference)
*A0HC0228DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0228DA   "Módosított mező
                                 C_ABEVAZ_A0DC0089CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5


*A 07-229-d From line 226 Eho tv. Section 11 (4) (obligation
*difference)
*A0HC0229DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0229DA   "Módosított mező
                                 C_ABEVAZ_A0DC0090CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A 08-230-d A simplified public burden on the payer.
*-i contributes 20% (obligation difference
*A0IC0230DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0230DA   "Módosított mező
                                 C_ABEVAZ_A0EC0092CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A 08-230-c The simplified public burden on the payer.-i
*contributes 20% (basis of obligation)
*A0IC0230CA = A0IC0230DA/20%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC0230CA   "Módosított mező
                                C_ABEVAZ_A0IC0230DA
                                '0.20'.

*A 08-231-a Part of the health insurance contribution calculated from line 230
*(basis of obligation)
*A0IC0231AA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC0231AA   "Módosított mező
                                C_ABEVAZ_A0IC0230CA
                                '30.30303'.

*A 08-232-a Part of the health insurance contribution calculated from line 230
*(obligation difference
*A0IC0232AA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC0232AA   "Módosított mező
                                C_ABEVAZ_A0IC0230CA
                                '5.98802'.

*A 08-233-d Ekho burdening a retired individual (obligation
*difference
*A0IC0233DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0233DA   "Módosított mező
                                 C_ABEVAZ_A0EC0095CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A 08-233-c Ekho burdening a retired individual (obligation
*alapja)
*A0IC0233CA = A0IC0233DA/11%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC0233CA   "Módosított mező
                                C_ABEVAZ_A0IC0233DA
                                '0.11'.

*A 08-234-d Ekho charged to a private individual who is not a Mnypt member (15%)
*(obligation difference
*A0IC0234DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0234DA   "Módosított mező
                                 C_ABEVAZ_A0EC0096CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A 08-234-d Ekho charged to a private individual who is not a Mnypt member (15%)
*(obligation)
*A0IC0234CA = A0IC0234DA/15%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC0234CA   "Módosított mező
                                C_ABEVAZ_A0IC0234DA
                                '0.15'.
*08-235-a Part of the pension contribution calculated from line 234
*(basis of obligation)
*A0IC0235AA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC0235AA   "Módosított mező
                                C_ABEVAZ_A0IC0234CA
                                '25.64102'.

*08-236-a The product calculated from line 234. insurance contribution part
*(obligation difference
*A0IC0236AA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC0236AA   "Módosított mező
                                C_ABEVAZ_A0IC0234CA
                                '62.5'.


*08-237-d A Mnypt member is responsible for Ekho (15%) in total
*(obligation difference
*A0IC0237DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0237DA   "Módosított mező
                                 C_ABEVAZ_A0EC0099CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A 08-237-c A Mnypt member is liable to an individual Ekho (15%) in total
*(obligation)
*A0IC0237CA = A0IC0237DA/15%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC0237CA   "Módosított mező
                                C_ABEVAZ_A0IC0237DA
                                '0.15'.

*08-238-a Part of the pension contribution calculated from line 237
*A0IC0238AA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC0238AA   "Módosított mező
                                C_ABEVAZ_A0IC0237CA
                                '1000.00'.

*08-239-a The product calculated from line 237. I'm sure. part
*A0IC0239AA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC0239AA   "Módosított mező
                                C_ABEVAZ_A0IC0237CA
                                '62.5'.

*A 08-260-d Ekho deducted from a person insured in an EEA member state
*(obligation difference
*A0IC0260DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0IC0260DA   "Módosított mező
                                 C_ABEVAZ_A0EC0122CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A 08-260-c Ekho deducted from a person insured in an EEA member state
*(obligation base)
*A0IC0260CA = A0IC0260DA/9,5%
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0IC0260CA   "Módosított mező
                                C_ABEVAZ_A0IC0260DA
                                '0.095'.

*COMPOUNDS
*Total personal income tax 07-198-c (base difference)
*A0HC0198CA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0199CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0200CA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0198CA.


*Total personal income tax 07-198-d (difference in liability)
*A0HC0198DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0199DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0200DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0198DA.

*07-202-c Pension Commission. Total contributions due to the fund
*(base difference)
*A0HC0202CA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0203CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0204CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0205CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0206CA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0202CA.

*07-202-d Pension Commission. Total contributions due to the fund
*(obligation difference)
*A0HC0202DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0203DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0204DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0205DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0206DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0202DA.


*Total contributions due to the Health Insurance Fund 07-208-c
*(base difference)
*A0HC0208CA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0209CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0210CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0211CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0212CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0213CA SPACE.


   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0208CA.


*Total contributions due to the Health Insurance Fund 07-208-d
*(obligation difference
*A0HC0208DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0209DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0210DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0211DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0212DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0213DA SPACE.


   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0208DA.


*With the 07-219-c A START (START, PLUST, EXTRA) card 15
*and/or 25% bond base
*A0HC0219CA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0220CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0221CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0222CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0223CA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0224CA SPACE.


   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0219CA.


*With the 07-219-d A START (START, PLUST, EXTRA) card
*15 and/or 25% bond
*A0HC0219DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0220DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0221DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0222DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0223DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0224DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0219DA.


*A 07-226-d Itemized medical contribution
*(obligation difference)
*A0HC0226DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0227DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0228DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0229DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0226DA.

*++0808 2009.02.11 BG
   REFRESH LR_ABEVAZ.
*  A numerical value must be searched for in this range
   M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0HC0198CA C_ABEVAZ_A0HC0229DA.
   M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0IC0230CA C_ABEVAZ_A0ID0272BA.
   M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0JC0280CA C_ABEVAZ_A0JC0307EA.
   M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0KC0308CA C_ABEVAZ_A0KC0335EA.
   M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0LC0336CA C_ABEVAZ_A0LC0359EA.
   M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0LC50099A C_ABEVAZ_A0LC50105A.
   LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO WHERE ABEVAZ IN LR_ABEVAZ
                                   AND NOT FIELD_N IS INITIAL.
     EXIT.
   ENDLOOP.
*  There is value:
   IF SY-SUBRC EQ 0.
*--0808 2009.02.11 BG
*  Mark with an X if your declaration qualifies as a self-verification
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                               WITH KEY ABEVAZ = C_ABEVAZ_A0AC035A.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE 'X' TO W_/ZAK/BEVALLO-FIELD_C.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.

*  Mark with an X if your declaration is considered a repeated self-check
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                               WITH KEY ABEVAZ = C_ABEVAZ_A0AC036A.

     IF SY-SUBRC EQ 0 AND $INDEX > '001'.
       MOVE SY-TABIX TO L_TABIX.
       MOVE 'X' TO W_/ZAK/BEVALLO-FIELD_C.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
     ENDIF.
*++0808 2009.02.11 BG
   ENDIF.
*--0808 2009.02.11 BG


 ENDFORM.                    " CALC_ABEV_ONREV_SZJA_0808
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_SZJA_0808
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$LAST_DATE  text
*      -->P_$INDEX  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SZJA_0808
                    TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                            T_BEVALLB STRUCTURE /ZAK/BEVALLB
                     USING  $DATE
                            $INDEX.

   DATA: L_KAM_KEZD TYPE DATUM.

   DATA: BEGIN OF LI_ADOAZON OCCURS 0,
           ADOAZON TYPE /ZAK/ADOAZON,
         END OF LI_ADOAZON.
   DATA: L_BEVALLO TYPE /ZAK/BEVALLO.


************************************************************************
* Special abev fields
************************************************************************

   SORT T_BEVALLB BY ABEVAZ  .

* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE  ABEVAZ EQ     C_ABEVAZ_A0AC029A
        OR  ABEVAZ EQ     C_ABEVAZ_A0AC030A
        OR  ABEVAZ EQ     C_ABEVAZ_A0AC039A.

     CLEAR W_/ZAK/BEVALLO.

*    this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
*++BG 2008.06.10
          BINARY SEARCH.
*--BG 2008.06.10

     CHECK SY-SUBRC EQ 0.
     V_TABIX = SY-TABIX .


     CASE W_/ZAK/BEVALLB-ABEVAZ.
* always A0AC029A = first day from period
       WHEN C_ABEVAZ_A0AC029A.
* Havi
         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* A year old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'E'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+4(4) = '0101'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* He is four years old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.

           L_KAM_KEZD = $DATE.
           IF L_KAM_KEZD+4(2) >= '01' AND
              L_KAM_KEZD+4(2) <= '03'.

             L_KAM_KEZD+4(4) = '0101'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '04' AND
              L_KAM_KEZD+4(2) <= '06'.

             L_KAM_KEZD+4(4) = '0401'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '07' AND
              L_KAM_KEZD+4(2) <= '09'.

             L_KAM_KEZD+4(4) = '0701'.
           ENDIF.


           IF L_KAM_KEZD+4(2) >= '10' AND
              L_KAM_KEZD+4(2) <= '12'.

             L_KAM_KEZD+4(4) = '1001'.
           ENDIF.

           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ELSE.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ENDIF.

         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*      always A0AC030A = last day until period
       WHEN C_ABEVAZ_A0AC030A.
         W_/ZAK/BEVALLO-FIELD_C = $DATE.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*      Number of taxpayers = Tax numbers
       WHEN C_ABEVAZ_A0AC039A.

         REFRESH LI_ADOAZON.
         LOOP AT T_BEVALLO INTO L_BEVALLO.
           CHECK NOT L_BEVALLO-ADOAZON IS INITIAL.
           MOVE L_BEVALLO-ADOAZON TO LI_ADOAZON.
           COLLECT LI_ADOAZON.
         ENDLOOP.


         DESCRIBE TABLE LI_ADOAZON LINES SY-TFILL.
         IF NOT SY-TFILL IS INITIAL.
           W_/ZAK/BEVALLO-FIELD_C = SY-TFILL.
         ELSE.
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
         ENDIF.

         CONDENSE W_/ZAK/BEVALLO-FIELD_C.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

     ENDCASE.

   ENDLOOP.


 ENDFORM.                    " CALC_ABEV_SZJA_0808
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_0_SZJA_0808
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_ADOAZON_ALL  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_0_SZJA_0808  TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                             T_ADOAZON_ALL STRUCTURE /ZAK/ADOAZONLPSZ
*++0908 2009.02.27 BG
                             USING   $ONREV.

* So that you don't have to expand the self-revision to a global one for every FORM
* treated as a variable:
   CLEAR V_ONREV.
   IF NOT $ONREV IS INITIAL.
     MOVE $ONREV TO V_ONREV.
   ENDIF.
*--0908 2009.02.27 BG

*M0BC0382CA >= M0BC0382BA then M0BC0382DA = 0 and set flag
   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0382CA
                                C_ABEVAZ_M0BC0382BA
                                C_ABEVAZ_M0BC0382DA.
*M0BC0382DA >= M0BC0382BA then M0BC0382CA = 0 and set flag
   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0382DA
                                C_ABEVAZ_M0BC0382BA
                                C_ABEVAZ_M0BC0382CA.
*M0BC0386CA >= M0BC0386BA then M0BC0386DA = 0 and set flag
   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0386CA
                                C_ABEVAZ_M0BC0386BA
                                C_ABEVAZ_M0BC0386DA.
*M0BC0386DA >= M0BC0386BA then M0BC0386CA = 0 and set flag
   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0386DA
                                C_ABEVAZ_M0BC0386BA
                                C_ABEVAZ_M0BC0386CA.

*  If field1+field2+field3+field4 > 0 then 0 flag setting
   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0JC0283EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0JC0280DA    "mező1
                                     C_ABEVAZ_A0JC0281DA    "mező2
                                     C_ABEVAZ_A0JC0282DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0JC0287EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0JC0284DA    "mező1
                                     C_ABEVAZ_A0JC0285DA    "mező2
                                     C_ABEVAZ_A0JC0286DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0JC0291EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0JC0288DA    "mező1
                                     C_ABEVAZ_A0JC0289DA    "mező2
                                     C_ABEVAZ_A0JC0290DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0JC0295EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0JC0292DA    "mező1
                                     C_ABEVAZ_A0JC0293DA    "mező2
                                     C_ABEVAZ_A0JC0294DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0JC0299EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0JC0296DA    "mező1
                                     C_ABEVAZ_A0JC0297DA    "mező2
                                     C_ABEVAZ_A0JC0298DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0JC0303EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0JC0300DA    "mező1
                                     C_ABEVAZ_A0JC0301DA    "mező2
                                     C_ABEVAZ_A0JC0302DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0JC0307EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0JC0304DA    "mező1
                                     C_ABEVAZ_A0JC0305DA    "mező2
                                     C_ABEVAZ_A0JC0306DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0KC0311EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0KC0308DA    "mező1
                                     C_ABEVAZ_A0KC0309DA    "mező2
                                     C_ABEVAZ_A0KC0310DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0KC0315EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0KC0312DA    "mező1
                                     C_ABEVAZ_A0KC0313DA    "mező2
                                     C_ABEVAZ_A0KC0314DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0KC0319EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0KC0316DA    "mező1
                                     C_ABEVAZ_A0KC0317DA    "mező2
                                     C_ABEVAZ_A0KC0318DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0KC0323EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0KC0320DA    "mező1
                                     C_ABEVAZ_A0KC0321DA    "mező2
                                     C_ABEVAZ_A0KC0322DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0KC0327EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0KC0324DA    "mező1
                                     C_ABEVAZ_A0KC0325DA    "mező2
                                     C_ABEVAZ_A0KC0326DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0KC0331EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0KC0328DA    "mező1
                                     C_ABEVAZ_A0KC0329DA    "mező2
                                     C_ABEVAZ_A0KC0330DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0KC0335EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0KC0332DA    "mező1
                                     C_ABEVAZ_A0KC0333DA    "mező2
                                     C_ABEVAZ_A0KC0334DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0LC0339EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0LC0336DA    "mező1
                                     C_ABEVAZ_A0LC0337DA    "mező2
                                     C_ABEVAZ_A0LC0338DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0LC0343EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0LC0340DA    "mező1
                                     C_ABEVAZ_A0LC0341DA    "mező2
                                     C_ABEVAZ_A0LC0342DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0LC0347EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0LC0344DA    "mező1
                                     C_ABEVAZ_A0LC0345DA    "mező2
                                     C_ABEVAZ_A0LC0346DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0LC0351EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0LC0348DA    "mező1
                                     C_ABEVAZ_A0LC0349DA    "mező2
                                     C_ABEVAZ_A0LC0350DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0LC0355EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0LC0352DA    "mező1
                                     C_ABEVAZ_A0LC0353DA    "mező2
                                     C_ABEVAZ_A0LC0354DA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0LC0359EA
                              "0-flag beállítás
                                     C_ABEVAZ_A0LC0356DA    "mező1
                                     C_ABEVAZ_A0LC0357DA    "mező2
                                     C_ABEVAZ_A0LC0358DA    "mező3
                                     SPACE.                 "mező4

* If field1 is not 0 or field2 is not 0 or field3 is not 0 or field4 is not 0
* or field 5 not 0 then 0 flag setting
   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0HC0202CA
                              "0-flag beállítás
                                     C_ABEVAZ_A0HC0203CA    "mező1
                                     C_ABEVAZ_A0HC0204CA    "mező2
                                     C_ABEVAZ_A0HC0205CA    "mező3
                                     C_ABEVAZ_A0HC0206CA    "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6

   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0HC0202DA
                              "0-flag beállítás
                                     C_ABEVAZ_A0HC0203DA    "mező1
                                     C_ABEVAZ_A0HC0204DA    "mező2
                                     C_ABEVAZ_A0HC0205DA    "mező3
                                     C_ABEVAZ_A0HC0206DA    "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6

   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0HC0208CA
                              "0-flag beállítás
                                     C_ABEVAZ_A0HC0209CA    "mező1
                                     C_ABEVAZ_A0HC0210CA    "mező2
                                     C_ABEVAZ_A0HC0211CA    "mező3
                                     C_ABEVAZ_A0HC0212CA    "mező4
                                     C_ABEVAZ_A0HC0213CA    "mező5
                                     SPACE.                 "mező6

   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0HC0208DA
                              "0-flag beállítás
                                     C_ABEVAZ_A0HC0209DA    "mező1
                                     C_ABEVAZ_A0HC0210DA    "mező2
                                     C_ABEVAZ_A0HC0211DA    "mező3
                                     C_ABEVAZ_A0HC0212DA    "mező4
                                     C_ABEVAZ_A0HC0213DA    "mező5
                                     SPACE.                 "mező6

   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0HC0219CA
                              "0-flag beállítás
                                     C_ABEVAZ_A0HC0220CA    "mező1
                                     C_ABEVAZ_A0HC0221CA    "mező2
                                     C_ABEVAZ_A0HC0222CA    "mező3
                                     C_ABEVAZ_A0HC0223CA    "mező4
                                     C_ABEVAZ_A0HC0224CA    "mező5
                                     SPACE.                 "mező6

   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0HC0219DA
                              "0-flag beállítás
                                     C_ABEVAZ_A0HC0220DA    "mező1
                                     C_ABEVAZ_A0HC0221DA    "mező2
                                     C_ABEVAZ_A0HC0222DA    "mező3
                                     C_ABEVAZ_A0HC0223DA    "mező4
                                     C_ABEVAZ_A0HC0224DA    "mező5
                                     SPACE.                 "mező6

   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0HC0226DA
                              "0-flag beállítás
                                     C_ABEVAZ_A0HC0227DA    "mező1
                                     C_ABEVAZ_A0HC0228DA    "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6
*++0808 2009.02.11 BG
   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0DC0077DA
                              "0-flag beállítás
                                     C_ABEVAZ_A0DC0077CA    "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6

   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0DC0078DA
                              "0-flag beállítás
                                     C_ABEVAZ_A0DC0078CA    "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6


   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0DC0068DA
                              "0-flag beállítás
                                     C_ABEVAZ_A0DC0068CA    "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6

   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0CC0035DA
                              "0-flag beállítás
                                     C_ABEVAZ_A0CC0035CA    "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6
*--0808 2009.02.11 BG

*++BG 2009.07.16
   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0DC0068DA
                              "0-flag beállítás
                                     C_ABEVAZ_A0DC0068CA    "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6

*--BG 2009.07.16


* If field1 is not 0 or field2 is not 0 or field3 is not 0 or field4 is not 0
* or field 5 is not 0 or field 6 is not 0 then 0 flag setting on page M
   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0CC0416DA
                                      C_ABEVAZ_M0BC0381DA
                                      C_ABEVAZ_M0BC0382BA
                                      C_ABEVAZ_M0BC0383BA
                                      C_ABEVAZ_M0BC0384BA
                                      C_ABEVAZ_M0CC0413AA
                                      C_ABEVAZ_M0CC0414AA.



 ENDFORM.                    " CALC_ABEV_0_SZJA_0808
*&---------------------------------------------------------------------*
*&      Form  GET_LAP_SZ_0808
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*----------------------------------------------------------------------*
 FORM GET_LAP_SZ_0808  TABLES T_BEVALLO STRUCTURE  /ZAK/BEVALLALV.

   DATA L_ALV LIKE /ZAK/BEVALLALV.
   DATA L_INDEX LIKE SY-TABIX.
   DATA L_TABIX LIKE SY-TABIX.
*++0908 2009.02.27 BG
   DATA L_NULL_FLAG TYPE /ZAK/NULL.
*--0908 2009.02.27 BG


   CLEAR L_INDEX.

*  Upload RANKS for SZJA tax identification page number management
   M_DEF R_M0AC022A 'I' 'BT' 'M0BC0000000000000' 'M0BZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC023A 'I' 'BT' 'M0CC0000000000000' 'M0CZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC024A 'I' 'BT' 'M0DC0000000000000' 'M0DZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC025A 'I' 'BT' 'M0EC0000000000000' 'M0EZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC026A 'I' 'BT' 'M0FC0000000000000' 'M0FZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC027A 'I' 'BT' 'M0GC0000000000000' 'M0GZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC028A 'I' 'BT' 'M0HC0000000000000' 'M0HZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC029A 'I' 'BT' 'M0IC0000000000000' 'M0IZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC030A 'I' 'BT' 'M0JC0000000000000' 'M0JZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC031A 'I' 'BT' 'M0KC0000000000000' 'M0KZZZZZZZZZZZZZZ'.
   M_DEF R_M0AC032A 'I' 'BT' 'M0LC0000000000000' 'M0LZZZZZZZZZZZZZZ'.

   LOOP AT I_/ZAK/BEVALLO INTO W_/ZAK/BEVALLO.
     L_TABIX = SY-TABIX.

*   Dialog run for insurance
     PERFORM PROCESS_IND_ITEM USING '100000'
                                    L_INDEX
                                    TEXT-P01.

*   Csak SZJA-nal
     IF  W_/ZAK/BEVALL-BTYPART EQ C_BTYPART_SZJA.
*   Collections for tax identification number
       PERFORM CALL_MLAPSZ: TABLES R_M0AC022A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC022A,
                            TABLES R_M0AC023A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC023A,
                            TABLES R_M0AC024A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC024A,
                            TABLES R_M0AC025A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC025A,
                            TABLES R_M0AC026A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC026A,
                            TABLES R_M0AC027A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC027A,
                            TABLES R_M0AC028A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC028A,
                            TABLES R_M0AC029A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC029A,
                            TABLES R_M0AC030A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC030A,
                            TABLES R_M0AC031A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC031A,
                            TABLES R_M0AC032A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AC032A.
     ENDIF.

     READ TABLE T_BEVALLO INTO L_ALV WITH KEY
                   BUKRS   = W_/ZAK/BEVALLO-BUKRS
                   BTYPE   = W_/ZAK/BEVALLO-BTYPE
                   GJAHR   = W_/ZAK/BEVALLO-GJAHR
                   MONAT   = W_/ZAK/BEVALLO-MONAT
                   ZINDEX  = W_/ZAK/BEVALLO-ZINDEX
                   ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ
                   ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                   LAPSZ   = W_/ZAK/BEVALLO-LAPSZ
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
*++0908 2009.05.11 BG
**++0908 2009.02.27 BG
*       IF NOT L_ALV-NULL_FLAG IS INITIAL OR
*          NOT W_/ZAK/BEVALLO-NULL_FLAG IS INITIAL.
*         L_NULL_FLAG = C_X.
*       ELSE.
*         CLEAR L_NULL_FLAG.
*       ENDIF.
**--0908 2009.02.27 BG
*  The 0 flag handling was not appropriate
*  If it is a self-revision calculation, the T_BEVALLO 0 flag is required
*  otherwise, the I_/ZAK/BEVALLO 0 flag.
       IF NOT L_ALV-OFLAG IS INITIAL.
         L_NULL_FLAG = L_ALV-NULL_FLAG.
       ELSE.
         L_NULL_FLAG = W_/ZAK/BEVALLO-NULL_FLAG.
       ENDIF.
*--0908 2009.05.11 BG
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
*++0908 2009.02.27 BG
       L_ALV-NULL_FLAG = L_NULL_FLAG.
*--0908 2009.02.27 BG
       IF L_ALV-OFLAG IS INITIAL.
         MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX
                         TRANSPORTING FIELD_C FIELD_N FIELD_NR FIELD_NRK
                                      NULL_FLAG WAERS
                                       .
       ELSE.
         MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX
                         TRANSPORTING FIELD_C FIELD_N  FIELD_NR
                         FIELD_NRK
                                      OFLAG   FIELD_ON FIELD_ONR
                                      FIELD_ONRK
                                      NULL_FLAG WAERS.
         PERFORM SUM_ONR TABLES T_BEVALLO
                         USING  L_ALV
                                L_ALV-FIELD_ON
                                L_ALV-FIELD_ONR
                                L_ALV-FIELD_ONRK.
       ENDIF.
     ELSE.
       READ TABLE I_/ZAK/BEVALLB INTO W_/ZAK/BEVALLB
       WITH KEY ABEVAZ = W_/ZAK/BEVALLO-ABEVAZ.
       MOVE-CORRESPONDING W_/ZAK/BEVALLB TO L_ALV.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
       SELECT SINGLE ABEVTEXT INTO L_ALV-ABEVTEXT
         FROM  /ZAK/BEVALLBT
              WHERE  LANGU   = SY-LANGU
              AND    BTYPE   = W_/ZAK/BEVALLO-BTYPE
              AND    ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ.
       L_ALV-ABEVTEXT_DISP = L_ALV-ABEVTEXT.
       APPEND L_ALV TO T_BEVALLO.
       SORT T_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ ADOAZON
            LAPSZ.
     ENDIF.
     DELETE I_/ZAK/BEVALLO.
   ENDLOOP.

 ENDFORM.                    " GET_LAP_SZ_0808
*&---------------------------------------------------------------------*
*&      Form  GET_ONELL_0808
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*----------------------------------------------------------------------*
 FORM GET_ONELL_0808  TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLALV
                             T_BEVALLB STRUCTURE /ZAK/BEVALLB
                      USING  $INDEX.

*  To upload fields to be summarized
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.


*  If self-revision
   CHECK $INDEX NE '000'.

*A 07-200-c From line 198: personal income tax due to an individual
*A0HC0199CA : A0BC0002CA/25% + A0BC0005CA/54% + A0BC0006CA/54% +
*             A0BC0008CA/33% + A0BC0009CA/10% + A0BC0012CA/54%
   PERFORM GET_ONELL_DIV: TABLES T_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0199CA   "Módosított mező
                                 C_ABEVAZ_A0BC0002CA
                                 '0.25',
                          TABLES T_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0199CA   "Módosított mező
                                 C_ABEVAZ_A0BC0005CA
                                 '0.54',
                          TABLES T_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0199CA   "Módosított mező
                                 C_ABEVAZ_A0BC0006CA
                                 '0.54',
                          TABLES T_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0199CA   "Módosított mező
                                 C_ABEVAZ_A0BC0008CA
                                 '0.33',
                          TABLES T_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0199CA   "Módosított mező
                                 C_ABEVAZ_A0BC0009CA
                                 '0.10',
                          TABLES T_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0199CA   "Módosított mező
                                 C_ABEVAZ_A0BC0012CA
                                 '0.54'.

*  Due to modification A0HC0199CA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0199CA SPACE.

   PERFORM GET_ONELL_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0198CA.



*A 07-225-c Percentage health contribution (base
*difference)
*A0HC0225CA = A0BC0017CA/25% + A0BC0018CA/11%
   PERFORM GET_ONELL_DIV: TABLES T_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0225CA   "Módosított mező
                                 C_ABEVAZ_A0BC0017CA
                                 '0.25',
                          TABLES T_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0225CA   "Módosított mező
                                 C_ABEVAZ_A0BC0018CA
                                 '0.11'.


 ENDFORM.                    " GET_ONELL_0808
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_M_SZJA_0808
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_M_SZJA_0808  TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                    T_BEVALLB STRUCTURE /ZAK/BEVALLB.


   SORT T_BEVALLB BY ABEVAZ.

*  It is the basis of obligation
*  A0ZZ000001
   PERFORM GET_SUM_CALC  TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ZZ000001   "Módosított mező
                                C_ABEVAZ_M0CC0415DA         "Forrás 1
                                C_ABEVAZ_M0CF0430BA         "Forrás 2
                                C_ABEVAZ_M0CF0431BA         "Forrás 3
                                C_ABEVAZ_M0CF0434BA         "Forrás 4
                                C_ABEVAZ_M0CF0435CA         "Forrás 5
                                SPACE                       "Forrás 6
                                SPACE                       "Forrás 7
                                SPACE                       "Forrás 8
                                SPACE                       "Forrás 9
                                SPACE.                      "Forrás 10

*  The basis of Eho's obligation
*  A0ZZ000002
   PERFORM GET_SUM_CALC  TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ZZ000002   "Módosított mező
                                C_ABEVAZ_M0EC0461CA         "Forrás 1
                                C_ABEVAZ_M0EC0463CA         "Forrás 2
                                SPACE                       "Forrás 3
                                SPACE                       "Forrás 4
                                SPACE                       "Forrás 5
                                SPACE                       "Forrás 6
                                SPACE                       "Forrás 7
                                SPACE                       "Forrás 8
                                SPACE                       "Forrás 9
                                SPACE.                      "Forrás 10




 ENDFORM.                    " CALC_ABEV_M_SZJA_0808
*&---------------------------------------------------------------------*
*&      Form  GET_SUM_CALC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_C_ABEVAZ_A0ZZ000001  text
*      -->P_C_ABEVAZ_M0CC0415DA  text
*      -->P_C_ABEVAZ_M0CF0430BA  text
*      -->P_C_ABEVAZ_M0CF0431BA  text
*      -->P_C_ABEVAZ_M0CF0434BA  text
*      -->P_C_ABEVAZ_M0CF0435CA  text
*----------------------------------------------------------------------*
 FORM GET_SUM_CALC  TABLES     $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                               $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                      USING    $ABEV_MOD
                               $ABEV_F1
                               $ABEV_F2
                               $ABEV_F3
                               $ABEV_F4
                               $ABEV_F5
                               $ABEV_F6
                               $ABEV_F7
                               $ABEV_F8
                               $ABEV_F9
                               $ABEV_F10.

   DATA L_SUM       LIKE /ZAK/BEVALLO-FIELD_NRK.
   DATA L_FIELD_NRK LIKE /ZAK/BEVALLO-FIELD_NRK.
   DATA L_TABIX LIKE SY-TABIX.

   DEFINE M_BEVALLO_READ.
     LOOP AT &1 INTO W_/ZAK/BEVALLO WHERE ABEVAZ = &2.
       ADD W_/ZAK/BEVALLO-FIELD_NRK TO &3.
     ENDLOOP.

   END-OF-DEFINITION.


*  Reading a current tax return
   IF NOT $ABEV_F1 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F1 L_SUM.
   ENDIF.

   IF NOT $ABEV_F2 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F2 L_SUM.
   ENDIF.

   IF NOT $ABEV_F3 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F3 L_SUM.
   ENDIF.

   IF NOT $ABEV_F4 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F4 L_SUM.
   ENDIF.

   IF NOT $ABEV_F5 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F5 L_SUM.
   ENDIF.

   IF NOT $ABEV_F6 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F6 L_SUM.
   ENDIF.

   IF NOT $ABEV_F7 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F7 L_SUM.
   ENDIF.

   IF NOT $ABEV_F8 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F8 L_SUM.
   ENDIF.

   IF NOT $ABEV_F9 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F9 L_SUM.
   ENDIF.

   IF NOT $ABEV_F10 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F10 L_SUM.
   ENDIF.


*  Summary
   L_FIELD_NRK = L_SUM.

*  Modify a calculated field
   READ TABLE $T_BEVALLO INTO W_/ZAK/BEVALLO
                         WITH KEY ABEVAZ = $ABEV_MOD.
   IF SY-SUBRC EQ 0.
     MOVE SY-TABIX TO L_TABIX.
     MOVE L_FIELD_NRK TO W_/ZAK/BEVALLO-FIELD_N.
     READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                           WITH KEY ABEVAZ = $ABEV_MOD
                           BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                    W_/ZAK/BEVALLB-ROUND
                    W_/ZAK/BEVALLO-WAERS
           CHANGING W_/ZAK/BEVALLO-FIELD_NR
                    W_/ZAK/BEVALLO-FIELD_NRK.
     ENDIF.

     MODIFY $T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.

   ENDIF.

 ENDFORM.                    " GET_SUM_CALC
*&---------------------------------------------------------------------*
*&      Form  GET_ONREV_SUM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_LR_ABEVAZ  text
*      -->P_C_ABEVAZ_A0DC0302DA  text
*----------------------------------------------------------------------*
 FORM GET_ONELL_SUM TABLES  $T_BEVALLO STRUCTURE /ZAK/BEVALLALV
                            $R_ABEVAZ  STRUCTURE /ZAK/RANGE_C17
                            $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                    USING   $ABEVAZ_MOD.

   DATA L_SUM LIKE /ZAK/BEVALLO-FIELD_N.
   DATA L_TABIX LIKE SY-TABIX.
   DATA LW_/ZAK/BEVALLALV LIKE /ZAK/BEVALLALV.

   LOOP AT $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                     WHERE ABEVAZ IN $R_ABEVAZ.
     ADD LW_/ZAK/BEVALLALV-FIELD_NRK TO L_SUM.
   ENDLOOP.

   READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                         WITH KEY ABEVAZ = $ABEVAZ_MOD
                         BINARY SEARCH.
   IF SY-SUBRC EQ 0.
     MOVE SY-TABIX TO L_TABIX.
     ADD L_SUM TO LW_/ZAK/BEVALLALV-FIELD_N.

     READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                           WITH KEY ABEVAZ = $ABEVAZ_MOD
                           BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       PERFORM CALC_FIELD_NRK USING LW_/ZAK/BEVALLALV-FIELD_N
                    W_/ZAK/BEVALLB-ROUND
                    LW_/ZAK/BEVALLALV-WAERS
           CHANGING LW_/ZAK/BEVALLALV-FIELD_NR
                    LW_/ZAK/BEVALLALV-FIELD_NRK.
     ENDIF.

     MODIFY $T_BEVALLO FROM LW_/ZAK/BEVALLALV INDEX L_TABIX.
   ENDIF.


 ENDFORM.                    " GET_ONREV_SUM
*&---------------------------------------------------------------------*
*&      Form  GET_NULL_FLAG_A
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_C_ABEVAZ_A0JB0283EA  text
*      -->P_C_ABEVAZ_A0JB0280DA  text
*      -->P_C_ABEVAZ_A0JB0281DA  text
*      -->P_C_ABEVAZ_A0JB0282DA  text
*      -->P_SPACE  text
*----------------------------------------------------------------------*
 FORM GET_NULL_FLAG_ASUM  TABLES  $T_BEVALLO     STRUCTURE /ZAK/BEVALLO
                          USING   $ABEV_0
                                  $ABEV_1
                                  $ABEV_2
                                  $ABEV_3
                                  $ABEV_4.

   DATA L_SUM TYPE /ZAK/FIELDN.
   DATA L_TABIX LIKE SY-TABIX.

   DEFINE LM_GET_VALUE.
     READ TABLE $T_BEVALLO WITH KEY ABEVAZ = &1
                                    BINARY SEARCH.
*++0908 2009.02.27 BG
*    IF SY-SUBRC EQ 0.
     IF SY-SUBRC EQ 0 AND V_ONREV IS INITIAL.
*--0908 2009.02.27 BG
       ADD $T_BEVALLO-FIELD_N TO L_SUM.
*++0908 2009.02.27 BG
     ELSEIF SY-SUBRC EQ 0 AND NOT V_ONREV IS INITIAL.
       ADD $T_BEVALLO-FIELD_ON TO L_SUM.
*--0908 2009.02.27 BG
     ENDIF.
   END-OF-DEFINITION.


   IF NOT $ABEV_1 IS INITIAL.
     LM_GET_VALUE $ABEV_1.
   ENDIF.

   IF NOT $ABEV_2 IS INITIAL.
     LM_GET_VALUE $ABEV_2.
   ENDIF.

   IF NOT $ABEV_3 IS INITIAL.
     LM_GET_VALUE $ABEV_3.
   ENDIF.

   IF NOT $ABEV_4 IS INITIAL.
     LM_GET_VALUE $ABEV_4.
   ENDIF.


   IF L_SUM > 0.
     READ TABLE $T_BEVALLO WITH KEY ABEVAZ = $ABEV_0
                                    BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE C_X TO $T_BEVALLO-NULL_FLAG.
       MODIFY $T_BEVALLO INDEX L_TABIX TRANSPORTING NULL_FLAG.
     ENDIF.
   ENDIF.


 ENDFORM.                    " GET_NULL_FLAG_A
*&---------------------------------------------------------------------*
*&      Form  GET_NULL_FLAG_INIT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_C_ABEVAZ_A0HC0226DA  text
*      -->P_C_ABEVAZ_A0HC0227DA  text
*      -->P_C_ABEVAZ_A0HC0228DA  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*      -->P_ENDFORM  text
*----------------------------------------------------------------------*
 FORM GET_NULL_FLAG_INIT  TABLES   $T_BEVALLO     STRUCTURE /ZAK/BEVALLO
                           USING   $ABEV_0
                                   $ABEV_1
                                   $ABEV_2
                                   $ABEV_3
                                   $ABEV_4
                                   $ABEV_5
                                   $ABEV_6.
   DATA L_TRUE.
   DATA L_TABIX LIKE SY-TABIX.

   DEFINE LM_GET_INIT.
     IF NOT &1 IS INITIAL AND L_TRUE IS INITIAL.
       READ TABLE $T_BEVALLO WITH KEY ABEVAZ = &1
                                      BINARY SEARCH.
*++0908 2009.02.27 BG
*++BG 2008.07.09
*      FIELD_NRK should be examined as it may be
*      FIELD_N is not empty but FIELD_NRK is.
*       IF SY-SUBRC EQ 0 AND NOT $T_BEVALLO-FIELD_N IS INITIAL.
*      It must be dismantled due to self-revision treatment.
*      IF SY-SUBRC EQ 0 AND NOT $T_BEVALLO-FIELD_NRK IS INITIAL.
*--BG 2008.07.09
       IF SY-SUBRC EQ 0 AND V_ONREV IS INITIAL.
         IF NOT $T_BEVALLO-FIELD_NRK IS INITIAL.
           MOVE C_X TO L_TRUE.
         ENDIF.
       ELSEIF SY-SUBRC EQ 0 AND NOT V_ONREV IS INITIAL.
         IF NOT $T_BEVALLO-FIELD_ONRK IS INITIAL.
           MOVE C_X TO L_TRUE.
         ENDIF.
       ENDIF.
     ENDIF.
*--0908 2009.02.27 BG
   END-OF-DEFINITION.

   LM_GET_INIT: $ABEV_1, $ABEV_2, $ABEV_3, $ABEV_4, $ABEV_5, $ABEV_6.

   IF NOT L_TRUE IS INITIAL.
     READ TABLE $T_BEVALLO WITH KEY ABEVAZ = $ABEV_0
                                    BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE C_X TO $T_BEVALLO-NULL_FLAG.
       MODIFY $T_BEVALLO INDEX L_TABIX TRANSPORTING NULL_FLAG.
     ENDIF.
   ENDIF.

 ENDFORM.                    " GET_NULL_FLAG_INIT

*&---------------------------------------------------------------------*
*&      Form  GET_NULL_FLAG_INIT_N
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_C_ABEVAZ_A0HC0226DA  text
*      -->P_C_ABEVAZ_A0HC0227DA  text
*      -->P_C_ABEVAZ_A0HC0228DA  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*      -->P_ENDFORM  text
*----------------------------------------------------------------------*
 FORM GET_NULL_FLAG_INIT_N TABLES   $T_BEVALLO     STRUCTURE /ZAK/BEVALLO
                            USING   $ABEV_0
                                    $ABEV_1
                                    $ABEV_2
                                    $ABEV_3
                                    $ABEV_4
                                    $ABEV_5
                                    $ABEV_6.
   DATA L_TRUE.
   DATA L_TABIX LIKE SY-TABIX.

   DEFINE LM_GET_INIT.
     IF NOT &1 IS INITIAL AND L_TRUE IS INITIAL.
       READ TABLE $T_BEVALLO WITH KEY ABEVAZ = &1
                                      BINARY SEARCH.
*      We examine FILED_N because if FIELD_NRK is 0 then
*      we write the field with 0 and ABEV in this case
*      it also expects 0 on the summary line.
       IF SY-SUBRC EQ 0 AND V_ONREV IS INITIAL.
         IF NOT $T_BEVALLO-FIELD_N IS INITIAL.
           MOVE C_X TO L_TRUE.
         ENDIF.
       ELSEIF SY-SUBRC EQ 0 AND NOT V_ONREV IS INITIAL.
         IF NOT $T_BEVALLO-FIELD_ON IS INITIAL.
           MOVE C_X TO L_TRUE.
         ENDIF.
       ENDIF.
     ENDIF.
*--0908 2009.02.27 BG
   END-OF-DEFINITION.

   LM_GET_INIT: $ABEV_1, $ABEV_2, $ABEV_3, $ABEV_4, $ABEV_5, $ABEV_6.

   IF NOT L_TRUE IS INITIAL.
     READ TABLE $T_BEVALLO WITH KEY ABEVAZ = $ABEV_0
                                    BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE C_X TO $T_BEVALLO-NULL_FLAG.
       MODIFY $T_BEVALLO INDEX L_TABIX TRANSPORTING NULL_FLAG.
     ENDIF.
   ENDIF.

 ENDFORM.                    " GET_NULL_FLAG_INIT_N

*&---------------------------------------------------------------------*
*&      Form  GET_NULL_FLAG_0
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_C_ABEVAZ_A0HC0226DA  text
*      -->P_C_ABEVAZ_A0HC0227DA  text
*      -->P_C_ABEVAZ_A0HC0228DA  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*      -->P_ENDFORM  text
*----------------------------------------------------------------------*
 FORM GET_NULL_FLAG_0     TABLES   $T_BEVALLO     STRUCTURE /ZAK/BEVALLO
                           USING   $ABEV_0.
   DATA L_TRUE.
   DATA L_TABIX LIKE SY-TABIX.

   READ TABLE $T_BEVALLO WITH KEY ABEVAZ = $ABEV_0
                                  BINARY SEARCH.
   IF SY-SUBRC EQ 0.
     MOVE SY-TABIX TO L_TABIX.
     MOVE C_X TO $T_BEVALLO-NULL_FLAG.
     MODIFY $T_BEVALLO INDEX L_TABIX TRANSPORTING NULL_FLAG.
   ENDIF.

 ENDFORM.                    " GET_NULL_FLAG_0

*&---------------------------------------------------------------------*
*&      Form  GET_NULL_FLAG_0_M
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_C_ABEVAZ_A0HC0226DA  text
*      -->P_C_ABEVAZ_A0HC0227DA  text
*      -->P_C_ABEVAZ_A0HC0228DA  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*      -->P_ENDFORM  text
*----------------------------------------------------------------------*
 FORM GET_NULL_FLAG_0_M   TABLES   $T_BEVALLO     STRUCTURE /ZAK/BEVALLO
                                   $T_ADOAZON_ALL STRUCTURE
                                   /ZAK/ADOAZONLPSZ
                           USING   $ABEV_0.
   DATA L_TRUE.
   DATA L_TABIX LIKE SY-TABIX.

   LOOP AT $T_ADOAZON_ALL.
     READ TABLE $T_BEVALLO WITH KEY ABEVAZ  = $ABEV_0
                                    ADOAZON = $T_ADOAZON_ALL-ADOAZON
                                    LAPSZ   = $T_ADOAZON_ALL-LAPSZ
                                    BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE C_X TO $T_BEVALLO-NULL_FLAG.
       MODIFY $T_BEVALLO INDEX L_TABIX TRANSPORTING NULL_FLAG.
     ENDIF.
   ENDLOOP.


 ENDFORM.                    " GET_NULL_FLAG_0

*&---------------------------------------------------------------------*
*&      Form  GET_NULL_FLAG_INITM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_ADOAZON_ALL  text
*      -->P_C_ABEVAZ_M0CC0416DA  text
*      -->P_C_ABEVAZ_M0BC0381DA  text
*      -->P_C_ABEVAZ_M0BC0382BA  text
*      -->P_C_ABEVAZ_M0BC0383BA  text
*      -->P_C_ABEVAZ_M0BC0384BA  text
*      -->P_C_ABEVAZ_M0CC0413AA  text
*      -->P_C_ABEVAZ_M0CC0414AA  text
*----------------------------------------------------------------------*
 FORM GET_NULL_FLAG_INITM  TABLES   $T_BEVALLO     STRUCTURE /ZAK/BEVALLO
                                    $T_ADOAZON_ALL STRUCTURE
                                    /ZAK/ADOAZONLPSZ
                           USING    $ABEV_0
                                    $ABEV_1
                                    $ABEV_2
                                    $ABEV_3
                                    $ABEV_4
                                    $ABEV_5
                                    $ABEV_6.



   DATA L_TRUE.
   DATA L_TABIX LIKE SY-TABIX.

   DEFINE LM_GET_INIT.
     IF NOT &1 IS INITIAL AND L_TRUE IS INITIAL.
       READ TABLE $T_BEVALLO WITH KEY ABEVAZ  = &1
                                      ADOAZON = &2
                                      LAPSZ   = &3
                                      BINARY SEARCH.
*++0908 2009.02.27 BG
       IF SY-SUBRC EQ 0 AND V_ONREV IS INITIAL.
         IF NOT $T_BEVALLO-FIELD_N IS INITIAL
*++2011.05.10 BG
            OR NOT $T_BEVALLO-FIELD_C IS INITIAL.
*--2011.05.10 BG
           MOVE C_X TO L_TRUE.
         ENDIF.
       ELSEIF SY-SUBRC EQ 0 AND NOT V_ONREV IS INITIAL.
         IF NOT $T_BEVALLO-FIELD_ON IS INITIAL
*++2011.05.10 BG
            OR NOT $T_BEVALLO-FIELD_C IS INITIAL.
*--2011.05.10 BG
           MOVE C_X TO L_TRUE.
         ENDIF.
       ENDIF.
     ENDIF.
*--0908 2009.02.27 BG
   END-OF-DEFINITION.

   LOOP AT $T_ADOAZON_ALL.
     CLEAR L_TRUE.
     LM_GET_INIT: $ABEV_1 $T_ADOAZON_ALL-ADOAZON $T_ADOAZON_ALL-LAPSZ,
                  $ABEV_2 $T_ADOAZON_ALL-ADOAZON $T_ADOAZON_ALL-LAPSZ,
                  $ABEV_3 $T_ADOAZON_ALL-ADOAZON $T_ADOAZON_ALL-LAPSZ,
                  $ABEV_4 $T_ADOAZON_ALL-ADOAZON $T_ADOAZON_ALL-LAPSZ,
                  $ABEV_5 $T_ADOAZON_ALL-ADOAZON $T_ADOAZON_ALL-LAPSZ,
                  $ABEV_6 $T_ADOAZON_ALL-ADOAZON $T_ADOAZON_ALL-LAPSZ.

     IF NOT L_TRUE IS INITIAL.
       READ TABLE $T_BEVALLO WITH KEY ABEVAZ  = $ABEV_0
                                      ADOAZON = $T_ADOAZON_ALL-ADOAZON
                                      LAPSZ   = $T_ADOAZON_ALL-LAPSZ
                                      BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         MOVE SY-TABIX TO L_TABIX.
         MOVE C_X TO $T_BEVALLO-NULL_FLAG.
         MODIFY $T_BEVALLO INDEX L_TABIX TRANSPORTING NULL_FLAG.
       ENDIF.
     ENDIF.
   ENDLOOP.


 ENDFORM.                    " GET_NULL_FLAG_INITM

*&---------------------------------------------------------------------*
*&      Form  GET_NULL_FLAG_INITM_C
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_ADOAZON_ALL  text
*      -->P_C_ABEVAZ_M0CC0416DA  text
*      -->P_C_ABEVAZ_M0BC0381DA  text
*      -->P_C_ABEVAZ_M0BC0382BA  text
*      -->P_C_ABEVAZ_M0BC0383BA  text
*      -->P_C_ABEVAZ_M0BC0384BA  text
*      -->P_C_ABEVAZ_M0CC0413AA  text
*      -->P_C_ABEVAZ_M0CC0414AA  text
*----------------------------------------------------------------------*
 FORM GET_NULL_FLAG_INITM_C TABLES $T_BEVALLO     STRUCTURE /ZAK/BEVALLO
                                   $T_ADOAZON_ALL STRUCTURE
                                   /ZAK/ADOAZONLPSZ
                           USING   $ABEV_0
                                   $ABEV_1
                                   $ABEV_2
                                   $ABEV_3
                                   $ABEV_4
                                   $ABEV_5
                                   $ABEV_6.



   DATA L_TRUE.
   DATA L_TABIX LIKE SY-TABIX.

   DEFINE LM_GET_INIT.
     IF NOT &1 IS INITIAL AND L_TRUE IS INITIAL.
       READ TABLE $T_BEVALLO WITH KEY ABEVAZ  = &1
                                      ADOAZON = &2
                                      LAPSZ   = &3
                                      BINARY SEARCH.
*++ 2010.06.10 RN
* there is no need to handle the self-revision field separately, because field_c
* it has no self-rev field pairs
**++0908 2009.02.27 BG
*       IF SY-SUBRC EQ 0 AND V_ONREV IS INITIAL.
*         IF NOT $T_BEVALLO-FIELD_N IS INITIAL.
*           MOVE C_X TO L_TRUE.
*         ENDIF.
*       ELSEIF SY-SUBRC EQ 0 AND NOT V_ONREV IS INITIAL.
*         IF NOT $T_BEVALLO-FIELD_ON IS INITIAL.
*           MOVE C_X TO L_TRUE.
*         ENDIF.
*       ENDIF.
*     ENDIF.
**--0908 2009.02.27 BG
       IF SY-SUBRC EQ 0.
         IF NOT $T_BEVALLO-FIELD_C IS INITIAL.
           MOVE C_X TO L_TRUE.
         ENDIF.
       ENDIF.
     ENDIF.
*-- 2010.06.10 RN
   END-OF-DEFINITION.

   LOOP AT $T_ADOAZON_ALL.
     CLEAR L_TRUE.
     LM_GET_INIT: $ABEV_1 $T_ADOAZON_ALL-ADOAZON $T_ADOAZON_ALL-LAPSZ,
                  $ABEV_2 $T_ADOAZON_ALL-ADOAZON $T_ADOAZON_ALL-LAPSZ,
                  $ABEV_3 $T_ADOAZON_ALL-ADOAZON $T_ADOAZON_ALL-LAPSZ,
                  $ABEV_4 $T_ADOAZON_ALL-ADOAZON $T_ADOAZON_ALL-LAPSZ,
                  $ABEV_5 $T_ADOAZON_ALL-ADOAZON $T_ADOAZON_ALL-LAPSZ,
                  $ABEV_6 $T_ADOAZON_ALL-ADOAZON $T_ADOAZON_ALL-LAPSZ.

     IF NOT L_TRUE IS INITIAL.
       READ TABLE $T_BEVALLO WITH KEY ABEVAZ  = $ABEV_0
                                      ADOAZON = $T_ADOAZON_ALL-ADOAZON
                                      LAPSZ   = $T_ADOAZON_ALL-LAPSZ
                                      BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         MOVE SY-TABIX TO L_TABIX.
         MOVE C_X TO $T_BEVALLO-NULL_FLAG.
         MODIFY $T_BEVALLO INDEX L_TABIX TRANSPORTING NULL_FLAG.
       ENDIF.
     ENDIF.
   ENDLOOP.


 ENDFORM.                    " GET_NULL_FLAG_INITM_C
*&---------------------------------------------------------------------*
*&      Form  change_elojel
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_I_/ZAK/BEVALLB  text
*----------------------------------------------------------------------*
 FORM CHANGE_ELOJEL  TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLALV
                              $T_BEVALLB STRUCTURE /ZAK/BEVALLB.
* If sign translation is checked in BEVALLB, then it is
* in self-revision fields it is suitable due to the calculation, but not in ABEV
* should be treated appropriately. Therefore, let's read through it based on the setting
* and we reverse the sign in the self-revision fields.
   LOOP AT $T_BEVALLB WHERE NOT ELOJEL IS INITIAL.
     LOOP AT $T_BEVALLO WHERE ABEVAZ EQ $T_BEVALLB-ABEVAZ
                          AND OFLAG  EQ 'X'
                          AND FIELD_ON < 0.
       $T_BEVALLO-FIELD_ON   = ABS( $T_BEVALLO-FIELD_ON ).
       $T_BEVALLO-FIELD_ONR  = ABS( $T_BEVALLO-FIELD_ONR ).
       $T_BEVALLO-FIELD_ONRK = ABS( $T_BEVALLO-FIELD_ONRK ).
       MODIFY $T_BEVALLO.
     ENDLOOP.
   ENDLOOP.
 ENDFORM.                    " change_elojel

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_SZJA_SPECIAL_0908
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*      -->P_$INDEX  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SZJA_SPECIAL_0908
                                  TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                         T_BEVALLB STRUCTURE
                                         /ZAK/BEVALLB
                                         T_ADOAZON STRUCTURE
                                         /ZAK/ONR_ADOAZON
                                  USING  $INDEX
                                         $DATE.


   DATA LR_COND TYPE RANGE_C2 OCCURS 0 WITH HEADER LINE.
   DATA L_TMP_BEVALLO TYPE /ZAK/BEVALLO.
   DATA L_BEVALLO TYPE /ZAK/BEVALLO.

   FIELD-SYMBOLS: <FIELD_N>, <FIELD_NR>, <FIELD_NRK>.

   DEFINE LM_GET_FIELD.
     IF &1 EQ '000'.
       ASSIGN W_/ZAK/BEVALLO-FIELD_N   TO <FIELD_N>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_NR  TO <FIELD_NR>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_NRK TO <FIELD_NRK>.
     ELSE.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ON   TO <FIELD_N>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ONR  TO <FIELD_NR>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ONRK TO <FIELD_NRK>.
     ENDIF.
     CLEAR: <FIELD_N>, <FIELD_NR>, <FIELD_NRK>.
   END-OF-DEFINITION.

   DEFINE LM_GET_SPEC_SUM1.
     LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ = &1.
*      The ABEV for the condition must be determined
*      ID value
       READ TABLE T_BEVALLO INTO L_TMP_BEVALLO
                WITH KEY ABEVAZ  = &2
                         ADOAZON = L_BEVALLO-ADOAZON
                          LAPSZ  = L_BEVALLO-LAPSZ
                          BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         CONDENSE L_TMP_BEVALLO-FIELD_C.
         IF L_TMP_BEVALLO-FIELD_C IN &3.
           ADD L_BEVALLO-FIELD_N TO <FIELD_N>.
         ENDIF.
       ENDIF.
     ENDLOOP.
   END-OF-DEFINITION.

*++0908/2 2009.08.07 BG
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.
   DEFINE LM_GET_SPEC_SUM2.
     IF NOT &1[] IS INITIAL.
       LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ IN &1.
         IF $INDEX EQ '000'.
           ADD L_BEVALLO-FIELD_N TO <FIELD_N>.
         ELSE.
           ADD L_BEVALLO-FIELD_ON TO <FIELD_N>.
         ENDIF.
       ENDLOOP.
     ENDIF.
   END-OF-DEFINITION.
*--0908/2 2009.08.07 BG


   SORT T_BEVALLB BY ABEVAZ.


* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE ABEVAZ EQ C_ABEVAZ_A0CC0040CA OR
           ABEVAZ EQ C_ABEVAZ_A0CC0041CA OR
           ABEVAZ EQ C_ABEVAZ_A0CC0042CA OR
           ABEVAZ EQ C_ABEVAZ_A0CC0043CA OR
           ABEVAZ EQ C_ABEVAZ_A0CC0044CA OR
           ABEVAZ EQ C_ABEVAZ_A0CC0045CA OR
           ABEVAZ EQ C_ABEVAZ_A0CC0046CA OR
           ABEVAZ EQ C_ABEVAZ_A0CC0047CA OR
           ABEVAZ EQ C_ABEVAZ_A0CC0048CA OR
           ABEVAZ EQ C_ABEVAZ_A0DC0060CA OR
           ABEVAZ EQ C_ABEVAZ_A0DC0061CA OR
           ABEVAZ EQ C_ABEVAZ_A0DC0062CA OR
           ABEVAZ EQ C_ABEVAZ_A0DC0063CA OR
           ABEVAZ EQ C_ABEVAZ_A0DC0079CA OR
           ABEVAZ EQ C_ABEVAZ_A0DC0080CA OR
*++0908/2 2009.08.04 BG
           ABEVAZ EQ C_ABEVAZ_A0ZZ000004 OR
           ABEVAZ EQ C_ABEVAZ_A0ZZ000005 OR
           ABEVAZ EQ C_ABEVAZ_A0ZZ000006 OR
           ABEVAZ EQ C_ABEVAZ_A0ZZ000007
*--0908/2 2009.08.04 BG
           .

     CLEAR W_/ZAK/BEVALLO.

*    this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
              BINARY SEARCH.

     CHECK SY-SUBRC EQ 0.

     V_TABIX = SY-TABIX .

*    Special calculations
     CASE W_/ZAK/BEVALLB-ABEVAZ.
*      02-40-c The total burden of the pension commission
       WHEN  C_ABEVAZ_A0CC0040CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         M_DEF LR_COND 'E' 'EQ' '94' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0551CA' 'M0HC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0596CA' 'M0IC006A' LR_COND.
*++0908/2 2009.08.04 BG
         LM_GET_SPEC_SUM1 'M0OD50006A' 'M0OC555A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QD50098A' 'M0QC613A' LR_COND.
*--0908/2 2009.08.04 BG
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      02-41-c The employee is unemployed, the employment circle pays pension insurance
       WHEN  C_ABEVAZ_A0CC0041CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0551CA' 'M0HC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0596CA' 'M0IC006A' LR_COND.
*++0908/2 2009.08.04 BG
         LM_GET_SPEC_SUM1 'M0OD50006A' 'M0OC555A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QD50098A' 'M0QC613A' LR_COND.
*--0908/2 2009.08.04 BG
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 02-40-c The nursing care fee for the patient pension commission
       WHEN  C_ABEVAZ_A0CC0042CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '94' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0551CA' 'M0HC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0596CA' 'M0IC006A' LR_COND.
*++0908/2 2009.08.04 BG
         LM_GET_SPEC_SUM1 'M0OD50006A' 'M0OC555A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QD50098A' 'M0QC613A' LR_COND.
*--0908/2 2009.08.04 BG
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 02-43-c The private burden pension
       WHEN  C_ABEVAZ_A0CC0043CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         M_DEF LR_COND 'E' 'EQ' '83' SPACE.
         M_DEF LR_COND 'E' 'EQ' '92' SPACE.
         M_DEF LR_COND 'E' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0558CA' 'M0HC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0591CA' 'M0IC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0IE0602CA' 'M0IC006A' LR_COND.
*++0908/2 2009.08.04 BG
         LM_GET_SPEC_SUM1 'M0OD50015A' 'M0OC555A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QD50086A' 'M0QC613A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QE50118A' 'M0QC613A' LR_COND.
*--0908/2 2009.08.04 BG
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 02-44-c Private burden unemployment, employment pension
       WHEN  C_ABEVAZ_A0CC0044CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0558CA' 'M0HC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0591CA' 'M0IC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0IE0602CA' 'M0IC006A' LR_COND.
*++0908/2 2009.08.04 BG
         LM_GET_SPEC_SUM1 'M0OD50015A' 'M0OC555A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QD50086A' 'M0QC613A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QE50118A' 'M0QC613A' LR_COND.
*--0908/2 2009.08.04 BG
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 02-45-c The private sector pays pension after GYED, S, T
       WHEN  C_ABEVAZ_A0CC0045CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '83' SPACE.
         M_DEF LR_COND 'I' 'EQ' '92' SPACE.
         M_DEF LR_COND 'I' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0558CA' 'M0HC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0591CA' 'M0IC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0IE0602CA' 'M0IC006A' LR_COND.
*++0908/2 2009.08.04 BG
         LM_GET_SPEC_SUM1 'M0OD50015A' 'M0OC555A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QD50086A' 'M0QC613A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QE50118A' 'M0QC613A' LR_COND.
*--0908/2 2009.08.04 BG
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 02-46-c Mnypt member private pension
       WHEN  C_ABEVAZ_A0CC0046CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         M_DEF LR_COND 'E' 'EQ' '83' SPACE.
         M_DEF LR_COND 'E' 'EQ' '92' SPACE.
         M_DEF LR_COND 'E' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0559CA' 'M0HC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0592CA' 'M0IC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0IE0603CA' 'M0IC006A' LR_COND.
*++0908/2 2009.08.04 BG
         LM_GET_SPEC_SUM1 'M0OD50017A' 'M0OC555A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QD50088A' 'M0QC613A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QE50120A' 'M0QC613A' LR_COND.
*--0908/2 2009.08.04 BG
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 02-47-c Mnypt member private tax unemployment, unemployment pension
       WHEN  C_ABEVAZ_A0CC0047CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0559CA' 'M0HC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0592CA' 'M0IC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0IE0603CA' 'M0IC006A' LR_COND.
*++0908/2 2009.08.04 BG
         LM_GET_SPEC_SUM1 'M0OD50017A' 'M0OC555A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QD50088A' 'M0QC613A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QE50120A' 'M0QC613A' LR_COND.
*--0908/2 2009.08.04 BG
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      The 02-48-cA Mnypt member pays private tax GYED,S,T pension
       WHEN  C_ABEVAZ_A0CC0048CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '83' SPACE.
         M_DEF LR_COND 'I' 'EQ' '92' SPACE.
         M_DEF LR_COND 'I' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0559CA' 'M0HC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0592CA' 'M0IC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0IE0603CA' 'M0IC006A' LR_COND.
*++0908/2 2009.08.04 BG
         LM_GET_SPEC_SUM1 'M0OD50017A' 'M0OC555A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QD50088A' 'M0QC613A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QE50120A' 'M0QC613A' LR_COND.
*--0908/2 2009.08.04 BG
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 03-60-c A fogl terh term egbizt
       WHEN  C_ABEVAZ_A0DC0060CA.
*++0908/2 2009.08.04 BG
         IF $DATE(6) <= '200906'.
*--0908/2 2009.08.04 BG
*        Upload condition
           REFRESH LR_COND.
           M_DEF LR_COND 'E' 'EQ' '25' SPACE.
           M_DEF LR_COND 'E' 'EQ' '42' SPACE.
           M_DEF LR_COND 'E' 'EQ' '81' SPACE.
           LM_GET_FIELD $INDEX.
           LM_GET_SPEC_SUM1 'M0HD0552CA' 'M0HC006A' LR_COND.
           LM_GET_SPEC_SUM1 'M0ID0597CA' 'M0IC006A' LR_COND.
           PERFORM CALC_FIELD_NRK USING <FIELD_N>
                        W_/ZAK/BEVALLB-ROUND
                        W_/ZAK/BEVALLO-WAERS
               CHANGING <FIELD_NR>
                        <FIELD_NRK>.
           IF $INDEX NE '000'.
             MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
           ENDIF.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*++0908/2 2009.08.04 BG
         ENDIF.
*      Employer's unemployment insurance 1.5% not 25, 42, 81
       WHEN  C_ABEVAZ_A0ZZ000004.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0OD50008A' 'M0OC555A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QD50100A' 'M0QC613A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      Employer's unemployment insurance 4.5% not 25, 42, 81
       WHEN  C_ABEVAZ_A0ZZ000006.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0OD50009A' 'M0OC555A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QD50101A' 'M0QC613A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*--0908/2 2009.08.04 BG
*      The 03-61-c The burden of unemployment benefits the employee
       WHEN  C_ABEVAZ_A0DC0061CA.
*++0908/2 2009.08.04 BG
         IF $DATE(6) <= '200906'.
*--0908/2 2009.08.04 BG
*        Upload condition
           REFRESH LR_COND.
           M_DEF LR_COND 'I' 'EQ' '25' SPACE.
           M_DEF LR_COND 'I' 'EQ' '42' SPACE.
           M_DEF LR_COND 'I' 'EQ' '81' SPACE.
           LM_GET_FIELD $INDEX.
           LM_GET_SPEC_SUM1 'M0HD0552CA' 'M0HC006A' LR_COND.
           LM_GET_SPEC_SUM1 'M0ID0597CA' 'M0IC006A' LR_COND.
           PERFORM CALC_FIELD_NRK USING <FIELD_N>
                        W_/ZAK/BEVALLB-ROUND
                        W_/ZAK/BEVALLO-WAERS
               CHANGING <FIELD_NR>
                        <FIELD_NRK>.
           IF $INDEX NE '000'.
             MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
           ENDIF.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*++0908/2 2009.08.04 BG
         ENDIF.
*      Employer's unemployment insurance 1.5% not 25, 42, 81
       WHEN  C_ABEVAZ_A0ZZ000005.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0OD50008A' 'M0OC555A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QD50100A' 'M0QC613A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      Employer's unemployment insurance 4.5% not 25, 42, 81
       WHEN  C_ABEVAZ_A0ZZ000007.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0OD50009A' 'M0OC555A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QD50101A' 'M0QC613A' LR_COND.
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*--0908/2 2009.08.04 BG
*      The 03-62-c The prisoner is charged with money insurance
       WHEN  C_ABEVAZ_A0DC0062CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0553CA' 'M0HC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0598CA' 'M0IC006A' LR_COND.
*++0908/2 2009.08.04 BG
         LM_GET_SPEC_SUM1 'M0OD50007A' 'M0OC555A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QD50099A' 'M0QC613A' LR_COND.
*--0908/2 2009.08.04 BG
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      The 03-63-c The unemployment insurance of the employee
       WHEN  C_ABEVAZ_A0DC0063CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0553CA' 'M0HC006A' LR_COND.
         LM_GET_SPEC_SUM1 'M0ID0598CA' 'M0IC006A' LR_COND.
*++0908/2 2009.08.04 BG
         LM_GET_SPEC_SUM1 'M0OD50007A' 'M0OC555A' LR_COND.
         LM_GET_SPEC_SUM1 'M0QD50099A' 'M0QC613A' LR_COND.
*--0908/2 2009.08.04 BG
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      With the 03-79-c A START EXTRA card, the order is 0%
       WHEN  C_ABEVAZ_A0DC0079CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' 'X' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0LD0669CA' 'M0LD0669AA' LR_COND.
*++0908/2 2009.08.04 BG
         LM_GET_SPEC_SUM1 'M0SD50207A' 'M0SD50197A' LR_COND.
*--0908/2 2009.08.04 BG
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                     W_/ZAK/BEVALLB-ROUND
                     W_/ZAK/BEVALLO-WAERS
            CHANGING <FIELD_NR>
                     <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*      A 03-80-c A Pmtv. 0% in the case of § 8
       WHEN  C_ABEVAZ_A0DC0080CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' 'X' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0LD0669CA' 'M0LD0669AA' LR_COND.
*++0908/2 2009.08.04 BG
         LM_GET_SPEC_SUM1 'M0SD50207A' 'M0SD50197A' LR_COND.
*--0908/2 2009.08.04 BG
         PERFORM CALC_FIELD_NRK USING <FIELD_N>
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING <FIELD_NR>
                      <FIELD_NRK>.
         IF $INDEX NE '000'.
           MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
     ENDCASE.
   ENDLOOP.

*++0908/2 2009.08.07 BG
* Special summaries only from 07.2009
   IF $DATE(6) > '200906'.
     LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
       WHERE ABEVAZ EQ C_ABEVAZ_A0DC0060CA OR
             ABEVAZ EQ C_ABEVAZ_A0DC0061CA.

       CLEAR W_/ZAK/BEVALLO.

*    this line must be modified!
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
       WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
                BINARY SEARCH.

       CHECK SY-SUBRC EQ 0.

       V_TABIX = SY-TABIX .

       CASE W_/ZAK/BEVALLB-ABEVAZ.
*        A0DC0060CA
         WHEN  C_ABEVAZ_A0DC0060CA.
           LM_GET_FIELD $INDEX.
           REFRESH LR_ABEVAZ.
           M_DEF LR_ABEVAZ 'I' 'EQ' 'A0ZZ000004' SPACE.
           M_DEF LR_ABEVAZ 'I' 'EQ' 'A0ZZ000006' SPACE.
           LM_GET_SPEC_SUM2 LR_ABEVAZ.
           PERFORM CALC_FIELD_NRK USING <FIELD_N>
                        W_/ZAK/BEVALLB-ROUND
                        W_/ZAK/BEVALLO-WAERS
               CHANGING <FIELD_NR>
                        <FIELD_NRK>.
           IF $INDEX NE '000'.
             MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
           ENDIF.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         WHEN C_ABEVAZ_A0DC0061CA.
           LM_GET_FIELD $INDEX.
           REFRESH LR_ABEVAZ.
           M_DEF LR_ABEVAZ 'I' 'EQ' 'A0ZZ000005' SPACE.
           M_DEF LR_ABEVAZ 'I' 'EQ' 'A0ZZ000007' SPACE.
           LM_GET_SPEC_SUM2 LR_ABEVAZ.
           PERFORM CALC_FIELD_NRK USING <FIELD_N>
                        W_/ZAK/BEVALLB-ROUND
                        W_/ZAK/BEVALLO-WAERS
               CHANGING <FIELD_NR>
                        <FIELD_NRK>.
           IF $INDEX NE '000'.
             MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
           ENDIF.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       ENDCASE.
     ENDLOOP.
   ENDIF.
*--0908/2 2009.08.07 BG

 ENDFORM.                    " CALC_ABEV_SZJA_SPECIAL_0908
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_ONREV_SZJA_0808
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*      -->P_$INDEX  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONREV_SZJA_0908
                           TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                   T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                   T_ADOAZON STRUCTURE /ZAK/ONR_ADOAZON
                           USING   $INDEX
                                   $LAST_DATE.

   DATA LI_LAST_BEVALLO LIKE /ZAK/BEVALLO OCCURS 0 WITH HEADER LINE.

   DATA L_LAST_INDEX LIKE /ZAK/BEVALLO-ZINDEX.
   DATA L_TABIX LIKE SY-TABIX.
   DATA L_TRUE.

   RANGES LR_ONREV_ABEVAZ FOR /ZAK/BEVALLB-ABEVAZ.
   DATA   L_ABEVAZ LIKE /ZAK/BEVALLB-ABEVAZ.

   DATA: L_KAM_KEZD TYPE DATUM,
         L_KAM_VEG  TYPE DATUM.
   DATA   L_KAMAT LIKE /ZAK/BEVALLO-FIELD_N.
   DATA   L_KAMAT_SUM LIKE /ZAK/BEVALLO-FIELD_N.

*  To upload fields to be summarized
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.

*  If self-revision
   CHECK $INDEX NE '000'.

   SORT T_BEVALLB BY ABEVAZ.

*  Let's read the 'A' abev identifiers of the previous period
   READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO INDEX 1.
   CHECK SY-SUBRC EQ 0.
   L_LAST_INDEX = $INDEX - 1.

   CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
     EXPORTING
       INPUT  = L_LAST_INDEX
     IMPORTING
       OUTPUT = L_LAST_INDEX.


   SELECT * INTO TABLE LI_LAST_BEVALLO
                 FROM  /ZAK/BEVALLO
                WHERE  BUKRS   EQ W_/ZAK/BEVALLO-BUKRS
                  AND  BTYPE   EQ W_/ZAK/BEVALLO-BTYPE
                  AND  GJAHR   EQ W_/ZAK/BEVALLO-GJAHR
                  AND  MONAT   EQ W_/ZAK/BEVALLO-MONAT
                  AND  ZINDEX  EQ L_LAST_INDEX
                  AND  ADOAZON EQ ''.

   SORT LI_LAST_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ.

*  We delete records that are not in the given period
*  adtak fel.
   LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                     WHERE NOT ADOAZON IS INITIAL.
     READ TABLE T_ADOAZON WITH KEY ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                                   BINARY SEARCH.
*    Nem kell a rekord.
     IF SY-SUBRC NE 0.
       DELETE T_BEVALLO.
       CONTINUE.
     ENDIF.
*  M 11 Mark with an X if your declaration is considered a correction
     IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_M0AE003A.
       MOVE 'H' TO W_/ZAK/BEVALLO-FIELD_C.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO TRANSPORTING FIELD_C.
     ENDIF.
   ENDLOOP.

**  Jelölje X-ell, ha a bevallása helyesbítésnek minősül
*   READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
*                             WITH KEY ABEVAZ = C_ABEVAZ_A0AC033A.
*   IF SY-SUBRC EQ 0.
*     MOVE SY-TABIX TO L_TABIX.
*     MOVE 'X' TO W_/ZAK/BEVALLO-FIELD_C.
*     MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
*   ENDIF.
*
**  Jelölje X-ell, ha a bevallása önellenőrzésnek minősül
*   READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
*                             WITH KEY ABEVAZ = C_ABEVAZ_A0AC035A.
*   IF SY-SUBRC EQ 0.
*     MOVE SY-TABIX TO L_TABIX.
*     MOVE 'X' TO W_/ZAK/BEVALLO-FIELD_C.
*     MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
*   ENDIF.
*
**  Jelölje X-ell, ha a bevallása ismételt önellenőrzésnek minősül
*   READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
*                             WITH KEY ABEVAZ = C_ABEVAZ_A0AC036A.
*
*   IF SY-SUBRC EQ 0 AND $INDEX > '001'.
*     MOVE SY-TABIX TO L_TABIX.
*     MOVE 'X' TO W_/ZAK/BEVALLO-FIELD_C.
*     MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.
*   ENDIF.

**  Számítási algoritmus ÖNREVÍZIÓHOZ:
*A0GC0200DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0200DA   "Módosított mező
                                 C_ABEVAZ_A0BC0001CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0201CA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                LI_LAST_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0201CA   "Módosított mező
                                C_ABEVAZ_A0ZZ000001         "Forrás 1
                                SPACE                       "Forrás 2
                                SPACE                       "Forrás 3
                                SPACE                       "Forrás 4
                                SPACE.                      "Forrás 5

*A0GC0201DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0201DA   "Módosított mező
                                 C_ABEVAZ_A0CC0035CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0202DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0202DA   "Módosított mező
                                 C_ABEVAZ_A0CC0039CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0202CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0202CA   "Módosított mező
                                C_ABEVAZ_A0GC0202DA
                                '0.04'.

*A0GC0204DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0204DA   "Módosított mező
                                 C_ABEVAZ_A0BC0014CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0205DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0205DA   "Módosított mező
                                 C_ABEVAZ_A0CC0040CA        "Forrás 1
                                 C_ABEVAZ_A0CC0041CA        "Forrás 2
                                 C_ABEVAZ_A0CC0042CA        "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0205CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0205CA   "Módosított mező
                                C_ABEVAZ_A0GC0205DA
                                '0.24'.
*++2011.09.09 BG
*HR will handle it from here on, we won't give up on it
**A0GC0206DA
*   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
*                                 LI_LAST_BEVALLO
*                                 T_BEVALLB
*                          USING C_ABEVAZ_A0GC0206DA "Modified field
*                                 C_ABEVAZ_A0CC0043CA "Source 1
*                                 C_ABEVAZ_A0CC0044CA "Source 2
*                                 C_ABEVAZ_A0CC0045CA "Source 3
*                                 SPACE "Source 4
*                                 SPACE.                     "Source 5
**A0GC0206CA
*   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
*                                T_BEVALLB
*                         USING C_ABEVAZ_A0GC0206CA "Modified field
*                                C_ABEVAZ_A0GC0206DA
*                                '0.095'.
*
*
**A0GC0207DA
*   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
*                                 LI_LAST_BEVALLO
*                                 T_BEVALLB
*                          USING C_ABEVAZ_A0GC0207DA "Modified field
*                                 C_ABEVAZ_A0CC0046CA "Source 1
*                                 C_ABEVAZ_A0CC0047CA "Source 2
*                                 C_ABEVAZ_A0CC0048CA "Source 3
*                                 SPACE "Source 4
*                                 SPACE.                     "Source 5
**A0GC0207CA
*   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
*                                T_BEVALLB
*                         USING C_ABEVAZ_A0GC0207CA "Modified field
*                                C_ABEVAZ_A0GC0207DA
*                                '0.015'.
*++2011.09.09 BG

*A0GC0208DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0208DA   "Módosított mező
                                 C_ABEVAZ_A0CC0049CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0208CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0208CA   "Módosított mező
                                C_ABEVAZ_A0GC0208DA
                                '0.15'.


*A0GC0210DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0210DA   "Módosított mező
                                 C_ABEVAZ_A0BC0015CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0211DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0211DA   "Módosított mező
                                 C_ABEVAZ_A0BC0016CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0212DA
*++0908/2 2009.08.07 BG
   IF $LAST_DATE(6) <= '200906'.
*--0908/2 2009.08.07 BG
     PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                   LI_LAST_BEVALLO
                                   T_BEVALLB
                            USING  C_ABEVAZ_A0GC0212DA
                            "Módosított mező
                                   C_ABEVAZ_A0DC0060CA      "Forrás 1
                                   C_ABEVAZ_A0DC0061CA      "Forrás 2
                                   SPACE                    "Forrás 3
                                   SPACE                    "Forrás 4
                                   SPACE.                   "Forrás 5
*++0908/2 2009.08.07 BG
   ELSE.
     PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                   LI_LAST_BEVALLO
                                   T_BEVALLB
                            USING  C_ABEVAZ_A0GC0212DA
                            "Módosított mező
                                   C_ABEVAZ_A0ZZ000006      "Forrás 1
                                   C_ABEVAZ_A0ZZ000007      "Forrás 2
                                   SPACE                    "Forrás 3
                                   SPACE                    "Forrás 4
                                   SPACE.                   "Forrás 5
   ENDIF.
*--0908/2 2009.08.07 BG
*A0GC0212CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0212CA   "Módosított mező
                                C_ABEVAZ_A0GC0212DA
                                '0.045'.

*A0GC0213DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0213DA   "Módosított mező
                                 C_ABEVAZ_A0DC0062CA        "Forrás 1
                                 C_ABEVAZ_A0DC0063CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0213CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0213CA   "Módosított mező
                                C_ABEVAZ_A0GC0213DA
                                '0.005'.

*A0GC0214DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0214DA   "Módosított mező
                                 C_ABEVAZ_A0DC0064CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0215DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0215DA   "Módosított mező
                                 C_ABEVAZ_A0DC0065CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0215CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0215CA   "Módosított mező
                                C_ABEVAZ_A0GC0215DA
                                '0.04'.

*A0GC0216DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0216DA   "Módosított mező
                                 C_ABEVAZ_A0DC0066CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0216CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0216CA   "Módosított mező
                                C_ABEVAZ_A0GC0216DA
                                '0.02'.

*A0GC0217DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0217DA   "Módosított mező
                                 C_ABEVAZ_A0DC0067CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0218DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0218DA   "Módosított mező
                                 C_ABEVAZ_A0CC0051CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0218CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0218CA   "Módosított mező
                                C_ABEVAZ_A0GC0218DA
                                '0.065'.
*A0GC0219DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0219DA   "Módosított mező
                                 C_ABEVAZ_A0BC0013CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0220DA
*++0908/2 2009.08.07 BG
   IF $LAST_DATE(6) <= '200906'.
*--0908/2 2009.08.07 BG
     PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                   LI_LAST_BEVALLO
                                   T_BEVALLB
                            USING  C_ABEVAZ_A0GC0220DA
                            "Módosított mező
                                   C_ABEVAZ_A0DC0072CA      "Forrás 1
                                   SPACE                    "Forrás 2
                                   SPACE                    "Forrás 3
                                   SPACE                    "Forrás 4
                                   SPACE.                   "Forrás 5
*++0908/2 2009.08.07 BG
   ELSE.
     PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                   LI_LAST_BEVALLO
                                   T_BEVALLB
                            USING  C_ABEVAZ_A0GC0220DA "Módosított mező
                                   C_ABEVAZ_A0ZZ000003      "Forrás 1
                                   SPACE                    "Forrás 2
                                   SPACE                    "Forrás 3
                                   SPACE                    "Forrás 4
                                   SPACE.                   "Forrás 5
   ENDIF.
*--0908/2 2009.08.07 BG
*A0GC0220CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0220CA   "Módosított mező
                                C_ABEVAZ_A0GC0220DA
                                '0.03'.

*A0GC0221DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0221DA   "Módosított mező
                                 C_ABEVAZ_A0DC0073CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0221CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0221CA   "Módosított mező
                                C_ABEVAZ_A0GC0221DA
                                '0.015'.
*A0GC0222DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0222DA   "Módosított mező
                                 C_ABEVAZ_A0DC0074CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0222CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0222CA   "Módosított mező
                                C_ABEVAZ_A0GC0222DA
                                '0.04'.
*A0GC0224DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0224DA   "Módosított mező
                                 C_ABEVAZ_A0DC0075CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0224CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0224CA   "Módosított mező
                                C_ABEVAZ_A0GC0224DA
                                '0.15'.
*A0GC0225DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0225DA   "Módosított mező
                                 C_ABEVAZ_A0DC0076CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0225CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0225CA   "Módosított mező
                                C_ABEVAZ_A0GC0225DA
                                '0.25'.
*A0GC0226DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0226DA   "Módosított mező
                                 C_ABEVAZ_A0DC0077CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0226CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0226CA   "Módosított mező
                                C_ABEVAZ_A0GC0226DA
                                '0.15'.

*A0GC0227DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0227DA   "Módosított mező
                                 C_ABEVAZ_A0DC0078CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0227CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0227CA   "Módosított mező
                                C_ABEVAZ_A0GC0227DA
                                '0.25'.
*A0GC0228DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0228DA   "Módosított mező
                                 C_ABEVAZ_A0DC0081CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0228CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0228CA   "Módosított mező
                                C_ABEVAZ_A0GC0228DA
                                '0.15'.
*A0GC0229DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0229DA   "Módosított mező
                                 C_ABEVAZ_A0BC0017CA        "Forrás 1
                                 C_ABEVAZ_A0BC0018CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0230DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0230DA   "Módosított mező
                                 C_ABEVAZ_A0DC0083CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0230CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0230CA   "Módosított mező
                                C_ABEVAZ_A0GC0230DA
                                '0.11'.

*A0GC0232DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0232DA   "Módosított mező
                                 C_ABEVAZ_A0DC0084CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0233DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0233DA   "Módosított mező
                                 C_ABEVAZ_A0DC0085CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0234DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0234DA   "Módosított mező
                                 C_ABEVAZ_A0DC0086CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0235DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0235DA   "Módosított mező
                                 C_ABEVAZ_A0EC0092CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0235CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0235CA   "Módosított mező
                                C_ABEVAZ_A0HC0235DA
                                '0.095'.

*A0HC0237AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0237AA   "Módosított mező
                                 C_ABEVAZ_A0EC0094CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0238AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0238AA   "Módosított mező
                                 C_ABEVAZ_A0EC0095CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0239DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0239DA   "Módosított mező
                                 C_ABEVAZ_A0EC0096CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0239CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0239CA   "Módosított mező
                                C_ABEVAZ_A0HC0239DA
                                '0.111'.
*A0HC0240DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0240DA   "Módosított mező
                                 C_ABEVAZ_A0EC0097CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0240CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0240CA   "Módosított mező
                                C_ABEVAZ_A0HC0240DA
                                '0.15'.
*A0HC0241AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0241AA   "Módosított mező
                                 C_ABEVAZ_A0EC0098CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0242AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0242AA   "Módosított mező
                                 C_ABEVAZ_A0EC0099CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0243DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0243DA   "Módosított mező
                                 C_ABEVAZ_A0EC0100CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0243CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0243CA   "Módosított mező
                                C_ABEVAZ_A0HC0243DA
                                '0.15'.
*A0HC0244AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0244AA   "Módosított mező
                                 C_ABEVAZ_A0EC0101CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0245AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0245AA   "Módosított mező
                                 C_ABEVAZ_A0EC0102CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*++0908/2 2009.08.04 BG
*A0HC50047A
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC50047A   "Módosított mező
                                 C_ABEVAZ_A0BC50042A        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC50048A
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC50048A   "Módosított mező
                                 C_ABEVAZ_A0ZZ000004        "Forrás 1
                                 C_ABEVAZ_A0ZZ000005        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC50046A
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC50046A   "Módosított mező
                                C_ABEVAZ_A0HC50048A
                                '0.015'.
*A0HC50049A
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC50049A   "Módosított mező
                                 C_ABEVAZ_A0BC50041A        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC50029A
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC50029A   "Módosított mező
                                 C_ABEVAZ_A0EC50022A        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC50030A
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC50030A   "Módosított mező
                                C_ABEVAZ_A0HC50029A
                                '0.10'.
*A0HC50031A
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC50031A   "Módosított mező
                                 C_ABEVAZ_A0EC50019A        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC50032A
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC50032A   "Módosított mező
                                C_ABEVAZ_A0HC50031A
                                '0.20'.

*A0HC50033A
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC50033A   "Módosított mező
                                 C_ABEVAZ_A0EC50017A        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC50034A
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC50034A   "Módosított mező
                                C_ABEVAZ_A0HC50033A
                                '0.10'.
*A0HC50035A
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC50035A   "Módosított mező
                                 C_ABEVAZ_A0EC50015A        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC50036A
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC50036A   "Módosított mező
                                C_ABEVAZ_A0HC50035A
                                '0.20'.
*A0HC50037A
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC50037A   "Módosított mező
                                 C_ABEVAZ_A0EC50024A        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC50038A
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC50038A   "Módosított mező
                                C_ABEVAZ_A0HC50037A
                                '0.10'.
*A0HC50050A
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC50050A   "Módosított mező
                                 C_ABEVAZ_A0DC50013A        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC50045A
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC50045A   "Módosított mező
                                C_ABEVAZ_A0HC50050A
                                '0.01'.
*COMPOUNDS
*A0GC0199CA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0201CA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0199CA.

*A0GC0199DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0200DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0201DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0199DA.

*A0GC0203DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0204DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0205DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0206DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0207DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0208DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0203DA.

*A0GC0209DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0210DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0211DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0212DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0213DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0214DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0215DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0216DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0217DA SPACE.
*++0908/2 2009.08.07 BG
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC50047A SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC50048A SPACE.
*--0908/2 2009.08.07 BG

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0209DA.

*A0GC0223DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0224DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0225DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0226DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0227DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0228DA SPACE.
*--0908/2 2009.08.04 BG
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC50029A SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC50031A SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC50033A SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC50035A SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC50037A SPACE.
*++0908/2 2009.08.04 BG
   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0223DA.
*A0GC0231DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0232DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0233DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0234DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0231DA.
*A0HC0236DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0237AA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0238AA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0236DA.
*A0HC0236CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0236CA   "Módosított mező
                                C_ABEVAZ_A0HC0236DA
                                '0.20'.


 ENDFORM.                    " CALC_ABEV_ONREV_SZJA_0908
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_M_SZJA_0908
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_M_SZJA_0908 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                   T_BEVALLB STRUCTURE /ZAK/BEVALLB.

   SORT T_BEVALLB BY ABEVAZ.

*  Modification of the self-check obligation basis
*  A0ZZ000001
   PERFORM GET_SUM_CALC  TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ZZ000001   "Módosított mező
                                C_ABEVAZ_M0CC0415DA         "Forrás 1
                                C_ABEVAZ_M0CF0430BA         "Forrás 2
                                C_ABEVAZ_M0CF0431BA         "Forrás 3
                                C_ABEVAZ_M0CF0432BA         "Forrás 4
                                C_ABEVAZ_M0CF0434BA         "Forrás 5
                                C_ABEVAZ_M0CF0435CA         "Forrás 6
*++BG 2009.11.30
                                C_ABEVAZ_M0CF0433BA         "Forrás 7
*--BG 2009.11.30
                                SPACE                       "Forrás 8
                                SPACE                       "Forrás 9
                                SPACE.                      "Forrás 10

 ENDFORM.                    " CALC_ABEV_M_SZJA_0908
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_SZJA_0908
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$LAST_DATE  text
*      -->P_$INDEX  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SZJA_0908 TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                  T_BEVALLB STRUCTURE /ZAK/BEVALLB
                           USING  $DATE
                                  $INDEX.

   DATA: L_KAM_KEZD TYPE DATUM.

   DATA: BEGIN OF LI_ADOAZON OCCURS 0,
           ADOAZON TYPE /ZAK/ADOAZON,
         END OF LI_ADOAZON.
   DATA: L_BEVALLO TYPE /ZAK/BEVALLO.

*  To define a self-check
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.



************************************************************************
* Special abev fields
************************************************************************

   SORT T_BEVALLB BY ABEVAZ  .

* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE  ABEVAZ EQ     C_ABEVAZ_A0AC031A
        OR  ABEVAZ EQ     C_ABEVAZ_A0AC032A
        OR  ABEVAZ EQ     C_ABEVAZ_A0AC038A
        OR  ABEVAZ EQ     C_ABEVAZ_A0AC033A.

     CLEAR W_/ZAK/BEVALLO.

*    this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
          BINARY SEARCH.

     CHECK SY-SUBRC EQ 0.
     V_TABIX = SY-TABIX .


     CASE W_/ZAK/BEVALLB-ABEVAZ.
* always A0AC031A = first day from period
       WHEN C_ABEVAZ_A0AC031A.
* Havi
         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* A year old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'E'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+4(4) = '0101'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* He is four years old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.

           L_KAM_KEZD = $DATE.
           IF L_KAM_KEZD+4(2) >= '01' AND
              L_KAM_KEZD+4(2) <= '03'.

             L_KAM_KEZD+4(4) = '0101'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '04' AND
              L_KAM_KEZD+4(2) <= '06'.

             L_KAM_KEZD+4(4) = '0401'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '07' AND
              L_KAM_KEZD+4(2) <= '09'.

             L_KAM_KEZD+4(4) = '0701'.
           ENDIF.


           IF L_KAM_KEZD+4(2) >= '10' AND
              L_KAM_KEZD+4(2) <= '12'.

             L_KAM_KEZD+4(4) = '1001'.
           ENDIF.

           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ELSE.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ENDIF.

         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*      always A0AC032A = last day until period
       WHEN C_ABEVAZ_A0AC032A.
         W_/ZAK/BEVALLO-FIELD_C = $DATE.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*      Number of taxpayers = Tax numbers
       WHEN C_ABEVAZ_A0AC038A.

         REFRESH LI_ADOAZON.
         LOOP AT T_BEVALLO INTO L_BEVALLO.
           CHECK NOT L_BEVALLO-ADOAZON IS INITIAL.
           MOVE L_BEVALLO-ADOAZON TO LI_ADOAZON.
           COLLECT LI_ADOAZON.
         ENDLOOP.


         DESCRIBE TABLE LI_ADOAZON LINES SY-TFILL.
         IF NOT SY-TFILL IS INITIAL.
           W_/ZAK/BEVALLO-FIELD_C = SY-TFILL.
         ELSE.
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
         ENDIF.

         CONDENSE W_/ZAK/BEVALLO-FIELD_C.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*     Correction, Self-check, Repeated self-check
       WHEN C_ABEVAZ_A0AC033A.
*        Only in self-check
         IF $INDEX NE '000'.
           REFRESH LR_ABEVAZ.
*          A numerical value must be searched for in this range
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0GC0199CA
           C_ABEVAZ_A0GC0234DA.
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0HC0235CA
           C_ABEVAZ_A0HD0272BA.
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0IC0284BA
           C_ABEVAZ_A0IC0303HA.
*++0908/2 2009.08.04 BG
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0HC50029A
           C_ABEVAZ_A0HC50050A.
*--0908/2 2009.08.04 BG
           LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ IN LR_ABEVAZ
*++2009.10.09 BG (NESS)
*          We monitor the rounded sum because it may be FIELD_N
*          it is not empty, but no value is added to the return because of the fkator.
*                                          AND NOT FIELD_N  IS INITIAL.
                                           AND NOT FIELD_NR IS INITIAL.
*--2009.10.09 BG (NESS)
             EXIT.
           ENDLOOP.
*          There is value:
           IF SY-SUBRC EQ 0.
*            Repeated self-check
             IF $INDEX > '001'.
               W_/ZAK/BEVALLO-FIELD_C = 'I'.
*            Self-check
             ELSE.
               W_/ZAK/BEVALLO-FIELD_C = 'O'.
             ENDIF.
*          Corrective
           ELSE.
             W_/ZAK/BEVALLO-FIELD_C = 'H'.
           ENDIF.
           CONDENSE W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
     ENDCASE.
   ENDLOOP.

 ENDFORM.                    " CALC_ABEV_SZJA_0908
*&---------------------------------------------------------------------*
*&      Form  GET_LAP_SZ_0908
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*----------------------------------------------------------------------*
 FORM GET_LAP_SZ_0908  TABLES T_BEVALLO STRUCTURE  /ZAK/BEVALLALV.

   DATA L_ALV LIKE /ZAK/BEVALLALV.
   DATA L_INDEX LIKE SY-TABIX.
   DATA L_TABIX LIKE SY-TABIX.
   DATA L_NYLAP LIKE SY-TABIX.
   DATA L_BEVALLO_ALV LIKE /ZAK/BEVALLALV.
*++0908 2009.02.27 BG
   DATA L_NULL_FLAG TYPE /ZAK/NULL.
*--0908 2009.02.27 BG

   CLEAR L_INDEX.

*  Upload RANKS for SZJA tax identification page number management
   M_DEF R_M0AE007A 'I' 'BT' 'M0BC0000000000000' 'M0BZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE008A 'I' 'BT' 'M0CC0000000000000' 'M0CZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE009A 'I' 'BT' 'M0DC0000000000000' 'M0DZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE010A 'I' 'BT' 'M0EC0000000000000' 'M0EZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE011A 'I' 'BT' 'M0FC0000000000000' 'M0FZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE012A 'I' 'BT' 'M0GC0000000000000' 'M0GZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE013A 'I' 'BT' 'M0HD0000000000000' 'M0HZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE014A 'I' 'BT' 'M0ID0000000000000' 'M0IZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE015A 'I' 'BT' 'M0JD0000000000000' 'M0JZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE016A 'I' 'BT' 'M0KD0000000000000' 'M0KZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE017A 'I' 'BT' 'M0LD0000000000000' 'M0LZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE018A 'I' 'BT' 'M0MD0000000000000' 'M0MZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE019A 'I' 'BT' 'M0ND0000000000000' 'M0NZZZZZZZZZZZZZZ'.
*++0908/2 2009.08.04 BG
   M_DEF R_M0AE812A 'I' 'BT' 'M0OC552A' 'M0OC553A'.
   M_DEF R_M0AE811A 'I' 'BT' 'M0PC577A' 'M0PC553A'.
   M_DEF R_M0AE807A 'I' 'BT' 'M0QD0000000000000' 'M0QZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE810A 'I' 'BT' 'M0RD0000000000000' 'M0RZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE809A 'I' 'BT' 'M0SD0000000000000' 'M0SZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE808A 'I' 'BT' 'M0TD0000000000000' 'M0TZZZZZZZZZZZZZZ'.
*--0908/2 2009.08.04 BG

*  Upload RANKS to manage retired numbers
   M_DEF R_A0AC039A 'I' 'EQ' 'M0GC003A' SPACE.
   M_DEF R_A0AC039A 'I' 'EQ' 'M0HC003A' SPACE.
   M_DEF R_A0AC039A 'I' 'EQ' 'M0IC003A' SPACE.
   M_DEF R_A0AC039A 'I' 'EQ' 'M0JC003A' SPACE.
   M_DEF R_A0AC039A 'I' 'EQ' 'M0KC003A' SPACE.
   M_DEF R_A0AC039A 'I' 'EQ' 'M0LC003A' SPACE.
   M_DEF R_A0AC039A 'I' 'EQ' 'M0MC003A' SPACE.
   M_DEF R_A0AC039A 'I' 'EQ' 'M0NC001A' SPACE.
*++0908/2 2009.08.04 BG
   M_DEF R_A0AC039A 'I' 'EQ' 'M0OC554A' SPACE.
   M_DEF R_A0AC039A 'I' 'EQ' 'M0PC579A' SPACE.
   M_DEF R_A0AC039A 'I' 'EQ' 'M0PC579A' SPACE.
   M_DEF R_A0AC039A 'I' 'EQ' 'M0QC612A' SPACE.
   M_DEF R_A0AC039A 'I' 'EQ' 'M0RC659A' SPACE.
   M_DEF R_A0AC039A 'I' 'EQ' 'M0SC691A' SPACE.
   M_DEF R_A0AC039A 'I' 'EQ' 'M0TC741A' SPACE.
*--0908/2 2009.08.04 BG

*  Values
   M_DEF R_NYLAPVAL 'I' 'EQ' '1' SPACE.
   M_DEF R_NYLAPVAL 'I' 'EQ' '2' SPACE.
   M_DEF R_NYLAPVAL 'I' 'EQ' '3' SPACE.
   M_DEF R_NYLAPVAL 'I' 'EQ' '5' SPACE.

   REFRESH I_NYLAP.

   LOOP AT I_/ZAK/BEVALLO INTO W_/ZAK/BEVALLO.
     L_TABIX = SY-TABIX.

*   Dialog run for insurance
     PERFORM PROCESS_IND_ITEM USING '100000'
                                    L_INDEX
                                    TEXT-P01.

*   Csak SZJA-nal
     IF  W_/ZAK/BEVALL-BTYPART EQ C_BTYPART_SZJA.
*      Collections for tax identification number
       PERFORM CALL_MLAPSZ: TABLES R_M0AE007A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE007A,
                            TABLES R_M0AE008A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE008A,
                            TABLES R_M0AE009A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE009A,
                            TABLES R_M0AE010A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE010A,
                            TABLES R_M0AE011A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE011A,
                            TABLES R_M0AE012A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE012A,
                            TABLES R_M0AE013A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE013A,
                            TABLES R_M0AE014A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE014A,
                            TABLES R_M0AE015A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE015A,
                            TABLES R_M0AE016A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE016A,
                            TABLES R_M0AE017A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE017A,
                            TABLES R_M0AE018A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE018A,
                            TABLES R_M0AE019A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE019A,
*++0908/2 2009.08.04 BG
                            TABLES R_M0AE812A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE812A,
                            TABLES R_M0AE811A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE811A,
                            TABLES R_M0AE807A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE807A,
                            TABLES R_M0AE810A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE810A,
                            TABLES R_M0AE809A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE809A,
                            TABLES R_M0AE808A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE808A.
*--0908/2 2009.08.04 BG

*      Collection of pensioner tax numbers
       PERFORM CALL_NYLAP TABLES R_A0AC039A
                                 R_NYLAPVAL
                          USING  W_/ZAK/BEVALLO.

     ENDIF.

     READ TABLE T_BEVALLO INTO L_ALV WITH KEY
                   BUKRS   = W_/ZAK/BEVALLO-BUKRS
                   BTYPE   = W_/ZAK/BEVALLO-BTYPE
                   GJAHR   = W_/ZAK/BEVALLO-GJAHR
                   MONAT   = W_/ZAK/BEVALLO-MONAT
                   ZINDEX  = W_/ZAK/BEVALLO-ZINDEX
                   ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ
                   ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                   LAPSZ   = W_/ZAK/BEVALLO-LAPSZ
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
*++0908 2009.05.11 BG
**++0908 2009.02.27 BG
*       IF NOT L_ALV-NULL_FLAG IS INITIAL OR
*          NOT W_/ZAK/BEVALLO-NULL_FLAG IS INITIAL.
*         L_NULL_FLAG = C_X.
*       ELSE.
*         CLEAR L_NULL_FLAG.
*       ENDIF.
**--0908 2009.02.27 BG
*  The 0 flag handling was not appropriate
*  If it is a self-revision calculation, the T_BEVALLO 0 flag is required
*  otherwise, the I_/ZAK/BEVALLO 0 flag.
       IF NOT L_ALV-OFLAG IS INITIAL.
         L_NULL_FLAG = L_ALV-NULL_FLAG.
       ELSE.
         L_NULL_FLAG = W_/ZAK/BEVALLO-NULL_FLAG.
       ENDIF.
*--0908 2009.05.11 BG

*--0908 2009.02.27 BG
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
*++0908 2009.02.27 BG
       L_ALV-NULL_FLAG = L_NULL_FLAG.
*--0908 2009.02.27 BG
       IF L_ALV-OFLAG IS INITIAL.
         MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX
                         TRANSPORTING FIELD_C FIELD_N FIELD_NR FIELD_NRK
                                      NULL_FLAG WAERS
                                       .
       ELSE.
         MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX
                         TRANSPORTING FIELD_C FIELD_N  FIELD_NR
                         FIELD_NRK
                                      OFLAG   FIELD_ON FIELD_ONR
                                      FIELD_ONRK
                                      NULL_FLAG WAERS.
         PERFORM SUM_ONR TABLES T_BEVALLO
                         USING  L_ALV
                                L_ALV-FIELD_ON
                                L_ALV-FIELD_ONR
                                L_ALV-FIELD_ONRK.
       ENDIF.
     ELSE.
       READ TABLE I_/ZAK/BEVALLB INTO W_/ZAK/BEVALLB
       WITH KEY ABEVAZ = W_/ZAK/BEVALLO-ABEVAZ.
       MOVE-CORRESPONDING W_/ZAK/BEVALLB TO L_ALV.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
       SELECT SINGLE ABEVTEXT INTO L_ALV-ABEVTEXT
         FROM  /ZAK/BEVALLBT
              WHERE  LANGU   = SY-LANGU
              AND    BTYPE   = W_/ZAK/BEVALLO-BTYPE
              AND    ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ.
       L_ALV-ABEVTEXT_DISP = L_ALV-ABEVTEXT.
       APPEND L_ALV TO T_BEVALLO.
       SORT T_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ ADOAZON
            LAPSZ.
     ENDIF.
     DELETE I_/ZAK/BEVALLO.
   ENDLOOP.

*  Definition of pensioners
   IF NOT I_NYLAP[] IS INITIAL.
     DESCRIBE TABLE I_NYLAP LINES L_NYLAP.
     READ TABLE T_BEVALLO INTO L_BEVALLO_ALV
                          WITH KEY ABEVAZ  = C_ABEVAZ_A0AC039A
                          BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE L_NYLAP TO L_BEVALLO_ALV-FIELD_C.
       CONDENSE L_BEVALLO_ALV-FIELD_C.
       MODIFY T_BEVALLO FROM L_BEVALLO_ALV INDEX SY-TABIX
                             TRANSPORTING FIELD_C.
     ENDIF.
*++0908 2009.03.10 BG
   ELSE.
     READ TABLE T_BEVALLO INTO L_BEVALLO_ALV
                          WITH KEY ABEVAZ  = C_ABEVAZ_A0AC039A
                          BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       CLEAR L_BEVALLO_ALV-FIELD_C.
       MODIFY T_BEVALLO FROM L_BEVALLO_ALV INDEX SY-TABIX
                             TRANSPORTING FIELD_C.
     ENDIF.
*--0908 2009.03.10 BG
   ENDIF.

 ENDFORM.                    " GET_LAP_SZ_0908
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_0_SZJA_0908
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_ADOAZON_ALL  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_0_SZJA_0908  TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                              T_ADOAZON_ALL STRUCTURE /ZAK/ADOAZONLPSZ
*++0908 2009.02.27 BG
                             USING   $ONREV
*++0908/2 2009.12.09 BG
                                     $DATE.
*--0908/2 2009.12.09 BG


* So that you don't have to expand the self-revision to a global one for every FORM
* treated as a variable:
   CLEAR V_ONREV.
   IF NOT $ONREV IS INITIAL.
     MOVE $ONREV TO V_ONREV.
   ENDIF.
*--0908 2009.02.27 BG


*  If field1 >= field2 then field3 0 flag setting
   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0382CA         "mező1
                                C_ABEVAZ_M0BC0382BA         "mező2
                                C_ABEVAZ_M0BC0382DA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0382DA         "mező1
                                C_ABEVAZ_M0BC0382BA         "mező2
                                C_ABEVAZ_M0BC0382CA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0386CA         "mező1
                                C_ABEVAZ_M0BC0386BA         "mező2
                                C_ABEVAZ_M0BC0386DA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0386DA         "mező1
                                C_ABEVAZ_M0BC0386BA         "mező2
                                C_ABEVAZ_M0BC0386CA.        "mező3

*++RN 2009.07.09
**++BG 2009.07.08
*   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
*                                T_ADOAZON_ALL
*                         USING C_ABEVAZ_M0FD0496AA "field1
*                                C_ABEVAZ_M0FD0495AA "field2
*                                C_ABEVAZ_M0FD0498BA.        "field 3
*
**--BG 2009.07.08
*--RN 2009.07.09

*  If field1+field2+field3+field4 > 0 then 0 flag setting
   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0284HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0284CA    "mező1
                                     C_ABEVAZ_A0IC0284DA    "mező2
                                     C_ABEVAZ_A0IC0284EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0285HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0285CA    "mező1
                                     C_ABEVAZ_A0IC0285DA    "mező2
                                     C_ABEVAZ_A0IC0285EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0286HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0286CA    "mező1
                                     C_ABEVAZ_A0IC0286DA    "mező2
                                     C_ABEVAZ_A0IC0286EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0287HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0287CA    "mező1
                                     C_ABEVAZ_A0IC0287DA    "mező2
                                     C_ABEVAZ_A0IC0287EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0288HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0288CA    "mező1
                                     C_ABEVAZ_A0IC0288DA    "mező2
                                     C_ABEVAZ_A0IC0288EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0289HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0289CA    "mező1
                                     C_ABEVAZ_A0IC0289DA    "mező2
                                     C_ABEVAZ_A0IC0289EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0290HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0290CA    "mező1
                                     C_ABEVAZ_A0IC0290DA    "mező2
                                     C_ABEVAZ_A0IC0290EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0291HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0291CA    "mező1
                                     C_ABEVAZ_A0IC0291DA    "mező2
                                     C_ABEVAZ_A0IC0291EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0292HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0292CA    "mező1
                                     C_ABEVAZ_A0IC0292DA    "mező2
                                     C_ABEVAZ_A0IC0292EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0293HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0293CA    "mező1
                                     C_ABEVAZ_A0IC0293DA    "mező2
                                     C_ABEVAZ_A0IC0293EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0294HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0294CA    "mező1
                                     C_ABEVAZ_A0IC0294DA    "mező2
                                     C_ABEVAZ_A0IC0294EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0295HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0295CA    "mező1
                                     C_ABEVAZ_A0IC0295DA    "mező2
                                     C_ABEVAZ_A0IC0295EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0296HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0296CA    "mező1
                                     C_ABEVAZ_A0IC0296DA    "mező2
                                     C_ABEVAZ_A0IC0296EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0297HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0297CA    "mező1
                                     C_ABEVAZ_A0IC0297DA    "mező2
                                     C_ABEVAZ_A0IC0297EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0298HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0298CA    "mező1
                                     C_ABEVAZ_A0IC0298DA    "mező2
                                     C_ABEVAZ_A0IC0298EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0299HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0299CA    "mező1
                                     C_ABEVAZ_A0IC0299DA    "mező2
                                     C_ABEVAZ_A0IC0299EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0300HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0300CA    "mező1
                                     C_ABEVAZ_A0IC0300DA    "mező2
                                     C_ABEVAZ_A0IC0300EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0301HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0301CA    "mező1
                                     C_ABEVAZ_A0IC0301DA    "mező2
                                     C_ABEVAZ_A0IC0301EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0302HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0302CA    "mező1
                                     C_ABEVAZ_A0IC0302DA    "mező2
                                     C_ABEVAZ_A0IC0302EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0303HA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0303CA    "mező1
                                     C_ABEVAZ_A0IC0303DA    "mező2
                                     C_ABEVAZ_A0IC0303EA    "mező3
                                     SPACE.                 "mező4

* If field1 is not 0 or field2 is not 0 or field3 is not 0 or field4 is not 0
* or field 5 not 0 then 0 flag setting
*++BG 2009.07.08
   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0DC0087DA
                              "0-flag beállítás
                                     C_ABEVAZ_A0DC0087CA    "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6
*--BG 2009.07.08

   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0GC0199CA
                              "0-flag beállítás
                                     C_ABEVAZ_A0GC0199DA    "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6

   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0GC0201CA
                              "0-flag beállítás
                                     C_ABEVAZ_A0GC0201DA    "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6


*++0908/2 2009.12.09 BG
   IF $DATE(6) >= '200907'.
*--0908/2 2009.12.09 BG
*++2009.11.09 BG (NESS)
* 0 flag setting on field 1
     PERFORM GET_NULL_FLAG_0     TABLES T_BEVALLO
                                 USING  C_ABEVAZ_A0BC50041A.

     PERFORM GET_NULL_FLAG_0     TABLES T_BEVALLO
                                 USING  C_ABEVAZ_A0BC50042A.
*--2009.11.09 BG (Ness)
*++0908/2 2009.12.09 BG
   ENDIF.
*--0908/2 2009.12.09 BG



   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0CC0415DA
                               "0-flag beállítás
                                      C_ABEVAZ_M0BC0382BA   "mező1
                                      C_ABEVAZ_M0BC0386BA   "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0CC0416DA
                               "0-flag beállítás
                                      C_ABEVAZ_M0BC0382BA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0551CA
                               "0-flag beállítás
                                      C_ABEVAZ_M0HD0550CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0552CA
                               "0-flag beállítás
                                      C_ABEVAZ_M0HD0550CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0553CA
                               "0-flag beállítás
                                      C_ABEVAZ_M0HD0550CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6
*++2009.04.08 BG
*   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
*                                      T_ADOAZON_ALL
*USING C_ABEVAZ_M0HD0558CA "0-flag setting
*                                      C_ABEVAZ_M0HD0555CA "field1
*                                      SPACE "field2
*                                      SPACE "field3
*                                      SPACE "field4
*                                      SPACE "field5
*                                      SPACE.                 "field 6
*--2009.04.08 BG

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0566CA
                               "0-flag beállítás
                                      C_ABEVAZ_M0HD0565CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0568CA
                               "0-flag beállítás
                                      C_ABEVAZ_M0HD0567CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0570CA
                               "0-flag beállítás
                                      C_ABEVAZ_M0HD0569CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0572CA
                               "0-flag beállítás
                                      C_ABEVAZ_M0HD0571CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0574CA
                               "0-flag beállítás
                                      C_ABEVAZ_M0HD0573CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6
*++0908/2 2009.08.04 BG
   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0OD50006A
                               "0-flag beállítás
                                      C_ABEVAZ_M0OD50004A   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0OD50007A
                               "0-flag beállítás
                                      C_ABEVAZ_M0OD50004A   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0OD50008A
                               "0-flag beállítás
                                      C_ABEVAZ_M0OD50004A   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0OD50006A
                               "0-flag beállítás
                                      C_ABEVAZ_M0OD50005A   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0OD50007A
                               "0-flag beállítás
                                      C_ABEVAZ_M0OD50005A   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0OD50009A
                               "0-flag beállítás
                                      C_ABEVAZ_M0OD50005A   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0OD50031A
                               "0-flag beállítás
                                      C_ABEVAZ_M0OD50029A   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0OD50034A
                               "0-flag beállítás
                                      C_ABEVAZ_M0OD50032A   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0OD50037A
                               "0-flag beállítás
                                      C_ABEVAZ_M0OD50035A   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0OD50040A
                               "0-flag beállítás
                                      C_ABEVAZ_M0OD50038A   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0OD50043A
                               "0-flag beállítás
                                      C_ABEVAZ_M0OD50041A   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0PD50060A
                               "0-flag beállítás
                                      C_ABEVAZ_M0PD50058A   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

*--0908/2 2009.08.04 BG

*++BG 2009.07.16
* If field1 = field2 then 0 flag is set
   PERFORM GET_NULL_FLAG_EQM TABLES T_BEVALLO
                                    T_ADOAZON_ALL
                             USING  C_ABEVAZ_M0FD0496AA     "mező1
                                    C_ABEVAZ_M0FD0495AA     "mező2
                                    C_ABEVAZ_M0FD0498BA     "0-flag
                                    C_ABEVAZ_M0FD0497BA.    "0-flag
*--BG 2009.07.16




 ENDFORM.                    " CALC_ABEV_0_SZJA_0908
*&---------------------------------------------------------------------*
*&      Form  CALL_NYLAP
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_R_A0AC039A  text
*      -->P_R_NYLAPVAL  text
*      -->P_W_/ZAK/BEVALLO  text
*----------------------------------------------------------------------*
 FORM CALL_NYLAP  TABLES   $RANGE   STRUCTURE R_A0AC039A
                           $VALUE   STRUCTURE R_NYLAPVAL
                  USING    $BEVALLO STRUCTURE /ZAK/BEVALLO.

   IF $BEVALLO-ABEVAZ  IN $RANGE AND
      $BEVALLO-FIELD_C IN $VALUE.
     CLEAR W_NYLAP.
     MOVE $BEVALLO-ADOAZON TO W_NYLAP-ADOAZON.
     COLLECT W_NYLAP INTO I_NYLAP.
   ENDIF.

 ENDFORM.                    " CALL_NYLAP
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_AFA_0965
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_AFA_0965  TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                 T_BEVALLB STRUCTURE /ZAK/BEVALLB
                          USING  $DATE.

   DATA: L_SUM      LIKE /ZAK/BEVALLO-FIELD_N,
         L_SUM_203  LIKE /ZAK/BEVALLO-FIELD_N,
*++ BG 2009.06.17
         L_SUM_SAVE LIKE /ZAK/BEVALLO-FIELD_N,
*-- BG 2009.06.17
         L_KAMAT    LIKE /ZAK/BEVALLO-FIELD_N,
         L_ABEV_SUM LIKE /ZAK/BEVALLO-FIELD_N.
   DATA: L_KAM_KEZD  TYPE DATUM,
         L_KAM_VEG   TYPE DATUM,
         L_ROUND(20) TYPE C,
         L_TABIX     LIKE SY-TABIX,
         L_UPD.
************************************************************************
* Special abev fields

******************************************************** CSAK ÁFA normál

   DATA: W_SZ TYPE /ZAK/BEVALLB.

   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.

*  Loading calculated fields
   REFRESH LR_ABEVAZ.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8277 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8283 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_7650 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_7651 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_7653 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_7654 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8272 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8274 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8276 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8278 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8280 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8282 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_7693 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8281 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8282 SPACE.
ENHANCEMENT-POINT /ZAK/ZAK_0965_RG_01 SPOTS /ZAK/FUNCTIONS_ES .

   SORT T_BEVALLB BY ABEVAZ  .
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_ABEVAZ.
     CLEAR : L_SUM,W_/ZAK/BEVALLO.
* this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
     V_TABIX = SY-TABIX .
     CLEAR: W_/ZAK/BEVALLO-FIELD_N,
            W_/ZAK/BEVALLO-FIELD_NR,
            W_/ZAK/BEVALLO-FIELD_NRK.


     CASE W_/ZAK/BEVALLB-ABEVAZ.
* 72.C. Amount of tax to be paid
       WHEN C_ABEVAZ_8277.
         CLEAR L_SUM.
         READ TABLE T_BEVALLO INTO W_SUM
         WITH KEY ABEVAZ = C_ABEVAZ_8275.
         IF SY-SUBRC = 0.
           IF W_SUM-FIELD_N > 0.
             L_SUM = W_SUM-FIELD_NRK.
             W_/ZAK/BEVALLO-FIELD_N = L_SUM.
           ELSE.
             CLEAR W_/ZAK/BEVALLO-FIELD_N.
           ENDIF.
           L_UPD = 'X'.
         ENDIF.
* 00C Declaration period from
       WHEN C_ABEVAZ_7650.
* Havi
         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* A year old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'E'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+4(4) = '0101'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* He is four years old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.

           L_KAM_KEZD = $DATE.
           IF L_KAM_KEZD+4(2) >= '01' AND
              L_KAM_KEZD+4(2) <= '03'.

             L_KAM_KEZD+4(4) = '0101'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '04' AND
              L_KAM_KEZD+4(2) <= '06'.

             L_KAM_KEZD+4(4) = '0401'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '07' AND
              L_KAM_KEZD+4(2) <= '09'.

             L_KAM_KEZD+4(4) = '0701'.
           ENDIF.


           IF L_KAM_KEZD+4(2) >= '10' AND
              L_KAM_KEZD+4(2) <= '12'.

             L_KAM_KEZD+4(4) = '1001'.
           ENDIF.

           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ELSE.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ENDIF.

         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*00C Declaration period from
       WHEN C_ABEVAZ_7651.
         W_/ZAK/BEVALLO-FIELD_C = $DATE.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*00C Nature of declaration
       WHEN C_ABEVAZ_7653.
*        ZINDEX = '001' --> 'O' "self check
*        ZINDEX > '001' --> 'I' "repeated self-check
         IF W_/ZAK/BEVALLO-ZINDEX = '001'.
           W_/ZAK/BEVALLO-FIELD_C = 'O'.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ELSEIF W_/ZAK/BEVALLO-ZINDEX > '001'.
           W_/ZAK/BEVALLO-FIELD_C = 'I'.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
*00C Declaration frequency /H-monthly, N-quarterly, E-yearly
       WHEN C_ABEVAZ_7654.
         W_/ZAK/BEVALLO-FIELD_C = W_/ZAK/BEVALL-BIDOSZ.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*70.B. It can be calculated from the previous period
       WHEN C_ABEVAZ_8272.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8273
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*71.B. Established in the subject period
       WHEN C_ABEVAZ_8274.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8275
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*72.B. Amount of tax to be paid
       WHEN C_ABEVAZ_8276.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8277
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*73.B. It is not organized in terms of Pü
       WHEN C_ABEVAZ_8278.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8279
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*74.B. Amount of recoverable tax
       WHEN C_ABEVAZ_8280.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8281
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*74.B. It can be carried over to the next period
       WHEN C_ABEVAZ_8282.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8283
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*00F year month day
       WHEN C_ABEVAZ_7693.
         W_/ZAK/BEVALLO-FIELD_C = SY-DATUM.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
* Claimable,
       WHEN  C_ABEVAZ_8281.
         READ TABLE T_BEVALLO INTO W_SUM
              WITH KEY ABEVAZ = C_ABEVAZ_8275.
         IF SY-SUBRC EQ 0 AND W_SUM-FIELD_N < 0.
           CLEAR L_SUM.
           L_SUM = W_SUM-FIELD_NRK.
           READ TABLE T_BEVALLO INTO W_SUM
                WITH KEY ABEVAZ = C_ABEVAZ_7688.
           IF SY-SUBRC EQ 0 AND NOT W_SUM-FIELD_C IS INITIAL.
             READ TABLE T_BEVALLO INTO W_SUM
                  WITH KEY ABEVAZ = C_ABEVAZ_8279.
             IF SY-SUBRC EQ 0.
               SUBTRACT W_SUM-FIELD_NRK FROM L_SUM.
               W_/ZAK/BEVALLO-FIELD_N = ABS( L_SUM ).
               L_UPD = 'X'.
             ENDIF.
           ELSEIF SY-SUBRC EQ 0 AND W_SUM-FIELD_C IS INITIAL.
             CLEAR W_/ZAK/BEVALLO-FIELD_N.
             L_UPD = 'X'.
           ENDIF.
         ENDIF.
*Carried over to next period
       WHEN  C_ABEVAZ_8283.
         READ TABLE T_BEVALLO INTO W_SUM
              WITH KEY ABEVAZ = C_ABEVAZ_8275.
         IF SY-SUBRC EQ 0 AND W_SUM-FIELD_N < 0.
           CLEAR L_SUM.
           L_SUM = W_SUM-FIELD_NRK.
           READ TABLE T_BEVALLO INTO W_SUM
                WITH KEY ABEVAZ = C_ABEVAZ_7688.
           IF SY-SUBRC EQ 0 AND NOT W_SUM-FIELD_C IS INITIAL.
             READ TABLE T_BEVALLO INTO W_SUM
                  WITH KEY ABEVAZ = C_ABEVAZ_8279.
             IF SY-SUBRC EQ 0.
               W_/ZAK/BEVALLO-FIELD_N = ABS( W_SUM-FIELD_NRK ).
               L_UPD = 'X'.
             ENDIF.
           ELSEIF SY-SUBRC EQ 0 AND W_SUM-FIELD_C IS INITIAL.
             W_/ZAK/BEVALLO-FIELD_N = ABS( L_SUM ).
             L_UPD = 'X'.
           ENDIF.
         ENDIF.

     ENDCASE.
ENHANCEMENT-POINT /ZAK/ZAK_0965_RG_02 SPOTS /ZAK/FUNCTIONS_ES .

* fill in all numerical values ​​for calculated fields!
* the procedure for forming an amount is as follows:
* pl: ABEV3 field_n = ABEV1 field_nrk + ABEV2 field_nrk
* then apply the default rounding rule!
     IF NOT W_/ZAK/BEVALLB-COLLECT IS INITIAL AND
        L_UPD EQ 'X'.
       CLEAR L_ROUND.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                   W_/ZAK/BEVALLB-ROUND
                   W_/ZAK/BEVALLO-WAERS
          CHANGING W_/ZAK/BEVALLO-FIELD_NR
                   W_/ZAK/BEVALLO-FIELD_NRK.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       CLEAR: L_SUM,L_UPD.
     ENDIF.
     CLEAR: L_UPD,L_SUM,L_ROUND.

   ENDLOOP.

*  Calculation of dependent fields
   REFRESH LR_ABEVAZ.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_7689 SPACE.

   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_ABEVAZ.
     CLEAR : L_SUM,W_/ZAK/BEVALLO.
* this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
     V_TABIX = SY-TABIX .
     CLEAR: W_/ZAK/BEVALLO-FIELD_N,
            W_/ZAK/BEVALLO-FIELD_NR,
            W_/ZAK/BEVALLO-FIELD_NRK.


     CASE W_/ZAK/BEVALLB-ABEVAZ.

*00D I do not request a referral
       WHEN C_ABEVAZ_7689.
         READ TABLE T_BEVALLO INTO W_SUM
              WITH KEY ABEVAZ = C_ABEVAZ_8281.
         IF SY-SUBRC EQ 0 AND W_SUM-FIELD_N NE 0.
           W_/ZAK/BEVALLO-FIELD_C = C_X.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ELSEIF SY-SUBRC EQ 0 AND W_SUM-FIELD_N EQ 0.
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.


     ENDCASE.


* fill in all numerical values ​​for calculated fields!
* the procedure for forming an amount is as follows:
* pl: ABEV3 field_n = ABEV1 field_nrk + ABEV2 field_nrk
* then apply the default rounding rule!
     IF NOT W_/ZAK/BEVALLB-COLLECT IS INITIAL AND
        L_UPD EQ 'X'.
       CLEAR L_ROUND.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                   W_/ZAK/BEVALLB-ROUND
                   W_/ZAK/BEVALLO-WAERS
          CHANGING W_/ZAK/BEVALLO-FIELD_NR
                   W_/ZAK/BEVALLO-FIELD_NRK.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       CLEAR: L_SUM,L_UPD.
     ENDIF.
     CLEAR: L_UPD,L_SUM,L_ROUND.

   ENDLOOP.

************************************************************************
****
* calculation of self-check allowance
************************************************************************
****
   IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
* if 8277 - 8276 > 0 then this value, otherwise 0
     LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
       WHERE  ABEVAZ EQ     C_ABEVAZ_203.
       CLEAR: L_SUM,L_SUM_203.
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_8276  OR
                ABEVAZ EQ     C_ABEVAZ_8277.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_8276.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM < 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_203 = L_SUM_203 + L_SUM.
       CLEAR L_SUM.
* (8283 - 8282) < 0 then the calculated value is minus
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_8283  OR
                ABEVAZ EQ     C_ABEVAZ_8282.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_8282.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM > 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_203 = L_SUM_203 - L_SUM.
       CLEAR L_SUM.
* 8281 - 8280 < 0 then the calculated value is minus
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_8281  OR
                ABEVAZ EQ     C_ABEVAZ_8280.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_8280.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM > 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_203 = L_SUM_203 - L_SUM.
       CLEAR L_SUM.
*     If 8273-8272 < 0, it must be reduced by this amount
*     az L_SUM_203-at.
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                            WITH KEY ABEVAZ = C_ABEVAZ_8273.
       IF SY-SUBRC EQ 0.
         L_SUM = W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                            WITH KEY ABEVAZ = C_ABEVAZ_8272.
       IF SY-SUBRC EQ 0.
         L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       IF L_SUM < 0.
*++ BG 2009.06.17
         L_SUM_SAVE = ABS( L_SUM ).
*-- BG 2009.06.17
         ADD L_SUM TO L_SUM_203.
       ENDIF.

       IF L_SUM_203 < 0.
*++ BG 2009.06.17
         ADD L_SUM_203 TO L_SUM_SAVE.
*-- BG 2009.06.17
         CLEAR L_SUM_203.
       ENDIF.
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
       WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
       V_TABIX = SY-TABIX .
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING L_SUM_203
                     W_/ZAK/BEVALLB-ROUND
                     W_/ZAK/BEVALLO-WAERS
            CHANGING W_/ZAK/BEVALLO-FIELD_NR
                     W_/ZAK/BEVALLO-FIELD_NRK.
         W_/ZAK/BEVALLO-FIELD_N = L_SUM_203.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       ENDIF.
     ENDLOOP.
ENHANCEMENT-POINT /ZAK/ZAK_0965_RG_03 SPOTS /ZAK/FUNCTIONS_ES .

* determination of self-control allowance
* Calculation of ABEV 205 based on 203, if the index is 2 or greater, then x1.5

     IF W_/ZAK/BEVALLO-ZINDEX NE '000'.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_205.
       IF SY-SUBRC EQ 0.
         CLEAR L_SUM.
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                              WITH KEY ABEVAZ = C_ABEVAZ_203.
         IF SY-SUBRC = 0.
           L_SUM = W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
* period definition
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                              WITH KEY ABEVAZ = C_ABEVAZ_7652.
         IF SY-SUBRC EQ 0 AND
         NOT W_/ZAK/BEVALLO-FIELD_C IS INITIAL .
* determining the deadline for calculating the allowance! the 104
* I don't need a tax for the /ZAK/ADONEM table key !!

           SELECT SINGLE FIZHAT INTO W_/ZAK/ADONEM-FIZHAT FROM /ZAK/ADONEM
                                 WHERE BUKRS  EQ W_/ZAK/BEVALLO-BUKRS AND
                                                  ADONEM EQ C_ADONEM_104
                                                  .
           IF SY-SUBRC EQ 0.
* start date of allowance calculation
             CLEAR L_KAM_KEZD.
             L_KAM_KEZD = $DATE + 1 + W_/ZAK/ADONEM-FIZHAT.
* end date of allowance calculation in the character field of row 5299 above
             CLEAR L_KAM_VEG.
             CALL FUNCTION 'CONVERSION_EXIT_IDATE_INPUT'
               EXPORTING
                 INPUT  = W_/ZAK/BEVALLO-FIELD_C
               IMPORTING
                 OUTPUT = L_KAM_VEG.
*++2012.01.06 BG
*             L_KAM_VEG = L_KAM_VEG - 15 .
*--2012.01.06 BG
* allowance calculation
             PERFORM CALC_POTLEK USING    W_/ZAK/BEVALLO-BUKRS
                                          W_/ZAK/BEVALLO-ZINDEX
                                 CHANGING L_KAM_KEZD
                                          L_KAM_VEG
                                          L_SUM
                                          L_KAMAT. " 203 --> 205
             READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                                  WITH KEY ABEVAZ = C_ABEVAZ_205.
             V_TABIX = SY-TABIX.
             IF SY-SUBRC = 0.
               W_/ZAK/BEVALLO-FIELD_N = L_KAMAT.
               PERFORM CALC_FIELD_NRK USING L_KAMAT
                          W_/ZAK/BEVALLB-ROUND
                          W_/ZAK/BEVALLO-WAERS
                 CHANGING W_/ZAK/BEVALLO-FIELD_NR
                          W_/ZAK/BEVALLO-FIELD_NRK.
*++BG 2009.05.18
*              The value of the 0 flag must be handled in the form control
*              miatt:
               IF NOT W_/ZAK/BEVALLO-FIELD_N IS INITIAL AND
                  W_/ZAK/BEVALLO-FIELD_NRK IS INITIAL.
                 W_/ZAK/BEVALLO-NULL_FLAG = 'X'.
               ENDIF.
*--BG 2009.05.18
               MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
             ENDIF.
           ENDIF.
         ENDIF.
       ENDIF.
*++ BG 2009.06.17
*      If there is a value, 203 must be corrected.
       IF NOT L_SUM_SAVE IS INITIAL.
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
         WITH KEY ABEVAZ = C_ABEVAZ_203.
         V_TABIX = SY-TABIX .
         IF SY-SUBRC EQ 0.
           ADD L_SUM_SAVE TO W_/ZAK/BEVALLO-FIELD_N.
           READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                WITH KEY ABEVAZ = C_ABEVAZ_203.
           IF SY-SUBRC EQ 0.
             PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                         W_/ZAK/BEVALLB-ROUND
                         W_/ZAK/BEVALLO-WAERS
                CHANGING W_/ZAK/BEVALLO-FIELD_NR
                         W_/ZAK/BEVALLO-FIELD_NRK.
             MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
           ENDIF.
         ENDIF.
       ENDIF.
*-- BG 2009.06.17
     ENDIF.
   ENDIF.

*++ BG 2009.06.17
*  0 flag field management
* If field1 is not 0 or field2 is not 0 or field3 is not 0 or field4 is not 0
* or field 5 not 0 then 0 flag setting
   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_205
                              "0-flag beállítás
                                     C_ABEVAZ_203           "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6
*-- BG 2009.06.17

 ENDFORM.                    " CALC_ABEV_AFA_0965
*&---------------------------------------------------------------------*
*&      Form  del_esdat_field_0908
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_C_ABEVAZ_A0AC033A  text
*----------------------------------------------------------------------*
 FORM DEL_ESDAT_FIELD_0908 TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLALV
                                    $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                           USING    $ABEVAZ_JELLEG.

   DATA LW_/ZAK/BEVALLALV TYPE /ZAK/BEVALLALV.

*  We define the character:
   READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                         WITH KEY ABEVAZ = $ABEVAZ_JELLEG
                         BINARY SEARCH.
*  In this case, you do not need to fill in the due date:
   IF SY-SUBRC EQ 0 AND LW_/ZAK/BEVALLALV-FIELD_C = 'H'.
*  ABEV ID value marked in ESDAT_FLAG
     READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                         WITH KEY  ESDAT_FLAG = 'X'.
     IF SY-SUBRC EQ 0.
       READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                           WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
                           BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         V_TABIX = SY-TABIX .
         CLEAR LW_/ZAK/BEVALLALV-FIELD_C.
         MODIFY $T_BEVALLO FROM LW_/ZAK/BEVALLALV
                               INDEX V_TABIX TRANSPORTING FIELD_C.
       ENDIF.
     ENDIF.
   ENDIF.

 ENDFORM.                    " del_esdat_field_0908
*&---------------------------------------------------------------------*
*&      Form  DEL_ESDAT_FIELD_0808
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_I_/ZAK/BEVALLB  text
*      -->P_C_ABEVAZ_A0AC035A  text
*----------------------------------------------------------------------*
 FORM DEL_ESDAT_FIELD_0808  TABLES   $T_BEVALLO STRUCTURE
 /ZAK/BEVALLALV
                                     $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                            USING    $ABEVAZ.


   DATA LW_/ZAK/BEVALLALV TYPE /ZAK/BEVALLALV.

*  We define the character:
   READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                         WITH KEY ABEVAZ = $ABEVAZ
                         BINARY SEARCH.
*  In this case, you do not need to fill in the due date:
   IF SY-SUBRC EQ 0 AND LW_/ZAK/BEVALLALV-FIELD_C IS INITIAL.
*  ABEV ID value marked in ESDAT_FLAG
     READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                         WITH KEY  ESDAT_FLAG = 'X'.
     IF SY-SUBRC EQ 0.
       READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                           WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
                           BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         V_TABIX = SY-TABIX .
         CLEAR LW_/ZAK/BEVALLALV-FIELD_C.
         MODIFY $T_BEVALLO FROM LW_/ZAK/BEVALLALV
                               INDEX V_TABIX TRANSPORTING FIELD_C.
       ENDIF.
     ENDIF.
   ENDIF.

 ENDFORM.                    " DEL_ESDAT_FIELD_0808
*&---------------------------------------------------------------------*
*&      Form  GET_NULL_FLAG_EQM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_ADOAZON_ALL  text
*      -->P_C_ABEVAZ_M0FD0496AA  text
*      -->P_C_ABEVAZ_M0FD0495AA  text
*      -->P_C_ABEVAZ_M0FD0498BA  text
*      -->P_C_ABEVAZ_M0FD0497BA  text
*----------------------------------------------------------------------*
 FORM GET_NULL_FLAG_EQM  TABLES   $T_BEVALLO     STRUCTURE /ZAK/BEVALLO
                                     $T_ADOAZON_ALL STRUCTURE
                                     /ZAK/ADOAZONLPSZ
                            USING    $ABEV_1
                                     $ABEV_2
                                     $ABEV_3
                                     $ABEV_4.

   DATA L_TRUE.
   DATA L_TABIX LIKE SY-TABIX.
   DATA LW_BEVALLO1 LIKE /ZAK/BEVALLO.
   DATA LW_BEVALLO2 LIKE /ZAK/BEVALLO.

   DEFINE LM_GET_EQ.
     IF NOT &1 IS INITIAL AND
        NOT &2 IS INITIAL.
       READ TABLE $T_BEVALLO INTO LW_BEVALLO1
                             WITH KEY ABEVAZ  = &1
                                      ADOAZON = &3
                                      LAPSZ   = &4
                                      BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         READ TABLE $T_BEVALLO INTO LW_BEVALLO2
                               WITH KEY ABEVAZ  = &2
                                        ADOAZON = &3
                                        LAPSZ   = &4
                                        BINARY SEARCH.
         IF SY-SUBRC EQ 0 AND V_ONREV IS INITIAL.
           IF LW_BEVALLO1-FIELD_N EQ LW_BEVALLO2-FIELD_N.
             MOVE C_X TO L_TRUE.
           ENDIF.
         ELSEIF SY-SUBRC EQ 0 AND NOT V_ONREV IS INITIAL.
           IF NOT LW_BEVALLO1-FIELD_ON EQ LW_BEVALLO2-FIELD_ON.
             MOVE C_X TO L_TRUE.
           ENDIF.
         ENDIF.
       ENDIF.
     ENDIF.
   END-OF-DEFINITION.

   DEFINE LM_GET_0_FLAG.
     READ TABLE $T_BEVALLO WITH KEY ABEVAZ  = &1
                                    ADOAZON = &2
                                    LAPSZ   = &3
                                    BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_TABIX.
       MOVE C_X TO $T_BEVALLO-NULL_FLAG.
       MODIFY $T_BEVALLO INDEX L_TABIX TRANSPORTING NULL_FLAG.
     ENDIF.
   END-OF-DEFINITION.

   LOOP AT $T_ADOAZON_ALL.
     CLEAR L_TRUE.
     LM_GET_EQ $ABEV_1 $ABEV_2 $T_ADOAZON_ALL-ADOAZON
     $T_ADOAZON_ALL-LAPSZ.
     IF NOT L_TRUE IS INITIAL.
       LM_GET_0_FLAG: $ABEV_3 $T_ADOAZON_ALL-ADOAZON
       $T_ADOAZON_ALL-LAPSZ,
                      $ABEV_4 $T_ADOAZON_ALL-ADOAZON
                      $T_ADOAZON_ALL-LAPSZ.
     ENDIF.
   ENDLOOP.


 ENDFORM.                    " GET_NULL_FLAG_EQM
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_M_SZJA_1008
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_M_SZJA_1008 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                   T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                   T_ADOAZON_ALL STRUCTURE
                                                 /ZAK/ADOAZONLPSZ
                           USING   $INDEX
                                   $LAST_DATE.

   SORT T_BEVALLB BY ABEVAZ.
   SORT T_BEVALLO BY ABEVAZ ADOAZON LAPSZ.


*  Special M calculations as a tax ID
*  field0 = ( field1 - field2 ) * field3
*  M0CC0406DA
   PERFORM GET_SUB_MULT_M  TABLES T_BEVALLO
                                  T_BEVALLB
                                  T_ADOAZON_ALL
                           USING  C_ABEVAZ_M0CC0406DA       "mező0
                                  C_ABEVAZ_M0CC0405DA       "mező1
                                  C_ABEVAZ_M0BC0391DA       "mező2
                                  '0.27'.                   "mező3
*  M0CC0407DA
   PERFORM GET_SUM_M   TABLES T_BEVALLO
                              T_BEVALLB
                              T_ADOAZON_ALL
                       USING  C_ABEVAZ_M0CC0407DA           "mező0
                              C_ABEVAZ_M0CC0405DA           "mező1
                              C_ABEVAZ_M0CC0406DA           "mező2
                              SPACE                         "mező3
                              SPACE                         "mező4
                              SPACE                         "mező5
                              SPACE.                        "mező6


*  M0CC0408DA
*  field0 = field1+field2+.....field6.
   PERFORM GET_SUM_M   TABLES T_BEVALLO
                              T_BEVALLB
                              T_ADOAZON_ALL
                       USING  C_ABEVAZ_M0CC0408DA           "mező0
                              C_ABEVAZ_M0BC0361DA           "mező1
                              C_ABEVAZ_M0BC0362DA           "mező2
                              C_ABEVAZ_M0BC0363DA           "mező3
                              C_ABEVAZ_M0BC0364DA           "mező4
                              C_ABEVAZ_M0CC0403AA           "mező5
                              C_ABEVAZ_M0CC0404AA.          "mező6

*  M0CC0409DA
*  field0 = field1+field2+.....field6.
*   PERFORM GET_SUM_M   TABLES T_BEVALLO
*                              T_BEVALLB
*                              T_ADOAZON_ALL
*                       USING C_ABEVAZ_M0CC0409DA "field0
*                              C_ABEVAZ_M0CC0406DA "field1
*                              C_ABEVAZ_M0CC0408DA "field2
*                              SPACE "field3
*                              SPACE "field4
*                              SPACE "field5
*                              SPACE.                        "field 6

   PERFORM GET_SUB_MULT_M  TABLES T_BEVALLO
                                  T_BEVALLB
                                  T_ADOAZON_ALL
                           USING  C_ABEVAZ_M0CC0409DA       "mező0
                                  C_ABEVAZ_M0CC0408DA       "mező1
                                  SPACE                     "mező2
                                  '1.27'.                   "mező3

*  Modification of the self-check obligation basis
*  A0ZZ000001
   PERFORM GET_SUM_CALC  TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ZZ000001   "Módosított mező
                                C_ABEVAZ_M0CE0425BA         "Forrás 1
                                C_ABEVAZ_M0CE0426BA         "Forrás 2
                                C_ABEVAZ_M0CE0427BA         "Forrás 3
                                C_ABEVAZ_M0CE0428BA         "Forrás 4
                                C_ABEVAZ_M0CE0429BA         "Forrás 5
                                C_ABEVAZ_M0CE0430CA         "Forrás 6
                                C_ABEVAZ_M0CC0405DA         "Forrás 7
                                C_ABEVAZ_M0CC0406DA         "Forrás 8
                                SPACE                       "Forrás 9
                                SPACE.                      "Forrás 10
* A0ZZ000002
   PERFORM GET_SUM_CALC  TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ZZ000002   "Módosított mező
                                C_ABEVAZ_M0EC0466CA         "Forrás 1
                                C_ABEVAZ_M0EC0468CA         "Forrás 2
                                SPACE                       "Forrás 3
                                SPACE                       "Forrás 4
                                SPACE                       "Forrás 5
                                SPACE                       "Forrás 6
                                SPACE                       "Forrás 7
                                SPACE                       "Forrás 8
                                SPACE                       "Forrás 9
                                SPACE.                      "Forrás 10


 ENDFORM.                    " CALC_ABEV_M_SZJA_1008
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_SZJA_SPECIAL_1008
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*      -->P_0408   text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SZJA_SPECIAL_1008
                                 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                          T_BEVALLB STRUCTURE
                                          /ZAK/BEVALLB
                                          T_ADOAZON STRUCTURE
                                          /ZAK/ONR_ADOAZON
                                   USING  $INDEX
                                          $DATE.


   DATA LR_COND TYPE RANGE_C2 OCCURS 0 WITH HEADER LINE.
   DATA L_TMP_BEVALLO TYPE /ZAK/BEVALLO.
   DATA L_BEVALLO TYPE /ZAK/BEVALLO.

   FIELD-SYMBOLS: <FIELD_N>, <FIELD_NR>, <FIELD_NRK>.

   DEFINE LM_GET_FIELD.
     IF &1 EQ '000'.
       ASSIGN W_/ZAK/BEVALLO-FIELD_N   TO <FIELD_N>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_NR  TO <FIELD_NR>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_NRK TO <FIELD_NRK>.
     ELSE.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ON   TO <FIELD_N>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ONR  TO <FIELD_NR>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ONRK TO <FIELD_NRK>.
     ENDIF.
     CLEAR: <FIELD_N>, <FIELD_NR>, <FIELD_NRK>.
   END-OF-DEFINITION.

   DEFINE LM_GET_SPEC_SUM1.
     LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ = &1.
*      The ABEV for the condition must be determined
*      ID value
       READ TABLE T_BEVALLO INTO L_TMP_BEVALLO
                WITH KEY ABEVAZ  = &2
                         ADOAZON = L_BEVALLO-ADOAZON
                          LAPSZ  = L_BEVALLO-LAPSZ
                          BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         CONDENSE L_TMP_BEVALLO-FIELD_C.
         IF L_TMP_BEVALLO-FIELD_C IN &3.
           ADD L_BEVALLO-FIELD_N TO <FIELD_N>.
         ENDIF.
       ENDIF.
     ENDLOOP.
   END-OF-DEFINITION.

   RANGES LR_ABEVAZ     FOR /ZAK/BEVALLO-ABEVAZ.
   RANGES LR_SEL_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.


   DEFINE LM_GET_SPEC_SUM2.
     IF NOT &1[] IS INITIAL.
       LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ IN &1.
         IF $INDEX EQ '000'.
           ADD L_BEVALLO-FIELD_N TO <FIELD_N>.
         ELSE.
           ADD L_BEVALLO-FIELD_ON TO <FIELD_N>.
         ENDIF.
       ENDLOOP.
     ENDIF.
   END-OF-DEFINITION.

   SORT T_BEVALLB BY ABEVAZ.

*  Uploading selective ABEVAZ
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0040CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0041CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0042CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0043CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0044CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0045CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0046CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0047CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0048CA SPACE.

   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0055CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0056CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0057CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0058CA SPACE.

   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0073CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0074CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0075CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0076CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0077CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0078CA SPACE.

   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0086CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0087CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0088CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0089CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0090CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0091CA SPACE.

* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_SEL_ABEVAZ.

     CLEAR W_/ZAK/BEVALLO.

*    this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
              BINARY SEARCH.

     CHECK SY-SUBRC EQ 0.

     V_TABIX = SY-TABIX .

*    Special calculations
     CASE W_/ZAK/BEVALLB-ABEVAZ.
*      A 02-40-c The total burden of the employee's pension commission (Lines 559 "c"...
       WHEN  C_ABEVAZ_A0CC0040CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         M_DEF LR_COND 'E' 'EQ' '94' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0559CA' 'M0HC004A' LR_COND.
*      The 02-41-c The employee is unemployed, the employment circle pays pension...
       WHEN  C_ABEVAZ_A0CC0041CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0630CA' 'M0HC004A' LR_COND.
*      A 02-40-c The nursing care fee for the employee pension commission (Lines 630...
       WHEN  C_ABEVAZ_A0CC0042CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '94' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0551CA' 'M0HC004A' LR_COND.
*      A 02-43-c Private pension (The 568,631 lines "c" ....
       WHEN  C_ABEVAZ_A0CC0043CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         M_DEF LR_COND 'E' 'EQ' '83' SPACE.
         M_DEF LR_COND 'E' 'EQ' '92' SPACE.
         M_DEF LR_COND 'E' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0568CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0JF0631CA' 'M0JC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0JE0607CA' 'M0JC004A' LR_COND.
*      A 02-44-c The private sector unemployment, employment pension .....
       WHEN  C_ABEVAZ_A0CC0044CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0558CA' 'M0HC006A' LR_COND.
*      A 02-45-c The private sector pays pension after GYED, S, T (...
       WHEN  C_ABEVAZ_A0CC0045CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '83' SPACE.
         M_DEF LR_COND 'I' 'EQ' '92' SPACE.
         M_DEF LR_COND 'I' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0JE0607CA' 'M0JC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0JF0631CA' 'M0JC004A' LR_COND.
*      A 02-46-c Mnypt member private pension (.......)
       WHEN  C_ABEVAZ_A0CC0046CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         M_DEF LR_COND 'E' 'EQ' '83' SPACE.
         M_DEF LR_COND 'E' 'EQ' '92' SPACE.
         M_DEF LR_COND 'E' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0569CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0JE0608CA' 'M0JC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0JF0632CA' 'M0JC004A' LR_COND.
*      A 02-47-c Mnypt member private tax unemployed,.....
       WHEN  C_ABEVAZ_A0CC0047CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0JF0632CA' 'M0JC004A' LR_COND.
*      The 02-48-cA Mnypt member pays private tax GYED,S,T pension (....
       WHEN  C_ABEVAZ_A0CC0048CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '83' SPACE.
         M_DEF LR_COND 'I' 'EQ' '92' SPACE.
         M_DEF LR_COND 'I' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0JE0608CA' 'M0JC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0JF0632CA' 'M0JC004A' LR_COND.
*      A 03-55-c A fogl terh term egbizt (552,553. sorok "c" .....
       WHEN  C_ABEVAZ_A0DC0055CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0552CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0HD0553CA' 'M0HC004A' LR_COND.
*      The 03-56-c The employee burden unemployment insurance pays production insurance (....
       WHEN  C_ABEVAZ_A0DC0056CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0JF0623CA' 'M0JC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0JF0624CA' 'M0JC004A' LR_COND.
*      The 03-57-c The account is charged with money insurance (lines 554, "c" is NOT...
       WHEN  C_ABEVAZ_A0DC0057CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0554CA' 'M0HC004A' LR_COND.
*      The 03-58-c The employee's unemployment insurance financial insurance (....
       WHEN  C_ABEVAZ_A0DC0058CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0JF0625CA' 'M0JC004A' LR_COND.
*      A 03-73 -c A vol. burdensome insurance and labor market costs. production
       WHEN  C_ABEVAZ_A0DC0073CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0556CA' 'M0HC004A' LR_COND.
*      A 03-74-c The unemployment insurance and labor market.
       WHEN  C_ABEVAZ_A0DC0074CA.
*        Upload condition
         REFRESH LR_COND.
*++2011.01.28 BG
*         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
*         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
*         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
*--2011.01.28 BG
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0JF0627CA' 'M0JC004A' LR_COND.
*     A 03-75 -c A vol. burdensome insurance and labor market costs. monetary
       WHEN  C_ABEVAZ_A0DC0075CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0557CA' 'M0HC004A' LR_COND.
*     A 03-76-c The unemployment insurance and labor market rate unemployed
       WHEN  C_ABEVAZ_A0DC0076CA.
*        Upload condition
         REFRESH LR_COND.
*++2011.01.28 BG
*         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
*         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
*         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
*--2011.01.28 BG
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0JF0628CA' 'M0JC004A' LR_COND.
*      A 03-77 -c A vol. burdensome insurance and labor market costs.
       WHEN  C_ABEVAZ_A0DC0077CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0558CA' 'M0HC004A' LR_COND.
*      A 03-78-c The unemployment insurance and labor market rate unemployed
       WHEN  C_ABEVAZ_A0DC0078CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0JF0629CA' 'M0JC004A' LR_COND.
*     A 04-86-c With the START card, order 10%/15% (code 1: A 694,...
       WHEN  C_ABEVAZ_A0EC0086CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '1' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0LD0692CA' 'M0LC007A' LR_COND.
         LM_GET_SPEC_SUM1 'M0LD0694CA' 'M0LC007A' LR_COND.
*     A 04-87-c Order 20%/25% with the START card (code 1: A 695,693.
       WHEN  C_ABEVAZ_A0EC0087CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '1' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0LD0695CA' 'M0LC007A' LR_COND.
         LM_GET_SPEC_SUM1 'M0LD0693CA' 'M0LC007A' LR_COND.
*      A 04-88-c A START PLUS order 10%/15% (code 2: A 654.692
       WHEN  C_ABEVAZ_A0EC0088CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '2' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0LD0692CA' 'M0LC007A' LR_COND.
         LM_GET_SPEC_SUM1 'M0LD0694CA' 'M0LC007A' LR_COND.
*      A 04-89-c A START PLUS plan 20%/255% (code 2: A 654.692
       WHEN  C_ABEVAZ_A0EC0089CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '2' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0LD0695CA' 'M0LC007A' LR_COND.
         LM_GET_SPEC_SUM1 'M0LD0693CA' 'M0LC007A' LR_COND.
*      With the 04-90-c A START EXTRA card, order 0% (code 3.4: A 691.
       WHEN  C_ABEVAZ_A0EC0090CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'BT' '3' '4'.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0LD0691CA' 'M0LC007A' LR_COND.
*      A 04-91-c A 10%/15% order with the START EXTRA card (code 3: A 692
       WHEN  C_ABEVAZ_A0EC0091CA.
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '3' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0LD0692CA' 'M0LC007A' LR_COND.
         LM_GET_SPEC_SUM1 'M0LD0694CA' 'M0LC007A' LR_COND.

     ENDCASE.

     PERFORM CALC_FIELD_NRK USING <FIELD_N>
                  W_/ZAK/BEVALLB-ROUND
                  W_/ZAK/BEVALLO-WAERS
         CHANGING <FIELD_NR>
                  <FIELD_NRK>.
     IF $INDEX NE '000'.
       MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
     ENDIF.
     MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.


   ENDLOOP.


 ENDFORM.                    " CALC_ABEV_SZJA_SPECIAL_1008
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_ONREV_SZJA_1008
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*      -->P_$INDEX  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONREV_SZJA_1008                             TABLES
 T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                    T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                  T_ADOAZON STRUCTURE /ZAK/ONR_ADOAZON
                            USING   $INDEX
                                    $LAST_DATE.


   DATA LI_LAST_BEVALLO LIKE /ZAK/BEVALLO OCCURS 0 WITH HEADER LINE.

   DATA L_LAST_INDEX LIKE /ZAK/BEVALLO-ZINDEX.
   DATA L_TABIX LIKE SY-TABIX.
   DATA L_TRUE.

   RANGES LR_ONREV_ABEVAZ FOR /ZAK/BEVALLB-ABEVAZ.
   DATA   L_ABEVAZ LIKE /ZAK/BEVALLB-ABEVAZ.

   DATA: L_KAM_KEZD TYPE DATUM,
         L_KAM_VEG  TYPE DATUM.
   DATA   L_KAMAT LIKE /ZAK/BEVALLO-FIELD_N.
   DATA   L_KAMAT_SUM LIKE /ZAK/BEVALLO-FIELD_N.

*  To upload fields to be summarized
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.

*  If self-revision
   CHECK $INDEX NE '000'.

   SORT T_BEVALLB BY ABEVAZ.

*  Let's read the 'A' abev identifiers of the previous period
   READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO INDEX 1.
   CHECK SY-SUBRC EQ 0.
   L_LAST_INDEX = $INDEX - 1.

   CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
     EXPORTING
       INPUT  = L_LAST_INDEX
     IMPORTING
       OUTPUT = L_LAST_INDEX.


   SELECT * INTO TABLE LI_LAST_BEVALLO
                 FROM  /ZAK/BEVALLO
                WHERE  BUKRS   EQ W_/ZAK/BEVALLO-BUKRS
                  AND  BTYPE   EQ W_/ZAK/BEVALLO-BTYPE
                  AND  GJAHR   EQ W_/ZAK/BEVALLO-GJAHR
                  AND  MONAT   EQ W_/ZAK/BEVALLO-MONAT
                  AND  ZINDEX  EQ L_LAST_INDEX
                  AND  ADOAZON EQ ''.

   SORT LI_LAST_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ.

*  We delete records that are not in the given period
*  adtak fel.
   LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                     WHERE NOT ADOAZON IS INITIAL.
     READ TABLE T_ADOAZON WITH KEY ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                                   BINARY SEARCH.
*    Nem kell a rekord.
     IF SY-SUBRC NE 0.
       DELETE T_BEVALLO.
       CONTINUE.
     ENDIF.
*  M 11 Mark with an X if your declaration is considered a correction
     IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_M0AE003A.
       MOVE 'H' TO W_/ZAK/BEVALLO-FIELD_C.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO TRANSPORTING FIELD_C.
     ENDIF.
   ENDLOOP.

**  Számítási algoritmus ÖNREVÍZIÓHOZ:
**A0GC0200DA
*   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
*                                 LI_LAST_BEVALLO
*                                 T_BEVALLB
*                          USING C_ABEVAZ_A0GC0200DA "Modified field
*                                 C_ABEVAZ_A0BC0001CA "Source 1
*                                 SPACE "Source 2
*                                 SPACE "Source 3
*                                 SPACE "Source 4
*                                 SPACE.                     "Source 5
**A0GC0202CA
*   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
*                                T_BEVALLB
*                         USING C_ABEVAZ_A0GC0202CA "Modified field
*                                C_ABEVAZ_A0GC0202DA
*                                '0.04'.


*A0GC0146DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0146DA   "Módosított mező
                                 C_ABEVAZ_A0BC0001CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0147CA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0147CA   "Módosított mező
                                 C_ABEVAZ_A0ZZ000001        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0147DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0147DA   "Módosított mező
                                 C_ABEVAZ_A0CC0035CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0148DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0148DA   "Módosított mező
                                 C_ABEVAZ_A0CC0038CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0148CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0148CA   "Módosított mező
                                C_ABEVAZ_A0GC0148DA
                                '0.04'.

*A0GC0150DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0150DA   "Módosított mező
                                 C_ABEVAZ_A0BC0016CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0150CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0150CA   "Módosított mező
                                C_ABEVAZ_A0GC0150DA
                                '0.24'.

*A0GC0151DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0151DA   "Módosított mező
                                 C_ABEVAZ_A0CC0040CA        "Forrás 1
                                 C_ABEVAZ_A0CC0041CA        "Forrás 2
                                 C_ABEVAZ_A0CC0042CA        "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0151CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0151CA   "Módosított mező
                                C_ABEVAZ_A0GC0151DA
                                '0.24'.
*++2011.04.09 BG
* From here on, HR handles it, we don't give up on it
**A0GC0152DA
*   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
*                                 LI_LAST_BEVALLO
*                                 T_BEVALLB
*                          USING C_ABEVAZ_A0GC0152DA "Modified field
*                                 C_ABEVAZ_A0CC0043CA "Source 1
*                                 C_ABEVAZ_A0CC0044CA "Source 2
*                                 C_ABEVAZ_A0CC0045CA "Source 3
*                                 SPACE "Source 4
*                                 SPACE.                     "Source 5
*
**A0GC0152CA
*   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
*                                T_BEVALLB
*                         USING C_ABEVAZ_A0GC0152CA "Modified field
*                                C_ABEVAZ_A0GC0152DA
*                                '0.095'.
*
**A0GC0153DA
*   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
*                                 LI_LAST_BEVALLO
*                                 T_BEVALLB
*                          USING C_ABEVAZ_A0GC0153DA "Modified field
*                                 C_ABEVAZ_A0CC0046CA "Source 1
*                                 C_ABEVAZ_A0CC0047CA "Source 2
*                                 C_ABEVAZ_A0CC0048CA "Source 3
*                                 SPACE "Source 4
*                                 SPACE.                     "Source 5
*
**A0GC0153CA
*   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
*                                T_BEVALLB
*                         USING C_ABEVAZ_A0GC0153CA "Modified field
*                                C_ABEVAZ_A0GC0153DA
*                                '0.015'.
*--2011.04.09 BG

*A0GC0154DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0154DA   "Módosított mező
                                 C_ABEVAZ_A0CC0049CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0154CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0154CA   "Módosított mező
                                C_ABEVAZ_A0GC0154DA
                                '0.15'.
*A0GC0155DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0155DA   "Módosított mező
                                 C_ABEVAZ_A0CC0050CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0156DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0156DA   "Módosított mező
                                 C_ABEVAZ_A0CC0052CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0156CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0156CA   "Módosított mező
                                C_ABEVAZ_A0GC0156DA
                                '0.0975'.
*A0GC0158DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0158DA   "Módosított mező
                                 C_ABEVAZ_A0BC0023CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0159DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0159DA   "Módosított mező
                                 C_ABEVAZ_A0BC0022CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0160DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0160DA   "Módosított mező
                                 C_ABEVAZ_A0BC0024CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0163DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0163DA   "Módosított mező
                                 C_ABEVAZ_A0DC0057CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0163CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0163CA   "Módosított mező
                                C_ABEVAZ_A0GC0163DA
                                '0.005'.

*A0GC0164DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0164DA   "Módosított mező
                                 C_ABEVAZ_A0DC0059CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0164CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0164CA   "Módosított mező
                                C_ABEVAZ_A0GC0164DA
                                '0.04'.

*A0GC0165DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0165DA   "Módosított mező
                                 C_ABEVAZ_A0DC0060CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0165CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0165CA   "Módosított mező
                                C_ABEVAZ_A0GC0165DA
                                '0.02'.
*A0GC0166DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0166DA   "Módosított mező
                                 C_ABEVAZ_A0DC0061CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0167DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0167DA   "Módosított mező
                                 C_ABEVAZ_A0DC0062CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0168DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0168DA   "Módosított mező
                                 C_ABEVAZ_A0BC0014CA        "Forrás 1
                                 C_ABEVAZ_A0BC0015CA        "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

**A0ZZ000003
*   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
*                                T_BEVALLB
*                         USING C_ABEVAZ_A0ZZ000003 "Modified field
*                                C_ABEVAZ_A0ZZ000002
*                                '0.14'.
**A0ZZ000005
*   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
*                                T_BEVALLB
*                         USING C_ABEVAZ_A0ZZ000005 "Modified field
*                                C_ABEVAZ_A0ZZ000004
*                                '0.27'.

*A0GC0169CA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0169CA   "Módosított mező
                                 C_ABEVAZ_A0ZZ000002        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0169DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0169DA   "Módosított mező
*++2010.04.09 BG
*                                 C_ABEVAZ_A0BC0014CA "Source 1
*                                 C_ABEVAZ_A0BC0015CA "Source 2
*++2010.04.09 BG
                                 C_ABEVAZ_A0DC0064CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0171DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0171DA   "Módosított mező
                                 C_ABEVAZ_A0DC0065CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GC0172DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0172DA   "Módosított mező
                                 C_ABEVAZ_A0DC0066CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GC0173DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GC0173DA   "Módosított mező
                                 C_ABEVAZ_A0DC0067CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0175DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0175DA   "Módosított mező
                                 C_ABEVAZ_A0BC0018CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0176DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0176DA   "Módosított mező
                                 C_ABEVAZ_A0BC0019CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0177DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0177DA   "Módosított mező
                                 C_ABEVAZ_A0BC0020CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0178DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0178DA   "Módosított mező
                                 C_ABEVAZ_A0DC0073CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0178CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0178CA   "Módosított mező
                                C_ABEVAZ_A0HC0178DA
                                '0.015'.
*A0HC0179DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0179DA   "Módosított mező
                                 C_ABEVAZ_A0DC0075CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0179CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0179CA   "Módosított mező
                                C_ABEVAZ_A0HC0179DA
                                '0.005'.
*A0HC0180DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0180DA   "Módosított mező
                                 C_ABEVAZ_A0DC0077CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0180CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0180CA   "Módosított mező
                                C_ABEVAZ_A0HC0180DA
                                '0.01'.
*A0HC0181DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0181DA   "Módosított mező
                                 C_ABEVAZ_A0DC0079CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0181CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0181CA   "Módosított mező
                                C_ABEVAZ_A0HC0181DA
                                '0.04'.
*A0HC0182DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0182DA   "Módosított mező
                                 C_ABEVAZ_A0DC0080CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0182CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0182CA   "Módosított mező
                                C_ABEVAZ_A0HC0182DA
                                '0.02'.
*A0HC0183DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0183DA   "Módosított mező
                                 C_ABEVAZ_A0DC0081CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0183CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0183CA   "Módosított mező
                                C_ABEVAZ_A0HC0183DA
                                '0.015'.
*A0HC0184DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0184DA   "Módosított mező
                                 C_ABEVAZ_A0DC0082CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0186DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0186DA   "Módosított mező
                                 C_ABEVAZ_A0EC0086CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0186CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0186CA   "Módosított mező
                                C_ABEVAZ_A0HC0186DA
                                '0.10'.
*A0HC0187DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0187DA   "Módosított mező
                                 C_ABEVAZ_A0EC0087CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0187CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0187CA   "Módosított mező
                                C_ABEVAZ_A0HC0187DA
                                '0.20'.
*A0HC0188DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0188DA   "Módosított mező
                                 C_ABEVAZ_A0EC0088CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0188CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0188CA   "Módosított mező
                                C_ABEVAZ_A0HC0188DA
                                '0.10'.
*A0HC0189DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0189DA   "Módosított mező
                                 C_ABEVAZ_A0EC0089CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0189CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0189CA   "Módosított mező
                                C_ABEVAZ_A0HC0189DA
                                '0.20'.

*A0HC0190DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0190DA   "Módosított mező
                                 C_ABEVAZ_A0EC0091CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0190CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0190CA   "Módosított mező
                                C_ABEVAZ_A0HC0190DA
                                '0.10'.
*A0HC0191DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0191DA   "Módosított mező
                                 C_ABEVAZ_A0EC0093CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0191CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0191CA   "Módosított mező
                                C_ABEVAZ_A0HC0191DA
                                '0.095'.
*A0HC0192DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0192DA   "Módosított mező
                                 C_ABEVAZ_A0EC0094CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0192CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0192CA   "Módosított mező
                                C_ABEVAZ_A0HC0192DA
                                '0.20'.

*A0HC0193AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0193AA   "Módosított mező
                                 C_ABEVAZ_A0EC0095CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0194AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0194AA   "Módosított mező
                                 C_ABEVAZ_A0EC0096CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0195DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0195DA   "Módosított mező
                                 C_ABEVAZ_A0EC0097CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0195CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0195CA   "Módosított mező
                                C_ABEVAZ_A0HC0195DA
                                '0.111'.

*A0HC0196DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0196DA   "Módosított mező
                                 C_ABEVAZ_A0EC0098CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0196CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0196CA   "Módosított mező
                                C_ABEVAZ_A0HC0196DA
                                '0.15'.

*A0HC0197AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0197AA   "Módosított mező
                                 C_ABEVAZ_A0EC0099CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0198AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0198AA   "Módosított mező
                                 C_ABEVAZ_A0EC0100CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0199DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0199DA   "Módosított mező
                                 C_ABEVAZ_A0EC0101CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0199CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0199CA   "Módosított mező
                                C_ABEVAZ_A0HC0199DA
                                '0.15'.
*A0HC0200AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0200AA   "Módosított mező
                                 C_ABEVAZ_A0EC0102CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0HC0201AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0201AA   "Módosított mező
                                 C_ABEVAZ_A0EC0103CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0202DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0202DA   "Módosított mező
                                 C_ABEVAZ_A0BC0027CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0203DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0203DA   "Módosított mező
                                 C_ABEVAZ_A0BC0026CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5


**ÖSSZESÍTÉSEK
*A0GC0145CA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0147CA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0145CA.

*A0GC0145DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0146DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0147DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0145DA.



*A0GC0149DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0150DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0151DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0152DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0153DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0154DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0155DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0149DA.

*A0GC0157DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0158DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0159DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0160DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0161DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0162DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0163DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0164DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0165DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0166DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0167DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0157DA.
*A0GC0170DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0171DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0172DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC0173DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GC0170DA.

*A0HC0174DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0175DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0176DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0177DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0178DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0179DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0180DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0181DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0182DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0183DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0184DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0174DA.

*A0HC0185DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0186DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0187DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0188DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0189DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0190DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0185DA.



 ENDFORM.                    " CALC_ABEV_ONREV_SZJA_1008
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_ONREV_SZJA_1108
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*      -->P_$INDEX  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONREV_SZJA_1108 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                       T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                       T_ADOAZON STRUCTURE
                                                 /ZAK/ONR_ADOAZON
                            USING   $INDEX
                                    $LAST_DATE.

   DATA LI_LAST_BEVALLO LIKE /ZAK/BEVALLO OCCURS 0 WITH HEADER LINE.

   DATA L_LAST_INDEX LIKE /ZAK/BEVALLO-ZINDEX.
   DATA L_TABIX LIKE SY-TABIX.
   DATA L_TRUE.

   RANGES LR_ONREV_ABEVAZ FOR /ZAK/BEVALLB-ABEVAZ.
   DATA   L_ABEVAZ LIKE /ZAK/BEVALLB-ABEVAZ.

   DATA: L_KAM_KEZD TYPE DATUM,
         L_KAM_VEG  TYPE DATUM.
   DATA   L_KAMAT LIKE /ZAK/BEVALLO-FIELD_N.
   DATA   L_KAMAT_SUM LIKE /ZAK/BEVALLO-FIELD_N.

*  To upload fields to be summarized
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.

*  If self-revision
   CHECK $INDEX NE '000'.

   SORT T_BEVALLB BY ABEVAZ.

*  Let's read the 'A' abev identifiers of the previous period
   READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO INDEX 1.
   CHECK SY-SUBRC EQ 0.
   L_LAST_INDEX = $INDEX - 1.

   CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
     EXPORTING
       INPUT  = L_LAST_INDEX
     IMPORTING
       OUTPUT = L_LAST_INDEX.


   SELECT * INTO TABLE LI_LAST_BEVALLO
                 FROM  /ZAK/BEVALLO
                WHERE  BUKRS   EQ W_/ZAK/BEVALLO-BUKRS
                  AND  BTYPE   EQ W_/ZAK/BEVALLO-BTYPE
                  AND  GJAHR   EQ W_/ZAK/BEVALLO-GJAHR
                  AND  MONAT   EQ W_/ZAK/BEVALLO-MONAT
                  AND  ZINDEX  EQ L_LAST_INDEX
                  AND  ADOAZON EQ ''.

   SORT LI_LAST_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ.

*  We delete records that are not in the given period
*  adtak fel.
   LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                     WHERE NOT ADOAZON IS INITIAL.
     READ TABLE T_ADOAZON WITH KEY ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                                   BINARY SEARCH.
*    Nem kell a rekord.
     IF SY-SUBRC NE 0.
       DELETE T_BEVALLO.
       CONTINUE.
     ENDIF.
*  M 11 Mark with an X if your declaration is considered a correction
     IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_M0AE003A.
       MOVE 'H' TO W_/ZAK/BEVALLO-FIELD_C.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO TRANSPORTING FIELD_C.
     ENDIF.
   ENDLOOP.

**  Számítási algoritmus ÖNREVÍZIÓHOZ:
**A0GC0200DA
*   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
*                                 LI_LAST_BEVALLO
*                                 T_BEVALLB
*                          USING C_ABEVAZ_A0GC0200DA "Modified field
*                                 C_ABEVAZ_A0BC0001CA "Source 1
*                                 SPACE "Source 2
*                                 SPACE "Source 3
*                                 SPACE "Source 4
*                                 SPACE.                     "Source 5
**A0GC0202CA
*   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
*                                T_BEVALLB
*                         USING C_ABEVAZ_A0GC0202CA "Modified field
*                                C_ABEVAZ_A0GC0202DA
*                                '0.04'.

* A0GD0151DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0151DA   "Módosított mező
                                 C_ABEVAZ_A0BC0001CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0GD0152CA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0152CA   "Módosított mező
                                 C_ABEVAZ_A0ZZ000001        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0GD0152DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0152DA   "Módosított mező
                                 C_ABEVAZ_A0CC0035CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0GD0153DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0153DA   "Módosított mező
                                 C_ABEVAZ_A0CC0036CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GD0153CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0153CA   "Módosított mező
                                C_ABEVAZ_A0GD0153DA
                                '0.98'.
* A0GD0155DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0155DA   "Módosított mező
                                 C_ABEVAZ_A0CC0050CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GD0155CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0155CA   "Módosított mező
                                C_ABEVAZ_A0GD0155DA
                                '0.24'.
* A0GD0156DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0156DA   "Módosított mező
                                 C_ABEVAZ_A0CC0051CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GD0156CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0156CA   "Módosított mező
                                C_ABEVAZ_A0GD0156DA
                                '0.18'.
*++2011.04.09 BG
* The calculation of the field has changed, from here it is handled by HR, we do not give up on it
** A0GD0157DA
*   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
*                                 LI_LAST_BEVALLO
*                                 T_BEVALLB
*                          USING C_ABEVAZ_A0GD0157DA "Modified field
*                                 C_ABEVAZ_A0CC0054CA "Source 1
*                                 SPACE "Source 2
*                                 SPACE "Source 3
*                                 SPACE "Source 4
*                                 SPACE.                     "Source 5
**A0GD0157CA
*   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
*                                T_BEVALLB
*                         USING C_ABEVAZ_A0GD0157CA "Modified field
*                                C_ABEVAZ_A0GD0157DA
*                                '0.10'.
** A0GD0158DA
*   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
*                                 LI_LAST_BEVALLO
*                                 T_BEVALLB
*                          USING C_ABEVAZ_A0GD0158DA "Modified field
*                                 C_ABEVAZ_A0CC0057CA "Source 1
*                                 SPACE "Source 2
*                                 SPACE "Source 3
*                                 SPACE "Source 4
*                                 SPACE.                     "Source 5
**A0GD0158CA
*   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
*                                T_BEVALLB
*                         USING C_ABEVAZ_A0GD0158CA "Modified field
*                                C_ABEVAZ_A0GD0158DA
*                                '0.10'.
*--2011.04.09 BG
* A0GD0159DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0159DA   "Módosított mező
                                 C_ABEVAZ_A0BC0060CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GD0159CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0159CA   "Módosított mező
                                C_ABEVAZ_A0GD0159DA
                                '0.15'.
* A0GD0160DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0160DA   "Módosított mező
                                 C_ABEVAZ_A0BC0061CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0GD0161DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0161DA   "Módosított mező
                                 C_ABEVAZ_A0BC0063CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*A0GD0161CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0161CA   "Módosított mező
                                C_ABEVAZ_A0GD0161DA
                                '0.13'.
* A0GD0163DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0163DA   "Módosított mező
                                 C_ABEVAZ_A0DC0070CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0GD0164DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0164DA   "Módosított mező
                                 C_ABEVAZ_A0DC0071CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0GD0165DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0165DA   "Módosított mező
                                 C_ABEVAZ_A0BC0012CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0GD0166CA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0166CA   "Módosított mező
                                 C_ABEVAZ_A0ZZ000002        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0GD0166DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0166DA   "Módosított mező
                                 C_ABEVAZ_A0DC0073CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0GD0168DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0168DA   "Módosított mező
                                 C_ABEVAZ_A0DC0074CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0GD0169DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0169DA   "Módosított mező
                                 C_ABEVAZ_A0DC0075CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0GD0171DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0171DA   "Módosított mező
                                 C_ABEVAZ_A0DC0080CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GD0171CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0171CA   "Módosított mező
                                C_ABEVAZ_A0GD0171DA
                                '0.015'.
* A0GD0172DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0172DA   "Módosított mező
                                 C_ABEVAZ_A0DC0081CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GD0172CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0172CA   "Módosított mező
                                C_ABEVAZ_A0GD0172DA
                                '0.01'.
* A0GD0173DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0173DA   "Módosított mező
                                 C_ABEVAZ_A0DC0083CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GD0173CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0173CA   "Módosított mező
                                C_ABEVAZ_A0GD0173DA
                                '0.005'.
* A0GD0174DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0174DA   "Módosított mező
                                 C_ABEVAZ_A0DC0084CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GD0174CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0174CA   "Módosított mező
                                C_ABEVAZ_A0GD0174DA
                                '0.003'.
* A0GD0175DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0175DA   "Módosított mező
                                 C_ABEVAZ_A0DC0086CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GD0175CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0175CA   "Módosított mező
                                C_ABEVAZ_A0GD0175DA
                                '0.01'.
* A0GD0176DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0176DA   "Módosított mező
                                 C_ABEVAZ_A0ZZ000003        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GD0176CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0176CA   "Módosított mező
                                C_ABEVAZ_A0GD0176DA
                                '0.007'.
* A0GD0177DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0177DA   "Módosított mező
                                 C_ABEVAZ_A0DC0087CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GD0177CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0177CA   "Módosított mező
                                C_ABEVAZ_A0GD0177DA
                                '0.04'.
* A0GD0178DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0178DA   "Módosított mező
                                 C_ABEVAZ_A0DC0088CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GD0178CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0178CA   "Módosított mező
                                C_ABEVAZ_A0GD0178DA
                                '0.02'.
* A0GD0179DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0179DA   "Módosított mező
                                 C_ABEVAZ_A0DC0089CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0GD0179CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0179CA   "Módosított mező
                                C_ABEVAZ_A0GD0179DA
                                '0.015'.
* A0GD0180DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0GD0180DA   "Módosított mező
                                 C_ABEVAZ_A0DC0090CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0HC0182DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0182DA   "Módosított mező
                                 C_ABEVAZ_A0EC0100CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0182CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0182CA   "Módosított mező
                                C_ABEVAZ_A0HC0182DA
                                '0.10'.
* A0HC0183DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0183DA   "Módosított mező
                                 C_ABEVAZ_A0EC0101CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0183CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0183CA   "Módosított mező
                                C_ABEVAZ_A0HC0183DA
                                '0.20'.
* A0HC0184DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0184DA   "Módosított mező
                                 C_ABEVAZ_A0EC0102CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0184CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0184CA   "Módosított mező
                                C_ABEVAZ_A0HC0184DA
                                '0.10'.
* A0HC0185DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0185DA   "Módosított mező
                                 C_ABEVAZ_A0EC0103CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0185CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0185CA   "Módosított mező
                                C_ABEVAZ_A0HC0185DA
                                '0.20'.
* A0HC0186DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0186DA   "Módosított mező
                                 C_ABEVAZ_A0EC0105CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0186CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0186CA   "Módosított mező
                                C_ABEVAZ_A0HC0186DA
                                '0.10'.
* A0HC0187DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0187DA   "Módosított mező
                                 C_ABEVAZ_A0EC0107CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0187CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0187CA   "Módosított mező
                                C_ABEVAZ_A0HC0187DA
                                '0.095'.
* A0HC0188DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0188DA   "Módosított mező
                                 C_ABEVAZ_A0EC0108CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0188CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0188CA   "Módosított mező
                                C_ABEVAZ_A0HC0188DA
                                '0.20'.
* A0HC0189AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0189AA   "Módosított mező
                                 C_ABEVAZ_A0EC0109CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0HC0190AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0190AA   "Módosított mező
                                 C_ABEVAZ_A0EC0110CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0HC0191DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0191DA   "Módosított mező
                                 C_ABEVAZ_A0EC0111CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0191CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0191CA   "Módosított mező
                                C_ABEVAZ_A0HC0191DA
                                '0.111'.
* A0HC0192DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0192DA   "Módosított mező
                                 C_ABEVAZ_A0EC0112CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0192CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0192CA   "Módosított mező
                                C_ABEVAZ_A0HC0192DA
                                '0.15'.
* A0HC0193AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0193AA   "Módosított mező
                                 C_ABEVAZ_A0EC0113CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0HC0194AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0194AA   "Módosított mező
                                 C_ABEVAZ_A0EC0114CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0HC0195DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0195DA   "Módosított mező
                                 C_ABEVAZ_A0EC0115CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0HC0195CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0195CA   "Módosított mező
                                C_ABEVAZ_A0HC0195DA
                                '0.15'.
* A0HC0196AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0196AA   "Módosított mező
                                 C_ABEVAZ_A0EC0116CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0HC0197AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0HC0197AA   "Módosított mező
                                 C_ABEVAZ_A0EC0117CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
**ÖSSZESÍTÉSEK
*A0GD0150DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0151DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0152DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0150DA.
*A0GD0150CA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0152CA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0150CA.
*A0GD0154DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0155DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0156DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0157DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0158DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0159DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0160DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0154DA.
*A0GD0162DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0163DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0164DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0162DA.
*A0GD0167DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0168DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0169DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0167DA.
*A0GD0170DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0171DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0172DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0173DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0174DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0175DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0176DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0177DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0178DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0179DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GD0180DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0GD0170DA.
*A0GD0170DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0182DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0183DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0184DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0185DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HC0186DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0HC0181DA.


 ENDFORM.                    " CALC_ABEV_ONREV_SZJA_1108
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_SZJA_1008
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$LAST_DATE  text
*      -->P_$INDEX  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SZJA_1008  TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                   T_BEVALLB STRUCTURE /ZAK/BEVALLB
                            USING  $DATE
                                   $INDEX.

   DATA: L_KAM_KEZD TYPE DATUM.

   DATA: BEGIN OF LI_ADOAZON OCCURS 0,
           ADOAZON TYPE /ZAK/ADOAZON,
         END OF LI_ADOAZON.
   DATA: L_BEVALLO TYPE /ZAK/BEVALLO.

*  To define a self-check
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.
   RANGES LR_SEL_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.

************************************************************************
* Special abev fields
************************************************************************

   SORT T_BEVALLB BY ABEVAZ  .

* the following abev codes can only occur once, summary v. char

   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC036A SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC034A SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC035A SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC041A SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HD0220BA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0HD0222BA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC037A SPACE.


   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_SEL_ABEVAZ.

     CLEAR W_/ZAK/BEVALLO.

*    this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
          BINARY SEARCH.

     CHECK SY-SUBRC EQ 0.
     V_TABIX = SY-TABIX .


     CASE W_/ZAK/BEVALLB-ABEVAZ.
*      period from first day
       WHEN C_ABEVAZ_A0AC034A.
* Havi
         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* A year old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'E'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+4(4) = '0101'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* He is four years old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.

           L_KAM_KEZD = $DATE.
           IF L_KAM_KEZD+4(2) >= '01' AND
              L_KAM_KEZD+4(2) <= '03'.

             L_KAM_KEZD+4(4) = '0101'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '04' AND
              L_KAM_KEZD+4(2) <= '06'.

             L_KAM_KEZD+4(4) = '0401'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '07' AND
              L_KAM_KEZD+4(2) <= '09'.

             L_KAM_KEZD+4(4) = '0701'.
           ENDIF.


           IF L_KAM_KEZD+4(2) >= '10' AND
              L_KAM_KEZD+4(2) <= '12'.

             L_KAM_KEZD+4(4) = '1001'.
           ENDIF.

           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ELSE.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*      last day until period
       WHEN C_ABEVAZ_A0AC035A.
         W_/ZAK/BEVALLO-FIELD_C = $DATE.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*      Number of taxpayers = Tax numbers
       WHEN C_ABEVAZ_A0AC041A.

         REFRESH LI_ADOAZON.
         LOOP AT T_BEVALLO INTO L_BEVALLO.
           CHECK NOT L_BEVALLO-ADOAZON IS INITIAL.
           MOVE L_BEVALLO-ADOAZON TO LI_ADOAZON.
           COLLECT LI_ADOAZON.
         ENDLOOP.


         DESCRIBE TABLE LI_ADOAZON LINES SY-TFILL.
         IF NOT SY-TFILL IS INITIAL.
           W_/ZAK/BEVALLO-FIELD_C = SY-TFILL.
         ELSE.
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
         ENDIF.

         CONDENSE W_/ZAK/BEVALLO-FIELD_C.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.


*      Correction, Self-check, Repeated self-check
       WHEN C_ABEVAZ_A0AC036A.
*        Only in self-check
         IF $INDEX NE '000'.
           REFRESH LR_ABEVAZ.
*          A numerical value must be searched for in this range
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0GC0145CA
                                    C_ABEVAZ_A0GC0173DA.
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0HC0174DA
                                    C_ABEVAZ_A0HD0222BA.
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0IC0284BA
                                    C_ABEVAZ_A0IC0302HA.
           LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ IN LR_ABEVAZ
*          We monitor the rounded sum because it may be FIELD_N
*          it is not empty, but no value is added to the return because of the fkator.
*                                          AND NOT FIELD_N  IS INITIAL.
                                           AND NOT FIELD_NR IS INITIAL.
             EXIT.
           ENDLOOP.
*          There is value:
           IF SY-SUBRC EQ 0.
*            Repeated self-check
             IF $INDEX > '001'.
               W_/ZAK/BEVALLO-FIELD_C = 'I'.
*            Self-check
             ELSE.
               W_/ZAK/BEVALLO-FIELD_C = 'O'.
             ENDIF.
*          Corrective
           ELSE.
             W_/ZAK/BEVALLO-FIELD_C = 'H'.
           ENDIF.
           CONDENSE W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
     ENDCASE.




   ENDLOOP.

 ENDFORM.                    " CALC_ABEV_SZJA_1008
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_0_SZJA_1008
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_ADOAZON_ALL  text
*      -->P_SPACE  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_0_SZJA_1008  TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                              T_ADOAZON_ALL STRUCTURE /ZAK/ADOAZONLPSZ
                              USING   $ONREV
                                      $DATE.
*++2010.11.09  Balázs Gábor (Ness)
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.
*--2010.11.09  Balázs Gábor (Ness)

* So that you don't have to expand the self-revision to a global one for every FORM
* treated as a variable:
   CLEAR V_ONREV.
   IF NOT $ONREV IS INITIAL.
     MOVE $ONREV TO V_ONREV.
   ENDIF.

**  Ha mező1 >= mező2 akkor mező3 0 flag beállítás
*   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
*                                T_ADOAZON_ALL
*                         USING C_ABEVAZ_M0BC0382CA "field1
*                                C_ABEVAZ_M0BC0382BA "field2
*                                C_ABEVAZ_M0BC0382DA.        "field 3
**  Ha mező1+mező2+mező3+mező4 > 0 akkor 0 flag beállítás
*   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
*                              USING  C_ABEVAZ_A0IC0284HA
*                              "0-flag setting
*                                     C_ABEVAZ_A0IC0284CA "field1
*                                     C_ABEVAZ_A0IC0284DA "field2
*                                     C_ABEVAZ_A0IC0284EA "field3
*                                     SPACE.                 "field 4
** Ha mező1 ne 0 vagy mező2 ne 0 vagy mező3 ne 0 vagy mező4 ne 0
** vagy mező5 ne 0 akkor 0 flag beállítás
*   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
*                              USING  C_ABEVAZ_A0DC0087DA    "0flag
*                                     C_ABEVAZ_A0DC0087CA "field1
*                                     SPACE "field2
*                                     SPACE "field3
*                                     SPACE "field4
*                                     SPACE "field5
*                                     SPACE.                 "field 6
*   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
*                                      T_ADOAZON_ALL
*                               USING  C_ABEVAZ_M0CC0415DA   "0flag
*                                      C_ABEVAZ_M0BC0382BA "field1
*                                      C_ABEVAZ_M0BC0386BA "field2
*                                      SPACE "field3
*                                      SPACE "field4
*                                      SPACE "field5
*                                      SPACE.                "field 6
** mező1-n 0 flag állítás
*     PERFORM GET_NULL_FLAG_0     TABLES T_BEVALLO
*                                 USING  C_ABEVAZ_A0BC50041A.
* If field1 = field2 then 0 flag is set
*   PERFORM GET_NULL_FLAG_EQM TABLES T_BEVALLO
*                                    T_ADOAZON_ALL
*                             USING C_ABEVAZ_M0FD0496AA "field1
*                                    C_ABEVAZ_M0FD0495AA "field2
*                                    C_ABEVAZ_M0FD0498BA     "0-flag
*                                    C_ABEVAZ_M0FD0497BA.    "0-flag
*++2010.11.09  Balázs Gábor (Ness)
* If ABEV identifiers have the desired value, set the flag to 0
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0HD0570BA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0JE0609BA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0JF0633BA SPACE.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '261'
                                        C_ABEVAZ_A0FC0110BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '262'
                                        C_ABEVAZ_A0FC0111BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '263'
                                        C_ABEVAZ_A0FC0112BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '265'
                                        C_ABEVAZ_A0FC0113BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '265'
                                        C_ABEVAZ_A0FC0113BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '266'
                                        C_ABEVAZ_A0FC0114BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '267'
                                        C_ABEVAZ_A0FC0115BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '268'
                                        C_ABEVAZ_A0FC0116BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '269'
                                        C_ABEVAZ_A0FC0117BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '270'
                                        C_ABEVAZ_A0FC0118BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '271'
                                        C_ABEVAZ_A0FC0119BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '272'
                                        C_ABEVAZ_A0FC0120BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '273'
                                        C_ABEVAZ_A0FC0121BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '274'
                                        C_ABEVAZ_A0FC0122BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '275'
                                        C_ABEVAZ_A0FC0123BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '276'
                                        C_ABEVAZ_A0FC0124BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '277'
                                        C_ABEVAZ_A0FC0125BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '278'
                                        C_ABEVAZ_A0FC0126BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '279'
                                        C_ABEVAZ_A0FC0127BA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '282'
                                        C_ABEVAZ_A0FC0128BA.
*++2010.02.10  Balázs Gábor (Ness)
   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '274'
                                        C_ABEVAZ_A0IC0296CA.

*  If field1 >= field2 then field3 0 flag setting
   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0362CA         "mező1
                                C_ABEVAZ_M0BC0362BA         "mező2
                                C_ABEVAZ_M0BC0362DA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0362DA         "mező1
                                C_ABEVAZ_M0BC0362BA         "mező2
                                C_ABEVAZ_M0BC0362CA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0366CA         "mező1
                                C_ABEVAZ_M0BC0366BA         "mező2
                                C_ABEVAZ_M0BC0366DA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0366DA         "mező1
                                C_ABEVAZ_M0BC0366BA         "mező2
                                C_ABEVAZ_M0BC0366CA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0368CA         "mező1
                                C_ABEVAZ_M0BC0368BA         "mező2
                                C_ABEVAZ_M0BC0368DA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0368DA         "mező1
                                C_ABEVAZ_M0BC0368BA         "mező2
                                C_ABEVAZ_M0BC0368CA.        "mező3

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0284HA    "0flag
                                     C_ABEVAZ_A0IC0284CA    "mező1
                                     C_ABEVAZ_A0IC0284DA    "mező2
                                     C_ABEVAZ_A0IC0284EA    "mező3
                                     SPACE.                 "mező4


   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0285HA    "0flag
                                     C_ABEVAZ_A0IC0285CA    "mező1
                                     C_ABEVAZ_A0IC0285DA    "mező2
                                     C_ABEVAZ_A0IC0285EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0286HA    "0flag
                                     C_ABEVAZ_A0IC0286CA    "mező1
                                     C_ABEVAZ_A0IC0286DA    "mező2
                                     C_ABEVAZ_A0IC0286EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0287HA    "0flag
                                     C_ABEVAZ_A0IC0287CA    "mező1
                                     C_ABEVAZ_A0IC0287DA    "mező2
                                     C_ABEVAZ_A0IC0287EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0288HA    "0flag
                                     C_ABEVAZ_A0IC0288CA    "mező1
                                     C_ABEVAZ_A0IC0288DA    "mező2
                                     C_ABEVAZ_A0IC0288EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0289HA    "0flag
                                     C_ABEVAZ_A0IC0289CA    "mező1
                                     C_ABEVAZ_A0IC0289DA    "mező2
                                     C_ABEVAZ_A0IC0289EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0290HA    "0flag
                                     C_ABEVAZ_A0IC0290CA    "mező1
                                     C_ABEVAZ_A0IC0290DA    "mező2
                                     C_ABEVAZ_A0IC0290EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0291HA    "0flag
                                     C_ABEVAZ_A0IC0291CA    "mező1
                                     C_ABEVAZ_A0IC0291DA    "mező2
                                     C_ABEVAZ_A0IC0291EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0292HA    "0flag
                                     C_ABEVAZ_A0IC0292CA    "mező1
                                     C_ABEVAZ_A0IC0292DA    "mező2
                                     C_ABEVAZ_A0IC0292EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0293HA    "0flag
                                     C_ABEVAZ_A0IC0293CA    "mező1
                                     C_ABEVAZ_A0IC0293DA    "mező2
                                     C_ABEVAZ_A0IC0293EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0294HA    "0flag
                                     C_ABEVAZ_A0IC0294CA    "mező1
                                     C_ABEVAZ_A0IC0294DA    "mező2
                                     C_ABEVAZ_A0IC0294EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0295HA    "0flag
                                     C_ABEVAZ_A0IC0295CA    "mező1
                                     C_ABEVAZ_A0IC0295DA    "mező2
                                     C_ABEVAZ_A0IC0295EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0296HA    "0flag
                                     C_ABEVAZ_A0IC0296CA    "mező1
                                     C_ABEVAZ_A0IC0296DA    "mező2
                                     C_ABEVAZ_A0IC0296EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0297HA    "0flag
                                     C_ABEVAZ_A0IC0297CA    "mező1
                                     C_ABEVAZ_A0IC0297DA    "mező2
                                     C_ABEVAZ_A0IC0297EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0298HA    "0flag
                                     C_ABEVAZ_A0IC0298CA    "mező1
                                     C_ABEVAZ_A0IC0298DA    "mező2
                                     C_ABEVAZ_A0IC0298EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0299HA    "0flag
                                     C_ABEVAZ_A0IC0299CA    "mező1
                                     C_ABEVAZ_A0IC0299DA    "mező2
                                     C_ABEVAZ_A0IC0299EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0300HA    "0flag
                                     C_ABEVAZ_A0IC0300CA    "mező1
                                     C_ABEVAZ_A0IC0300DA    "mező2
                                     C_ABEVAZ_A0IC0300EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0301HA    "0flag
                                     C_ABEVAZ_A0IC0301CA    "mező1
                                     C_ABEVAZ_A0IC0301DA    "mező2
                                     C_ABEVAZ_A0IC0301EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0302HA    "0flag
                                     C_ABEVAZ_A0IC0302CA    "mező1
                                     C_ABEVAZ_A0IC0302DA    "mező2
                                     C_ABEVAZ_A0IC0302EA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0552CA   "0flag
                                      C_ABEVAZ_M0HD0550CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0553CA   "0flag
                                      C_ABEVAZ_M0HD0551CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0556CA   "0flag
                                      C_ABEVAZ_M0HD0555CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0557CA   "0flag
                                      C_ABEVAZ_M0HD0555CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0558CA   "0flag
                                      C_ABEVAZ_M0HD0555CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0562CA   "0flag
                                      C_ABEVAZ_M0HD0561CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0568CA   "0flag
                                      C_ABEVAZ_M0HD0565CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0568CA   "0flag
                                      C_ABEVAZ_M0HD0566CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0568CA   "0flag
                                      C_ABEVAZ_M0HD0567CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0574CA   "0flag
                                      C_ABEVAZ_M0HD0573CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0576CA   "0flag
                                      C_ABEVAZ_M0HD0575CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0578CA   "0flag
                                      C_ABEVAZ_M0HD0577CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0580CA   "0flag
                                      C_ABEVAZ_M0HD0579CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0582CA   "0flag
                                      C_ABEVAZ_M0HD0581CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6
*++ 2010.06.10 RN
* same as GET_NULL_FLAG_INITM, only the field to be checked is character-based,
* therefore FIELD_C must be monitored
* just to be safe, I put in field 1 to field 6, just in case later
* lesz ilyen eset
   PERFORM GET_NULL_FLAG_INITM_C TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0DC0443AA   "0flag
                                      C_ABEVAZ_M0DC0441AA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6
   PERFORM GET_NULL_FLAG_INITM_C TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0DC0444AA   "0flag
                                      C_ABEVAZ_M0DC0441AA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6
   PERFORM GET_NULL_FLAG_INITM_C TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0DC0445AA   "0flag
                                      C_ABEVAZ_M0DC0441AA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6
*-- 2010.06.10 RN
*  0 flag setting on field 1
   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0565CA.

   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0568CA.

   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0569CA.

   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0570CA.

*++ 2010.07.08 1008-ban nem kell 0 flag.
**  Ha mező1-FIELD_N <> 0 vagy .......
**  akkor mező0 0 flag.
*   PERFORM GET_NULL_FLAG_INIT_N TABLES T_BEVALLO
*                                USING  C_ABEVAZ_A0BC0017CA    "0flag
*                                       C_ABEVAZ_A0BC0018CA "field1
*                                       C_ABEVAZ_A0BC0019CA "field2
*                                       C_ABEVAZ_A0BC0020CA "field3
*                                       SPACE "field4
*                                       SPACE "field5
*                                       SPACE.                 "field 6
*-- 2010.07.08 1008-ban nem kell 0 flag.

*++ 2010.06.10 RN
* If field1 = field2 then 0 flag is set
   PERFORM GET_NULL_FLAG_EQM TABLES T_BEVALLO
                                    T_ADOAZON_ALL
                             USING  C_ABEVAZ_M0FD0496AA     "mező1
                                    C_ABEVAZ_M0FD0495AA     "mező2
                                    C_ABEVAZ_M0FD0498BA     "0-flag
                                    C_ABEVAZ_M0FD0497BA.    "0-flag
*-- 2010.06.10 RN
*++ 2011.04.08 BG
   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0GC0149DA    "0flag
                                     C_ABEVAZ_A0GC0152DA    "mező1
                                     C_ABEVAZ_A0GC0153DA    "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6
*-- 2011.04.08 BG

 ENDFORM.                    " CALC_ABEV_0_SZJA_1008
*&---------------------------------------------------------------------*
*&      Form  GET_LAP_SZ_1008
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*----------------------------------------------------------------------*
 FORM GET_LAP_SZ_1008  TABLES T_BEVALLO STRUCTURE  /ZAK/BEVALLALV.


   DATA L_ALV LIKE /ZAK/BEVALLALV.
   DATA L_INDEX LIKE SY-TABIX.
   DATA L_TABIX LIKE SY-TABIX.
   DATA L_NYLAP LIKE SY-TABIX.
   DATA L_BEVALLO_ALV LIKE /ZAK/BEVALLALV.
   DATA L_NULL_FLAG TYPE /ZAK/NULL.

   CLEAR L_INDEX.

*  Upload RANKS for SZJA tax identification page number management
   M_DEF R_M0AE007A 'I' 'BT' 'M0BC0000000000000' 'M0BZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE008A 'I' 'BT' 'M0CC0000000000000' 'M0CZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE009A 'I' 'BT' 'M0DC0000000000000' 'M0DZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE010A 'I' 'BT' 'M0EC0000000000000' 'M0EZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE011A 'I' 'BT' 'M0FC0000000000000' 'M0FZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE012A 'I' 'BT' 'M0GC0000000000000' 'M0GZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE013A 'I' 'BT' 'M0HC0000000000000' 'M0HZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE014A 'I' 'BT' 'M0IC0000000000000' 'M0IZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE015A 'I' 'BT' 'M0JC0000000000000' 'M0JZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE016A 'I' 'BT' 'M0KC0000000000000' 'M0KZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE017A 'I' 'BT' 'M0LC0000000000000' 'M0LZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE018A 'I' 'BT' 'M0MC0000000000000' 'M0MZZZZZZZZZZZZZZ'.
   M_DEF R_M0AE019A 'I' 'BT' 'M0ND0000000000000' 'M0NZZZZZZZZZZZZZZ'.

*  Upload RANKS to manage retired numbers
   M_DEF R_A0AC042A 'I' 'EQ' 'M0GC003A' SPACE.
   M_DEF R_A0AC042A 'I' 'EQ' 'M0HC003A' SPACE.
   M_DEF R_A0AC042A 'I' 'EQ' 'M0IC003A' SPACE.
   M_DEF R_A0AC042A 'I' 'EQ' 'M0JC003A' SPACE.
   M_DEF R_A0AC042A 'I' 'EQ' 'M0KC003A' SPACE.
   M_DEF R_A0AC042A 'I' 'EQ' 'M0LC003A' SPACE.
   M_DEF R_A0AC042A 'I' 'EQ' 'M0MC003A' SPACE.
   M_DEF R_A0AC042A 'I' 'EQ' 'M0NC001A' SPACE.

*  Values
   M_DEF R_NYLAPVAL 'I' 'EQ' '1' SPACE.
   M_DEF R_NYLAPVAL 'I' 'EQ' '2' SPACE.
   M_DEF R_NYLAPVAL 'I' 'EQ' '3' SPACE.
   M_DEF R_NYLAPVAL 'I' 'EQ' '5' SPACE.
   M_DEF R_NYLAPVAL 'I' 'EQ' '7' SPACE.


   REFRESH I_NYLAP.

   LOOP AT I_/ZAK/BEVALLO INTO W_/ZAK/BEVALLO.
     L_TABIX = SY-TABIX.

*   Dialog run for insurance
     PERFORM PROCESS_IND_ITEM USING '100000'
                                    L_INDEX
                                    TEXT-P01.

*   Csak SZJA-nal
     IF  W_/ZAK/BEVALL-BTYPART EQ C_BTYPART_SZJA.
*      Collections for tax identification number
       PERFORM CALL_MLAPSZ: TABLES R_M0AE007A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE007A,
                            TABLES R_M0AE008A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE008A,
                            TABLES R_M0AE009A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE009A,
                            TABLES R_M0AE010A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE010A,
                            TABLES R_M0AE011A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE011A,
                            TABLES R_M0AE012A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE012A,
                            TABLES R_M0AE013A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE013A,
                            TABLES R_M0AE014A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE014A,
                            TABLES R_M0AE015A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE015A,
                            TABLES R_M0AE016A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE016A,
                            TABLES R_M0AE017A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE017A,
                            TABLES R_M0AE018A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE018A,
                            TABLES R_M0AE019A
                            USING  W_/ZAK/BEVALLO
                                   C_ABEVAZ_M0AE019A.

*      Collection of pensioner tax numbers
       PERFORM CALL_NYLAP TABLES R_A0AC042A
                                 R_NYLAPVAL
                          USING  W_/ZAK/BEVALLO.

     ENDIF.

     READ TABLE T_BEVALLO INTO L_ALV WITH KEY
                   BUKRS   = W_/ZAK/BEVALLO-BUKRS
                   BTYPE   = W_/ZAK/BEVALLO-BTYPE
                   GJAHR   = W_/ZAK/BEVALLO-GJAHR
                   MONAT   = W_/ZAK/BEVALLO-MONAT
                   ZINDEX  = W_/ZAK/BEVALLO-ZINDEX
                   ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ
                   ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                   LAPSZ   = W_/ZAK/BEVALLO-LAPSZ
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
*  The 0 flag handling was not appropriate
*  If it is a self-revision calculation, the T_BEVALLO 0 flag is required
*  otherwise, the I_/ZAK/BEVALLO 0 flag.
       IF NOT L_ALV-OFLAG IS INITIAL.
         L_NULL_FLAG = L_ALV-NULL_FLAG.
       ELSE.
         L_NULL_FLAG = W_/ZAK/BEVALLO-NULL_FLAG.
       ENDIF.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
       L_ALV-NULL_FLAG = L_NULL_FLAG.
       IF L_ALV-OFLAG IS INITIAL.
         MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX
                         TRANSPORTING FIELD_C FIELD_N FIELD_NR FIELD_NRK
                                      NULL_FLAG WAERS
                                       .
       ELSE.
         MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX
                         TRANSPORTING FIELD_C FIELD_N  FIELD_NR
                         FIELD_NRK
                                      OFLAG   FIELD_ON FIELD_ONR
                                      FIELD_ONRK
                                      NULL_FLAG WAERS.
         PERFORM SUM_ONR TABLES T_BEVALLO
                         USING  L_ALV
                                L_ALV-FIELD_ON
                                L_ALV-FIELD_ONR
                                L_ALV-FIELD_ONRK.
       ENDIF.
     ELSE.
       READ TABLE I_/ZAK/BEVALLB INTO W_/ZAK/BEVALLB
       WITH KEY ABEVAZ = W_/ZAK/BEVALLO-ABEVAZ.
       MOVE-CORRESPONDING W_/ZAK/BEVALLB TO L_ALV.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
       SELECT SINGLE ABEVTEXT INTO L_ALV-ABEVTEXT
         FROM  /ZAK/BEVALLBT
              WHERE  LANGU   = SY-LANGU
              AND    BTYPE   = W_/ZAK/BEVALLO-BTYPE
              AND    ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ.
       L_ALV-ABEVTEXT_DISP = L_ALV-ABEVTEXT.
       APPEND L_ALV TO T_BEVALLO.
       SORT T_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ ADOAZON
            LAPSZ.
     ENDIF.
     DELETE I_/ZAK/BEVALLO.
   ENDLOOP.

*  Definition of pensioners
   IF NOT I_NYLAP[] IS INITIAL.
     DESCRIBE TABLE I_NYLAP LINES L_NYLAP.
     READ TABLE T_BEVALLO INTO L_BEVALLO_ALV
                          WITH KEY ABEVAZ  = C_ABEVAZ_A0AC042A
                          BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE L_NYLAP TO L_BEVALLO_ALV-FIELD_C.
       CONDENSE L_BEVALLO_ALV-FIELD_C.
       MODIFY T_BEVALLO FROM L_BEVALLO_ALV INDEX SY-TABIX
                             TRANSPORTING FIELD_C.
     ENDIF.
   ELSE.
     READ TABLE T_BEVALLO INTO L_BEVALLO_ALV
                          WITH KEY ABEVAZ  = C_ABEVAZ_A0AC042A
                          BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       CLEAR L_BEVALLO_ALV-FIELD_C.
       MODIFY T_BEVALLO FROM L_BEVALLO_ALV INDEX SY-TABIX
                             TRANSPORTING FIELD_C.
     ENDIF.
   ENDIF.

 ENDFORM.                    " GET_LAP_SZ_1008
*&---------------------------------------------------------------------*
*&      Form  del_esdat_field_1008
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_C_ABEVAZ_A0AC033A  text
*----------------------------------------------------------------------*
 FORM DEL_ESDAT_FIELD_1008 TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLALV
                                    $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                           USING    $ABEVAZ_JELLEG.

   DATA LW_/ZAK/BEVALLALV TYPE /ZAK/BEVALLALV.

*  We define the character:
   READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                         WITH KEY ABEVAZ = $ABEVAZ_JELLEG
                         BINARY SEARCH.
*  In this case, you do not need to fill in the due date:
   IF SY-SUBRC EQ 0 AND LW_/ZAK/BEVALLALV-FIELD_C = 'H'.
*  ABEV ID value marked in ESDAT_FLAG
     READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                         WITH KEY  ESDAT_FLAG = 'X'.
     IF SY-SUBRC EQ 0.
       READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                           WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
                           BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         V_TABIX = SY-TABIX .
         CLEAR LW_/ZAK/BEVALLALV-FIELD_C.
         MODIFY $T_BEVALLO FROM LW_/ZAK/BEVALLALV
                               INDEX V_TABIX TRANSPORTING FIELD_C.
       ENDIF.
     ENDIF.
   ENDIF.

 ENDFORM.                    " del_esdat_field_1008
*&---------------------------------------------------------------------*
*&      Form  GET_SUB_MULT_M
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*      -->P_C_ABEVAZ_M0CC0406DA  text
*      -->P_C_ABEVAZ_M0CC0405DA  text
*      -->P_C_ABEVAZ_M0BC0391DA  text
*      -->P_4387   text
*----------------------------------------------------------------------*
 FORM GET_SUB_MULT_M  TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                               $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                               $T_ADOAZON STRUCTURE /ZAK/ADOAZONLPSZ
                      USING    $ABEV_MOD
                               $ABEV_F1
                               $ABEV_F2
                               $DIV.

   DATA L_INDEX_MOD LIKE SY-TABIX.

   DATA L_FIELD_N TYPE /ZAK/FIELDN.
   DATA L_FIELD_N1 TYPE /ZAK/FIELDN.
   DATA L_FIELD_N2 TYPE /ZAK/FIELDN.

   DEFINE LM_READ_DATA.
     CLEAR &4.
     IF NOT &1 IS INITIAL.
       READ TABLE $T_BEVALLO INTO W_/ZAK/BEVALLO
            WITH KEY ABEVAZ  = &1
                     ADOAZON = &2
                     LAPSZ   = &3
                     BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         &4 = W_/ZAK/BEVALLO-FIELD_N.
       ENDIF.
     ENDIF.
   END-OF-DEFINITION.

*  ADMIT scan
   READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                        WITH KEY ABEVAZ = $ABEV_MOD.

* It must be calculated by tax number:
   LOOP AT $T_ADOAZON.
*   Let's read the ABEV to be modified
     READ TABLE $T_BEVALLO TRANSPORTING NO FIELDS
          WITH KEY ABEVAZ  = $ABEV_MOD
                   ADOAZON = $T_ADOAZON-ADOAZON
                   LAPSZ   = $T_ADOAZON-LAPSZ
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_INDEX_MOD.
*      Determination of value
       LM_READ_DATA $ABEV_F1 $T_ADOAZON-ADOAZON
                             $T_ADOAZON-LAPSZ
                             L_FIELD_N1.
       LM_READ_DATA $ABEV_F2 $T_ADOAZON-ADOAZON
                             $T_ADOAZON-LAPSZ
                             L_FIELD_N2.
       L_FIELD_N = L_FIELD_N1 - L_FIELD_N2.
*++2010.02.09 RN (NESS)
* if the amount is negative, you do not need to enter anything, it is empty
* must be left, you don't even need 0 in it
       IF L_FIELD_N > 0.
*--2010.02.09 RN (NESS)
*      Calculate the ratio
         CATCH SYSTEM-EXCEPTIONS  BCD_FIELD_OVERFLOW  = 1
                                  BCD_OVERFLOW        = 2
                                  BCD_ZERODIVIDE      = 3
                                  COMPUTE_BCD_OVERFLOW = 4.
           MULTIPLY L_FIELD_N BY $DIV.
           CLEAR W_/ZAK/BEVALLO.
           W_/ZAK/BEVALLO-FIELD_N = L_FIELD_N.
         ENDCATCH.
         IF SY-SUBRC EQ 0.
           PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                        W_/ZAK/BEVALLB-ROUND
                        W_/ZAK/BEVALLO-WAERS
               CHANGING W_/ZAK/BEVALLO-FIELD_NR
                        W_/ZAK/BEVALLO-FIELD_NRK.

           MODIFY $T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_INDEX_MOD
                                                TRANSPORTING FIELD_N
                                                             FIELD_NR
                                                             FIELD_NRK.
         ENDIF.
*++2010.02.09 RN (NESS)
       ENDIF.
*--2010.02.09 RN (NESS)
     ENDIF.
   ENDLOOP.

 ENDFORM.                    " GET_SUB_MULT_M
*&---------------------------------------------------------------------*
*&      Form  GET_SUM_M
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*      -->P_C_ABEVAZ_M0CC0408DA  text
*      -->P_C_ABEVAZ_M0BC0361DA  text
*      -->P_C_ABEVAZ_M0BC0362DA  text
*      -->P_C_ABEVAZ_M0BC0363DA  text
*      -->P_C_ABEVAZ_M0BC0364DA  text
*      -->P_C_ABEVAZ_M0CC0403AA  text
*      -->P_C_ABEVAZ_M0CC0404AA  text
*----------------------------------------------------------------------*
 FORM GET_SUM_M        TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                $T_ADOAZON STRUCTURE /ZAK/ADOAZONLPSZ
                       USING    $ABEV_MOD
                                $ABEV_F1
                                $ABEV_F2
                                $ABEV_F3
                                $ABEV_F4
                                $ABEV_F5
                                $ABEV_F6.


   DATA L_INDEX_MOD LIKE SY-TABIX.

   DATA L_FIELD_SUM TYPE /ZAK/FIELDN.
   DATA L_FIELD_N   TYPE /ZAK/FIELDN.

   DEFINE LM_READ_DATA.
     CLEAR &4.
     READ TABLE $T_BEVALLO INTO W_/ZAK/BEVALLO
          WITH KEY ABEVAZ  = &1
                   ADOAZON = &2
                   LAPSZ   = &3
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       &4 = W_/ZAK/BEVALLO-FIELD_N.
     ENDIF.
   END-OF-DEFINITION.

*  ADMIT scan
   READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                        WITH KEY ABEVAZ = $ABEV_MOD.

* It must be calculated by tax number:
   LOOP AT $T_ADOAZON.
     CLEAR L_FIELD_SUM.
*   Let's read the ABEV to be modified
     READ TABLE $T_BEVALLO TRANSPORTING NO FIELDS
          WITH KEY ABEVAZ  = $ABEV_MOD
                   ADOAZON = $T_ADOAZON-ADOAZON
                   LAPSZ   = $T_ADOAZON-LAPSZ
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_INDEX_MOD.
*      Determination and summarization of value
       LM_READ_DATA $ABEV_F1 $T_ADOAZON-ADOAZON
                             $T_ADOAZON-LAPSZ
                             L_FIELD_N.
       ADD L_FIELD_N TO L_FIELD_SUM.
       LM_READ_DATA $ABEV_F2 $T_ADOAZON-ADOAZON
                             $T_ADOAZON-LAPSZ
                             L_FIELD_N.
       ADD L_FIELD_N TO L_FIELD_SUM.
       LM_READ_DATA $ABEV_F3 $T_ADOAZON-ADOAZON
                             $T_ADOAZON-LAPSZ
                             L_FIELD_N.
       ADD L_FIELD_N TO L_FIELD_SUM.
       LM_READ_DATA $ABEV_F4 $T_ADOAZON-ADOAZON
                             $T_ADOAZON-LAPSZ
                             L_FIELD_N.
       ADD L_FIELD_N TO L_FIELD_SUM.
       LM_READ_DATA $ABEV_F5 $T_ADOAZON-ADOAZON
                             $T_ADOAZON-LAPSZ
                             L_FIELD_N.
       ADD L_FIELD_N TO L_FIELD_SUM.
       LM_READ_DATA $ABEV_F6 $T_ADOAZON-ADOAZON
                             $T_ADOAZON-LAPSZ
                             L_FIELD_N.
       ADD L_FIELD_N TO L_FIELD_SUM.

       W_/ZAK/BEVALLO-FIELD_N = L_FIELD_SUM.

       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                    W_/ZAK/BEVALLB-ROUND
                    W_/ZAK/BEVALLO-WAERS
           CHANGING W_/ZAK/BEVALLO-FIELD_NR
                    W_/ZAK/BEVALLO-FIELD_NRK.


       MODIFY $T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_INDEX_MOD
                                            TRANSPORTING FIELD_N
                                                         FIELD_NR
                                                         FIELD_NRK.
     ENDIF.
   ENDLOOP.

 ENDFORM.                    " GET_SUM_M

*&---------------------------------------------------------------------*
*&      Form  GET_SUB_M
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*----------------------------------------------------------------------*
 FORM GET_SUB_M        TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                $T_ADOAZON STRUCTURE /ZAK/ADOAZONLPSZ
                       USING    $ABEV_MOD
                                $ABEV_F1
                                $ABEV_F2
*++1408 2014.02.10 BG
                                $SIGN.
*--1408 2014.02.10 BG

   DATA L_INDEX_MOD LIKE SY-TABIX.

   DATA L_FIELD_SUB    TYPE /ZAK/FIELDN.
   DATA L_FIELD_F1_N   TYPE /ZAK/FIELDN.
   DATA L_FIELD_F2_N   TYPE /ZAK/FIELDN.

   DEFINE LM_READ_DATA.
     CLEAR &4.
     READ TABLE $T_BEVALLO INTO W_/ZAK/BEVALLO
          WITH KEY ABEVAZ  = &1
                   ADOAZON = &2
                   LAPSZ   = &3
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       &4 = W_/ZAK/BEVALLO-FIELD_N.
     ENDIF.
   END-OF-DEFINITION.

*  ADMIT scan
   READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                        WITH KEY ABEVAZ = $ABEV_MOD.

* It must be calculated by tax number:
   LOOP AT $T_ADOAZON.
     CLEAR L_FIELD_SUB.
*   Let's read the ABEV to be modified
     READ TABLE $T_BEVALLO TRANSPORTING NO FIELDS
          WITH KEY ABEVAZ  = $ABEV_MOD
                   ADOAZON = $T_ADOAZON-ADOAZON
                   LAPSZ   = $T_ADOAZON-LAPSZ
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_INDEX_MOD.
*      Determination and summarization of value
       LM_READ_DATA $ABEV_F1 $T_ADOAZON-ADOAZON
                             $T_ADOAZON-LAPSZ
                             L_FIELD_F1_N.

       LM_READ_DATA $ABEV_F2 $T_ADOAZON-ADOAZON
                             $T_ADOAZON-LAPSZ
                             L_FIELD_F2_N.

       L_FIELD_SUB = L_FIELD_F1_N - L_FIELD_F2_N.

*++1408 2014.02.10 BG
       IF $SIGN EQ '+' AND L_FIELD_SUB < 0.
         L_FIELD_SUB = 0.
       ENDIF.

       IF NOT L_FIELD_SUB IS INITIAL.
*--1408 2014.02.10 BG

         W_/ZAK/BEVALLO-FIELD_N = L_FIELD_SUB.

         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.


         MODIFY $T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_INDEX_MOD
                                              TRANSPORTING FIELD_N
                                                           FIELD_NR
                                                           FIELD_NRK.
*++1408 2014.02.10 BG
       ENDIF.
*--1408 2014.02.10 BG
     ENDIF.
   ENDLOOP.

 ENDFORM.                    " GET_SUB_M
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_AFA_1065
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_AFA_1065  TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                 T_BEVALLB STRUCTURE /ZAK/BEVALLB
                           USING $DATE.

   DATA: L_SUM      LIKE /ZAK/BEVALLO-FIELD_N,
         L_SUM_203  LIKE /ZAK/BEVALLO-FIELD_N,
*++ BG 2009.06.17
         L_SUM_SAVE LIKE /ZAK/BEVALLO-FIELD_N,
*-- BG 2009.06.17
         L_KAMAT    LIKE /ZAK/BEVALLO-FIELD_N,
         L_ABEV_SUM LIKE /ZAK/BEVALLO-FIELD_N.
   DATA: L_KAM_KEZD  TYPE DATUM,
         L_KAM_VEG   TYPE DATUM,
         L_ROUND(20) TYPE C,
         L_TABIX     LIKE SY-TABIX,
         L_UPD.
************************************************************************
* Special abev fields

******************************************************** CSAK ÁFA normál

   DATA: W_SZ TYPE /ZAK/BEVALLB.

   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.

*  Loading calculated fields
   REFRESH LR_ABEVAZ.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8277 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8283 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_7650 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_7651 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_7653 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_7654 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8272 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8274 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8276 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8278 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8280 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8282 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_7693 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8281 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_8282 SPACE.
ENHANCEMENT-POINT /ZAK/ZAK_1065_RG_01 SPOTS /ZAK/FUNCTIONS_ES .


   SORT T_BEVALLB BY ABEVAZ  .
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_ABEVAZ.
     CLEAR : L_SUM,W_/ZAK/BEVALLO.
* this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
     V_TABIX = SY-TABIX .
     CLEAR: W_/ZAK/BEVALLO-FIELD_N,
            W_/ZAK/BEVALLO-FIELD_NR,
            W_/ZAK/BEVALLO-FIELD_NRK.


     CASE W_/ZAK/BEVALLB-ABEVAZ.
* 72.C. Amount of tax to be paid
       WHEN C_ABEVAZ_8277.
         CLEAR L_SUM.
         READ TABLE T_BEVALLO INTO W_SUM
         WITH KEY ABEVAZ = C_ABEVAZ_8275.
         IF SY-SUBRC = 0.
           IF W_SUM-FIELD_N > 0.
             L_SUM = W_SUM-FIELD_NRK.
             W_/ZAK/BEVALLO-FIELD_N = L_SUM.
           ELSE.
             CLEAR W_/ZAK/BEVALLO-FIELD_N.
           ENDIF.
           L_UPD = 'X'.
         ENDIF.
* 00C Declaration period from
       WHEN C_ABEVAZ_7650.
* Havi
         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* A year old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'E'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+4(4) = '0101'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* He is four years old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.

           L_KAM_KEZD = $DATE.
           IF L_KAM_KEZD+4(2) >= '01' AND
              L_KAM_KEZD+4(2) <= '03'.

             L_KAM_KEZD+4(4) = '0101'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '04' AND
              L_KAM_KEZD+4(2) <= '06'.

             L_KAM_KEZD+4(4) = '0401'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '07' AND
              L_KAM_KEZD+4(2) <= '09'.

             L_KAM_KEZD+4(4) = '0701'.
           ENDIF.


           IF L_KAM_KEZD+4(2) >= '10' AND
              L_KAM_KEZD+4(2) <= '12'.

             L_KAM_KEZD+4(4) = '1001'.
           ENDIF.

           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ELSE.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ENDIF.

         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*00C Declaration period from
       WHEN C_ABEVAZ_7651.
         W_/ZAK/BEVALLO-FIELD_C = $DATE.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*00C Nature of declaration
       WHEN C_ABEVAZ_7653.
*        ZINDEX = '001' --> 'O' "self check
*        ZINDEX > '001' --> 'I' "repeated self-check
         IF W_/ZAK/BEVALLO-ZINDEX = '001'.
           W_/ZAK/BEVALLO-FIELD_C = 'O'.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ELSEIF W_/ZAK/BEVALLO-ZINDEX > '001'.
           W_/ZAK/BEVALLO-FIELD_C = 'I'.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
*00C Declaration frequency /H-monthly, N-quarterly, E-yearly
       WHEN C_ABEVAZ_7654.
         W_/ZAK/BEVALLO-FIELD_C = W_/ZAK/BEVALL-BIDOSZ.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*70.B. It can be calculated from the previous period
       WHEN C_ABEVAZ_8272.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8273
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*71.B. Established in the subject period
       WHEN C_ABEVAZ_8274.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8275
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*72.B. Amount of tax to be paid
       WHEN C_ABEVAZ_8276.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8277
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*73.B. It is not organized in terms of Pü
       WHEN C_ABEVAZ_8278.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8279
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*74.B. Amount of recoverable tax
       WHEN C_ABEVAZ_8280.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8281
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*74.B. It can be carried over to the next period
       WHEN C_ABEVAZ_8282.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8283
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*00F year month day
       WHEN C_ABEVAZ_7693.
         W_/ZAK/BEVALLO-FIELD_C = SY-DATUM.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
* Claimable,
       WHEN  C_ABEVAZ_8281.
         READ TABLE T_BEVALLO INTO W_SUM
              WITH KEY ABEVAZ = C_ABEVAZ_8275.
         IF SY-SUBRC EQ 0 AND W_SUM-FIELD_N < 0.
           CLEAR L_SUM.
           L_SUM = W_SUM-FIELD_NRK.
           READ TABLE T_BEVALLO INTO W_SUM
                WITH KEY ABEVAZ = C_ABEVAZ_7688.
           IF SY-SUBRC EQ 0 AND NOT W_SUM-FIELD_C IS INITIAL.
             READ TABLE T_BEVALLO INTO W_SUM
                  WITH KEY ABEVAZ = C_ABEVAZ_8279.
             IF SY-SUBRC EQ 0.
               SUBTRACT W_SUM-FIELD_NRK FROM L_SUM.
               W_/ZAK/BEVALLO-FIELD_N = ABS( L_SUM ).
               L_UPD = 'X'.
             ENDIF.
           ELSEIF SY-SUBRC EQ 0 AND W_SUM-FIELD_C IS INITIAL.
             CLEAR W_/ZAK/BEVALLO-FIELD_N.
             L_UPD = 'X'.
           ENDIF.
         ENDIF.
*Carried over to next period
       WHEN  C_ABEVAZ_8283.
         READ TABLE T_BEVALLO INTO W_SUM
              WITH KEY ABEVAZ = C_ABEVAZ_8275.
         IF SY-SUBRC EQ 0 AND W_SUM-FIELD_N < 0.
           CLEAR L_SUM.
           L_SUM = W_SUM-FIELD_NRK.
           READ TABLE T_BEVALLO INTO W_SUM
                WITH KEY ABEVAZ = C_ABEVAZ_7688.
           IF SY-SUBRC EQ 0 AND NOT W_SUM-FIELD_C IS INITIAL.
             READ TABLE T_BEVALLO INTO W_SUM
                  WITH KEY ABEVAZ = C_ABEVAZ_8279.
             IF SY-SUBRC EQ 0.
               W_/ZAK/BEVALLO-FIELD_N = ABS( W_SUM-FIELD_NRK ).
               L_UPD = 'X'.
             ENDIF.
           ELSEIF SY-SUBRC EQ 0 AND W_SUM-FIELD_C IS INITIAL.
             W_/ZAK/BEVALLO-FIELD_N = ABS( L_SUM ).
             L_UPD = 'X'.
           ENDIF.
         ENDIF.

     ENDCASE.

* fill in all numerical values ​​for calculated fields!
* the procedure for forming an amount is as follows:
* pl: ABEV3 field_n = ABEV1 field_nrk + ABEV2 field_nrk
* then apply the default rounding rule!
     IF NOT W_/ZAK/BEVALLB-COLLECT IS INITIAL AND
        L_UPD EQ 'X'.
       CLEAR L_ROUND.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                   W_/ZAK/BEVALLB-ROUND
                   W_/ZAK/BEVALLO-WAERS
          CHANGING W_/ZAK/BEVALLO-FIELD_NR
                   W_/ZAK/BEVALLO-FIELD_NRK.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       CLEAR: L_SUM,L_UPD.
     ENDIF.
     CLEAR: L_UPD,L_SUM,L_ROUND.

   ENDLOOP.

*  Calculation of dependent fields
   REFRESH LR_ABEVAZ.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_7689 SPACE.
ENHANCEMENT-POINT /ZAK/ZAK_1065_RG_02 SPOTS /ZAK/FUNCTIONS_ES .

   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_ABEVAZ.
     CLEAR : L_SUM,W_/ZAK/BEVALLO.
* this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
     V_TABIX = SY-TABIX .
     CLEAR: W_/ZAK/BEVALLO-FIELD_N,
            W_/ZAK/BEVALLO-FIELD_NR,
            W_/ZAK/BEVALLO-FIELD_NRK.


     CASE W_/ZAK/BEVALLB-ABEVAZ.

*00D I do not request a referral
       WHEN C_ABEVAZ_7689.
         READ TABLE T_BEVALLO INTO W_SUM
              WITH KEY ABEVAZ = C_ABEVAZ_8281.
         IF SY-SUBRC EQ 0 AND W_SUM-FIELD_N NE 0.
           W_/ZAK/BEVALLO-FIELD_C = C_X.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ELSEIF SY-SUBRC EQ 0 AND W_SUM-FIELD_N EQ 0.
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.


     ENDCASE.
ENHANCEMENT-POINT /ZAK/ZAK_1065_RG_03 SPOTS /ZAK/FUNCTIONS_ES .


* fill in all numerical values ​​for calculated fields!
* the procedure for forming an amount is as follows:
* pl: ABEV3 field_n = ABEV1 field_nrk + ABEV2 field_nrk
* then apply the default rounding rule!
     IF NOT W_/ZAK/BEVALLB-COLLECT IS INITIAL AND
        L_UPD EQ 'X'.
       CLEAR L_ROUND.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                   W_/ZAK/BEVALLB-ROUND
                   W_/ZAK/BEVALLO-WAERS
          CHANGING W_/ZAK/BEVALLO-FIELD_NR
                   W_/ZAK/BEVALLO-FIELD_NRK.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       CLEAR: L_SUM,L_UPD.
     ENDIF.
     CLEAR: L_UPD,L_SUM,L_ROUND.

   ENDLOOP.

************************************************************************
****
* calculation of self-check allowance
************************************************************************
****
   IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
* if 8277 - 8276 > 0 then this value, otherwise 0
     LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
       WHERE  ABEVAZ EQ     C_ABEVAZ_203.
       CLEAR: L_SUM,L_SUM_203.
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_8276  OR
                ABEVAZ EQ     C_ABEVAZ_8277.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_8276.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM < 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_203 = L_SUM_203 + L_SUM.
       CLEAR L_SUM.
* (8283 - 8282) < 0 then the calculated value is minus
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_8283  OR
                ABEVAZ EQ     C_ABEVAZ_8282.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_8282.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM > 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_203 = L_SUM_203 - L_SUM.
       CLEAR L_SUM.
* 8281 - 8280 < 0 then the calculated value is minus
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_8281  OR
                ABEVAZ EQ     C_ABEVAZ_8280.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_8280.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM > 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_203 = L_SUM_203 - L_SUM.
       CLEAR L_SUM.
*     If 8273-8272 < 0, it must be reduced by this amount
*     az L_SUM_203-at.
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                            WITH KEY ABEVAZ = C_ABEVAZ_8273.
       IF SY-SUBRC EQ 0.
         L_SUM = W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                            WITH KEY ABEVAZ = C_ABEVAZ_8272.
       IF SY-SUBRC EQ 0.
         L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       IF L_SUM < 0.
*++ BG 2009.06.17
         L_SUM_SAVE = ABS( L_SUM ).
*-- BG 2009.06.17
         ADD L_SUM TO L_SUM_203.
       ENDIF.

       IF L_SUM_203 < 0.
*++ BG 2009.06.17
         ADD L_SUM_203 TO L_SUM_SAVE.
*-- BG 2009.06.17
         CLEAR L_SUM_203.
       ENDIF.
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
       WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
       V_TABIX = SY-TABIX .
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING L_SUM_203
                     W_/ZAK/BEVALLB-ROUND
                     W_/ZAK/BEVALLO-WAERS
            CHANGING W_/ZAK/BEVALLO-FIELD_NR
                     W_/ZAK/BEVALLO-FIELD_NRK.
         W_/ZAK/BEVALLO-FIELD_N = L_SUM_203.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       ENDIF.
     ENDLOOP.
ENHANCEMENT-POINT /ZAK/ZAK_1065_RG_04 SPOTS /ZAK/FUNCTIONS_ES .

* determination of self-control allowance
* Calculation of ABEV 205 based on 203, if the index is 2 or greater, then x1.5

     IF W_/ZAK/BEVALLO-ZINDEX NE '000'.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_205.
       IF SY-SUBRC EQ 0.
         CLEAR L_SUM.
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                              WITH KEY ABEVAZ = C_ABEVAZ_203.
         IF SY-SUBRC = 0.
           L_SUM = W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
* period definition
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                              WITH KEY ABEVAZ = C_ABEVAZ_7652.
         IF SY-SUBRC EQ 0 AND
         NOT W_/ZAK/BEVALLO-FIELD_C IS INITIAL .
* determining the deadline for calculating the allowance! the 104
* I don't need a tax for the /ZAK/ADONEM table key !!

           SELECT SINGLE FIZHAT INTO W_/ZAK/ADONEM-FIZHAT FROM /ZAK/ADONEM
                                 WHERE BUKRS  EQ W_/ZAK/BEVALLO-BUKRS AND
                                                  ADONEM EQ C_ADONEM_104
                                                  .
           IF SY-SUBRC EQ 0.
* start date of allowance calculation
             CLEAR L_KAM_KEZD.
             L_KAM_KEZD = $DATE + 1 + W_/ZAK/ADONEM-FIZHAT.
* end date of allowance calculation in the character field of row 5299 above
             CLEAR L_KAM_VEG.
             CALL FUNCTION 'CONVERSION_EXIT_IDATE_INPUT'
               EXPORTING
                 INPUT  = W_/ZAK/BEVALLO-FIELD_C
               IMPORTING
                 OUTPUT = L_KAM_VEG.
*++2012.01.06 BG
*             L_KAM_VEG = L_KAM_VEG - 15 .
*--2012.01.06 BG
* allowance calculation
             PERFORM CALC_POTLEK USING    W_/ZAK/BEVALLO-BUKRS
                                          W_/ZAK/BEVALLO-ZINDEX
                                 CHANGING L_KAM_KEZD
                                          L_KAM_VEG
                                          L_SUM
                                          L_KAMAT. " 203 --> 205
             READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                                  WITH KEY ABEVAZ = C_ABEVAZ_205.
             V_TABIX = SY-TABIX.
             IF SY-SUBRC = 0.
               W_/ZAK/BEVALLO-FIELD_N = L_KAMAT.
               PERFORM CALC_FIELD_NRK USING L_KAMAT
                          W_/ZAK/BEVALLB-ROUND
                          W_/ZAK/BEVALLO-WAERS
                 CHANGING W_/ZAK/BEVALLO-FIELD_NR
                          W_/ZAK/BEVALLO-FIELD_NRK.
*++BG 2009.05.18
*              The value of the 0 flag must be handled in the form control
*              miatt:
               IF NOT W_/ZAK/BEVALLO-FIELD_N IS INITIAL AND
                  W_/ZAK/BEVALLO-FIELD_NRK IS INITIAL.
                 W_/ZAK/BEVALLO-NULL_FLAG = 'X'.
               ENDIF.
*--BG 2009.05.18
               MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
             ENDIF.
           ENDIF.
         ENDIF.
       ENDIF.
*++ BG 2009.06.17
*      If there is a value, 203 must be corrected.
       IF NOT L_SUM_SAVE IS INITIAL.
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
         WITH KEY ABEVAZ = C_ABEVAZ_203.
         V_TABIX = SY-TABIX .
         IF SY-SUBRC EQ 0.
           ADD L_SUM_SAVE TO W_/ZAK/BEVALLO-FIELD_N.
           READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                WITH KEY ABEVAZ = C_ABEVAZ_203.
           IF SY-SUBRC EQ 0.
             PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                         W_/ZAK/BEVALLB-ROUND
                         W_/ZAK/BEVALLO-WAERS
                CHANGING W_/ZAK/BEVALLO-FIELD_NR
                         W_/ZAK/BEVALLO-FIELD_NRK.
             MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
           ENDIF.
         ENDIF.
       ENDIF.
*-- BG 2009.06.17
     ENDIF.
   ENDIF.

*++ BG 2009.06.17
*  0 flag field management
* If field1 is not 0 or field2 is not 0 or field3 is not 0 or field4 is not 0
* or field 5 not 0 then 0 flag setting
   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_205
                              "0-flag beállítás
                                     C_ABEVAZ_203           "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6
*-- BG 2009.06.17
 ENDFORM.                    " CALC_ABEV_AFA_1065

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_AFA_1165
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_AFA_1165  TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                 T_BEVALLB STRUCTURE /ZAK/BEVALLB
                           USING $DATE.

   DATA: L_SUM      LIKE /ZAK/BEVALLO-FIELD_N,
         L_SUM_203  LIKE /ZAK/BEVALLO-FIELD_N,
*++ BG 2009.06.17
         L_SUM_SAVE LIKE /ZAK/BEVALLO-FIELD_N,
*-- BG 2009.06.17
         L_KAMAT    LIKE /ZAK/BEVALLO-FIELD_N,
         L_ABEV_SUM LIKE /ZAK/BEVALLO-FIELD_N.
   DATA: L_KAM_KEZD  TYPE DATUM,
         L_KAM_VEG   TYPE DATUM,
         L_ROUND(20) TYPE C,
         L_TABIX     LIKE SY-TABIX,
         L_UPD.
************************************************************************
* Special abev fields

******************************************************** CSAK ÁFA normál

   DATA: W_SZ TYPE /ZAK/BEVALLB.

   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.

*  Loading calculated fields
   REFRESH LR_ABEVAZ.
   M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_8272 C_ABEVAZ_8283.
   M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_23335 C_ABEVAZ_23339.
   M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_24004 C_ABEVAZ_24005.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_24008 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_7995 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_7996 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_23700 SPACE.



   SORT T_BEVALLB BY ABEVAZ  .
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_ABEVAZ.
     CLEAR : L_SUM,W_/ZAK/BEVALLO.
* this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
     V_TABIX = SY-TABIX .
     CLEAR: W_/ZAK/BEVALLO-FIELD_N,
            W_/ZAK/BEVALLO-FIELD_NR,
            W_/ZAK/BEVALLO-FIELD_NRK.


     CASE W_/ZAK/BEVALLB-ABEVAZ.
* 72.C. Amount of tax to be paid
       WHEN C_ABEVAZ_8277.
         CLEAR L_SUM.
         READ TABLE T_BEVALLO INTO W_SUM
         WITH KEY ABEVAZ = C_ABEVAZ_8275.
         IF SY-SUBRC = 0.
           IF W_SUM-FIELD_N > 0.
             L_SUM = W_SUM-FIELD_NRK.
             W_/ZAK/BEVALLO-FIELD_N = L_SUM.
           ELSE.
             CLEAR W_/ZAK/BEVALLO-FIELD_N.
           ENDIF.
           L_UPD = 'X'.
         ENDIF.
* 00C Declaration period from
       WHEN C_ABEVAZ_23335.
* Havi
         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* A year old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'E'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+4(4) = '0101'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* He is four years old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.

           L_KAM_KEZD = $DATE.
           IF L_KAM_KEZD+4(2) >= '01' AND
              L_KAM_KEZD+4(2) <= '03'.

             L_KAM_KEZD+4(4) = '0101'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '04' AND
              L_KAM_KEZD+4(2) <= '06'.

             L_KAM_KEZD+4(4) = '0401'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '07' AND
              L_KAM_KEZD+4(2) <= '09'.

             L_KAM_KEZD+4(4) = '0701'.
           ENDIF.


           IF L_KAM_KEZD+4(2) >= '10' AND
              L_KAM_KEZD+4(2) <= '12'.

             L_KAM_KEZD+4(4) = '1001'.
           ENDIF.

           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ELSE.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ENDIF.

         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*00C Declaration period from
       WHEN C_ABEVAZ_23336.
         W_/ZAK/BEVALLO-FIELD_C = $DATE.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*00C Nature of declaration
       WHEN C_ABEVAZ_23338.
*++ 20110418 RN ismételt önrev. kezelés módosult a 1065-höz képest
**        ZINDEX = '001' --> 'O'     "önellenőrzés
**        ZINDEX > '001' --> 'I'     "ismételt önellenőrzés
*         IF W_/ZAK/BEVALLO-ZINDEX = '001'.
*           W_/ZAK/BEVALLO-FIELD_C = 'O'.
*           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*         ELSEIF W_/ZAK/BEVALLO-ZINDEX > '001'.
*           W_/ZAK/BEVALLO-FIELD_C = 'I'.
*           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*         ENDIF.

*        ZINDEX >= '001' --> 'O' "self check
         IF W_/ZAK/BEVALLO-ZINDEX GE '001'.
           W_/ZAK/BEVALLO-FIELD_C = 'O'.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
*-04 sheets Self-revision (repeated)
       WHEN C_ABEVAZ_23700.
*        ZINDEX > '001' --> 'X' "repeated self-check
         IF W_/ZAK/BEVALLO-ZINDEX > '001'.
           W_/ZAK/BEVALLO-FIELD_C = 'X'.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
*-- 20110418 RN
*00C Declaration frequency /H-monthly, N-quarterly, E-yearly
       WHEN C_ABEVAZ_23339.
         W_/ZAK/BEVALLO-FIELD_C = W_/ZAK/BEVALL-BIDOSZ.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*70.B. It can be calculated from the previous period
       WHEN C_ABEVAZ_8272.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8273
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*71.B. Established in the subject period
       WHEN C_ABEVAZ_8274.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8275
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*72.B. Amount of tax to be paid
       WHEN C_ABEVAZ_8276.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8277
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*73.B. It is not organized in terms of Pü
       WHEN C_ABEVAZ_8278.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8279
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*74.B. Amount of recoverable tax
       WHEN C_ABEVAZ_8280.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8281
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*74.B. It can be carried over to the next period
       WHEN C_ABEVAZ_8282.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8283
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*00F year month day
       WHEN C_ABEVAZ_24008.
         W_/ZAK/BEVALLO-FIELD_C = SY-DATUM.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
* Claimable,
       WHEN  C_ABEVAZ_8281.
         READ TABLE T_BEVALLO INTO W_SUM
              WITH KEY ABEVAZ = C_ABEVAZ_8275.
         IF SY-SUBRC EQ 0 AND W_SUM-FIELD_N < 0.
           CLEAR L_SUM.
           L_SUM = W_SUM-FIELD_NRK.
           READ TABLE T_BEVALLO INTO W_SUM
                WITH KEY ABEVAZ = C_ABEVAZ_24005.
           IF SY-SUBRC EQ 0 AND NOT W_SUM-FIELD_C IS INITIAL.
             READ TABLE T_BEVALLO INTO W_SUM
                  WITH KEY ABEVAZ = C_ABEVAZ_8279.
             IF SY-SUBRC EQ 0.
               SUBTRACT W_SUM-FIELD_NRK FROM L_SUM.
               W_/ZAK/BEVALLO-FIELD_N = ABS( L_SUM ).
               L_UPD = 'X'.
             ENDIF.
           ELSEIF SY-SUBRC EQ 0 AND W_SUM-FIELD_C IS INITIAL.
             CLEAR W_/ZAK/BEVALLO-FIELD_N.
             L_UPD = 'X'.
           ENDIF.
         ENDIF.
*Carried over to next period
       WHEN  C_ABEVAZ_8283.
         READ TABLE T_BEVALLO INTO W_SUM
              WITH KEY ABEVAZ = C_ABEVAZ_8275.
         IF SY-SUBRC EQ 0 AND W_SUM-FIELD_N < 0.
           CLEAR L_SUM.
           L_SUM = W_SUM-FIELD_NRK.
           READ TABLE T_BEVALLO INTO W_SUM
                WITH KEY ABEVAZ = C_ABEVAZ_24005.
           IF SY-SUBRC EQ 0 AND NOT W_SUM-FIELD_C IS INITIAL.
             READ TABLE T_BEVALLO INTO W_SUM
                  WITH KEY ABEVAZ = C_ABEVAZ_8279.
             IF SY-SUBRC EQ 0.
               W_/ZAK/BEVALLO-FIELD_N = ABS( W_SUM-FIELD_NRK ).
               L_UPD = 'X'.
             ENDIF.
           ELSEIF SY-SUBRC EQ 0 AND W_SUM-FIELD_C IS INITIAL.
             W_/ZAK/BEVALLO-FIELD_N = ABS( L_SUM ).
             L_UPD = 'X'.
           ENDIF.
         ENDIF.

     ENDCASE.

* fill in all numerical values ​​for calculated fields!
* the procedure for forming an amount is as follows:
* pl: ABEV3 field_n = ABEV1 field_nrk + ABEV2 field_nrk
* then apply the default rounding rule!
     IF NOT W_/ZAK/BEVALLB-COLLECT IS INITIAL AND
        L_UPD EQ 'X'.
       CLEAR L_ROUND.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                   W_/ZAK/BEVALLB-ROUND
                   W_/ZAK/BEVALLO-WAERS
          CHANGING W_/ZAK/BEVALLO-FIELD_NR
                   W_/ZAK/BEVALLO-FIELD_NRK.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       CLEAR: L_SUM,L_UPD.
     ENDIF.
     CLEAR: L_UPD,L_SUM,L_ROUND.

   ENDLOOP.

*  Calculation of dependent fields
   REFRESH LR_ABEVAZ.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_24004 SPACE.
ENHANCEMENT-POINT /ZAK/ZAK_1165_RG_01 SPOTS /ZAK/FUNCTIONS_ES .

   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_ABEVAZ.
     CLEAR : L_SUM,W_/ZAK/BEVALLO.
* this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
     V_TABIX = SY-TABIX .
     CLEAR: W_/ZAK/BEVALLO-FIELD_N,
            W_/ZAK/BEVALLO-FIELD_NR,
            W_/ZAK/BEVALLO-FIELD_NRK.


     CASE W_/ZAK/BEVALLB-ABEVAZ.

*00D I do not request a referral
       WHEN C_ABEVAZ_24004.
         READ TABLE T_BEVALLO INTO W_SUM
              WITH KEY ABEVAZ = C_ABEVAZ_8281.
         IF SY-SUBRC EQ 0 AND W_SUM-FIELD_N NE 0.
           W_/ZAK/BEVALLO-FIELD_C = C_X.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ELSEIF SY-SUBRC EQ 0 AND W_SUM-FIELD_N EQ 0.
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.


     ENDCASE.
ENHANCEMENT-POINT /ZAK/ZAK_1165_RG_02 SPOTS /ZAK/FUNCTIONS_ES .


* fill in all numerical values ​​for calculated fields!
* the procedure for forming an amount is as follows:
* pl: ABEV3 field_n = ABEV1 field_nrk + ABEV2 field_nrk
* then apply the default rounding rule!
     IF NOT W_/ZAK/BEVALLB-COLLECT IS INITIAL AND
        L_UPD EQ 'X'.
       CLEAR L_ROUND.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                   W_/ZAK/BEVALLB-ROUND
                   W_/ZAK/BEVALLO-WAERS
          CHANGING W_/ZAK/BEVALLO-FIELD_NR
                   W_/ZAK/BEVALLO-FIELD_NRK.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       CLEAR: L_SUM,L_UPD.
     ENDIF.
     CLEAR: L_UPD,L_SUM,L_ROUND.

   ENDLOOP.

************************************************************************
****
* calculation of self-check allowance
************************************************************************
****
   IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
* if 8277 - 8276 > 0 then this value, otherwise 0
     LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
       WHERE  ABEVAZ EQ     C_ABEVAZ_203.
       CLEAR: L_SUM,L_SUM_203.
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_8276  OR
                ABEVAZ EQ     C_ABEVAZ_8277.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_8276.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM < 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_203 = L_SUM_203 + L_SUM.
       CLEAR L_SUM.
* (8283 - 8282) < 0 then the calculated value is minus
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_8283  OR
                ABEVAZ EQ     C_ABEVAZ_8282.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_8282.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM > 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_203 = L_SUM_203 - L_SUM.
       CLEAR L_SUM.
* 8281 - 8280 < 0 then the calculated value is minus
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_8281  OR
                ABEVAZ EQ     C_ABEVAZ_8280.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_8280.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM > 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_203 = L_SUM_203 - L_SUM.
       CLEAR L_SUM.
*     If 8273-8272 < 0, it must be reduced by this amount
*     az L_SUM_203-at.
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                            WITH KEY ABEVAZ = C_ABEVAZ_8273.
       IF SY-SUBRC EQ 0.
         L_SUM = W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                            WITH KEY ABEVAZ = C_ABEVAZ_8272.
       IF SY-SUBRC EQ 0.
         L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       IF L_SUM < 0.
*++ BG 2009.06.17
         L_SUM_SAVE = ABS( L_SUM ).
*-- BG 2009.06.17
         ADD L_SUM TO L_SUM_203.
       ENDIF.

       IF L_SUM_203 < 0.
*++ BG 2009.06.17
         ADD L_SUM_203 TO L_SUM_SAVE.
*-- BG 2009.06.17
         CLEAR L_SUM_203.
       ENDIF.
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
       WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
       V_TABIX = SY-TABIX .
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING L_SUM_203
                     W_/ZAK/BEVALLB-ROUND
                     W_/ZAK/BEVALLO-WAERS
            CHANGING W_/ZAK/BEVALLO-FIELD_NR
                     W_/ZAK/BEVALLO-FIELD_NRK.
         W_/ZAK/BEVALLO-FIELD_N = L_SUM_203.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       ENDIF.
     ENDLOOP.
ENHANCEMENT-POINT /ZAK/ZAK_1165_RG_03 SPOTS /ZAK/FUNCTIONS_ES .

* determination of self-control allowance
* Calculation of ABEV 205 based on 203, if the index is 2 or greater, then x1.5

     IF W_/ZAK/BEVALLO-ZINDEX NE '000'.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_205.
       IF SY-SUBRC EQ 0.
         CLEAR L_SUM.
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                              WITH KEY ABEVAZ = C_ABEVAZ_203.
         IF SY-SUBRC = 0.
           L_SUM = W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
* period definition
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                              WITH KEY ABEVAZ = C_ABEVAZ_23337.
         IF SY-SUBRC EQ 0 AND
         NOT W_/ZAK/BEVALLO-FIELD_C IS INITIAL .
* determining the deadline for calculating the allowance! the 104
* I don't need a tax for the /ZAK/ADONEM table key !!

           SELECT SINGLE FIZHAT INTO W_/ZAK/ADONEM-FIZHAT FROM /ZAK/ADONEM
                                 WHERE BUKRS  EQ W_/ZAK/BEVALLO-BUKRS AND
                                                  ADONEM EQ C_ADONEM_104
                                                  .
           IF SY-SUBRC EQ 0.
* start date of allowance calculation
             CLEAR L_KAM_KEZD.
             L_KAM_KEZD = $DATE + 1 + W_/ZAK/ADONEM-FIZHAT.
* end date of allowance calculation in the character field of row 5299 above
             CLEAR L_KAM_VEG.
             CALL FUNCTION 'CONVERSION_EXIT_IDATE_INPUT'
               EXPORTING
                 INPUT  = W_/ZAK/BEVALLO-FIELD_C
               IMPORTING
                 OUTPUT = L_KAM_VEG.
*++2012.01.06 BG
*             L_KAM_VEG = L_KAM_VEG - 15 .
*--2012.01.06 BG
* allowance calculation
             PERFORM CALC_POTLEK USING    W_/ZAK/BEVALLO-BUKRS
                                          W_/ZAK/BEVALLO-ZINDEX
                                 CHANGING L_KAM_KEZD
                                          L_KAM_VEG
                                          L_SUM
                                          L_KAMAT. " 203 --> 205
             READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                                  WITH KEY ABEVAZ = C_ABEVAZ_205.
             V_TABIX = SY-TABIX.
             IF SY-SUBRC = 0.
               W_/ZAK/BEVALLO-FIELD_N = L_KAMAT.
               PERFORM CALC_FIELD_NRK USING L_KAMAT
                          W_/ZAK/BEVALLB-ROUND
                          W_/ZAK/BEVALLO-WAERS
                 CHANGING W_/ZAK/BEVALLO-FIELD_NR
                          W_/ZAK/BEVALLO-FIELD_NRK.
*++BG 2009.05.18
*              The value of the 0 flag must be handled in the form control
*              miatt:
               IF NOT W_/ZAK/BEVALLO-FIELD_N IS INITIAL AND
                  W_/ZAK/BEVALLO-FIELD_NRK IS INITIAL.
                 W_/ZAK/BEVALLO-NULL_FLAG = 'X'.
               ENDIF.
*--BG 2009.05.18
               MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
             ENDIF.
           ENDIF.
         ENDIF.
       ENDIF.
*++ BG 2009.06.17
*      If there is a value, 203 must be corrected.
       IF NOT L_SUM_SAVE IS INITIAL.
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
         WITH KEY ABEVAZ = C_ABEVAZ_203.
         V_TABIX = SY-TABIX .
         IF SY-SUBRC EQ 0.
           ADD L_SUM_SAVE TO W_/ZAK/BEVALLO-FIELD_N.
           READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                WITH KEY ABEVAZ = C_ABEVAZ_203.
           IF SY-SUBRC EQ 0.
             PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                         W_/ZAK/BEVALLB-ROUND
                         W_/ZAK/BEVALLO-WAERS
                CHANGING W_/ZAK/BEVALLO-FIELD_NR
                         W_/ZAK/BEVALLO-FIELD_NRK.
             MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
           ENDIF.
         ENDIF.
       ENDIF.
*-- BG 2009.06.17
     ENDIF.
   ENDIF.

*++ BG 2009.06.17
*  0 flag field management
* If field1 is not 0 or field2 is not 0 or field3 is not 0 or field4 is not 0
* or field 5 not 0 then 0 flag setting
   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_205
                              "0-flag beállítás
                                     C_ABEVAZ_203           "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6
*-- BG 2009.06.17
 ENDFORM.                    " CALC_ABEV_AFA_1165



*&---------------------------------------------------------------------*
*&      Form  TRANSLATE_CODEPAGE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_0277   text
*      -->P_0278   text
*      -->P_LW_FILE  text
*----------------------------------------------------------------------*
 FORM TRANSLATE_CODEPAGE  USING    $CODE_FROM
                                   $CODE_TO
                                   $STRING.

   DATA: CONVERTER TYPE REF TO CL_ABAP_CONV_OBJ.
   DATA: L_OUT TYPE STRING.
   DATA: L_FROMCODE TYPE CPCODEPAGE.
   DATA: L_TOCODE TYPE CPCODEPAGE.
   L_FROMCODE = $CODE_FROM.
   L_TOCODE   = $CODE_TO.

   CREATE OBJECT CONVERTER
     EXPORTING
       INCODE           = L_FROMCODE
       MISS             = '.'
       BROKEN           = '.'
       USE_F1           = 'X'
       OUTCODE          = L_TOCODE
     EXCEPTIONS
       INVALID_CODEPAGE = 1
       INTERNAL_ERROR   = 2.
   IF SY-SUBRC EQ 0.
     CALL METHOD CONVERTER->CONVERT
       EXPORTING
         INBUFF         = $STRING
         INBUFFLG       = 0
         OUTBUFFLG      = 0
       IMPORTING
         OUTBUFF        = L_OUT
       EXCEPTIONS
         INTERNAL_ERROR = 1
         OTHERS         = 2.
     IF SY-SUBRC EQ 0.
       $STRING = L_OUT.
     ENDIF.
   ENDIF.

 ENDFORM.                    " TRANSLATE_CODEPAGE
*&---------------------------------------------------------------------*
*&      Form  get_value_in_abevaz
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_LR_ABEVAZ  text
*      -->P_8007   text
*      -->P_C_ABEVAZ_A0FC0116BA  text
*----------------------------------------------------------------------*
 FORM GET_VALUE_IN_M_ABEVAZ  TABLES $T_BEVALLO     STRUCTURE /ZAK/BEVALLO
                                    $R_ABEVAZ  STRUCTURE /ZAK/RANGE_C17
                           USING    $VALUE
                                    $ABEV_0.
   DATA L_TABIX LIKE SY-TABIX.

   READ TABLE $T_BEVALLO WITH KEY ABEVAZ = $ABEV_0
                                  BINARY SEARCH.
   IF SY-SUBRC EQ 0.
     MOVE SY-TABIX TO L_TABIX.
   ENDIF.

*  Search for value
   LOOP AT $T_BEVALLO WHERE ABEVAZ IN $R_ABEVAZ
                               AND FIELD_C EQ $VALUE.
     EXIT.
   ENDLOOP.
   IF SY-SUBRC EQ 0.
     MOVE C_X TO $T_BEVALLO-NULL_FLAG.
     MODIFY $T_BEVALLO INDEX L_TABIX TRANSPORTING NULL_FLAG.
   ENDIF.

 ENDFORM.                    " get_value_in_abevaz

*&---------------------------------------------------------------------*
*&      Form  get_value_in_abevaz
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_LR_ABEVAZ  text
*      -->P_8007   text
*      -->P_C_ABEVAZ_A0FC0116BA  text
*----------------------------------------------------------------------*
 FORM GET_VALUE_IN_M_ABEVAZ_M TABLES $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                     $T_ADOAZON_ALL STRUCTURE
                                                    /ZAK/ADOAZONLPSZ
                                     $R_VALUE  STRUCTURE RANGE_C3
                             USING   $ABEV_0
                                     $ABEV_1.
   DATA L_TABIX LIKE SY-TABIX.


*  Search for value
   LOOP AT $T_ADOAZON_ALL.
*++BG 2011.02.28
*     READ TABLE $T_BEVALLO WITH KEY ABEVAZ = $ABEV_0
*                                  ADOAZON = $T_ADOAZON_ALL-ADOAZON
*                                  LAPSZ   = $T_ADOAZON_ALL-LAPSZ
*                                  BINARY SEARCH.
*     IF SY-SUBRC EQ 0.
*       MOVE SY-TABIX TO L_TABIX.
*     ELSE.
*       CONTINUE.
*     ENDIF.
*--BG 2011.02.28
     READ TABLE $T_BEVALLO WITH KEY ABEVAZ  = $ABEV_1
                                    ADOAZON = $T_ADOAZON_ALL-ADOAZON
                                    LAPSZ   = $T_ADOAZON_ALL-LAPSZ
                                    BINARY SEARCH.

     IF SY-SUBRC EQ 0 AND $T_BEVALLO-FIELD_C IN $R_VALUE.

       READ TABLE $T_BEVALLO WITH KEY ABEVAZ = $ABEV_0
                                    ADOAZON = $T_ADOAZON_ALL-ADOAZON
                                    LAPSZ   = $T_ADOAZON_ALL-LAPSZ
                                    BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         MOVE SY-TABIX TO L_TABIX.
       ELSE.
         $T_BEVALLO-ABEVAZ = $T_BEVALLO-ABEVAZ_DISP = $ABEV_0.
         CLEAR: $T_BEVALLO-FIELD_C,
                $T_BEVALLO-FIELD_N,
                $T_BEVALLO-FIELD_NR,
                $T_BEVALLO-FIELD_NRK,
                $T_BEVALLO-WAERS,
                $T_BEVALLO-GET_ABEVAZ,
                $T_BEVALLO-OFLAG,
                $T_BEVALLO-FIELD_ON,
                $T_BEVALLO-FIELD_ONR,
                $T_BEVALLO-FIELD_ONRK,
                $T_BEVALLO-NULL_FLAG.
         SELECT SINGLE ROUND INTO $T_BEVALLO-ROUND
                             FROM /ZAK/BEVALLB
                            WHERE BTYPE  EQ $T_BEVALLO-BTYPE
                              AND ABEVAZ EQ $T_BEVALLO-ABEVAZ.
         APPEND $T_BEVALLO. SORT $T_BEVALLO.
         READ TABLE $T_BEVALLO WITH KEY ABEVAZ = $ABEV_0
                                      ADOAZON = $T_ADOAZON_ALL-ADOAZON
                                      LAPSZ   = $T_ADOAZON_ALL-LAPSZ
                                      BINARY SEARCH.
         IF SY-SUBRC EQ 0.
           MOVE SY-TABIX TO L_TABIX.
         ENDIF.
       ENDIF.
       MOVE C_X TO $T_BEVALLO-NULL_FLAG.
       MODIFY $T_BEVALLO INDEX L_TABIX TRANSPORTING NULL_FLAG.
     ENDIF.
   ENDLOOP.

 ENDFORM.                    " get_value_in_abevaz
*&---------------------------------------------------------------------*
*&      Form  get_value_in_abevaz
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_LR_ABEVAZ  text
*      -->P_8007   text
*      -->P_C_ABEVAZ_A0FC0116BA  text
*----------------------------------------------------------------------*
 FORM GET_VALUE_IN_M_ABEVAZ_M2 TABLES $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                      $T_ADOAZON_ALL STRUCTURE
                                                     /ZAK/ADOAZONLPSZ
                                      $R_VALUE  STRUCTURE RANGE_C3
                              USING   $ABEV_0
                                      $ABEV_1
                                      $ABEV_2.
   DATA L_TABIX LIKE SY-TABIX.


*  Search for value
   LOOP AT $T_ADOAZON_ALL.
*++BG 2011.02.28
*     READ TABLE $T_BEVALLO WITH KEY ABEVAZ = $ABEV_0
*                                  ADOAZON = $T_ADOAZON_ALL-ADOAZON
*                                  LAPSZ   = $T_ADOAZON_ALL-LAPSZ
*                                  BINARY SEARCH.
*     IF SY-SUBRC EQ 0.
*       MOVE SY-TABIX TO L_TABIX.
*     ELSE.
*       CONTINUE.
*     ENDIF.
*--BG 2011.02.28
     READ TABLE $T_BEVALLO WITH KEY ABEVAZ  = $ABEV_2
                                    ADOAZON = $T_ADOAZON_ALL-ADOAZON
                                    LAPSZ   = $T_ADOAZON_ALL-LAPSZ
                                    BINARY SEARCH.

     IF SY-SUBRC EQ 0 AND NOT $T_BEVALLO-FIELD_C  IS INITIAL.
       READ TABLE $T_BEVALLO WITH KEY ABEVAZ  = $ABEV_1
                                      ADOAZON = $T_ADOAZON_ALL-ADOAZON
*                                      LAPSZ   = $T_ADOAZON_ALL-LAPSZ
                                      LAPSZ   = '0001'
                                      BINARY SEARCH.

       IF SY-SUBRC EQ 0 AND $T_BEVALLO-FIELD_C IN $R_VALUE.

         READ TABLE $T_BEVALLO WITH KEY ABEVAZ = $ABEV_0
                                      ADOAZON = $T_ADOAZON_ALL-ADOAZON
                                      LAPSZ   = $T_ADOAZON_ALL-LAPSZ
                                      BINARY SEARCH.
         IF SY-SUBRC EQ 0.
           MOVE SY-TABIX TO L_TABIX.
         ELSE.
           $T_BEVALLO-ABEVAZ = $T_BEVALLO-ABEVAZ_DISP = $ABEV_0.
           CLEAR: $T_BEVALLO-FIELD_C,
                  $T_BEVALLO-FIELD_N,
                  $T_BEVALLO-FIELD_NR,
                  $T_BEVALLO-FIELD_NRK,
                  $T_BEVALLO-WAERS,
                  $T_BEVALLO-GET_ABEVAZ,
                  $T_BEVALLO-OFLAG,
                  $T_BEVALLO-FIELD_ON,
                  $T_BEVALLO-FIELD_ONR,
                  $T_BEVALLO-FIELD_ONRK,
                  $T_BEVALLO-NULL_FLAG.
           SELECT SINGLE ROUND INTO $T_BEVALLO-ROUND
                               FROM /ZAK/BEVALLB
                              WHERE BTYPE  EQ $T_BEVALLO-BTYPE
                                AND ABEVAZ EQ $T_BEVALLO-ABEVAZ.
           APPEND $T_BEVALLO. SORT $T_BEVALLO.
           READ TABLE $T_BEVALLO WITH KEY ABEVAZ = $ABEV_0
                                       ADOAZON = $T_ADOAZON_ALL-ADOAZON
                                        LAPSZ   = $T_ADOAZON_ALL-LAPSZ
                                        BINARY SEARCH.
           IF SY-SUBRC EQ 0.
             MOVE SY-TABIX TO L_TABIX.
           ENDIF.
         ENDIF.
         MOVE C_X TO $T_BEVALLO-NULL_FLAG.
         MODIFY $T_BEVALLO INDEX L_TABIX TRANSPORTING NULL_FLAG.
       ENDIF.
     ENDIF.
   ENDLOOP.

 ENDFORM.                    " get_value_in_abevaz


*&---------------------------------------------------------------------*
*&      Form  get_value_in_abevaz
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_LR_ABEVAZ  text
*      -->P_8007   text
*      -->P_C_ABEVAZ_A0FC0116BA  text
*----------------------------------------------------------------------*
 FORM GET_VALUE_IN_M_ABEVAZ_M3 TABLES $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                      $T_ADOAZON_ALL STRUCTURE
                                                     /ZAK/ADOAZONLPSZ
                                      $R_VALUE  STRUCTURE RANGE_C3
                                      $R_VALUE2 STRUCTURE RANGE_C3
                              USING   $ABEV_0
                                      $ABEV_1
                                      $ABEV_2.
   DATA L_TABIX LIKE SY-TABIX.


*  Search for value
   LOOP AT $T_ADOAZON_ALL.
*++BG 2011.02.28
*     READ TABLE $T_BEVALLO WITH KEY ABEVAZ = $ABEV_0
*                                  ADOAZON = $T_ADOAZON_ALL-ADOAZON
*                                  LAPSZ   = $T_ADOAZON_ALL-LAPSZ
*                                  BINARY SEARCH.
*     IF SY-SUBRC EQ 0.
*       MOVE SY-TABIX TO L_TABIX.
*     ELSE.
*       CONTINUE.
*     ENDIF.
*--BG 2011.02.28
     READ TABLE $T_BEVALLO WITH KEY ABEVAZ  = $ABEV_2
                                    ADOAZON = $T_ADOAZON_ALL-ADOAZON
                                    LAPSZ   = $T_ADOAZON_ALL-LAPSZ
                                    BINARY SEARCH.

     IF SY-SUBRC EQ 0 AND $T_BEVALLO-FIELD_C IN $R_VALUE2.
       READ TABLE $T_BEVALLO WITH KEY ABEVAZ  = $ABEV_1
                                      ADOAZON = $T_ADOAZON_ALL-ADOAZON
*                                      LAPSZ   = $T_ADOAZON_ALL-LAPSZ
                                      LAPSZ   = '0001'
                                      BINARY SEARCH.

       IF SY-SUBRC EQ 0 AND $T_BEVALLO-FIELD_C IN $R_VALUE.

         READ TABLE $T_BEVALLO WITH KEY ABEVAZ = $ABEV_0
                                      ADOAZON = $T_ADOAZON_ALL-ADOAZON
                                      LAPSZ   = $T_ADOAZON_ALL-LAPSZ
                                      BINARY SEARCH.
         IF SY-SUBRC EQ 0.
           MOVE SY-TABIX TO L_TABIX.
         ELSE.
           $T_BEVALLO-ABEVAZ = $T_BEVALLO-ABEVAZ_DISP = $ABEV_0.
           CLEAR: $T_BEVALLO-FIELD_C,
                  $T_BEVALLO-FIELD_N,
                  $T_BEVALLO-FIELD_NR,
                  $T_BEVALLO-FIELD_NRK,
                  $T_BEVALLO-WAERS,
                  $T_BEVALLO-GET_ABEVAZ,
                  $T_BEVALLO-OFLAG,
                  $T_BEVALLO-FIELD_ON,
                  $T_BEVALLO-FIELD_ONR,
                  $T_BEVALLO-FIELD_ONRK,
                  $T_BEVALLO-NULL_FLAG.
           SELECT SINGLE ROUND INTO $T_BEVALLO-ROUND
                               FROM /ZAK/BEVALLB
                              WHERE BTYPE  EQ $T_BEVALLO-BTYPE
                                AND ABEVAZ EQ $T_BEVALLO-ABEVAZ.
           APPEND $T_BEVALLO. SORT $T_BEVALLO.
           READ TABLE $T_BEVALLO WITH KEY ABEVAZ = $ABEV_0
                                       ADOAZON = $T_ADOAZON_ALL-ADOAZON
                                        LAPSZ   = $T_ADOAZON_ALL-LAPSZ
                                        BINARY SEARCH.
           IF SY-SUBRC EQ 0.
             MOVE SY-TABIX TO L_TABIX.
           ENDIF.
         ENDIF.
         MOVE C_X TO $T_BEVALLO-NULL_FLAG.
         MODIFY $T_BEVALLO INDEX L_TABIX TRANSPORTING NULL_FLAG.
       ENDIF.
     ENDIF.
   ENDLOOP.

 ENDFORM.                    " get_value_in_abevaz

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_M_SZJA_1108
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_M_SZJA_1108 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                   T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                   T_ADOAZON_ALL STRUCTURE
                                                 /ZAK/ADOAZONLPSZ
                           USING   $INDEX
                                   $LAST_DATE.

   SORT T_BEVALLB BY ABEVAZ.
   SORT T_BEVALLO BY ABEVAZ ADOAZON LAPSZ.


*  Special M calculations as a tax ID
*  field0 = ( field1 - field2 ) * field3
*++2011.03.10 BG
**  M0BC0372DA
*   PERFORM GET_SUB_MULT_M  TABLES T_BEVALLO
*                                  T_BEVALLB
*                                  T_ADOAZON_ALL
*                           USING C_ABEVAZ_M0BC0372DA "field0
*                                  C_ABEVAZ_M0BC0371DA "field1
*                                  SPACE "field2
*                                  '0.27'.                   "field 3
*--2011.03.10 BG
*  M0BC0373DA
*  field0 = field1+field2+.....field6.
   PERFORM GET_SUM_M   TABLES T_BEVALLO
                              T_BEVALLB
                              T_ADOAZON_ALL
                       USING  C_ABEVAZ_M0BC0373DA           "mező0
                              C_ABEVAZ_M0BC0371DA           "mező1
                              C_ABEVAZ_M0BC0372DA           "mező2
                              SPACE                         "mező3
                              SPACE                         "mező4
                              SPACE                         "mező5
                              SPACE.                        "mező6

*  M0BC0375DA
*  field0 = field1-field2.
   PERFORM GET_SUB_M   TABLES T_BEVALLO
                              T_BEVALLB
                              T_ADOAZON_ALL
                       USING  C_ABEVAZ_M0BC0375DA           "mező0
                              C_ABEVAZ_M0BC0373DA           "mező1
                              C_ABEVAZ_M0BC0374DA           "mező2
*++1408 2014.02.10 BG
                              '-'.      "Az eredmény lehet '-'
*--1408 2014.02.10 BG

*  M0BC0376DA
*  field0 = field1+field2+.....field6.
   PERFORM GET_SUM_M   TABLES T_BEVALLO
                              T_BEVALLB
                              T_ADOAZON_ALL
                       USING  C_ABEVAZ_M0BC0376DA           "mező0
                              C_ABEVAZ_M0BC0360DA           "mező1
                              C_ABEVAZ_M0BC0361DA           "mező2
                              C_ABEVAZ_M0BC0362DA           "mező3
                              C_ABEVAZ_M0BC0369AA           "mező4
                              C_ABEVAZ_M0BC0370AA           "mező5
                              SPACE.                        "mező6

*  M0BC0377DA
   PERFORM GET_SUB_MULT_M  TABLES T_BEVALLO
                                  T_BEVALLB
                                  T_ADOAZON_ALL
                           USING  C_ABEVAZ_M0BC0377DA       "mező0
                                  C_ABEVAZ_M0BC0376DA       "mező1
                                  SPACE                     "mező2
                                  '1.27'.                   "mező3

*  A0ZZ000001
   PERFORM GET_SUM_CALC  TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ZZ000001   "Módosított mező
                                C_ABEVAZ_M0BC0371DA         "Forrás 1
                                C_ABEVAZ_M0CC0424BA         "Forrás 2
                                C_ABEVAZ_M0CC0425BA         "Forrás 3
                                C_ABEVAZ_M0CC0426CA         "Forrás 4
                                SPACE                       "Forrás 5
                                SPACE                       "Forrás 6
                                SPACE                       "Forrás 7
                                SPACE                       "Forrás 8
                                SPACE                       "Forrás 9
                                SPACE.                      "Forrás 10

*  A0ZZ000002
   PERFORM GET_SUM_CALC  TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ZZ000002   "Módosított mező
                                C_ABEVAZ_M0EC0468CA         "Forrás 1
                                C_ABEVAZ_M0EC0466CA         "Forrás 2
                                SPACE                       "Forrás 3
                                SPACE                       "Forrás 4
                                SPACE                       "Forrás 5
                                SPACE                       "Forrás 6
                                SPACE                       "Forrás 7
                                SPACE                       "Forrás 8
                                SPACE                       "Forrás 9
                                SPACE.                      "Forrás 10

*  A0ZZ000003
   PERFORM GET_SUM_CALC  TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ZZ000003   "Módosított mező
                                C_ABEVAZ_M0KE0720CA         "Forrás 1
                                SPACE                       "Forrás 2
                                SPACE                       "Forrás 3
                                SPACE                       "Forrás 4
                                SPACE                       "Forrás 5
                                SPACE                       "Forrás 6
                                SPACE                       "Forrás 7
                                SPACE                       "Forrás 8
                                SPACE                       "Forrás 9
                                SPACE.                      "Forrás 10

 ENDFORM.                    " CALC_ABEV_M_SZJA_1108

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_SZJA_1108
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$LAST_DATE  text
*      -->P_$INDEX  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SZJA_1108  TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                   T_BEVALLB STRUCTURE /ZAK/BEVALLB
                            USING  $DATE
                                   $INDEX.

   DATA: L_KAM_KEZD TYPE DATUM.

   DATA: BEGIN OF LI_ADOAZON OCCURS 0,
           ADOAZON TYPE /ZAK/ADOAZON,
         END OF LI_ADOAZON.
   DATA: L_BEVALLO TYPE /ZAK/BEVALLO.

*  To define a self-check
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.
   RANGES LR_SEL_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.

************************************************************************
* Special abev fields
************************************************************************

   SORT T_BEVALLB BY ABEVAZ  .

* the following abev codes can only occur once, summary v. char

   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC042A SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0GC001A SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC040A SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC041A SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC046A SPACE.


   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_SEL_ABEVAZ.

     CLEAR W_/ZAK/BEVALLO.

*    this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
          BINARY SEARCH.

     CHECK SY-SUBRC EQ 0.
     V_TABIX = SY-TABIX .


     CASE W_/ZAK/BEVALLB-ABEVAZ.
*      period from first day
       WHEN C_ABEVAZ_A0AC040A.
* Havi
         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* A year old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'E'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+4(4) = '0101'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* He is four years old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.

           L_KAM_KEZD = $DATE.
           IF L_KAM_KEZD+4(2) >= '01' AND
              L_KAM_KEZD+4(2) <= '03'.

             L_KAM_KEZD+4(4) = '0101'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '04' AND
              L_KAM_KEZD+4(2) <= '06'.

             L_KAM_KEZD+4(4) = '0401'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '07' AND
              L_KAM_KEZD+4(2) <= '09'.

             L_KAM_KEZD+4(4) = '0701'.
           ENDIF.


           IF L_KAM_KEZD+4(2) >= '10' AND
              L_KAM_KEZD+4(2) <= '12'.

             L_KAM_KEZD+4(4) = '1001'.
           ENDIF.

           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ELSE.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*      last day until period
       WHEN C_ABEVAZ_A0AC041A.
         W_/ZAK/BEVALLO-FIELD_C = $DATE.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*      Number of taxpayers = Tax numbers
       WHEN C_ABEVAZ_A0AC046A.

         REFRESH LI_ADOAZON.
         LOOP AT T_BEVALLO INTO L_BEVALLO.
           CHECK NOT L_BEVALLO-ADOAZON IS INITIAL.
           MOVE L_BEVALLO-ADOAZON TO LI_ADOAZON.
           COLLECT LI_ADOAZON.
         ENDLOOP.


         DESCRIBE TABLE LI_ADOAZON LINES SY-TFILL.
         IF NOT SY-TFILL IS INITIAL.
           W_/ZAK/BEVALLO-FIELD_C = SY-TFILL.
         ELSE.
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
         ENDIF.

         CONDENSE W_/ZAK/BEVALLO-FIELD_C.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*      Correction, Self-check
       WHEN C_ABEVAZ_A0AC042A.
*        Only in self-check
         IF $INDEX NE '000'.
           REFRESH LR_ABEVAZ.
*          A numerical value must be searched for in this range
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0GD0150CA
                                    C_ABEVAZ_A0GD0180DA.
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0HC0181DA
                                    C_ABEVAZ_A0HF0225BA.
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0IC0230CA
                                    C_ABEVAZ_A0IC0248IA.
           LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ IN LR_ABEVAZ
*          We monitor the rounded sum because it may be FIELD_N
*          it is not empty, but no value is added to the return because of the fkator.
*                                          AND NOT FIELD_N  IS INITIAL.
                                           AND NOT FIELD_NR IS INITIAL.
             EXIT.
           ENDLOOP.
*          There is value:
           IF SY-SUBRC EQ 0.
             W_/ZAK/BEVALLO-FIELD_C = 'O'.
*          Corrective
           ELSE.
             W_/ZAK/BEVALLO-FIELD_C = 'H'.
           ENDIF.
           CONDENSE W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
*      Repeated self-check
       WHEN C_ABEVAZ_A0GC001A.
*        Only in self-check
         IF $INDEX > '001'.
           REFRESH LR_ABEVAZ.
*          A numerical value must be searched for in this range
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0GD0150CA
                                    C_ABEVAZ_A0GD0180DA.
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0HC0181DA
                                    C_ABEVAZ_A0HF0225BA.
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0IC0230CA
                                    C_ABEVAZ_A0IC0248IA.
           LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ IN LR_ABEVAZ
*          We monitor the rounded sum because it may be FIELD_N
*          it is not empty, but no value is added to the return because of the fkator.
*                                          AND NOT FIELD_N  IS INITIAL.
                                           AND NOT FIELD_NR IS INITIAL.
             EXIT.
           ENDLOOP.
*          There is value:
           IF SY-SUBRC EQ 0.
             W_/ZAK/BEVALLO-FIELD_C = 'X'.
           ENDIF.
           CONDENSE W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.

     ENDCASE.




   ENDLOOP.

 ENDFORM.                    " CALC_ABEV_SZJA_1108
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_0_SZJA_1108
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_ADOAZON_ALL  text
*      -->P_SPACE  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_0_SZJA_1108  TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                              T_ADOAZON_ALL STRUCTURE /ZAK/ADOAZONLPSZ
                              USING   $ONREV
                                      $DATE
                                      $INDEX.

   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.
   DATA   LR_VALUE  LIKE RANGE_C3 OCCURS 0 WITH HEADER LINE.
*++2011.07.11 BG
   DATA   LR_VALUE2 LIKE RANGE_C3 OCCURS 0 WITH HEADER LINE.
*--2011.07.11 BG
* So that you don't have to expand the self-revision to a global one for every FORM
* treated as a variable:
   CLEAR V_ONREV.
   IF NOT $ONREV IS INITIAL.
     MOVE $ONREV TO V_ONREV.
   ENDIF.

**  Ha mező1 >= mező2 akkor mező3 0 flag beállítás
*   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
*                                T_ADOAZON_ALL
*                         USING C_ABEVAZ_M0BC0382CA "field1
*                                C_ABEVAZ_M0BC0382BA "field2
*                                C_ABEVAZ_M0BC0382DA.        "field 3
**  Ha mező1+mező2+mező3+mező4 > 0 akkor 0 flag beállítás
*   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
*                              USING  C_ABEVAZ_A0IC0284HA
*                              "0-flag setting
*                                     C_ABEVAZ_A0IC0284CA "field1
*                                     C_ABEVAZ_A0IC0284DA "field2
*                                     C_ABEVAZ_A0IC0284EA "field3
*                                     SPACE.                 "field 4
** Ha mező1 ne 0 vagy mező2 ne 0 vagy mező3 ne 0 vagy mező4 ne 0
** vagy mező5 ne 0 akkor 0 flag beállítás
*   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
*                              USING  C_ABEVAZ_A0DC0087DA    "0flag
*                                     C_ABEVAZ_A0DC0087CA "field1
*                                     SPACE "field2
*                                     SPACE "field3
*                                     SPACE "field4
*                                     SPACE "field5
*                                     SPACE.                 "field 6
*   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
*                                      T_ADOAZON_ALL
*                               USING  C_ABEVAZ_M0CC0415DA   "0flag
*                                      C_ABEVAZ_M0BC0382BA "field1
*                                      C_ABEVAZ_M0BC0386BA "field2
*                                      SPACE "field3
*                                      SPACE "field4
*                                      SPACE "field5
*                                      SPACE.                "field 6
** mező1-n 0 flag állítás
*     PERFORM GET_NULL_FLAG_0     TABLES T_BEVALLO
*                                 USING  C_ABEVAZ_A0BC50041A.
* If field1 = field2 then 0 flag is set
*   PERFORM GET_NULL_FLAG_EQM TABLES T_BEVALLO
*                                    T_ADOAZON_ALL
*                             USING C_ABEVAZ_M0FD0496AA "field1
*                                    C_ABEVAZ_M0FD0495AA "field2
*                                    C_ABEVAZ_M0FD0498BA     "0-flag
*                                    C_ABEVAZ_M0FD0497BA.    "0-flag


* If ABEV identifiers have the desired value, set the flag to 0
   REFRESH LR_ABEVAZ.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0HD0570BA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0IE0609BA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0IF0633BA SPACE.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '261'
                                        C_ABEVAZ_A0FC0130CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '262'
                                        C_ABEVAZ_A0FC0131CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '263'
                                        C_ABEVAZ_A0FC0132CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '265'
                                        C_ABEVAZ_A0FC0133CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '266'
                                        C_ABEVAZ_A0FC0134CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '267'
                                        C_ABEVAZ_A0FC0135CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '268'
                                        C_ABEVAZ_A0FC0136CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '269'
                                        C_ABEVAZ_A0FC0137CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '270'
                                        C_ABEVAZ_A0FC0138CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '271'
                                        C_ABEVAZ_A0FC0139CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '272'
                                        C_ABEVAZ_A0FC0140CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '273'
                                        C_ABEVAZ_A0FC0141CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '274'
                                        C_ABEVAZ_A0FC0142CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '275'
                                        C_ABEVAZ_A0FC0143CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '276'
                                        C_ABEVAZ_A0FC0144CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '277'
                                        C_ABEVAZ_A0FC0145CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '278'
                                        C_ABEVAZ_A0FC0146CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '279'
                                        C_ABEVAZ_A0FC0147CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   '282'
                                        C_ABEVAZ_A0FC0148CA.

   REFRESH LR_VALUE.
   M_DEF LR_VALUE  'I' 'BT' '261' '282'.

   PERFORM GET_VALUE_IN_M_ABEVAZ_M TABLES T_BEVALLO
                                          T_ADOAZON_ALL
                                          LR_VALUE
                                   USING  C_ABEVAZ_M0HD0569CA "0 flag
                                          C_ABEVAZ_M0HD0570BA."értékmező

   PERFORM GET_VALUE_IN_M_ABEVAZ_M TABLES T_BEVALLO
                                          T_ADOAZON_ALL
                                          LR_VALUE
                                   USING  C_ABEVAZ_M0HD0570CA "0 flag
                                          C_ABEVAZ_M0HD0570BA."értékmező

   PERFORM GET_VALUE_IN_M_ABEVAZ_M TABLES T_BEVALLO
                                          T_ADOAZON_ALL
                                          LR_VALUE
                                   USING  C_ABEVAZ_M0IE0608CA "0 flag
                                          C_ABEVAZ_M0IE0609BA."értékmező

   PERFORM GET_VALUE_IN_M_ABEVAZ_M TABLES T_BEVALLO
                                          T_ADOAZON_ALL
                                          LR_VALUE
                                   USING  C_ABEVAZ_M0IE0609CA "0 flag
                                          C_ABEVAZ_M0IE0609BA."értékmező

   PERFORM GET_VALUE_IN_M_ABEVAZ_M TABLES T_BEVALLO
                                          T_ADOAZON_ALL
                                          LR_VALUE
                                    USING C_ABEVAZ_M0IF0632CA "0 flag
                                          C_ABEVAZ_M0IF0633BA."értékmező

   PERFORM GET_VALUE_IN_M_ABEVAZ_M TABLES T_BEVALLO
                                          T_ADOAZON_ALL
                                          LR_VALUE
                                    USING C_ABEVAZ_M0IF0633CA "0 flag
                                          C_ABEVAZ_M0IF0633BA."értékmező

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0230IA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0230DA    "mező1
                                     C_ABEVAZ_A0IC0230EA    "mező2
                                     C_ABEVAZ_A0IC0230FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0231IA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0231DA    "mező1
                                     C_ABEVAZ_A0IC0231EA    "mező2
                                     C_ABEVAZ_A0IC0231FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0232IA
                              "0-flag beállítás
                                     C_ABEVAZ_A0IC0232DA    "mező1
                                     C_ABEVAZ_A0IC0232EA    "mező2
                                     C_ABEVAZ_A0IC0232FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0233IA    "0flag
                                     C_ABEVAZ_A0IC0233DA    "mező1
                                     C_ABEVAZ_A0IC0233EA    "mező2
                                     C_ABEVAZ_A0IC0233FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0234IA    "0flag
                                     C_ABEVAZ_A0IC0234DA    "mező1
                                     C_ABEVAZ_A0IC0234EA    "mező2
                                     C_ABEVAZ_A0IC0234FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0235IA    "0flag
                                     C_ABEVAZ_A0IC0235DA    "mező1
                                     C_ABEVAZ_A0IC0235EA    "mező2
                                     C_ABEVAZ_A0IC0235FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0236IA    "0flag
                                     C_ABEVAZ_A0IC0236DA    "mező1
                                     C_ABEVAZ_A0IC0236EA    "mező2
                                     C_ABEVAZ_A0IC0236FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0237IA    "0flag
                                     C_ABEVAZ_A0IC0237DA    "mező1
                                     C_ABEVAZ_A0IC0237EA    "mező2
                                     C_ABEVAZ_A0IC0237FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0238IA    "0flag
                                     C_ABEVAZ_A0IC0238DA    "mező1
                                     C_ABEVAZ_A0IC0238EA    "mező2
                                     C_ABEVAZ_A0IC0238FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0239IA    "0flag
                                     C_ABEVAZ_A0IC0239DA    "mező1
                                     C_ABEVAZ_A0IC0239EA    "mező2
                                     C_ABEVAZ_A0IC0239FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0240IA    "0flag
                                     C_ABEVAZ_A0IC0240DA    "mező1
                                     C_ABEVAZ_A0IC0240EA    "mező2
                                     C_ABEVAZ_A0IC0240FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0241IA    "0flag
                                     C_ABEVAZ_A0IC0241DA    "mező1
                                     C_ABEVAZ_A0IC0241EA    "mező2
                                     C_ABEVAZ_A0IC0241FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0242IA    "0flag
                                     C_ABEVAZ_A0IC0242DA    "mező1
                                     C_ABEVAZ_A0IC0242EA    "mező2
                                     C_ABEVAZ_A0IC0242FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0243IA    "0flag
                                     C_ABEVAZ_A0IC0243DA    "mező1
                                     C_ABEVAZ_A0IC0243EA    "mező2
                                     C_ABEVAZ_A0IC0243FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0244IA    "0flag
                                     C_ABEVAZ_A0IC0244DA    "mező1
                                     C_ABEVAZ_A0IC0244EA    "mező2
                                     C_ABEVAZ_A0IC0244FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0245IA    "0flag
                                     C_ABEVAZ_A0IC0245DA    "mező1
                                     C_ABEVAZ_A0IC0245EA    "mező2
                                     C_ABEVAZ_A0IC0245FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0246IA    "0flag
                                     C_ABEVAZ_A0IC0246DA    "mező1
                                     C_ABEVAZ_A0IC0246EA    "mező2
                                     C_ABEVAZ_A0IC0246FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0247IA    "0flag
                                     C_ABEVAZ_A0IC0247DA    "mező1
                                     C_ABEVAZ_A0IC0247EA    "mező2
                                     C_ABEVAZ_A0IC0247FA    "mező3
                                     SPACE.                 "mező4

   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0IC0248IA    "0flag
                                     C_ABEVAZ_A0IC0248DA    "mező1
                                     C_ABEVAZ_A0IC0248EA    "mező2
                                     C_ABEVAZ_A0IC0248FA    "mező3
                                     SPACE.                 "mező4

*  If field1 >= field2 then field3 0 flag setting
   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0361CA         "mező1
                                C_ABEVAZ_M0BC0361BA         "mező2
                                C_ABEVAZ_M0BC0361DA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0361DA         "mező1
                                C_ABEVAZ_M0BC0361BA         "mező2
                                C_ABEVAZ_M0BC0361CA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0364CA         "mező1
                                C_ABEVAZ_M0BC0364BA         "mező2
                                C_ABEVAZ_M0BC0364DA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0364DA         "mező1
                                C_ABEVAZ_M0BC0364BA         "mező2
                                C_ABEVAZ_M0BC0364CA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0365CA         "mező1
                                C_ABEVAZ_M0BC0365BA         "mező2
                                C_ABEVAZ_M0BC0365DA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0365DA         "mező1
                                C_ABEVAZ_M0BC0365BA         "mező2
                                C_ABEVAZ_M0BC0365CA.        "mező3

*++2011.05.10 BG
   REFRESH LR_VALUE.
   M_DEF LR_VALUE  'I' 'BT' '15' '16'.
   M_DEF LR_VALUE  'I' 'BT' '19' '20'.
   M_DEF LR_VALUE  'I' 'BT' '19' '20'.
   M_DEF LR_VALUE  'I' 'EQ' '30' ''.
   M_DEF LR_VALUE  'I' 'BT' '34' '35'.
   M_DEF LR_VALUE  'I' 'EQ' '37' ''.
   M_DEF LR_VALUE  'I' 'EQ' '39' ''.
   M_DEF LR_VALUE  'I' 'EQ' '41' ''.
   M_DEF LR_VALUE  'I' 'EQ' '46' ''.
   M_DEF LR_VALUE  'I' 'BT' '68' '73'.
   M_DEF LR_VALUE  'I' 'EQ' '80' ''.
   M_DEF LR_VALUE  'I' 'EQ' '82' ''.
   M_DEF LR_VALUE  'I' 'BT' '90' '91'.

   PERFORM GET_VALUE_IN_M_ABEVAZ_M TABLES T_BEVALLO
                                          T_ADOAZON_ALL
                                          LR_VALUE
                                   USING  C_ABEVAZ_M0HD0555CA "0 flag
                                          C_ABEVAZ_M0HC004A.  "értékmező
*--2011.05.10 BG



   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0556CA   "0flag
                                      C_ABEVAZ_M0HD0555CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0557CA   "0flag
                                      C_ABEVAZ_M0HD0555CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0558CA   "0flag
                                      C_ABEVAZ_M0HD0555CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0562CA   "0flag
                                      C_ABEVAZ_M0HD0561CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6
*++2011.05.10 BG
*   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
*                                      T_ADOAZON_ALL
*                               USING  C_ABEVAZ_M0HD0565CA   "0flag
*                                      C_ABEVAZ_M0HD0570BA "field1
*                                      SPACE "field2
*                                      SPACE "field3
*                                      SPACE "field4
*                                      SPACE "field5
*                                      SPACE.                "field 6
*--2011.05.10 BG
*++2011.07.11 BG
*  Value field 2 is in LR_VALUE2, then it looks up according to value field 1.
*  ATTENTION ONLY SEARCH ON PAGE NUMBER 0001
   REFRESH: LR_VALUE, LR_VALUE2.
   M_DEF LR_VALUE   'I' 'EQ' 'N' SPACE.
   M_DEF LR_VALUE2  'E' 'BT' '2' '3'.

   PERFORM GET_VALUE_IN_M_ABEVAZ_M3 TABLES T_BEVALLO
                                          T_ADOAZON_ALL
                                          LR_VALUE
                                          LR_VALUE2
                                   USING  C_ABEVAZ_M0HD0565CA "0 flag
                                          C_ABEVAZ_M0AE005A "érték1
                                          C_ABEVAZ_M0HC003A. "érték2
*--2011.07.11 BG

*++2011.04.08 BG
*  If value field 2 is not initial, it is checked according to value field 1.
*  ATTENTION ONLY SEARCH ON PAGE NUMBER 0001
   REFRESH LR_VALUE.
   M_DEF LR_VALUE  'I' 'EQ' 'N' SPACE.

   PERFORM GET_VALUE_IN_M_ABEVAZ_M2 TABLES T_BEVALLO
                                          T_ADOAZON_ALL
                                          LR_VALUE
                                   USING  C_ABEVAZ_M0HD0568CA "0 flag
                                          C_ABEVAZ_M0AE005A "érték1
                                          C_ABEVAZ_M0HC005A. "érték2
*--2011.04.08 BG

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0568CA   "0flag
                                      C_ABEVAZ_M0HD0565CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0568CA   "0flag
                                      C_ABEVAZ_M0HD0566CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0568CA   "0flag
                                      C_ABEVAZ_M0HD0567CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0569CA   "0flag
                                      C_ABEVAZ_M0HD0570BA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0570CA   "0flag
                                      C_ABEVAZ_M0HD0570BA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0574CA   "0flag
                                      C_ABEVAZ_M0HD0573CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0576CA   "0flag
                                      C_ABEVAZ_M0HD0575CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0HD0578CA   "0flag
                                      C_ABEVAZ_M0HD0577CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0BC0375DA   "0flag
                                      C_ABEVAZ_M0BC0373DA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0IE0608CA   "0flag
                                      C_ABEVAZ_M0IE0609BA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0IE0609CA   "0flag
                                      C_ABEVAZ_M0IE0609BA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0IF0632CA   "0flag
                                      C_ABEVAZ_M0IF0633BA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0IF0633CA   "0flag
                                      C_ABEVAZ_M0IF0633BA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6
* Self-audit supplement if self-audit
   IF $INDEX NE '000'.
     PERFORM GET_NULL_FLAG_0     TABLES T_BEVALLO
                                 USING  C_ABEVAZ_A0HD0210CA.
*++ 2011.03.08 RN
     PERFORM GET_NULL_FLAG_0     TABLES T_BEVALLO
                                 USING  C_ABEVAZ_A0HD0212CA.
*-- 2011.03.08 RN
   ENDIF.
*++2011.06.09 BG
* If ABEV identifiers have the desired value, set the flag to 0
   REFRESH LR_ABEVAZ.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC042A SPACE.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   'O'
                                        C_ABEVAZ_A0GD0150CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   'O'
                                        C_ABEVAZ_A0GD0152CA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   'O'
                                        C_ABEVAZ_A0GD0150DA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   'O'
                                        C_ABEVAZ_A0GD0151DA.

   PERFORM GET_VALUE_IN_M_ABEVAZ TABLES T_BEVALLO
                                        LR_ABEVAZ
                                USING   'O'
                                        C_ABEVAZ_A0GD0152DA.
*--2011.06.09 BG

*++ 2011.04.08 BG
   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0GD0154DA    "0flag
                                     C_ABEVAZ_A0GD0157DA    "mező1
                                     C_ABEVAZ_A0GD0158DA    "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6
*-- 2011.04.08 BG

*++ 2011.08.10 BG
*  0 flag setting on field 1
   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0BD0401BA.
*-- 2011.08.10 BG

 ENDFORM.                    " CALC_ABEV_0_SZJA_1108

*&---------------------------------------------------------------------*
*&      Form  GET_LAP_SZ_1108
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*----------------------------------------------------------------------*
 FORM GET_LAP_SZ_1108  TABLES T_BEVALLO STRUCTURE  /ZAK/BEVALLALV.


   DATA L_ALV LIKE /ZAK/BEVALLALV.
   DATA L_INDEX LIKE SY-TABIX.
   DATA L_TABIX LIKE SY-TABIX.
   DATA L_NYLAP LIKE SY-TABIX.
   DATA L_BEVALLO_ALV LIKE /ZAK/BEVALLALV.
   DATA L_NULL_FLAG TYPE /ZAK/NULL.

   CLEAR L_INDEX.

*  Upload RANKS to manage retired numbers
   M_DEF R_A0AC047A 'I' 'EQ' 'M0GC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0HC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0IC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0JC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0KC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0LC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0MC003A' SPACE.
*   M_DEF R_A0AC047A 'I' 'EQ' 'M0NC001A' SPACE.

*  Values
   M_DEF R_NYLAPVAL 'I' 'EQ' '1' SPACE.
   M_DEF R_NYLAPVAL 'I' 'EQ' '2' SPACE.
   M_DEF R_NYLAPVAL 'I' 'EQ' '3' SPACE.
   M_DEF R_NYLAPVAL 'I' 'EQ' '5' SPACE.
   M_DEF R_NYLAPVAL 'I' 'EQ' '7' SPACE.


   REFRESH I_NYLAP.

   LOOP AT I_/ZAK/BEVALLO INTO W_/ZAK/BEVALLO.
     L_TABIX = SY-TABIX.

*   Dialog run for insurance
     PERFORM PROCESS_IND_ITEM USING '100000'
                                    L_INDEX
                                    TEXT-P01.

*   Csak SZJA-nal
     IF  W_/ZAK/BEVALL-BTYPART EQ C_BTYPART_SZJA.
*      Collection of pensioner tax numbers
       PERFORM CALL_NYLAP TABLES R_A0AC047A
                                 R_NYLAPVAL
                          USING  W_/ZAK/BEVALLO.

     ENDIF.

     READ TABLE T_BEVALLO INTO L_ALV WITH KEY
                   BUKRS   = W_/ZAK/BEVALLO-BUKRS
                   BTYPE   = W_/ZAK/BEVALLO-BTYPE
                   GJAHR   = W_/ZAK/BEVALLO-GJAHR
                   MONAT   = W_/ZAK/BEVALLO-MONAT
                   ZINDEX  = W_/ZAK/BEVALLO-ZINDEX
                   ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ
                   ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                   LAPSZ   = W_/ZAK/BEVALLO-LAPSZ
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
*  The 0 flag handling was not appropriate
*  If it is a self-revision calculation, the T_BEVALLO 0 flag is required
*  otherwise, the I_/ZAK/BEVALLO 0 flag.
       IF NOT L_ALV-OFLAG IS INITIAL.
         L_NULL_FLAG = L_ALV-NULL_FLAG.
       ELSE.
         L_NULL_FLAG = W_/ZAK/BEVALLO-NULL_FLAG.
       ENDIF.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
       L_ALV-NULL_FLAG = L_NULL_FLAG.
       IF L_ALV-OFLAG IS INITIAL.
         MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX
                         TRANSPORTING FIELD_C FIELD_N FIELD_NR FIELD_NRK
                                      NULL_FLAG WAERS
                                       .
       ELSE.
         MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX
                         TRANSPORTING FIELD_C FIELD_N  FIELD_NR
                         FIELD_NRK
                                      OFLAG   FIELD_ON FIELD_ONR
                                      FIELD_ONRK
                                      NULL_FLAG WAERS.
         PERFORM SUM_ONR TABLES T_BEVALLO
                         USING  L_ALV
                                L_ALV-FIELD_ON
                                L_ALV-FIELD_ONR
                                L_ALV-FIELD_ONRK.
       ENDIF.
     ELSE.
       READ TABLE I_/ZAK/BEVALLB INTO W_/ZAK/BEVALLB
       WITH KEY ABEVAZ = W_/ZAK/BEVALLO-ABEVAZ.
       MOVE-CORRESPONDING W_/ZAK/BEVALLB TO L_ALV.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
       SELECT SINGLE ABEVTEXT INTO L_ALV-ABEVTEXT
         FROM  /ZAK/BEVALLBT
              WHERE  LANGU   = SY-LANGU
              AND    BTYPE   = W_/ZAK/BEVALLO-BTYPE
              AND    ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ.
       L_ALV-ABEVTEXT_DISP = L_ALV-ABEVTEXT.
       APPEND L_ALV TO T_BEVALLO.
       SORT T_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ ADOAZON
            LAPSZ.
     ENDIF.
     DELETE I_/ZAK/BEVALLO.
   ENDLOOP.

*  Definition of pensioners
   IF NOT I_NYLAP[] IS INITIAL.
     DESCRIBE TABLE I_NYLAP LINES L_NYLAP.
     READ TABLE T_BEVALLO INTO L_BEVALLO_ALV
                          WITH KEY ABEVAZ  = C_ABEVAZ_A0AC047A
                          BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE L_NYLAP TO L_BEVALLO_ALV-FIELD_C.
       CONDENSE L_BEVALLO_ALV-FIELD_C.
       MODIFY T_BEVALLO FROM L_BEVALLO_ALV INDEX SY-TABIX
                             TRANSPORTING FIELD_C.
     ENDIF.
   ELSE.
     READ TABLE T_BEVALLO INTO L_BEVALLO_ALV
                          WITH KEY ABEVAZ  = C_ABEVAZ_A0AC047A
                          BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       CLEAR L_BEVALLO_ALV-FIELD_C.
       MODIFY T_BEVALLO FROM L_BEVALLO_ALV INDEX SY-TABIX
                             TRANSPORTING FIELD_C.
     ENDIF.
   ENDIF.

 ENDFORM.                    " GET_LAP_SZ_1108

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_SZJA_SPECIAL_1108
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*      -->P_0408   text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SZJA_SPECIAL_1108
                                 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                          T_BEVALLB STRUCTURE
                                          /ZAK/BEVALLB
                                          T_ADOAZON STRUCTURE
                                          /ZAK/ONR_ADOAZON
                                   USING  $INDEX
                                          $DATE.


   DATA LR_COND TYPE RANGE_C2 OCCURS 0 WITH HEADER LINE.
   DATA L_TMP_BEVALLO TYPE /ZAK/BEVALLO.
   DATA L_BEVALLO TYPE /ZAK/BEVALLO.

   FIELD-SYMBOLS: <FIELD_N>, <FIELD_NR>, <FIELD_NRK>.

   DEFINE LM_GET_FIELD.
     IF &1 EQ '000'.
       ASSIGN W_/ZAK/BEVALLO-FIELD_N   TO <FIELD_N>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_NR  TO <FIELD_NR>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_NRK TO <FIELD_NRK>.
     ELSE.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ON   TO <FIELD_N>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ONR  TO <FIELD_NR>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ONRK TO <FIELD_NRK>.
     ENDIF.
     CLEAR: <FIELD_N>, <FIELD_NR>, <FIELD_NRK>.
   END-OF-DEFINITION.

   DEFINE LM_GET_SPEC_SUM1.
     LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ = &1.
*      The ABEV for the condition must be determined
*      ID value
       READ TABLE T_BEVALLO INTO L_TMP_BEVALLO
                WITH KEY ABEVAZ  = &2
                         ADOAZON = L_BEVALLO-ADOAZON
                          LAPSZ  = L_BEVALLO-LAPSZ
                          BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         CONDENSE L_TMP_BEVALLO-FIELD_C.
         IF L_TMP_BEVALLO-FIELD_C IN &3.
           ADD L_BEVALLO-FIELD_N TO <FIELD_N>.
         ENDIF.
       ENDIF.
     ENDLOOP.
   END-OF-DEFINITION.

   RANGES LR_ABEVAZ     FOR /ZAK/BEVALLO-ABEVAZ.
   RANGES LR_SEL_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.


   DEFINE LM_GET_SPEC_SUM2.
     IF NOT &1[] IS INITIAL.
       LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ IN &1.
         IF $INDEX EQ '000'.
           ADD L_BEVALLO-FIELD_N TO <FIELD_N>.
         ELSE.
           ADD L_BEVALLO-FIELD_ON TO <FIELD_N>.
         ENDIF.
       ENDLOOP.
     ENDIF.
   END-OF-DEFINITION.

   SORT T_BEVALLB BY ABEVAZ.

*  Uploading selective ABEVAZ
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0050CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0052CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0053CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0054CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0055CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0056CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0057CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0058CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0059CA SPACE.

   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0080CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0082CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0083CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0085CA SPACE.

   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0100CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0101CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0102CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0103CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0104CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0105CA SPACE.

* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_SEL_ABEVAZ.

     CLEAR W_/ZAK/BEVALLO.

*    this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
              BINARY SEARCH.

     CHECK SY-SUBRC EQ 0.

     V_TABIX = SY-TABIX .

*    Special calculations
     CASE W_/ZAK/BEVALLB-ABEVAZ.
*      The 02-50-c The total burden of the pension commission (The 559,630...
       WHEN  C_ABEVAZ_A0CC0050CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '94' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0559CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0IF0630CA' 'M0HC004A' LR_COND.
*      A 02-52-c The employee is unemployed, the employment circle pays pension insurance (A 630. ..
       WHEN  C_ABEVAZ_A0CC0052CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0630CA' 'M0HC004A' LR_COND.
*      A 02-53-c The nursing care fee for the employee pension commission (Lines 630 ...
       WHEN  C_ABEVAZ_A0CC0053CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '94' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0630CA' 'M0HC004A' LR_COND.
*      A 02-53-c Private pension (Lines 568, 607, 631...
       WHEN  C_ABEVAZ_A0CC0054CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         M_DEF LR_COND 'E' 'EQ' '83' SPACE.
         M_DEF LR_COND 'E' 'EQ' '92' SPACE.
         M_DEF LR_COND 'E' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0568CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0IE0607CA' 'M0IC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0IF0631CA' 'M0IC004A' LR_COND.
*      A 02-54-c The burden of unemployment, employment pension (631.....
       WHEN  C_ABEVAZ_A0CC0055CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0IF0631CA' 'M0IC004A' LR_COND.
*      A 02-56-c The private sector pays pension after GYED, S, T (A 607.....
       WHEN  C_ABEVAZ_A0CC0056CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '83' SPACE.
         M_DEF LR_COND 'I' 'EQ' '92' SPACE.
         M_DEF LR_COND 'I' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0IE0607CA' 'M0IC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0IF0631CA' 'M0IC004A' LR_COND.
*      A 02-57-c Mnypt member private pension (Az 559,608,632 ....
       WHEN  C_ABEVAZ_A0CC0057CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         M_DEF LR_COND 'E' 'EQ' '83' SPACE.
         M_DEF LR_COND 'E' 'EQ' '92' SPACE.
         M_DEF LR_COND 'E' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0569CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0IE0608CA' 'M0IC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0IF0632CA' 'M0IC004A' LR_COND.
*      A 02-47-c Mnypt member private burden unemployment, job circle pension..
       WHEN  C_ABEVAZ_A0CC0058CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0IF0632CA' 'M0IC004A' LR_COND.
*      The 02-59-cA Mnypt member pays private tax GYED,S,T pension (608,...
       WHEN  C_ABEVAZ_A0CC0059CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '83' SPACE.
         M_DEF LR_COND 'I' 'EQ' '92' SPACE.
         M_DEF LR_COND 'I' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0IE0608CA' 'M0IC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0IF0632CA' 'M0IC004A' LR_COND.
*      A 03-80 -c A vol. burdensome insurance and labor market costs. ...
       WHEN  C_ABEVAZ_A0DC0080CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0556CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0IF0627CA' 'M0IC004A' LR_COND.
*      A 03-74-c The unemployment insurance and labor market rate for the unemployed.
       WHEN  C_ABEVAZ_A0DC0082CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0IF0627CA' 'M0IC004A' LR_COND.
*     A 03-75 -c A vol. burdensome insurance and labor market costs. monetary
       WHEN  C_ABEVAZ_A0DC0083CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0HD0557CA' 'M0HC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0IF0628CA' 'M0IC004A' LR_COND.
*     The 03-76-c The unemployment insurance and labor market rate for the unemployed ...
       WHEN  C_ABEVAZ_A0DC0085CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0IF0628CA' 'M0IC004A' LR_COND.
*     A 04-100-c Order 10%/15% with the START card (code 1: A 694,...
       WHEN  C_ABEVAZ_A0EC0100CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '1' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KD0692CA' 'M0KC007A' LR_COND.
         LM_GET_SPEC_SUM1 'M0KD0694CA' 'M0KC007A' LR_COND.
*     A 04-101-c Order 20%/25% with the START card (code 1: A 695,693.
       WHEN  C_ABEVAZ_A0EC0101CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '1' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KD0693CA' 'M0KC007A' LR_COND.
         LM_GET_SPEC_SUM1 'M0KD0695CA' 'M0KC007A' LR_COND.
*      A 04-102-c A START PLUS plan 10%/15% (code 2: A 654.692
       WHEN  C_ABEVAZ_A0EC0102CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '2' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KD0692CA' 'M0KC007A' LR_COND.
         LM_GET_SPEC_SUM1 'M0KD0694CA' 'M0KC007A' LR_COND.
*      A 04-103-c A START PLUS order 20%/255% (code 2: A 654.,692
       WHEN  C_ABEVAZ_A0EC0103CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '2' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KD0693CA' 'M0KC007A' LR_COND.
         LM_GET_SPEC_SUM1 'M0KD0695CA' 'M0KC007A' LR_COND.
*      Order 04-104-c with the START EXTRA card is 0% (code 3.4: A 691.
       WHEN  C_ABEVAZ_A0EC0104CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'BT' '3' '4'.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KD0691CA' 'M0KC007A' LR_COND.
*      A 04-91-c A 10%/15% order with the START EXTRA card (code 3: A 692
       WHEN  C_ABEVAZ_A0EC0105CA.
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '3' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0KD0692CA' 'M0KC007A' LR_COND.
         LM_GET_SPEC_SUM1 'M0KD0694CA' 'M0KC007A' LR_COND.

     ENDCASE.

     PERFORM CALC_FIELD_NRK USING <FIELD_N>
                  W_/ZAK/BEVALLB-ROUND
                  W_/ZAK/BEVALLO-WAERS
         CHANGING <FIELD_NR>
                  <FIELD_NRK>.
     IF $INDEX NE '000'.
       MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
     ENDIF.
     MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.


   ENDLOOP.


 ENDFORM.                    " CALC_ABEV_SZJA_SPECIAL_1108
*&---------------------------------------------------------------------*
*&      Form  del_esdat_field_1008
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_C_ABEVAZ_A0AC033A  text
*----------------------------------------------------------------------*
 FORM DEL_ESDAT_FIELD_1108 TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLALV
                                    $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                           USING    $ABEVAZ_JELLEG.

   DATA LW_/ZAK/BEVALLALV TYPE /ZAK/BEVALLALV.

*  We define the character:
   READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                         WITH KEY ABEVAZ = $ABEVAZ_JELLEG
                         BINARY SEARCH.
*  In this case, you do not need to fill in the due date:
   IF SY-SUBRC EQ 0 AND LW_/ZAK/BEVALLALV-FIELD_C = 'H'.
*  ABEV ID value marked in ESDAT_FLAG
     READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                         WITH KEY  ESDAT_FLAG = 'X'.
     IF SY-SUBRC EQ 0.
       READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                           WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
                           BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         V_TABIX = SY-TABIX .
         CLEAR LW_/ZAK/BEVALLALV-FIELD_C.
         MODIFY $T_BEVALLO FROM LW_/ZAK/BEVALLALV
                               INDEX V_TABIX TRANSPORTING FIELD_C.
       ENDIF.
     ENDIF.
*++2011.04.09 BG
*  For correctors, there is no need for 0 flag in the self-check allowance either
     READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                         WITH KEY ABEVAZ = C_ABEVAZ_A0HD0210CA
                         BINARY SEARCH.
     IF SY-SUBRC EQ 0 AND NOT LW_/ZAK/BEVALLALV-NULL_FLAG IS INITIAL.
       V_TABIX = SY-TABIX .
       CLEAR LW_/ZAK/BEVALLALV-NULL_FLAG.
       MODIFY $T_BEVALLO FROM LW_/ZAK/BEVALLALV
                             INDEX V_TABIX TRANSPORTING NULL_FLAG.
     ENDIF.
*--2011.04.09 BG
   ENDIF.

 ENDFORM.                    " del_esdat_field_1008

*&---------------------------------------------------------------------*
*&      Form  GET_ADOSZ_xxK79
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_I_ADOAZON_ALL  text
*      -->P_C_ABEVAZ_A0AC028A  text
*----------------------------------------------------------------------*
 FORM GET_ADOSZ_XXK79  TABLES  $T_BEVALLO     STRUCTURE /ZAK/BEVALLALV
                               $T_ADOAZON_ALL STRUCTURE
                               /ZAK/ADOAZONLPSZ
                       USING   $ABEVAZ_ADOSZ.

   DATA LW_/ZAK/BEVALLALV TYPE /ZAK/BEVALLALV.
   DATA L_TABIX LIKE SY-TABIX.

*  We determine the number of taxpayers:
   READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                         WITH KEY ABEVAZ = $ABEVAZ_ADOSZ
                         BINARY SEARCH.
   CHECK SY-SUBRC EQ 0.
   MOVE SY-TABIX TO L_TABIX.
   DESCRIBE TABLE $T_ADOAZON_ALL LINES  LW_/ZAK/BEVALLALV-FIELD_C.
   MODIFY $T_BEVALLO FROM LW_/ZAK/BEVALLALV INDEX L_TABIX
                     TRANSPORTING FIELD_C.

 ENDFORM.                    " GET_ADOSZ_xxK79
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_M_SZJA_1208
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_M_SZJA_1208 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                   T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                   T_ADOAZON_ALL STRUCTURE
                                                 /ZAK/ADOAZONLPSZ
                           USING   $INDEX
                                   $LAST_DATE.

   SORT T_BEVALLB BY ABEVAZ.
   SORT T_BEVALLO BY ABEVAZ ADOAZON LAPSZ.


*  Special M calculations as a tax ID
*  M0BC0373DA
*  field0 = field1+field2+.....field6.
   PERFORM GET_SUM_M   TABLES T_BEVALLO
                              T_BEVALLB
                              T_ADOAZON_ALL
                       USING  C_ABEVAZ_M0BC0373DA           "mező0
                              C_ABEVAZ_M0BC0370DA           "mező1
                              C_ABEVAZ_M0BC0372DA           "mező2
                              SPACE                         "mező3
                              SPACE                         "mező4
                              SPACE                         "mező5
                              SPACE.                        "mező6

*  M0BC0375DA
*  field0 = field1-field2.
   PERFORM GET_SUB_M   TABLES T_BEVALLO
                              T_BEVALLB
                              T_ADOAZON_ALL
                       USING  C_ABEVAZ_M0BC0375DA           "mező0
                              C_ABEVAZ_M0BC0373DA           "mező1
                              C_ABEVAZ_M0BC0374DA           "mező2
*++1408 2014.02.10 BG
                              '-'.      "Az eredmény lehet '-'
*--1408 2014.02.10 BG


*  M0BC0376DA
*  field0 = field1+field2+.....field6.
   PERFORM GET_SUM_M   TABLES T_BEVALLO
                              T_BEVALLB
                              T_ADOAZON_ALL
                       USING  C_ABEVAZ_M0BC0376DA           "mező0
                              C_ABEVAZ_M0BC0360DA           "mező1
                              C_ABEVAZ_M0BC0361DA           "mező2
                              C_ABEVAZ_M0BC0362DA           "mező3
                              C_ABEVAZ_M0BC0368AA           "mező4
                              C_ABEVAZ_M0BC0369AA           "mező5
                              SPACE.                        "mező6

*  A0ZZ000001
   PERFORM GET_SUM_CALC  TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ZZ000001   "Módosított mező
                                C_ABEVAZ_M0BC0370DA         "Forrás 1
                                C_ABEVAZ_M0CC0424BA         "Forrás 2
                                C_ABEVAZ_M0CC0425BA         "Forrás 3
                                C_ABEVAZ_M0CC0426CA         "Forrás 4
                                SPACE                       "Forrás 5
                                SPACE                       "Forrás 6
                                SPACE                       "Forrás 7
                                SPACE                       "Forrás 8
                                SPACE                       "Forrás 9
                                SPACE.                      "Forrás 10

 ENDFORM.                    " CALC_ABEV_M_SZJA_1208
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_SZJA_SPECIAL_1208
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*      -->P_0408   text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SZJA_SPECIAL_1208
                                 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                          T_BEVALLB STRUCTURE
                                          /ZAK/BEVALLB
                                          T_ADOAZON STRUCTURE
                                          /ZAK/ONR_ADOAZON
                                   USING  $INDEX
                                          $DATE.


   DATA LR_COND TYPE RANGE_C2 OCCURS 0 WITH HEADER LINE.
   DATA L_TMP_BEVALLO TYPE /ZAK/BEVALLO.
   DATA L_BEVALLO TYPE /ZAK/BEVALLO.

   FIELD-SYMBOLS: <FIELD_N>, <FIELD_NR>, <FIELD_NRK>.

   DEFINE LM_GET_FIELD.
     IF &1 EQ '000'.
       ASSIGN W_/ZAK/BEVALLO-FIELD_N   TO <FIELD_N>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_NR  TO <FIELD_NR>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_NRK TO <FIELD_NRK>.
     ELSE.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ON   TO <FIELD_N>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ONR  TO <FIELD_NR>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ONRK TO <FIELD_NRK>.
     ENDIF.
     CLEAR: <FIELD_N>, <FIELD_NR>, <FIELD_NRK>.
   END-OF-DEFINITION.

   DEFINE LM_GET_SPEC_SUM1.
     LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ = &1.
*      The ABEV for the condition must be determined
*      ID value
       READ TABLE T_BEVALLO INTO L_TMP_BEVALLO
                WITH KEY ABEVAZ  = &2
                         ADOAZON = L_BEVALLO-ADOAZON
                          LAPSZ  = L_BEVALLO-LAPSZ
                          BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         CONDENSE L_TMP_BEVALLO-FIELD_C.
         IF L_TMP_BEVALLO-FIELD_C IN &3.
           ADD L_BEVALLO-FIELD_N TO <FIELD_N>.
         ENDIF.
       ENDIF.
     ENDLOOP.
   END-OF-DEFINITION.

   RANGES LR_ABEVAZ     FOR /ZAK/BEVALLO-ABEVAZ.
   RANGES LR_SEL_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.


   DEFINE LM_GET_SPEC_SUM2.
     IF NOT &1[] IS INITIAL.
       LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ IN &1.
         IF $INDEX EQ '000'.
           ADD L_BEVALLO-FIELD_N TO <FIELD_N>.
         ELSE.
           ADD L_BEVALLO-FIELD_ON TO <FIELD_N>.
         ENDIF.
       ENDLOOP.
     ENDIF.
   END-OF-DEFINITION.

   SORT T_BEVALLB BY ABEVAZ.

*  Uploading selective ABEVAZ
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0038CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0039CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0040CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0041CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0CC0042CA SPACE.

   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0055CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0056CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0057CA SPACE.

* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_SEL_ABEVAZ.

     CLEAR W_/ZAK/BEVALLO.

*    this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
              BINARY SEARCH.

     CHECK SY-SUBRC EQ 0.

     V_TABIX = SY-TABIX .

*    Special calculations
     CASE W_/ZAK/BEVALLB-ABEVAZ.
*02-038 With the START card, there is a 10% social security tax (1
*code: line 643 "c")
       WHEN  C_ABEVAZ_A0CC0038CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '1' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0ID0643CA' 'M0IC007A' LR_COND.
*02-039 With the START card, there is a 20% social security tax (1
*code: line 644 "c")
       WHEN  C_ABEVAZ_A0CC0039CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '1' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0ID0644CA' 'M0IC007A' LR_COND.
*The 02-040 A START PLUSZ card comes with a 10% social security tax
*(Code 2: line 643 "c")
       WHEN  C_ABEVAZ_A0CC0040CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '2' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0ID0643CA' 'M0IC007A' LR_COND.
*The 02-041 START PLUSZ card comes with a 20% social security tax
*(Code 2: line 644 "c")
       WHEN  C_ABEVAZ_A0CC0041CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '2' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0ID0644CA' 'M0IC007A' LR_COND.
*With the 02-042 A START EXTRA card, you get a 10% social bonus
*tax (code 3: line 643 "c")
       WHEN  C_ABEVAZ_A0CC0042CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '3' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0ID0643CA' 'M0IC007A' LR_COND.
*A 03-055 The private individual's pension contribution (lines 563,603,611
*"c" fodl min NEM 25,42,81,83,92,93)
       WHEN  C_ABEVAZ_A0DC0055CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         M_DEF LR_COND 'E' 'EQ' '83' SPACE.
         M_DEF LR_COND 'E' 'EQ' '92' SPACE.
         M_DEF LR_COND 'E' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0GD0563CA' 'M0GC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0GF0602CA' 'M0GC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0GG0611CA' 'M0GC004A' LR_COND.
*A 03-56-c The burden of unemployment, employment pension
*(611.sorok "c" fogl min 25,42,81)
       WHEN  C_ABEVAZ_A0DC0056CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0GG0611CA' 'M0GC004A' LR_COND.
*A 03-57-c The private sector pays pension after GYED, S, T (lines 603, 611
*"c" a fogl min 83, 92, 93)
       WHEN C_ABEVAZ_A0DC0057CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '83' SPACE.
         M_DEF LR_COND 'I' 'EQ' '92' SPACE.
         M_DEF LR_COND 'I' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0GF0602CA' 'M0GC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0GG0611CA' 'M0GC004A' LR_COND.
     ENDCASE.

     PERFORM CALC_FIELD_NRK USING <FIELD_N>
                  W_/ZAK/BEVALLB-ROUND
                  W_/ZAK/BEVALLO-WAERS
         CHANGING <FIELD_NR>
                  <FIELD_NRK>.
     IF $INDEX NE '000'.
       MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
     ENDIF.
     MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

   ENDLOOP.

 ENDFORM.                    " CALC_ABEV_SZJA_SPECIAL_1208

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_ONREV_SZJA_1208
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*      -->P_$INDEX  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONREV_SZJA_1208 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                       T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                       T_ADOAZON STRUCTURE
                                                 /ZAK/ONR_ADOAZON
                            USING   $INDEX
                                    $LAST_DATE.

   DATA LI_LAST_BEVALLO LIKE /ZAK/BEVALLO OCCURS 0 WITH HEADER LINE.

   DATA L_LAST_INDEX LIKE /ZAK/BEVALLO-ZINDEX.
   DATA L_TABIX LIKE SY-TABIX.
   DATA L_TRUE.

   RANGES LR_ONREV_ABEVAZ FOR /ZAK/BEVALLB-ABEVAZ.
   DATA   L_ABEVAZ LIKE /ZAK/BEVALLB-ABEVAZ.

   DATA: L_KAM_KEZD TYPE DATUM,
         L_KAM_VEG  TYPE DATUM.
   DATA   L_KAMAT LIKE /ZAK/BEVALLO-FIELD_N.
   DATA   L_KAMAT_SUM LIKE /ZAK/BEVALLO-FIELD_N.

*  To upload fields to be summarized
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.

*  If self-revision
   CHECK $INDEX NE '000'.

   SORT T_BEVALLB BY ABEVAZ.

*  Let's read the 'A' abev identifiers of the previous period
   READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO INDEX 1.
   CHECK SY-SUBRC EQ 0.
   L_LAST_INDEX = $INDEX - 1.

   CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
     EXPORTING
       INPUT  = L_LAST_INDEX
     IMPORTING
       OUTPUT = L_LAST_INDEX.


   SELECT * INTO TABLE LI_LAST_BEVALLO
                 FROM  /ZAK/BEVALLO
                WHERE  BUKRS   EQ W_/ZAK/BEVALLO-BUKRS
                  AND  BTYPE   EQ W_/ZAK/BEVALLO-BTYPE
                  AND  GJAHR   EQ W_/ZAK/BEVALLO-GJAHR
                  AND  MONAT   EQ W_/ZAK/BEVALLO-MONAT
                  AND  ZINDEX  EQ L_LAST_INDEX
                  AND  ADOAZON EQ ''.

   SORT LI_LAST_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ.

*  We delete records that are not in the given period
*  adtak fel.
   LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                     WHERE NOT ADOAZON IS INITIAL.
     READ TABLE T_ADOAZON WITH KEY ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                                   BINARY SEARCH.
*    Nem kell a rekord.
     IF SY-SUBRC NE 0.
       DELETE T_BEVALLO.
       CONTINUE.
     ENDIF.
*  M 11 Mark with an X if your declaration is considered a correction
     IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_M0AE003A.
       MOVE 'H' TO W_/ZAK/BEVALLO-FIELD_C.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO TRANSPORTING FIELD_C.
     ENDIF.
   ENDLOOP.

* A0ED0115DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0115DA   "Módosított mező
                                 C_ABEVAZ_A0BC0001CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
* A0ED0117CA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0117CA   "Módosított mező
                                 C_ABEVAZ_A0ZZ000001        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0117DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0117DA   "Módosított mező
                                 C_ABEVAZ_A0CC0035CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0118DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0118DA   "Módosított mező
                                 C_ABEVAZ_A0BC0007CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0119DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0119DA   "Módosított mező
                                 C_ABEVAZ_A0CC0036CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0119CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ED0119CA   "Módosított mező
                                C_ABEVAZ_A0ED0119DA
                                '0.98'.
*A0ED0120DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0120DA   "Módosított mező
                                 C_ABEVAZ_A0CC0049CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0120CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ED0120CA   "Módosított mező
                                C_ABEVAZ_A0ED0120DA
                                '0.27'.
*A0ED0121DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0121DA   "Módosított mező
                                 C_ABEVAZ_A0CC0048CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0122DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0122DA   "Módosított mező
                                 C_ABEVAZ_A0DC0058CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0122CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ED0122CA   "Módosított mező
                                C_ABEVAZ_A0ED0122DA
                                '0.10'.
*A0ED0123DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0123DA   "Módosított mező
                                 C_ABEVAZ_A0DC0059CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0123CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ED0123CA   "Módosított mező
                                C_ABEVAZ_A0ED0123DA
                                '0.13'.
*A0ED0124DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0124DA   "Módosított mező
                                 C_ABEVAZ_A0DC0060CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0124CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ED0124CA   "Módosított mező
                                C_ABEVAZ_A0ED0124DA
                                '0.15'.
*A0ED0125DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0125DA   "Módosított mező
                                 C_ABEVAZ_A0DC0067CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0126DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0126DA   "Módosított mező
                                 C_ABEVAZ_A0DC0068CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0126CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ED0126CA   "Módosított mező
                                C_ABEVAZ_A0ED0126DA
                                '0.14'.
*A0ED0128DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0128DA   "Módosított mező
                                 C_ABEVAZ_A0DC0069CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0128CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ED0128CA   "Módosított mező
                                C_ABEVAZ_A0ED0128DA
                                '0.27'.
*A0ED0129DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0129DA   "Módosított mező
                                 C_ABEVAZ_A0BC0014CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0130DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0130DA   "Módosított mező
                                 C_ABEVAZ_A0BC0013CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0132DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0132DA   "Módosított mező
                                 C_ABEVAZ_A0DC0070CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0133DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0133DA   "Módosított mező
                                 C_ABEVAZ_A0DC0071CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0135DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0135DA   "Módosított mező
                                 C_ABEVAZ_A0DC0081CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0135CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ED0135CA   "Módosított mező
                                C_ABEVAZ_A0ED0135DA
                                '0.04'.
*A0ED0136DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0136DA   "Módosított mező
                                 C_ABEVAZ_A0DC0082CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0136CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ED0136CA   "Módosított mező
                                C_ABEVAZ_A0ED0136DA
                                '0.03'.
*A0ED0137DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0ED0137DA   "Módosított mező
                                 C_ABEVAZ_A0DC0083CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0ED0137CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ED0137CA   "Módosított mező
                                C_ABEVAZ_A0ED0137DA
                                '0.015'.
*A0FC0138DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0138DA   "Módosított mező
                                 C_ABEVAZ_A0DC0085CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0FC0138CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0138CA   "Módosított mező
                                C_ABEVAZ_A0FC0138DA
                                '0.095'.
*A0FC0139DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0139DA   "Módosított mező
                                 C_ABEVAZ_A0DC0086CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0FC0139CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0139CA   "Módosított mező
                                C_ABEVAZ_A0FC0139DA
                                '0.20'.
*A0FC0140DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0140DA   "Módosított mező
                                 C_ABEVAZ_A0DC0087CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0FC0140CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0140CA   "Módosított mező
                                C_ABEVAZ_A0FC0140DA
                                '0.111'.
*A0FC0141DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0141DA   "Módosított mező
                                 C_ABEVAZ_A0DC0088CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0FC0141CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FC0141CA   "Módosított mező
                                C_ABEVAZ_A0FC0141DA
                                '0.15'.
*A0FC0142AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0142AA   "Módosított mező
                                 C_ABEVAZ_A0DC0089CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*A0FC0143AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FC0143AA   "Módosított mező
                                 C_ABEVAZ_A0DC0090CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
**ÖSSZESÍTÉSEK
*A0ED0116DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0ED0117DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0ED0118DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ED0116DA.
*A0ED0127DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0ED0128DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0ED0129DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0ED0130DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ED0127DA.
*A0ED0131DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0ED0132DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0ED0133DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ED0131DA.
*A0ED0134DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0ED0135DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0ED0136DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0ED0137DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0ED0134DA.


 ENDFORM.                    " CALC_ABEV_ONREV_SZJA_1208

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_SZJA_1208
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$LAST_DATE  text
*      -->P_$INDEX  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SZJA_1208  TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                   T_BEVALLB STRUCTURE /ZAK/BEVALLB
                            USING  $DATE
                                   $INDEX.

   DATA: L_KAM_KEZD TYPE DATUM.

   DATA: BEGIN OF LI_ADOAZON OCCURS 0,
           ADOAZON TYPE /ZAK/ADOAZON,
         END OF LI_ADOAZON.
   DATA: L_BEVALLO TYPE /ZAK/BEVALLO.

*  To define a self-check
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.
   RANGES LR_SEL_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.

************************************************************************
* Special abev fields
************************************************************************

   SORT T_BEVALLB BY ABEVAZ  .

* the following abev codes can only occur once, summary v. char

   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC039A SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC040A SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC041A SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC044A SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC001A SPACE.


   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_SEL_ABEVAZ.

     CLEAR W_/ZAK/BEVALLO.

*    this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
          BINARY SEARCH.

     CHECK SY-SUBRC EQ 0.
     V_TABIX = SY-TABIX .


     CASE W_/ZAK/BEVALLB-ABEVAZ.
*      period from first day
       WHEN C_ABEVAZ_A0AC039A.
* Havi
         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* A year old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'E'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+4(4) = '0101'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* He is four years old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.

           L_KAM_KEZD = $DATE.
           IF L_KAM_KEZD+4(2) >= '01' AND
              L_KAM_KEZD+4(2) <= '03'.

             L_KAM_KEZD+4(4) = '0101'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '04' AND
              L_KAM_KEZD+4(2) <= '06'.

             L_KAM_KEZD+4(4) = '0401'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '07' AND
              L_KAM_KEZD+4(2) <= '09'.

             L_KAM_KEZD+4(4) = '0701'.
           ENDIF.


           IF L_KAM_KEZD+4(2) >= '10' AND
              L_KAM_KEZD+4(2) <= '12'.

             L_KAM_KEZD+4(4) = '1001'.
           ENDIF.

           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ELSE.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*      last day until period
       WHEN C_ABEVAZ_A0AC040A.
         W_/ZAK/BEVALLO-FIELD_C = $DATE.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*      Number of taxpayers = Tax numbers
       WHEN C_ABEVAZ_A0AC044A.

         REFRESH LI_ADOAZON.
         LOOP AT T_BEVALLO INTO L_BEVALLO.
           CHECK NOT L_BEVALLO-ADOAZON IS INITIAL.
           MOVE L_BEVALLO-ADOAZON TO LI_ADOAZON.
           COLLECT LI_ADOAZON.
         ENDLOOP.


         DESCRIBE TABLE LI_ADOAZON LINES SY-TFILL.
         IF NOT SY-TFILL IS INITIAL.
           W_/ZAK/BEVALLO-FIELD_C = SY-TFILL.
         ELSE.
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
         ENDIF.

         CONDENSE W_/ZAK/BEVALLO-FIELD_C.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*      Correction, Self-check
       WHEN C_ABEVAZ_A0AC041A.
*        Only in self-check
         IF $INDEX NE '000'.
           REFRESH LR_ABEVAZ.
*          A numerical value must be searched for in this range
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0ED0115DA
                                    C_ABEVAZ_A0ED0137DA.
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0FC0138CA
                                    C_ABEVAZ_A0FC0175CA.
           LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ IN LR_ABEVAZ
*          We monitor the rounded sum because it may be FIELD_N
*          it is not empty, but no value is added to the return because of the fkator.
*                                          AND NOT FIELD_N  IS INITIAL.
                                           AND NOT FIELD_NR IS INITIAL.
             EXIT.
           ENDLOOP.
*          There is value:
           IF SY-SUBRC EQ 0.
             W_/ZAK/BEVALLO-FIELD_C = 'O'.
*          Corrective
           ELSE.
             W_/ZAK/BEVALLO-FIELD_C = 'H'.
           ENDIF.
           CONDENSE W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
*      Repeated self-check
       WHEN C_ABEVAZ_A0EC001A.
*        Only in self-check
         IF $INDEX > '001'.
           REFRESH LR_ABEVAZ.
*          A numerical value must be searched for in this range
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0ED0115DA
                                    C_ABEVAZ_A0ED0137DA.
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0FC0138CA
                                    C_ABEVAZ_A0FC0175CA.
           LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ IN LR_ABEVAZ
*          We monitor the rounded sum because it may be FIELD_N
*          it is not empty, but no value is added to the return because of the fkator.
*                                          AND NOT FIELD_N  IS INITIAL.
                                           AND NOT FIELD_NR IS INITIAL.
             EXIT.
           ENDLOOP.
*          There is value:
           IF SY-SUBRC EQ 0.
             W_/ZAK/BEVALLO-FIELD_C = 'X'.
           ENDIF.
           CONDENSE W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.

     ENDCASE.

   ENDLOOP.

 ENDFORM.                    " CALC_ABEV_SZJA_1208

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_0_SZJA_1208
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_ADOAZON_ALL  text
*      -->P_SPACE  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_0_SZJA_1208  TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                              T_ADOAZON_ALL STRUCTURE /ZAK/ADOAZONLPSZ
                              USING   $ONREV
                                      $DATE
                                      $INDEX.

   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.
   DATA   LR_VALUE  LIKE RANGE_C3 OCCURS 0 WITH HEADER LINE.
*++2011.07.11 BG
   DATA   LR_VALUE2 LIKE RANGE_C3 OCCURS 0 WITH HEADER LINE.
*--2011.07.11 BG
* So that you don't have to expand the self-revision to a global one for every FORM
* treated as a variable:
   CLEAR V_ONREV.
   IF NOT $ONREV IS INITIAL.
     MOVE $ONREV TO V_ONREV.
   ENDIF.

**  Ha mező1 >= mező2 akkor mező3 0 flag beállítás
*   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
*                                T_ADOAZON_ALL
*                         USING C_ABEVAZ_M0BC0382CA "field1
*                                C_ABEVAZ_M0BC0382BA "field2
*                                C_ABEVAZ_M0BC0382DA.        "field 3
**  Ha mező1+mező2+mező3+mező4 > 0 akkor 0 flag beállítás
*   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
*                              USING  C_ABEVAZ_A0IC0284HA
*                              "0-flag setting
*                                     C_ABEVAZ_A0IC0284CA "field1
*                                     C_ABEVAZ_A0IC0284DA "field2
*                                     C_ABEVAZ_A0IC0284EA "field3
*                                     SPACE.                 "field 4
** Ha mező1 ne 0 vagy mező2 ne 0 vagy mező3 ne 0 vagy mező4 ne 0
** vagy mező5 ne 0 akkor 0 flag beállítás
*   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
*                              USING  C_ABEVAZ_A0DC0087DA    "0flag
*                                     C_ABEVAZ_A0DC0087CA "field1
*                                     SPACE "field2
*                                     SPACE "field3
*                                     SPACE "field4
*                                     SPACE "field5
*                                     SPACE.                 "field 6
*   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
*                                      T_ADOAZON_ALL
*                               USING  C_ABEVAZ_M0CC0415DA   "0flag
*                                      C_ABEVAZ_M0BC0382BA "field1
*                                      C_ABEVAZ_M0BC0386BA "field2
*                                      SPACE "field3
*                                      SPACE "field4
*                                      SPACE "field5
*                                      SPACE.                "field 6
** mező1-n 0 flag állítás
*     PERFORM GET_NULL_FLAG_0     TABLES T_BEVALLO
*                                 USING  C_ABEVAZ_A0BC50041A.
* If field1 = field2 then 0 flag is set
*   PERFORM GET_NULL_FLAG_EQM TABLES T_BEVALLO
*                                    T_ADOAZON_ALL
*                             USING C_ABEVAZ_M0FD0496AA "field1
*                                    C_ABEVAZ_M0FD0495AA "field2
*                                    C_ABEVAZ_M0FD0498BA     "0-flag
*                                    C_ABEVAZ_M0FD0497BA.    "0-flag
*  If field1 >= field2 then field3 0 flag setting
   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0361CA         "mező1
                                C_ABEVAZ_M0BC0361BA         "mező2
                                C_ABEVAZ_M0BC0361DA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0361DA         "mező1
                                C_ABEVAZ_M0BC0361BA         "mező2
                                C_ABEVAZ_M0BC0361CA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0364CA         "mező1
                                C_ABEVAZ_M0BC0364BA         "mező2
                                C_ABEVAZ_M0BC0364DA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0364DA         "mező1
                                C_ABEVAZ_M0BC0364BA         "mező2
                                C_ABEVAZ_M0BC0364CA.        "mező3
** Ha mező1 ne 0 vagy mező2 ne 0 vagy mező3 ne 0 vagy mező4 ne 0
** vagy mező5 ne 0 akkor 0 flag beállítás
   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0BC0375DA   "0flag
                                      C_ABEVAZ_M0BC0373DA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6
* If field1 is not 0 or field2 is not 0 or field3 is not 0 or field4 is not 0
** vagy mező5 nem üres (karakteres) akkor 0 flag beállítás
   PERFORM GET_NULL_FLAG_INITM_C TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0GD0560CA   "0flag
                                      C_ABEVAZ_M0GC001A     "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM_C TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0GD0563CA   "0flag
                                      C_ABEVAZ_M0GC001A     "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6


* Self-audit supplement if self-audit
   IF $INDEX NE '000'.
     PERFORM GET_NULL_FLAG_0     TABLES T_BEVALLO
                                 USING  C_ABEVAZ_A0FD0160CA.
     PERFORM GET_NULL_FLAG_0     TABLES T_BEVALLO
                                 USING  C_ABEVAZ_A0FD0162CA.
   ENDIF.

*++2012.03.09 BG
*  0 flag setting on field 1
   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0BC0370DA.

   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0BC0373DA.

   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0BC0375DA.

*   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
*                                      T_ADOAZON_ALL
*                               USING  C_ABEVAZ_M0BC0376DA.

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0ID0645AA   "0flag
                                      C_ABEVAZ_M0ID0638CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0ID0645CA   "0flag
                                      C_ABEVAZ_M0ID0638CA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

*--2012.03.09 BG

*++2012.04.10 BG
   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0ED0117CA    "0flag
                                     C_ABEVAZ_A0ED0117DA    "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6
*--2012.04.10 BG
*++2012.05.10 BG
   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0ED0117DA    "0flag
                                     C_ABEVAZ_A0ED0117CA    "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6

   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0ED0116DA    "0flag
                                     C_ABEVAZ_A0ED0117CA    "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6
*  2012.05.10 BG
*++2012.06.11 BG (Ness)
   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0ID0642CA   "0flag
                                      C_ABEVAZ_M0ID0642AA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6
*--2012.06.11 BG (Ness)
*++2012.12.10 BG (Ness)
   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0BD0401BA   "0flag
                                      C_ABEVAZ_M0BD0402BA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6
*--2012.12.10 BG (Ness)


 ENDFORM.                    " CALC_ABEV_0_SZJA_1208

*&---------------------------------------------------------------------*
*&      Form  GET_LAP_SZ_1208
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*----------------------------------------------------------------------*
 FORM GET_LAP_SZ_1208  TABLES T_BEVALLO STRUCTURE  /ZAK/BEVALLALV.


   DATA L_ALV LIKE /ZAK/BEVALLALV.
   DATA L_INDEX LIKE SY-TABIX.
   DATA L_TABIX LIKE SY-TABIX.
   DATA L_NYLAP LIKE SY-TABIX.
   DATA L_BEVALLO_ALV LIKE /ZAK/BEVALLALV.
   DATA L_NULL_FLAG TYPE /ZAK/NULL.

   CLEAR L_INDEX.

*  Upload RANKS to manage retired numbers
   M_DEF R_A0AC047A 'I' 'EQ' 'M0FC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0GC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0HC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0JC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0IC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0JC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0KC003A' SPACE.

*  Values
   M_DEF R_NYLAPVAL 'I' 'EQ' '1' SPACE.
   M_DEF R_NYLAPVAL 'I' 'EQ' '2' SPACE.
   M_DEF R_NYLAPVAL 'I' 'EQ' '3' SPACE.
   M_DEF R_NYLAPVAL 'I' 'EQ' '4' SPACE.
   M_DEF R_NYLAPVAL 'I' 'EQ' '11' SPACE.


   REFRESH I_NYLAP.

   LOOP AT I_/ZAK/BEVALLO INTO W_/ZAK/BEVALLO.
     L_TABIX = SY-TABIX.

*   Dialog run for insurance
     PERFORM PROCESS_IND_ITEM USING '100000'
                                    L_INDEX
                                    TEXT-P01.

*   Csak SZJA-nal
     IF  W_/ZAK/BEVALL-BTYPART EQ C_BTYPART_SZJA.
*      Collection of pensioner tax numbers
       PERFORM CALL_NYLAP TABLES R_A0AC047A
                                 R_NYLAPVAL
                          USING  W_/ZAK/BEVALLO.

     ENDIF.

     READ TABLE T_BEVALLO INTO L_ALV WITH KEY
                   BUKRS   = W_/ZAK/BEVALLO-BUKRS
                   BTYPE   = W_/ZAK/BEVALLO-BTYPE
                   GJAHR   = W_/ZAK/BEVALLO-GJAHR
                   MONAT   = W_/ZAK/BEVALLO-MONAT
                   ZINDEX  = W_/ZAK/BEVALLO-ZINDEX
                   ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ
                   ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                   LAPSZ   = W_/ZAK/BEVALLO-LAPSZ
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
*  The 0 flag handling was not appropriate
*  If it is a self-revision calculation, the T_BEVALLO 0 flag is required
*  otherwise, the I_/ZAK/BEVALLO 0 flag.
       IF NOT L_ALV-OFLAG IS INITIAL.
         L_NULL_FLAG = L_ALV-NULL_FLAG.
       ELSE.
         L_NULL_FLAG = W_/ZAK/BEVALLO-NULL_FLAG.
       ENDIF.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
       L_ALV-NULL_FLAG = L_NULL_FLAG.
       IF L_ALV-OFLAG IS INITIAL.
         MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX
                         TRANSPORTING FIELD_C FIELD_N FIELD_NR FIELD_NRK
                                      NULL_FLAG WAERS
                                       .
       ELSE.
         MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX
                         TRANSPORTING FIELD_C FIELD_N  FIELD_NR
                         FIELD_NRK
                                      OFLAG   FIELD_ON FIELD_ONR
                                      FIELD_ONRK
                                      NULL_FLAG WAERS.
         PERFORM SUM_ONR TABLES T_BEVALLO
                         USING  L_ALV
                                L_ALV-FIELD_ON
                                L_ALV-FIELD_ONR
                                L_ALV-FIELD_ONRK.
       ENDIF.
     ELSE.
       READ TABLE I_/ZAK/BEVALLB INTO W_/ZAK/BEVALLB
       WITH KEY ABEVAZ = W_/ZAK/BEVALLO-ABEVAZ.
       MOVE-CORRESPONDING W_/ZAK/BEVALLB TO L_ALV.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
       SELECT SINGLE ABEVTEXT INTO L_ALV-ABEVTEXT
         FROM  /ZAK/BEVALLBT
              WHERE  LANGU   = SY-LANGU
              AND    BTYPE   = W_/ZAK/BEVALLO-BTYPE
              AND    ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ.
       L_ALV-ABEVTEXT_DISP = L_ALV-ABEVTEXT.
       APPEND L_ALV TO T_BEVALLO.
       SORT T_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ ADOAZON
            LAPSZ.
     ENDIF.
     DELETE I_/ZAK/BEVALLO.
   ENDLOOP.

*  Definition of pensioners
   IF NOT I_NYLAP[] IS INITIAL.
     DESCRIBE TABLE I_NYLAP LINES L_NYLAP.
     READ TABLE T_BEVALLO INTO L_BEVALLO_ALV
                          WITH KEY ABEVAZ  = C_ABEVAZ_A0AC045A
                          BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE L_NYLAP TO L_BEVALLO_ALV-FIELD_C.
       CONDENSE L_BEVALLO_ALV-FIELD_C.
       MODIFY T_BEVALLO FROM L_BEVALLO_ALV INDEX SY-TABIX
                             TRANSPORTING FIELD_C.
     ENDIF.
   ELSE.
     READ TABLE T_BEVALLO INTO L_BEVALLO_ALV
                          WITH KEY ABEVAZ  = C_ABEVAZ_A0AC045A
                          BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       CLEAR L_BEVALLO_ALV-FIELD_C.
       MODIFY T_BEVALLO FROM L_BEVALLO_ALV INDEX SY-TABIX
                             TRANSPORTING FIELD_C.
     ENDIF.
   ENDIF.

 ENDFORM.                    " GET_LAP_SZ_1208

*&---------------------------------------------------------------------*
*&      Form  del_esdat_field_1208
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_C_ABEVAZ_A0AC033A  text
*----------------------------------------------------------------------*
 FORM DEL_ESDAT_FIELD_1208 TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLALV
                                    $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                           USING    $ABEVAZ_JELLEG.

   DATA LW_/ZAK/BEVALLALV TYPE /ZAK/BEVALLALV.

*  We define the character:
   READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                         WITH KEY ABEVAZ = $ABEVAZ_JELLEG
                         BINARY SEARCH.
*  In this case, you do not need to fill in the due date:
   IF SY-SUBRC EQ 0 AND LW_/ZAK/BEVALLALV-FIELD_C = 'H'.
**  ESDAT_FLAG-ben megjelölt ABEV azonosító értéke
*     READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
*                         WITH KEY  ESDAT_FLAG = 'X'.
*     IF SY-SUBRC EQ 0.
*       READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
*                           WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
*                           BINARY SEARCH.
*       IF SY-SUBRC EQ 0.
*         V_TABIX = SY-TABIX .
*         CLEAR LW_/ZAK/BEVALLALV-FIELD_C.
*         MODIFY $T_BEVALLO FROM LW_/ZAK/BEVALLALV
*                               INDEX V_TABIX TRANSPORTING FIELD_C.
*       ENDIF.
*     ENDIF.
*  For correctors, there is no need for 0 flag in the self-check allowance either
     READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                         WITH KEY ABEVAZ = C_ABEVAZ_A0FD0160CA
                         BINARY SEARCH.
     IF SY-SUBRC EQ 0 AND NOT LW_/ZAK/BEVALLALV-NULL_FLAG IS INITIAL.
       V_TABIX = SY-TABIX .
       CLEAR LW_/ZAK/BEVALLALV-NULL_FLAG.
       MODIFY $T_BEVALLO FROM LW_/ZAK/BEVALLALV
                             INDEX V_TABIX TRANSPORTING NULL_FLAG.
     ENDIF.
   ENDIF.

 ENDFORM.                    " del_esdat_field_1208

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_AFA_1265
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_AFA_1265  TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                 T_BEVALLB STRUCTURE /ZAK/BEVALLB
                           USING $DATE.

   DATA: L_SUM      LIKE /ZAK/BEVALLO-FIELD_N,
         L_SUM_203  LIKE /ZAK/BEVALLO-FIELD_N,
*++ BG 2009.06.17
         L_SUM_SAVE LIKE /ZAK/BEVALLO-FIELD_N,
*-- BG 2009.06.17
         L_KAMAT    LIKE /ZAK/BEVALLO-FIELD_N,
         L_ABEV_SUM LIKE /ZAK/BEVALLO-FIELD_N.
   DATA: L_KAM_KEZD  TYPE DATUM,
         L_KAM_VEG   TYPE DATUM,
         L_ROUND(20) TYPE C,
         L_TABIX     LIKE SY-TABIX,
         L_UPD.
************************************************************************
* Special abev fields

******************************************************** CSAK ÁFA normál

   DATA: W_SZ TYPE /ZAK/BEVALLB.

   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.

*  Loading calculated fields
   REFRESH LR_ABEVAZ.
   M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_8272 C_ABEVAZ_8283.
   M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_23335 C_ABEVAZ_23339.
   M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_24004 C_ABEVAZ_24005.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_24008 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_7995 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_7996 SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_23700 SPACE.



   SORT T_BEVALLB BY ABEVAZ  .
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_ABEVAZ.
     CLEAR : L_SUM,W_/ZAK/BEVALLO.
* this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
     V_TABIX = SY-TABIX .
     CLEAR: W_/ZAK/BEVALLO-FIELD_N,
            W_/ZAK/BEVALLO-FIELD_NR,
            W_/ZAK/BEVALLO-FIELD_NRK.


     CASE W_/ZAK/BEVALLB-ABEVAZ.
* 72.C. Amount of tax to be paid
       WHEN C_ABEVAZ_8277.
         CLEAR L_SUM.
         READ TABLE T_BEVALLO INTO W_SUM
         WITH KEY ABEVAZ = C_ABEVAZ_8275.
         IF SY-SUBRC = 0.
           IF W_SUM-FIELD_N > 0.
             L_SUM = W_SUM-FIELD_NRK.
             W_/ZAK/BEVALLO-FIELD_N = L_SUM.
           ELSE.
             CLEAR W_/ZAK/BEVALLO-FIELD_N.
           ENDIF.
           L_UPD = 'X'.
         ENDIF.
* 00C Declaration period from
       WHEN C_ABEVAZ_23335.
* Havi
         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* A year old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'E'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+4(4) = '0101'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* He is four years old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.

           L_KAM_KEZD = $DATE.
           IF L_KAM_KEZD+4(2) >= '01' AND
              L_KAM_KEZD+4(2) <= '03'.

             L_KAM_KEZD+4(4) = '0101'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '04' AND
              L_KAM_KEZD+4(2) <= '06'.

             L_KAM_KEZD+4(4) = '0401'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '07' AND
              L_KAM_KEZD+4(2) <= '09'.

             L_KAM_KEZD+4(4) = '0701'.
           ENDIF.


           IF L_KAM_KEZD+4(2) >= '10' AND
              L_KAM_KEZD+4(2) <= '12'.

             L_KAM_KEZD+4(4) = '1001'.
           ENDIF.

           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ELSE.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ENDIF.

         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*00C Declaration period from
       WHEN C_ABEVAZ_23336.
         W_/ZAK/BEVALLO-FIELD_C = $DATE.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*00C Nature of declaration
       WHEN C_ABEVAZ_23338.
*++ 20110418 RN ismételt önrev. kezelés módosult a 1065-höz képest
**        ZINDEX = '001' --> 'O'     "önellenőrzés
**        ZINDEX > '001' --> 'I'     "ismételt önellenőrzés
*         IF W_/ZAK/BEVALLO-ZINDEX = '001'.
*           W_/ZAK/BEVALLO-FIELD_C = 'O'.
*           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*         ELSEIF W_/ZAK/BEVALLO-ZINDEX > '001'.
*           W_/ZAK/BEVALLO-FIELD_C = 'I'.
*           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*         ENDIF.

*        ZINDEX >= '001' --> 'O' "self check
         IF W_/ZAK/BEVALLO-ZINDEX GE '001'.
           W_/ZAK/BEVALLO-FIELD_C = 'O'.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
*-04 sheets Self-revision (repeated)
       WHEN C_ABEVAZ_23700.
*        ZINDEX > '001' --> 'X' "repeated self-check
         IF W_/ZAK/BEVALLO-ZINDEX > '001'.
           W_/ZAK/BEVALLO-FIELD_C = 'X'.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
*-- 20110418 RN
*00C Declaration frequency /H-monthly, N-quarterly, E-yearly
       WHEN C_ABEVAZ_23339.
         W_/ZAK/BEVALLO-FIELD_C = W_/ZAK/BEVALL-BIDOSZ.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*70.B. It can be calculated from the previous period
       WHEN C_ABEVAZ_8272.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8273
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*71.B. Established in the subject period
       WHEN C_ABEVAZ_8274.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8275
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*72.B. Amount of tax to be paid
       WHEN C_ABEVAZ_8276.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8277
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
**73.B. Pü-ileg nem rendezett
*       WHEN C_ABEVAZ_8278.
*         PERFORM SET_BEVALLO USING C_ABEVAZ_8279
*                             CHANGING W_/ZAK/BEVALLO.
*         L_UPD = 'X'.
*74.B. Amount of recoverable tax
       WHEN C_ABEVAZ_8280.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8281
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*74.B. It can be carried over to the next period
       WHEN C_ABEVAZ_8282.
         PERFORM SET_BEVALLO USING C_ABEVAZ_8283
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*00F year month day
       WHEN C_ABEVAZ_24008.
         W_/ZAK/BEVALLO-FIELD_C = SY-DATUM.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
* Claimable,
       WHEN  C_ABEVAZ_8281.
         READ TABLE T_BEVALLO INTO W_SUM
              WITH KEY ABEVAZ = C_ABEVAZ_8275.
         IF SY-SUBRC EQ 0 AND W_SUM-FIELD_N < 0.
           CLEAR L_SUM.
           L_SUM = W_SUM-FIELD_NRK.
           READ TABLE T_BEVALLO INTO W_SUM
                WITH KEY ABEVAZ = C_ABEVAZ_24005.
           IF SY-SUBRC EQ 0 AND NOT W_SUM-FIELD_C IS INITIAL.
             W_/ZAK/BEVALLO-FIELD_N = ABS( L_SUM ).
             L_UPD = 'X'.
           ELSEIF SY-SUBRC EQ 0 AND W_SUM-FIELD_C IS INITIAL.
             CLEAR W_/ZAK/BEVALLO-FIELD_N.
             L_UPD = 'X'.
           ENDIF.
         ENDIF.
*Carried over to next period
       WHEN  C_ABEVAZ_8283.
         READ TABLE T_BEVALLO INTO W_SUM
              WITH KEY ABEVAZ = C_ABEVAZ_8275.
         IF SY-SUBRC EQ 0 AND W_SUM-FIELD_N < 0.
           CLEAR L_SUM.
           L_SUM = W_SUM-FIELD_NRK.
           READ TABLE T_BEVALLO INTO W_SUM
                WITH KEY ABEVAZ = C_ABEVAZ_24005.
           IF SY-SUBRC EQ 0 AND NOT W_SUM-FIELD_C IS INITIAL.
             CLEAR W_/ZAK/BEVALLO-FIELD_N.
             L_UPD = 'X'.
           ELSEIF SY-SUBRC EQ 0 AND W_SUM-FIELD_C IS INITIAL.
             W_/ZAK/BEVALLO-FIELD_N = ABS( L_SUM ).
             L_UPD = 'X'.
           ENDIF.
         ENDIF.

     ENDCASE.

* fill in all numerical values ​​for calculated fields!
* the procedure for forming an amount is as follows:
* pl: ABEV3 field_n = ABEV1 field_nrk + ABEV2 field_nrk
* then apply the default rounding rule!
     IF NOT W_/ZAK/BEVALLB-COLLECT IS INITIAL AND
        L_UPD EQ 'X'.
       CLEAR L_ROUND.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                   W_/ZAK/BEVALLB-ROUND
                   W_/ZAK/BEVALLO-WAERS
          CHANGING W_/ZAK/BEVALLO-FIELD_NR
                   W_/ZAK/BEVALLO-FIELD_NRK.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       CLEAR: L_SUM,L_UPD.
     ENDIF.
     CLEAR: L_UPD,L_SUM,L_ROUND.

   ENDLOOP.

*  Calculation of dependent fields
   REFRESH LR_ABEVAZ.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_24004 SPACE.
ENHANCEMENT-POINT /ZAK/ZAK_1265_RG_01 SPOTS /ZAK/FUNCTIONS_ES .

   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_ABEVAZ.
     CLEAR : L_SUM,W_/ZAK/BEVALLO.
* this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
     V_TABIX = SY-TABIX .
     CLEAR: W_/ZAK/BEVALLO-FIELD_N,
            W_/ZAK/BEVALLO-FIELD_NR,
            W_/ZAK/BEVALLO-FIELD_NRK.


     CASE W_/ZAK/BEVALLB-ABEVAZ.

*00D I do not request a referral
       WHEN C_ABEVAZ_24004.
         READ TABLE T_BEVALLO INTO W_SUM
              WITH KEY ABEVAZ = C_ABEVAZ_8281.
         IF SY-SUBRC EQ 0 AND W_SUM-FIELD_N NE 0.
           W_/ZAK/BEVALLO-FIELD_C = C_X.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ELSEIF SY-SUBRC EQ 0 AND W_SUM-FIELD_N EQ 0.
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.


     ENDCASE.
ENHANCEMENT-POINT /ZAK/ZAK_1265_RG_02 SPOTS /ZAK/FUNCTIONS_ES .

* fill in all numerical values ​​for calculated fields!
* the procedure for forming an amount is as follows:
* pl: ABEV3 field_n = ABEV1 field_nrk + ABEV2 field_nrk
* then apply the default rounding rule!
     IF NOT W_/ZAK/BEVALLB-COLLECT IS INITIAL AND
        L_UPD EQ 'X'.
       CLEAR L_ROUND.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                   W_/ZAK/BEVALLB-ROUND
                   W_/ZAK/BEVALLO-WAERS
          CHANGING W_/ZAK/BEVALLO-FIELD_NR
                   W_/ZAK/BEVALLO-FIELD_NRK.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       CLEAR: L_SUM,L_UPD.
     ENDIF.
     CLEAR: L_UPD,L_SUM,L_ROUND.

   ENDLOOP.
*++1265 2012.02.20 BG
*  Calculation of 3077 and 3079
   REFRESH LR_ABEVAZ.
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
                    WHERE NOT ONYBF IS INITIAL.
     M_DEF LR_ABEVAZ 'I' 'EQ' W_/ZAK/BEVALLB-ABEVAZ SPACE.
   ENDLOOP.
   IF NOT LR_ABEVAZ[] IS INITIAL.
     LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                      WHERE ABEVAZ IN LR_ABEVAZ
                        AND FIELD_NRK IS NOT INITIAL.
       EXIT.
     ENDLOOP.
*    There is value
     IF SY-SUBRC EQ 0.
*    The value of 23956 should be examined
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                        WITH KEY ABEVAZ = C_ABEVAZ_23956.
       IF SY-SUBRC EQ 0 AND NOT W_/ZAK/BEVALLO-FIELD_C IS INITIAL.
* this line must be modified!
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                          WITH KEY ABEVAZ = C_ABEVAZ_3079.
         IF SY-SUBRC EQ 0.
           V_TABIX = SY-TABIX .
           W_/ZAK/BEVALLO-FIELD_C = C_X.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
* this line must be filled
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                          WITH KEY ABEVAZ = C_ABEVAZ_3077.
         IF SY-SUBRC EQ 0.
           V_TABIX = SY-TABIX .
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
       ELSEIF SY-SUBRC EQ 0 AND  W_/ZAK/BEVALLO-FIELD_C IS INITIAL.
* this line must be modified!
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                          WITH KEY ABEVAZ = C_ABEVAZ_3077.
         IF SY-SUBRC EQ 0.
           V_TABIX = SY-TABIX .
           W_/ZAK/BEVALLO-FIELD_C = C_X.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
* this line must be filled
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                          WITH KEY ABEVAZ = C_ABEVAZ_3079.
         IF SY-SUBRC EQ 0.
           V_TABIX = SY-TABIX .
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
       ENDIF.
     ENDIF.
   ENDIF.
*--1265 2012.02.20 BG


************************************************************************
****
* calculation of self-check allowance
************************************************************************
****
   IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
* if 8277 - 8276 > 0 then this value, otherwise 0
     LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
       WHERE  ABEVAZ EQ     C_ABEVAZ_203.
       CLEAR: L_SUM,L_SUM_203.
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_8276  OR
                ABEVAZ EQ     C_ABEVAZ_8277.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_8276.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM < 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_203 = L_SUM_203 + L_SUM.
       CLEAR L_SUM.
* (8283 - 8282) < 0 then the calculated value is minus
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_8283  OR
                ABEVAZ EQ     C_ABEVAZ_8282.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_8282.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM > 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_203 = L_SUM_203 - L_SUM.
       CLEAR L_SUM.
* 8281 - 8280 < 0 then the calculated value is minus
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_8281  OR
                ABEVAZ EQ     C_ABEVAZ_8280.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_8280.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM > 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_203 = L_SUM_203 - L_SUM.
       CLEAR L_SUM.
*     If 8273-8272 < 0, it must be reduced by this amount
*     az L_SUM_203-at.
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                            WITH KEY ABEVAZ = C_ABEVAZ_8273.
       IF SY-SUBRC EQ 0.
         L_SUM = W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                            WITH KEY ABEVAZ = C_ABEVAZ_8272.
       IF SY-SUBRC EQ 0.
         L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       IF L_SUM < 0.
*++ BG 2009.06.17
         L_SUM_SAVE = ABS( L_SUM ).
*-- BG 2009.06.17
         ADD L_SUM TO L_SUM_203.
       ENDIF.

       IF L_SUM_203 < 0.
*++ BG 2009.06.17
         ADD L_SUM_203 TO L_SUM_SAVE.
*-- BG 2009.06.17
         CLEAR L_SUM_203.
       ENDIF.
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
       WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
       V_TABIX = SY-TABIX .
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING L_SUM_203
                     W_/ZAK/BEVALLB-ROUND
                     W_/ZAK/BEVALLO-WAERS
            CHANGING W_/ZAK/BEVALLO-FIELD_NR
                     W_/ZAK/BEVALLO-FIELD_NRK.
         W_/ZAK/BEVALLO-FIELD_N = L_SUM_203.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       ENDIF.
     ENDLOOP.
ENHANCEMENT-POINT /ZAK/ZAK_1265_RG_03 SPOTS /ZAK/FUNCTIONS_ES .

* determination of self-control allowance
* Calculation of ABEV 205 based on 203, if the index is 2 or greater, then x1.5

     IF W_/ZAK/BEVALLO-ZINDEX NE '000'.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_205.
       IF SY-SUBRC EQ 0.
         CLEAR L_SUM.
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                              WITH KEY ABEVAZ = C_ABEVAZ_203.
         IF SY-SUBRC = 0.
           L_SUM = W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
* period definition
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                              WITH KEY ABEVAZ = C_ABEVAZ_23337.
         IF SY-SUBRC EQ 0 AND
         NOT W_/ZAK/BEVALLO-FIELD_C IS INITIAL .
* determining the deadline for calculating the allowance! the 104
* I don't need a tax for the /ZAK/ADONEM table key !!

           SELECT SINGLE FIZHAT INTO W_/ZAK/ADONEM-FIZHAT FROM /ZAK/ADONEM
                                 WHERE BUKRS  EQ W_/ZAK/BEVALLO-BUKRS AND
                                                  ADONEM EQ C_ADONEM_104
                                                  .
           IF SY-SUBRC EQ 0.
* start date of allowance calculation
             CLEAR L_KAM_KEZD.
             L_KAM_KEZD = $DATE + 1 + W_/ZAK/ADONEM-FIZHAT.
* end date of allowance calculation in the character field of row 5299 above
             CLEAR L_KAM_VEG.
             CALL FUNCTION 'CONVERSION_EXIT_IDATE_INPUT'
               EXPORTING
                 INPUT  = W_/ZAK/BEVALLO-FIELD_C
               IMPORTING
                 OUTPUT = L_KAM_VEG.
*++2012.01.10 BG
*             L_KAM_VEG = L_KAM_VEG - 15 .
*--2012.01.10 BG
* allowance calculation
             PERFORM CALC_POTLEK USING    W_/ZAK/BEVALLO-BUKRS
                                          W_/ZAK/BEVALLO-ZINDEX
                                 CHANGING L_KAM_KEZD
                                          L_KAM_VEG
                                          L_SUM
                                          L_KAMAT. " 203 --> 205
             READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                                  WITH KEY ABEVAZ = C_ABEVAZ_205.
             V_TABIX = SY-TABIX.
             IF SY-SUBRC = 0.
               W_/ZAK/BEVALLO-FIELD_N = L_KAMAT.
               PERFORM CALC_FIELD_NRK USING L_KAMAT
                          W_/ZAK/BEVALLB-ROUND
                          W_/ZAK/BEVALLO-WAERS
                 CHANGING W_/ZAK/BEVALLO-FIELD_NR
                          W_/ZAK/BEVALLO-FIELD_NRK.
*++BG 2009.05.18
*              The value of the 0 flag must be handled in the form control
*              miatt:
               IF NOT W_/ZAK/BEVALLO-FIELD_N IS INITIAL AND
                  W_/ZAK/BEVALLO-FIELD_NRK IS INITIAL.
                 W_/ZAK/BEVALLO-NULL_FLAG = 'X'.
               ENDIF.
*--BG 2009.05.18
               MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
             ENDIF.
           ENDIF.
         ENDIF.
       ENDIF.
*++ BG 2009.06.17
*      If there is a value, 203 must be corrected.
       IF NOT L_SUM_SAVE IS INITIAL.
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
         WITH KEY ABEVAZ = C_ABEVAZ_203.
         V_TABIX = SY-TABIX .
         IF SY-SUBRC EQ 0.
           ADD L_SUM_SAVE TO W_/ZAK/BEVALLO-FIELD_N.
           READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                WITH KEY ABEVAZ = C_ABEVAZ_203.
           IF SY-SUBRC EQ 0.
             PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                         W_/ZAK/BEVALLB-ROUND
                         W_/ZAK/BEVALLO-WAERS
                CHANGING W_/ZAK/BEVALLO-FIELD_NR
                         W_/ZAK/BEVALLO-FIELD_NRK.
             MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
           ENDIF.
         ENDIF.
       ENDIF.
*-- BG 2009.06.17
     ENDIF.
   ENDIF.

*++ BG 2009.06.17
*  0 flag field management
* If field1 is not 0 or field2 is not 0 or field3 is not 0 or field4 is not 0
* or field 5 not 0 then 0 flag setting
   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_205
                              "0-flag beállítás
                                     C_ABEVAZ_203           "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6
*-- BG 2009.06.17
 ENDFORM.                    " CALC_ABEV_AFA_1265

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_ONYB_12A60
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONYB_12A60 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                  T_BEVALLB STRUCTURE /ZAK/BEVALLB
                           USING  $LAST_DATE.

   DATA L_TABIX LIKE SY-TABIX.

   DATA L_GJAHR TYPE GJAHR.
   DATA L_MONAT TYPE MONAT.
   DATA L_BEGIN_DAY LIKE SY-DATUM.

   CLEAR: L_GJAHR,L_MONAT.

   L_GJAHR = $LAST_DATE(4).
   L_MONAT = $LAST_DATE+4(2).
* E - Year old
   IF W_/ZAK/BEVALL-BIDOSZ = 'E'.
     L_MONAT = '01'.
* N - Quarterly
   ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.
     SUBTRACT 2 FROM L_MONAT.
* H - Havi
   ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'H'.

   ENDIF.

   CONCATENATE L_GJAHR L_MONAT '01' INTO L_BEGIN_DAY.

* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE  ABEVAZ EQ     C_ABEVAZ_23335
        OR  ABEVAZ EQ     C_ABEVAZ_23336
        OR  ABEVAZ EQ     C_ABEVAZ_23338
        OR  ABEVAZ EQ     C_ABEVAZ_23339.

* this line must be modified!
     LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                       WHERE ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.

       CASE W_/ZAK/BEVALLB-ABEVAZ.

*++2010.02.11 RN
* this field is no longer on the 10A60
**    Aláírás dátuma (sy-datum)
*         WHEN  C_ABEVAZ_24.
*           W_/ZAK/BEVALLO-FIELD_C = SY-DATUM.
*--2010.02.11 RN
*    PERIOD start date
         WHEN  C_ABEVAZ_23335.
           W_/ZAK/BEVALLO-FIELD_C = L_BEGIN_DAY.
*    PERIOD closing date
         WHEN  C_ABEVAZ_23336.
           W_/ZAK/BEVALLO-FIELD_C = $LAST_DATE.
*    Loading correction flags
*    We always upload if self-revision:
         WHEN  C_ABEVAZ_23338.
           IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
             W_/ZAK/BEVALLO-FIELD_C = 'H'.
           ENDIF.
*    Frequency of reporting
         WHEN  C_ABEVAZ_23339.
           IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
             W_/ZAK/BEVALLO-FIELD_C = 'H'.
           ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.
             W_/ZAK/BEVALLO-FIELD_C = 'N'.
           ENDIF.
       ENDCASE.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO.
     ENDLOOP.
   ENDLOOP.

 ENDFORM.                    " CALC_ABEV_ONYB_12A60
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_AFA_1365
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_AFA_1365  TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                 T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                 T_ADOAZON STRUCTURE /ZAK/ONR_ADOAZON
                                 T_AFA_SZLA_SUM STRUCTURE /ZAK/AFA_SZLASUM
                           USING $DATE
                                 $INDEX
                                 $OMREL
*++1665 #06.
                                 $KIUTALAS.
*--1665 #06.
   DATA: L_SUM            LIKE /ZAK/BEVALLO-FIELD_N,
         L_SUM_A0JD0001CA LIKE /ZAK/BEVALLO-FIELD_N,
         L_SUM_SAVE       LIKE /ZAK/BEVALLO-FIELD_N,
         L_KAMAT          LIKE /ZAK/BEVALLO-FIELD_N,
         L_ABEV_SUM       LIKE /ZAK/BEVALLO-FIELD_N.
   DATA: L_KAM_KEZD  TYPE DATUM,
         L_KAM_VEG   TYPE DATUM,
         L_ROUND(20) TYPE C,
         L_TABIX     LIKE SY-TABIX,
         L_UPD.

   DATA: LW_AFA_SZLA_SUM TYPE /ZAK/AFA_SZLASUM.
   DATA: L_LWSTE_SUM TYPE /ZAK/LWSTE.
   DATA: L_OLWSTE TYPE /ZAK/LWSTE.
   DATA: L_AMOUNT_EXTERNAL LIKE  BAPICURR-BAPICURR.
   TYPES: BEGIN OF LT_ADOAZ_SZAMLASZA_SUM,
            ADOAZON TYPE /ZAK/ADOAZON,
            LWSTE   TYPE /ZAK/LWSTE,
          END OF LT_ADOAZ_SZAMLASZA_SUM.
   DATA   LI_ADOAZ_SZAMLASZA_SUM TYPE TABLE OF LT_ADOAZ_SZAMLASZA_SUM.
   DATA   LW_ADOAZ_SZAMLASZA_SUM TYPE LT_ADOAZ_SZAMLASZA_SUM.

************************************************************************
* Special abev fields

******************************************************** CSAK ÁFA normál

   DATA: W_SZ TYPE /ZAK/BEVALLB.

   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.
*  Loading calculated fields
   REFRESH LR_ABEVAZ.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DD0084CA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AF001A   SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AF002A   SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AF005A   SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AF004A   SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DD0082BA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DD0083BA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DD0084BA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DD0085BA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DD0085CA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0JC001A   SPACE.
*++1365 #6.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DD0086BA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DD0086CA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AI002A   SPACE.
*--1365 #6.
*++1365 #17.
   RANGES LR_MONAT FOR /ZAK/AFA_SZLASUM-MONAT.
*--1365 #17.

   SORT T_BEVALLB BY ABEVAZ  .
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_ABEVAZ.
     CLEAR : L_SUM,W_/ZAK/BEVALLO.
* this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
     V_TABIX = SY-TABIX .
     CLEAR: W_/ZAK/BEVALLO-FIELD_N,
            W_/ZAK/BEVALLO-FIELD_NR,
            W_/ZAK/BEVALLO-FIELD_NRK.


     CASE W_/ZAK/BEVALLB-ABEVAZ.
* 84.C. Amount of tax to be paid (data of line 83, if unsigned)
       WHEN C_ABEVAZ_A0DD0084CA.
*++1765 #01.
         L_UPD = 'X'. "Mindig kell update, mert ha megfordul az összeg, akkor űríteni kell
*--1765 #01.
         CLEAR L_SUM.
         READ TABLE T_BEVALLO INTO W_SUM
         WITH KEY ABEVAZ = C_ABEVAZ_A0DD0083CA.
         IF SY-SUBRC = 0.
           IF W_SUM-FIELD_N > 0.
             L_SUM = W_SUM-FIELD_NRK.
             W_/ZAK/BEVALLO-FIELD_N = L_SUM.
           ELSE.
             CLEAR W_/ZAK/BEVALLO-FIELD_N.
           ENDIF.
*++1765 #01.
*         L_UPD = 'X'. "You always have to update, because if the amount changes, you have to empty it
*--1765 #01.
         ENDIF.
* 00C Declaration period from
       WHEN C_ABEVAZ_A0AF001A.
* Havi
         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* A year old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'E'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+4(4) = '0101'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* He is four years old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.

           L_KAM_KEZD = $DATE.
           IF L_KAM_KEZD+4(2) >= '01' AND
              L_KAM_KEZD+4(2) <= '03'.

             L_KAM_KEZD+4(4) = '0101'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '04' AND
              L_KAM_KEZD+4(2) <= '06'.

             L_KAM_KEZD+4(4) = '0401'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '07' AND
              L_KAM_KEZD+4(2) <= '09'.

             L_KAM_KEZD+4(4) = '0701'.
           ENDIF.


           IF L_KAM_KEZD+4(2) >= '10' AND
              L_KAM_KEZD+4(2) <= '12'.

             L_KAM_KEZD+4(4) = '1001'.
           ENDIF.

           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ELSE.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ENDIF.

         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*00C Declaration period until
       WHEN C_ABEVAZ_A0AF002A.
         W_/ZAK/BEVALLO-FIELD_C = $DATE.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*00C Nature of declaration
       WHEN C_ABEVAZ_A0AF004A.
         IF W_/ZAK/BEVALLO-ZINDEX GE '001'.
           W_/ZAK/BEVALLO-FIELD_C = 'O'.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
*04 (O) Mark repeated self-check (x)
       WHEN C_ABEVAZ_A0JC001A.
*        ZINDEX > '001' --> 'X' "repeated self-check
         IF W_/ZAK/BEVALLO-ZINDEX > '001'.
           W_/ZAK/BEVALLO-FIELD_C = 'X'.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
*00C Declaration frequency /H-monthly, N-quarterly, E-yearly
       WHEN C_ABEVAZ_A0AF005A.
         W_/ZAK/BEVALLO-FIELD_C = W_/ZAK/BEVALL-BIDOSZ.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*82.B. The amount of the reducing item that can be calculated from the previous period (previous year
       WHEN C_ABEVAZ_A0DD0082BA.
         PERFORM SET_BEVALLO USING C_ABEVAZ_A0DD0082CA
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*83.C. The total amount of tax payable in the subject period.
       WHEN C_ABEVAZ_A0DD0083BA.
         PERFORM SET_BEVALLO USING C_ABEVAZ_A0DD0083CA
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*84.B. Amount of tax to be paid (data of line 83, if unsigned)
       WHEN C_ABEVAZ_A0DD0084BA.
         PERFORM SET_BEVALLO USING C_ABEVAZ_A0DD0084CA
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*85.B. The amount of tax that can be reclaimed (line 83 with a negative sign, ...
       WHEN C_ABEVAZ_A0DD0085BA.
         PERFORM SET_BEVALLO USING C_ABEVAZ_A0DD0085CA
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*86.B. Amount of claim that can be carried over to the next period
       WHEN C_ABEVAZ_A0DD0086BA.
         PERFORM SET_BEVALLO USING C_ABEVAZ_A0DD0086CA
                             CHANGING W_/ZAK/BEVALLO.
         L_UPD = 'X'.
*00F year month day
       WHEN C_ABEVAZ_A0AI002A.
         W_/ZAK/BEVALLO-FIELD_C = SY-DATUM.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
*85.C. The amount of tax that can be reclaimed (line 83 with a negative sign...
       WHEN  C_ABEVAZ_A0DD0085CA.
*++1765 #01.
         L_UPD = 'X'. "Mindig kell update, mert ha megfordul az összeg, akkor űríteni kell
*--1765 #01.
         READ TABLE T_BEVALLO INTO W_SUM
              WITH KEY ABEVAZ = C_ABEVAZ_A0DD0083CA.
         IF SY-SUBRC EQ 0 AND W_SUM-FIELD_N < 0.
           CLEAR L_SUM.
           L_SUM = W_SUM-FIELD_NRK.
           READ TABLE T_BEVALLO INTO W_SUM
                WITH KEY ABEVAZ = C_ABEVAZ_A0AG017A.
           IF SY-SUBRC EQ 0 AND NOT W_SUM-FIELD_C IS INITIAL.
             W_/ZAK/BEVALLO-FIELD_N = ABS( L_SUM ).
*++1765 #01.
*          L_UPD = 'X'. "You always have to update, because if the amount changes, you have to empty it
*--1765 #01.
           ELSEIF SY-SUBRC EQ 0 AND W_SUM-FIELD_C IS INITIAL.
             CLEAR W_/ZAK/BEVALLO-FIELD_N.
*++1765 #01.
*          L_UPD = 'X'. "You always have to update, because if the amount changes, you have to empty it
*--1765 #01.
           ENDIF.
         ENDIF.
*Carried over to next period
       WHEN  C_ABEVAZ_A0DD0086CA.
*++1765 #01.
         L_UPD = 'X'. "Mindig kell update, mert ha megfordul az összeg, akkor űríteni kell
*--1765 #01.
         READ TABLE T_BEVALLO INTO W_SUM
              WITH KEY ABEVAZ = C_ABEVAZ_A0DD0083CA.
         IF SY-SUBRC EQ 0 AND W_SUM-FIELD_N < 0.
           CLEAR L_SUM.
           L_SUM = W_SUM-FIELD_NRK.
           READ TABLE T_BEVALLO INTO W_SUM
                WITH KEY ABEVAZ = C_ABEVAZ_A0AG017A.
           IF SY-SUBRC EQ 0 AND NOT W_SUM-FIELD_C IS INITIAL.
             CLEAR W_/ZAK/BEVALLO-FIELD_N.
*++1765 #01.
*          L_UPD = 'X'. "You always have to update, because if the amount changes, you have to empty it
*--1765 #01.
           ELSEIF SY-SUBRC EQ 0 AND W_SUM-FIELD_C IS INITIAL.
             W_/ZAK/BEVALLO-FIELD_N = ABS( L_SUM ).
*++1765 #01.
*          L_UPD = 'X'. "You always have to update, because if the amount changes, you have to empty it
*--1765 #01.
           ENDIF.
         ENDIF.

     ENDCASE.
* fill in all numerical values ​​for calculated fields!
* the procedure for forming an amount is as follows:
* pl: ABEV3 field_n = ABEV1 field_nrk + ABEV2 field_nrk
* then apply the default rounding rule!
     IF NOT W_/ZAK/BEVALLB-COLLECT IS INITIAL AND
        L_UPD EQ 'X'.
       CLEAR L_ROUND.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                   W_/ZAK/BEVALLB-ROUND
                   W_/ZAK/BEVALLO-WAERS
          CHANGING W_/ZAK/BEVALLO-FIELD_NR
                   W_/ZAK/BEVALLO-FIELD_NRK.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       CLEAR: L_SUM,L_UPD.
     ENDIF.
     CLEAR: L_UPD,L_SUM,L_ROUND.

   ENDLOOP.

*  Calculation of dependent fields
   REFRESH LR_ABEVAZ.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AG016A SPACE.
ENHANCEMENT-POINT /ZAK/ZAK_1365_RG_01 SPOTS /ZAK/FUNCTIONS_ES .

   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_ABEVAZ.
     CLEAR : L_SUM,W_/ZAK/BEVALLO.
* this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
     V_TABIX = SY-TABIX .
     CLEAR: W_/ZAK/BEVALLO-FIELD_N,
            W_/ZAK/BEVALLO-FIELD_NR,
            W_/ZAK/BEVALLO-FIELD_NRK.


     CASE W_/ZAK/BEVALLB-ABEVAZ.

*00D I do not request a referral
       WHEN C_ABEVAZ_A0AG016A.
*++1665 #06.
         IF NOT $KIUTALAS IS INITIAL.
*--1665 #06.
           READ TABLE T_BEVALLO INTO W_SUM
*++1665 #06.
*                WITH KEY ABEVAZ = C_ABEVAZ_A0DD0085CA.
                WITH KEY ABEVAZ = $KIUTALAS.
*--1665 #06.
           IF SY-SUBRC EQ 0 AND W_SUM-FIELD_N NE 0.
             W_/ZAK/BEVALLO-FIELD_C = C_X.
             MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
           ELSEIF SY-SUBRC EQ 0 AND W_SUM-FIELD_N EQ 0.
             CLEAR W_/ZAK/BEVALLO-FIELD_C.
             MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
           ENDIF.
*++1665 #06.
         ENDIF.
*--1665 #06.
     ENDCASE.
ENHANCEMENT-POINT /ZAK/ZAK_1365_RG_02 SPOTS /ZAK/FUNCTIONS_ES .

* fill in all numerical values ​​for calculated fields!
* the procedure for forming an amount is as follows:
* pl: ABEV3 field_n = ABEV1 field_nrk + ABEV2 field_nrk
* then apply the default rounding rule!
     IF NOT W_/ZAK/BEVALLB-COLLECT IS INITIAL AND
        L_UPD EQ 'X'.
       CLEAR L_ROUND.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                   W_/ZAK/BEVALLB-ROUND
                   W_/ZAK/BEVALLO-WAERS
          CHANGING W_/ZAK/BEVALLO-FIELD_NR
                   W_/ZAK/BEVALLO-FIELD_NRK.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       CLEAR: L_SUM,L_UPD.
     ENDIF.
     CLEAR: L_UPD,L_SUM,L_ROUND.

   ENDLOOP.
*  Calculation of A0AE005A and A0AE006A
   REFRESH LR_ABEVAZ.
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
                    WHERE NOT ONYBF IS INITIAL.
     M_DEF LR_ABEVAZ 'I' 'EQ' W_/ZAK/BEVALLB-ABEVAZ SPACE.
   ENDLOOP.
   IF NOT LR_ABEVAZ[] IS INITIAL.
     LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                      WHERE ABEVAZ IN LR_ABEVAZ
                        AND FIELD_NRK IS NOT INITIAL.
       EXIT.
     ENDLOOP.
*    There is value
     IF SY-SUBRC EQ 0.
*    The value of A0AE004A should be checked
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                        WITH KEY ABEVAZ = C_ABEVAZ_A0AE004A.
       IF SY-SUBRC EQ 0 AND NOT W_/ZAK/BEVALLO-FIELD_C IS INITIAL.
* this line must be modified!
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                          WITH KEY ABEVAZ = C_ABEVAZ_A0AE006A.
         IF SY-SUBRC EQ 0.
           V_TABIX = SY-TABIX .
           W_/ZAK/BEVALLO-FIELD_C = C_X.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
* this line must be filled
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                          WITH KEY ABEVAZ = C_ABEVAZ_A0AE005A.
         IF SY-SUBRC EQ 0.
           V_TABIX = SY-TABIX .
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
       ELSEIF SY-SUBRC EQ 0 AND  W_/ZAK/BEVALLO-FIELD_C IS INITIAL.
* this line must be modified!
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                          WITH KEY ABEVAZ = C_ABEVAZ_A0AE005A.
         IF SY-SUBRC EQ 0.
           V_TABIX = SY-TABIX .
           W_/ZAK/BEVALLO-FIELD_C = C_X.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
* this line must be filled
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                          WITH KEY ABEVAZ = C_ABEVAZ_A0AE006A.
         IF SY-SUBRC EQ 0.
           V_TABIX = SY-TABIX .
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
       ENDIF.
     ENDIF.
   ENDIF.

*  Summary report Calculation of fields below the VAT value limit
   IF NOT $OMREL IS INITIAL.
*  Value limit
     L_AMOUNT_EXTERNAL = W_/ZAK/BEVALL-OLWSTE.
     CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_INTERNAL'
       EXPORTING
         CURRENCY             = C_HUF
         AMOUNT_EXTERNAL      = L_AMOUNT_EXTERNAL
         MAX_NUMBER_OF_DIGITS = 20
       IMPORTING
         AMOUNT_INTERNAL      = L_OLWSTE
*        RETURN               =
       .
*++1365 #17.
*  Month treatment
     REFRESH LR_MONAT.
     IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
       M_DEF LR_MONAT 'I' 'EQ' $DATE+4(2) SPACE.
     ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.
       CASE $DATE+4(2).
         WHEN '03'.
           M_DEF LR_MONAT 'I' 'BT' '01' '03'.
         WHEN '06'.
           M_DEF LR_MONAT 'I' 'BT' '03' '06'.
         WHEN '09'.
           M_DEF LR_MONAT 'I' 'BT' '06' '09'.
         WHEN '12'.
           M_DEF LR_MONAT 'I' 'BT' '10' '12'.
       ENDCASE.
     ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'E'.
       M_DEF LR_MONAT 'I' 'BT' '01' '12'.
     ENDIF.
*--1365 #17.
*    Determination of amount per tax number, per invoice
     LOOP AT T_AFA_SZLA_SUM INTO LW_AFA_SZLA_SUM
                           WHERE MLAP   IS INITIAL
                             AND NYLAPAZON(3) = C_NYLAPAZON_M02.
*++1365 #16.
*      It must only be aggregated within the month
       CHECK LW_AFA_SZLA_SUM-GJAHR EQ $DATE(4) AND
*++1365 #17.
*             LW_AFA_SZLA_SUM-MONAT EQ $DATE+4(2).
             LW_AFA_SZLA_SUM-MONAT IN LR_MONAT.
*--1365 #17.
*--1365 #16.
       CLEAR LW_ADOAZ_SZAMLASZA_SUM.
       LW_ADOAZ_SZAMLASZA_SUM-ADOAZON    = LW_AFA_SZLA_SUM-ADOAZON.
       LW_ADOAZ_SZAMLASZA_SUM-LWSTE      = LW_AFA_SZLA_SUM-LWSTE.
       COLLECT LW_ADOAZ_SZAMLASZA_SUM INTO LI_ADOAZ_SZAMLASZA_SUM.
     ENDLOOP.
*    Determination of value limit
*++1365 #3.
*     DELETE LI_ADOAZ_SZAMLASZA_SUM WHERE LWSTE < L_OLWSTE.
*--1365 #3.*    Összeg visszaírása adószámonként
     READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                        WITH KEY ABEVAZ = C_ABEVAZ_M0AE0006DA.

     LOOP AT LI_ADOAZ_SZAMLASZA_SUM INTO LW_ADOAZ_SZAMLASZA_SUM.
*++1365 #3.
*      If it is listed on sheet M or the value limit is greater than the set one
       READ TABLE T_AFA_SZLA_SUM TRANSPORTING NO FIELDS
                  WITH KEY ADOAZON = LW_ADOAZ_SZAMLASZA_SUM-ADOAZON
*++1365 #11.
                           NYLAPAZON(3) = C_NYLAPAZON_M02
*--1365 #11.
                           MLAP    = 'X'.
*++1365 #8.
*++1365 #11.
       IF SY-SUBRC NE 0 AND LW_ADOAZ_SZAMLASZA_SUM-LWSTE < L_OLWSTE.
*      IF SY-SUBRC NE 0 OR LW_ADOAZ_SZAMLASZA_SUM-LWSTE < L_OLWSTE.
*--1365 #11.
*--1365 #8.
         CONTINUE.
       ENDIF.
*--1365 #3.
*      this line must be modified!
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
            WITH KEY ABEVAZ  = C_ABEVAZ_M0AE0006DA
                     ADOAZON = LW_ADOAZ_SZAMLASZA_SUM-ADOAZON.
       IF SY-SUBRC EQ 0.
         V_TABIX = SY-TABIX.
       ELSE.
*        Creation of tax number ABEV
         PERFORM CREATE_ADOSZ_ABEV_IN_BEVALLO TABLES T_BEVALLO
                                              USING  W_/ZAK/BEVALLO
                                                     W_/ZAK/BEVALLB
                                                     C_ABEVAZ_M0AE0006DA
                                                     LW_ADOAZ_SZAMLASZA_SUM-ADOAZON
                                                     V_TABIX.

       ENDIF.
       CLEAR: W_/ZAK/BEVALLO-FIELD_N,
              W_/ZAK/BEVALLO-FIELD_NR,
              W_/ZAK/BEVALLO-FIELD_NRK.

       W_/ZAK/BEVALLO-FIELD_N = LW_ADOAZ_SZAMLASZA_SUM-LWSTE.

       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                   W_/ZAK/BEVALLB-ROUND
                   W_/ZAK/BEVALLO-WAERS
          CHANGING W_/ZAK/BEVALLO-FIELD_NR
                   W_/ZAK/BEVALLO-FIELD_NRK.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*    Filling filling of other calculated fields of main sheet M
       PERFORM CALC_ABEV_AFA_1365_M TABLES T_BEVALLO
                                           T_BEVALLB
                                    USING  LW_ADOAZ_SZAMLASZA_SUM-ADOAZON
*++1365 #4.
                                           W_/ZAK/BEVALL.
*--1365 #4.

     ENDLOOP.

*    Management of calculated fields also on M flat fields
     FREE LI_ADOAZ_SZAMLASZA_SUM.
*    Determination of amount per tax number, per invoice
     LOOP AT T_AFA_SZLA_SUM INTO LW_AFA_SZLA_SUM
                           WHERE NOT MLAP   IS INITIAL.
       LW_ADOAZ_SZAMLASZA_SUM-ADOAZON    = LW_AFA_SZLA_SUM-ADOAZON.
       COLLECT LW_ADOAZ_SZAMLASZA_SUM INTO LI_ADOAZ_SZAMLASZA_SUM.
     ENDLOOP.

     LOOP AT LI_ADOAZ_SZAMLASZA_SUM INTO LW_ADOAZ_SZAMLASZA_SUM.
*       Filling filling of other calculated fields of main sheet M
       PERFORM CALC_ABEV_AFA_1365_M TABLES T_BEVALLO
                                           T_BEVALLB
                                    USING  LW_ADOAZ_SZAMLASZA_SUM-ADOAZON
*++1365 #4.
                                           W_/ZAK/BEVALL.
*--1365 #4.
     ENDLOOP.






   ENDIF.


************************************************************************
****
* calculation of self-check allowance
************************************************************************
****
*++1365 2013.01.22 Balázs Gábor (Ness)
   IF $INDEX NE '000'.
*   IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
*--1365 2013.01.22 Balázs Gábor (Ness)
* if A0DD0084CA - A0DD0084BA > 0 then this value, otherwise 0
     LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
       WHERE  ABEVAZ EQ     C_ABEVAZ_A0JD0001CA.
       CLEAR: L_SUM,L_SUM_A0JD0001CA.
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_A0DD0084BA  OR
                ABEVAZ EQ     C_ABEVAZ_A0DD0084CA.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_A0DD0084BA.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM < 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_A0JD0001CA = L_SUM_A0JD0001CA + L_SUM.
       CLEAR L_SUM.
* (A0DD0086CA - A0DD0086BA) < 0 then the calculated value is minus
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_A0DD0086CA  OR
                ABEVAZ EQ     C_ABEVAZ_A0DD0086BA.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_A0DD0086BA.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM > 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_A0JD0001CA = L_SUM_A0JD0001CA - L_SUM.
       CLEAR L_SUM.
* A0DD0085CA - A0DD0085BA < 0 then the calculated value is minus
       LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
         WHERE  ABEVAZ EQ     C_ABEVAZ_A0DD0085CA  OR
                ABEVAZ EQ     C_ABEVAZ_A0DD0085BA.
         IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_A0DD0085BA.
           L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
         ELSE.
           L_SUM = L_SUM + W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
       ENDLOOP.
       IF L_SUM > 0 .
         CLEAR L_SUM.
       ENDIF.
       L_SUM_A0JD0001CA = L_SUM_A0JD0001CA - L_SUM.
       CLEAR L_SUM.
*     If A0DD0082CA-A0DD0082BA < 0 then it must be reduced by this amount
*     az L_SUM_A0JD0001CA-at.
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                            WITH KEY ABEVAZ = C_ABEVAZ_A0DD0082CA.
       IF SY-SUBRC EQ 0.
         L_SUM = W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                            WITH KEY ABEVAZ = C_ABEVAZ_A0DD0082BA.
       IF SY-SUBRC EQ 0.
         L_SUM = L_SUM - W_/ZAK/BEVALLO-FIELD_NRK.
       ENDIF.

       IF L_SUM < 0.
         L_SUM_SAVE = ABS( L_SUM ).
         ADD L_SUM TO L_SUM_A0JD0001CA.
       ENDIF.

       IF L_SUM_A0JD0001CA < 0.
         ADD L_SUM_A0JD0001CA TO L_SUM_SAVE.
         CLEAR L_SUM_A0JD0001CA.
       ENDIF.
       READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
       WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.
       V_TABIX = SY-TABIX .
       IF SY-SUBRC EQ 0.
         PERFORM CALC_FIELD_NRK USING L_SUM_A0JD0001CA
                     W_/ZAK/BEVALLB-ROUND
                     W_/ZAK/BEVALLO-WAERS
            CHANGING W_/ZAK/BEVALLO-FIELD_NR
                     W_/ZAK/BEVALLO-FIELD_NRK.
         W_/ZAK/BEVALLO-FIELD_N = L_SUM_A0JD0001CA.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
       ENDIF.
     ENDLOOP.
ENHANCEMENT-POINT /ZAK/ZAK_1365_RG_03 SPOTS /ZAK/FUNCTIONS_ES .

* determination of self-control allowance
* Calculation of ABEV A0JD0002CA based on A0JD0001CA, if the index is 2 or greater, then x1.5
     IF W_/ZAK/BEVALLO-ZINDEX NE '000'.

       READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                            WITH KEY ABEVAZ = C_ABEVAZ_A0JD0002CA.
       IF SY-SUBRC EQ 0.
         CLEAR L_SUM.
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                              WITH KEY ABEVAZ = C_ABEVAZ_A0JD0001CA.
         IF SY-SUBRC = 0.
           L_SUM = W_/ZAK/BEVALLO-FIELD_NRK.
         ENDIF.
* period definition
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                              WITH KEY ABEVAZ = C_ABEVAZ_23337.
         IF SY-SUBRC EQ 0 AND
         NOT W_/ZAK/BEVALLO-FIELD_C IS INITIAL .
* determining the deadline for calculating the allowance! the 104
* I don't need a tax for the /ZAK/ADONEM table key !!
           SELECT SINGLE FIZHAT INTO W_/ZAK/ADONEM-FIZHAT FROM /ZAK/ADONEM
                                 WHERE BUKRS  EQ W_/ZAK/BEVALLO-BUKRS AND
                                                  ADONEM EQ C_ADONEM_104
                                                  .
           IF SY-SUBRC EQ 0.
* start date of allowance calculation
             CLEAR L_KAM_KEZD.
             L_KAM_KEZD = $DATE + 1 + W_/ZAK/ADONEM-FIZHAT.
* end date of allowance calculation in the character field of row 5299 above
             CLEAR L_KAM_VEG.
             CALL FUNCTION 'CONVERSION_EXIT_IDATE_INPUT'
               EXPORTING
                 INPUT  = W_/ZAK/BEVALLO-FIELD_C
               IMPORTING
                 OUTPUT = L_KAM_VEG.
* allowance calculation
             PERFORM CALC_POTLEK USING    W_/ZAK/BEVALLO-BUKRS
                                          W_/ZAK/BEVALLO-ZINDEX
                                 CHANGING L_KAM_KEZD
                                          L_KAM_VEG
                                          L_SUM
                                          L_KAMAT. " A0JD0001CA --> A0JD0002CA
             READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
                                  WITH KEY ABEVAZ = C_ABEVAZ_A0JD0002CA.
             V_TABIX = SY-TABIX.
             IF SY-SUBRC = 0.
               W_/ZAK/BEVALLO-FIELD_N = L_KAMAT.
               PERFORM CALC_FIELD_NRK USING L_KAMAT
                          W_/ZAK/BEVALLB-ROUND
                          W_/ZAK/BEVALLO-WAERS
                 CHANGING W_/ZAK/BEVALLO-FIELD_NR
                          W_/ZAK/BEVALLO-FIELD_NRK.
*              The value of the 0 flag must be handled in the form control
*              miatt:
               IF NOT W_/ZAK/BEVALLO-FIELD_N IS INITIAL AND
                  W_/ZAK/BEVALLO-FIELD_NRK IS INITIAL.
                 W_/ZAK/BEVALLO-NULL_FLAG = 'X'.
               ENDIF.
               MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
             ENDIF.
           ENDIF.
         ENDIF.
       ENDIF.
*      If there is a value, A0JD0001CA must be corrected.
       IF NOT L_SUM_SAVE IS INITIAL.
         READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
         WITH KEY ABEVAZ = C_ABEVAZ_A0JD0001CA.
         V_TABIX = SY-TABIX .
         IF SY-SUBRC EQ 0.
           ADD L_SUM_SAVE TO W_/ZAK/BEVALLO-FIELD_N.
           READ TABLE T_BEVALLB INTO W_/ZAK/BEVALLB
                WITH KEY ABEVAZ = C_ABEVAZ_A0JD0001CA.
           IF SY-SUBRC EQ 0.
             PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                         W_/ZAK/BEVALLB-ROUND
                         W_/ZAK/BEVALLO-WAERS
                CHANGING W_/ZAK/BEVALLO-FIELD_NR
                         W_/ZAK/BEVALLO-FIELD_NRK.
             MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
           ENDIF.
         ENDIF.
       ENDIF.
     ENDIF.
   ENDIF.





*  0 flag field management
* If field1 is not 0 or field2 is not 0 or field3 is not 0 or field4 is not 0
* or field 5 not 0 then 0 flag setting
   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
                              USING  C_ABEVAZ_A0JD0002CA
                              "0-flag beállítás
                                     C_ABEVAZ_A0JD0001CA    "mező1
                                     SPACE                  "mező2
                                     SPACE                  "mező3
                                     SPACE                  "mező4
                                     SPACE                  "mező5
                                     SPACE.                 "mező6

 ENDFORM.                    " CALC_ABEV_AFA_1365
*&---------------------------------------------------------------------*
*&      Form  CREATE_ADOSZ_ABEV_IN_BEVALLO
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_W_/ZAK/BEVALLO  text
*      -->P_C_ABEVAZ_M0AE0006DA  text
*      -->P_LW_ADOAZ_SZAMLASZA_SUM_ADOAZON  text
*      -->P_V_TABIX  text
*----------------------------------------------------------------------*
 FORM CREATE_ADOSZ_ABEV_IN_BEVALLO TABLES $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                   USING  $W_/ZAK/BEVALLO STRUCTURE /ZAK/BEVALLO
                                          $W_/ZAK/BEVALLB STRUCTURE /ZAK/BEVALLB
                                          $ABEVAZ
                                          $ADOAZON
                                          $TABIX.
   DATA LW_/ZAK/BEVALLO TYPE /ZAK/BEVALLO.

   READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLO INDEX 1.

   CLEAR: LW_/ZAK/BEVALLO-ABEVAZ_DISP,
          LW_/ZAK/BEVALLO-BTYPE_DISP,
          LW_/ZAK/BEVALLO-FIELD_C,
          LW_/ZAK/BEVALLO-FIELD_N,
          LW_/ZAK/BEVALLO-ROUND,
          LW_/ZAK/BEVALLO-FIELD_NR,
          LW_/ZAK/BEVALLO-FIELD_NRK,
          LW_/ZAK/BEVALLO-GET_ABEVAZ,
          LW_/ZAK/BEVALLO-OFLAG,
          LW_/ZAK/BEVALLO-FIELD_ON,
          LW_/ZAK/BEVALLO-FIELD_ONR,
          LW_/ZAK/BEVALLO-FIELD_ONRK,
          LW_/ZAK/BEVALLO-NULL_FLAG.

   LW_/ZAK/BEVALLO-ABEVAZ  = $ABEVAZ.
   LW_/ZAK/BEVALLO-ADOAZON = $ADOAZON.
   LW_/ZAK/BEVALLO-BTYPE_DISP  = LW_/ZAK/BEVALLO-BTYPE.
   LW_/ZAK/BEVALLO-ABEVAZ_DISP = LW_/ZAK/BEVALLO-ABEVAZ.
   LW_/ZAK/BEVALLO-ROUND = $W_/ZAK/BEVALLB-ROUND.
   APPEND LW_/ZAK/BEVALLO TO $T_BEVALLO.
   SORT $T_BEVALLO.
   READ TABLE $T_BEVALLO INTO $W_/ZAK/BEVALLO
                     WITH KEY ABEVAZ  = $ABEVAZ
                              ADOAZON = $ADOAZON.
   $TABIX = SY-TABIX.

 ENDFORM.                    " CREATE_ADOSZ_ABEV_IN_BEVALLO

*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_ONYB_13A60
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONYB_13A60 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                  T_BEVALLB STRUCTURE /ZAK/BEVALLB
                           USING  $LAST_DATE.

   DATA L_TABIX LIKE SY-TABIX.

   DATA L_GJAHR TYPE GJAHR.
   DATA L_MONAT TYPE MONAT.
   DATA L_BEGIN_DAY LIKE SY-DATUM.

   CLEAR: L_GJAHR,L_MONAT.

   L_GJAHR = $LAST_DATE(4).
   L_MONAT = $LAST_DATE+4(2).
* E - Year old
   IF W_/ZAK/BEVALL-BIDOSZ = 'E'.
     L_MONAT = '01'.
* N - Quarterly
   ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.
     SUBTRACT 2 FROM L_MONAT.
* H - Havi
   ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'H'.

   ENDIF.

   CONCATENATE L_GJAHR L_MONAT '01' INTO L_BEGIN_DAY.

* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE  ABEVAZ EQ     C_ABEVAZ_23335
        OR  ABEVAZ EQ     C_ABEVAZ_23336
        OR  ABEVAZ EQ     C_ABEVAZ_23338
        OR  ABEVAZ EQ     C_ABEVAZ_23339.

* this line must be modified!
     LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                       WHERE ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.

       CASE W_/ZAK/BEVALLB-ABEVAZ.

*++2010.02.11 RN
* this field is no longer on the 10A60
**    Aláírás dátuma (sy-datum)
*         WHEN  C_ABEVAZ_24.
*           W_/ZAK/BEVALLO-FIELD_C = SY-DATUM.
*--2010.02.11 RN
*    PERIOD start date
         WHEN  C_ABEVAZ_23335.
           W_/ZAK/BEVALLO-FIELD_C = L_BEGIN_DAY.
*    PERIOD closing date
         WHEN  C_ABEVAZ_23336.
           W_/ZAK/BEVALLO-FIELD_C = $LAST_DATE.
*    Loading correction flags
*    We always upload if self-revision:
         WHEN  C_ABEVAZ_23338.
           IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
             W_/ZAK/BEVALLO-FIELD_C = 'H'.
           ENDIF.
*    Frequency of reporting
         WHEN  C_ABEVAZ_23339.
           IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
             W_/ZAK/BEVALLO-FIELD_C = 'H'.
           ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.
             W_/ZAK/BEVALLO-FIELD_C = 'N'.
           ENDIF.
       ENDCASE.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO.
     ENDLOOP.
   ENDLOOP.
*++1765 #07.
* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB
     WHERE  ABEVAZ EQ     C_ABEVAZ_A0AD001A
        OR  ABEVAZ EQ     C_ABEVAZ_A0AD002A
        OR  ABEVAZ EQ     C_ABEVAZ_A0AD003A
        OR  ABEVAZ EQ     C_ABEVAZ_A0AD004A.

* this line must be modified!
     LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                       WHERE ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ.

       CASE W_/ZAK/BEVALLB-ABEVAZ.

*++2010.02.11 RN
* this field is no longer on the 10A60
**    Aláírás dátuma (sy-datum)
*         WHEN  C_ABEVAZ_24.
*           W_/ZAK/BEVALLO-FIELD_C = SY-DATUM.
*--2010.02.11 RN
*    PERIOD start date
         WHEN  C_ABEVAZ_A0AD001A.
           W_/ZAK/BEVALLO-FIELD_C = L_BEGIN_DAY.
*    PERIOD closing date
         WHEN  C_ABEVAZ_A0AD002A.
           W_/ZAK/BEVALLO-FIELD_C = $LAST_DATE.
*    Loading correction flags
*    We always upload if self-revision:
         WHEN  C_ABEVAZ_A0AD003A.
           IF W_/ZAK/BEVALLO-ZINDEX NE '000'.
             W_/ZAK/BEVALLO-FIELD_C = 'H'.
           ENDIF.
*    Frequency of reporting
         WHEN  C_ABEVAZ_A0AD004A.
           IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
             W_/ZAK/BEVALLO-FIELD_C = 'H'.
           ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.
             W_/ZAK/BEVALLO-FIELD_C = 'N'.
           ENDIF.
       ENDCASE.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO.
     ENDLOOP.
   ENDLOOP.
*--1765 #07.

 ENDFORM.                    " CALC_ABEV_ONYB_13A60
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_AFA_1365_M
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_LW_ADOAZ_SZAMLASZA_SUM_ADOAZON  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_AFA_1365_M  TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                     $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                            USING    $ADOAZON
*++1365 #4.
                                     $BEVALL    STRUCTURE /ZAK/BEVALL.
*--1365 #4.

   DATA LW_BEVALLO   TYPE /ZAK/BEVALLO.
   DATA LW_ANALITIKA TYPE /ZAK/ANALITIKA.
   DATA L_NAME1 TYPE NAME1_GP.
*++1365 #4.
   RANGES LR_MONAT FOR /ZAK/ANALITIKA-MONAT.
*--1365 #4.

*  M0AC001A Tax number of the taxpayer, can be taken from: A0AE001A
   PERFORM GET_AFA_M_ABEVAZ TABLES $T_BEVALLO
                                   $T_BEVALLB
                            USING  C_ABEVAZ_M0AC001A
                                   C_ABEVAZ_A0AE001A
                                   $ADOAZON.
*  M0AC003A Tax number of your legal predecessor, can be taken if it is not empty: from A0AE004A
   PERFORM GET_AFA_M_ABEVAZ TABLES $T_BEVALLO
                                   $T_BEVALLB
                            USING  C_ABEVAZ_M0AC003A
                                   C_ABEVAZ_A0AE004A
                                   $ADOAZON.

*  M0AC004A Taxpayer name, can be taken from: A0AE008A
   PERFORM GET_AFA_M_ABEVAZ TABLES $T_BEVALLO
                                   $T_BEVALLB
                            USING  C_ABEVAZ_M0AC004A
                                   C_ABEVAZ_A0AE008A
                                   $ADOAZON.

*  M0AD001A Declaration period from, can be taken from: A0AF001A
   PERFORM GET_AFA_M_ABEVAZ TABLES $T_BEVALLO
                                   $T_BEVALLB
                            USING  C_ABEVAZ_M0AD001A
                                   C_ABEVAZ_A0AF001A
                                   $ADOAZON.

*  M0AD002A Declaration period until , can be taken from: A0AF002A
   PERFORM GET_AFA_M_ABEVAZ TABLES $T_BEVALLO
                                   $T_BEVALLB
                            USING  C_ABEVAZ_M0AD002A
                                   C_ABEVAZ_A0AF002A
                                   $ADOAZON.

* M0AC005A Partner's tax number: the M paper ADOAZON must be entered here,
*if it was loaded from STCD1 (the receiver or
*carrier code+KOART specifies how to ship. Or customer!)
*M0AC006A if loaded from STCD3
   READ TABLE $T_BEVALLO INTO LW_BEVALLO INDEX 1.
*++1365 #4.
*  Upload month:
   REFRESH LR_MONAT.
   IF $BEVALL-BIDOSZ EQ 'H'.
     M_DEF LR_MONAT 'I' 'EQ' LW_BEVALLO-MONAT SPACE.
   ELSEIF $BEVALL-BIDOSZ EQ 'N'.
     IF LW_BEVALLO-MONAT BETWEEN '01' AND '03'.
*++1365 #5.
*      M_DEF LR_MONAT 'I' 'EQ' '01' '03'.
       M_DEF LR_MONAT 'I' 'BT' '01' '03'.
*--1365 #5.
     ELSEIF LW_BEVALLO-MONAT BETWEEN '04' AND '06'.
*++1365 #5.
*      M_DEF LR_MONAT 'I' 'EQ' '04' '06'.
*++1565 #09.
       M_DEF LR_MONAT 'I' 'BT' '04' '06'.
*--1565 #09.
*--1365 #5.
     ELSEIF LW_BEVALLO-MONAT BETWEEN '07' AND '09'.
*++1365 #5.
*      M_DEF LR_MONAT 'I' 'EQ' '07' '09'.
       M_DEF LR_MONAT 'I' 'BT' '07' '09'.
*--1365 #5.
     ELSEIF LW_BEVALLO-MONAT BETWEEN '10' AND '12'.
*++1365 #5.
*      M_DEF LR_MONAT 'I' 'EQ' '10' '12'.
       M_DEF LR_MONAT 'I' 'BT' '10' '12'.
*--1365 #5.
     ENDIF.
   ELSEIF $BEVALL-BIDOSZ EQ 'E'.
*++1365 #5.
*    M_DEF LR_MONAT 'I' 'EQ' '01' '12'.
     M_DEF LR_MONAT 'I' 'BT' '01' '12'.
*--1365 #5.
   ENDIF.
*--1365 #4.
   SELECT SINGLE * INTO LW_ANALITIKA
                   FROM /ZAK/ANALITIKA
                  WHERE BUKRS   EQ LW_BEVALLO-BUKRS
                    AND BTYPE   EQ LW_BEVALLO-BTYPE
                    AND GJAHR   EQ LW_BEVALLO-GJAHR
*++1365 #4.
*                    AND monat   EQ lw_bevallo-monat
                    AND MONAT   IN LR_MONAT
*--1365 #4.
*++1365 #11.
*                    AND ZINDEX  EQ LW_BEVALLO-ZINDEX
                    AND ZINDEX  LE LW_BEVALLO-ZINDEX
*--1365 #11.
                    AND ADOAZON EQ $ADOAZON.
*++1765 #10.
*   IF SY-SUBRC EQ 0.
   IF SY-SUBRC EQ 0 AND NOT $ADOAZON IS INITIAL.
*--1765 #10.
     IF NOT LW_ANALITIKA-STCD3 IS INITIAL.
*      M0AC006A<- STCD3
       PERFORM GET_AFA_M_VALUE  TABLES $T_BEVALLO
                                       $T_BEVALLB
                                USING  C_ABEVAZ_M0AC006A
                                       LW_ANALITIKA-STCD3(8)
                                       $ADOAZON.
*++1365 #9.
*     ELSEIF NOT  LW_ANALITIKA-STCD1 IS INITIAL.
     ENDIF.
     IF NOT  LW_ANALITIKA-STCD1 IS INITIAL.
*--1365 #9.
*      M0AC005A<- STCD1
       PERFORM GET_AFA_M_VALUE  TABLES $T_BEVALLO
                                       $T_BEVALLB
                                USING  C_ABEVAZ_M0AC005A
                                       LW_ANALITIKA-STCD1(8)
                                       $ADOAZON.
*++1365 #7.
     ELSEIF NOT  LW_ANALITIKA-ADOAZON IS INITIAL.
*      M0AC005A<- ADOAZON
       PERFORM GET_AFA_M_VALUE  TABLES $T_BEVALLO
                                       $T_BEVALLB
                                USING  C_ABEVAZ_M0AC005A
                                       LW_ANALITIKA-ADOAZON
                                       $ADOAZON.
*--1365 #7.
     ENDIF.
*    Customer name:
     IF LW_ANALITIKA-KOART EQ 'D'.
       SELECT SINGLE NAME1 INTO L_NAME1
                           FROM KNA1
                          WHERE KUNNR EQ LW_ANALITIKA-LIFKUN
*++1765 #26.
                            AND XCPDK NE 'X'.    "ha nem CPD
*--1765 #26.
*    Supplier name
     ELSEIF LW_ANALITIKA-KOART EQ 'K'.
       SELECT SINGLE NAME1 INTO L_NAME1
                           FROM LFA1
                          WHERE LIFNR EQ LW_ANALITIKA-LIFKUN
*++1765 #26.
                            AND XCPDK NE 'X'.    "ha nem CPD
*--1765 #26.
     ENDIF.
*++1365 #21.
*    There is a name in field_c on a DUMMY_R record
     IF L_NAME1 IS INITIAL AND NOT LW_ANALITIKA-FIELD_C IS INITIAL.
       L_NAME1 = LW_ANALITIKA-FIELD_C.
     ENDIF.
*--1365 #21.
     IF NOT L_NAME1 IS INITIAL.
*      M0AC007A <- NAME1
       PERFORM GET_AFA_M_VALUE  TABLES $T_BEVALLO
                                       $T_BEVALLB
                                USING  C_ABEVAZ_M0AC007A
                                       L_NAME1
                                       $ADOAZON.
*++1365 #3.
     ELSE.
*      M0AC007A <- DUMMY_R FIELD_C field
       PERFORM GET_AFA_M_FROM_ABEV TABLES $T_BEVALLO
                                          $T_BEVALLB
                                   USING  C_ABEVAZ_M0AC007A
                                          C_ABEVAZ_DUMMY_R
                                          $ADOAZON.

*--1365 #3.
     ENDIF.
   ENDIF.

 ENDFORM.                    " CALC_ABEV_AFA_1365_M
*&---------------------------------------------------------------------*
*&      Form  GET_AFA_M_ABEVAZ
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_$T_BEVALLO  text
*      -->P_$T_BEVALLB  text
*      -->P_C_ABEVAZ_M0AC001A  text
*      -->P_C_ABEVAZ_A0AE001A  text
*      -->P_$ADOAZON  text
*----------------------------------------------------------------------*
 FORM GET_AFA_M_ABEVAZ  TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                 $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                        USING    $ABEVAZ_TO
                                 $ABEVAZ_FROM
                                 $ADOAZON.

   DATA LW_/ZAK/BEVALLO TYPE /ZAK/BEVALLO.
   DATA LW_/ZAK/BEVALLO_FROM TYPE /ZAK/BEVALLO.
   DATA LW_/ZAK/BEVALLB TYPE /ZAK/BEVALLB.
   DATA L_TABIX LIKE SY-TABIX.

*  Read the ABEV to be modified
   READ TABLE $T_BEVALLB INTO LW_/ZAK/BEVALLB
                      WITH KEY ABEVAZ = $ABEVAZ_TO.
   CHECK SY-SUBRC EQ 0.
*  this line must be modified!
   READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLO
        WITH KEY ABEVAZ  = $ABEVAZ_TO
                 ADOAZON = $ADOAZON.
   IF SY-SUBRC EQ 0.
     L_TABIX = SY-TABIX.
   ELSE.
*    Creation of tax number ABEV
     PERFORM CREATE_ADOSZ_ABEV_IN_BEVALLO TABLES $T_BEVALLO
                                          USING  LW_/ZAK/BEVALLO
                                                 LW_/ZAK/BEVALLB
                                                 $ABEVAZ_TO
                                                 $ADOAZON
                                                 L_TABIX.

   ENDIF.
*  Let's read the source line first with the Tax ID number, if not, then without it
   READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLO_FROM
        WITH KEY ABEVAZ  = $ABEVAZ_FROM
                 ADOAZON = $ADOAZON.
   IF SY-SUBRC NE 0.
     READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLO_FROM
          WITH KEY ABEVAZ  = $ABEVAZ_FROM.
   ENDIF.
   CHECK SY-SUBRC EQ 0.
   LW_/ZAK/BEVALLO-FIELD_C   = LW_/ZAK/BEVALLO_FROM-FIELD_C.
   LW_/ZAK/BEVALLO-FIELD_N   = LW_/ZAK/BEVALLO_FROM-FIELD_N.
   LW_/ZAK/BEVALLO-FIELD_NR  = LW_/ZAK/BEVALLO_FROM-FIELD_NR.
   LW_/ZAK/BEVALLO-FIELD_NRK = LW_/ZAK/BEVALLO_FROM-FIELD_NRK.

   MODIFY $T_BEVALLO FROM LW_/ZAK/BEVALLO INDEX L_TABIX.

 ENDFORM.                    " GET_AFA_M_ABEVAZ
*&---------------------------------------------------------------------*
*&      Form  GET_AFA_M_ABEVAZ
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_$T_BEVALLO  text
*      -->P_$T_BEVALLB  text
*      -->P_C_ABEVAZ_M0AC001A  text
*      -->P_VALUE text
*      -->P_$ADOAZON  text
*----------------------------------------------------------------------*
 FORM GET_AFA_M_VALUE  TABLES    $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                 $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                        USING    $ABEVAZ_TO
                                 $VALUE
                                 $ADOAZON.

   DATA LW_/ZAK/BEVALLO TYPE /ZAK/BEVALLO.
   DATA LW_/ZAK/BEVALLO_FROM TYPE /ZAK/BEVALLO.
   DATA LW_/ZAK/BEVALLB TYPE /ZAK/BEVALLB.
   DATA L_TABIX LIKE SY-TABIX.

*  Read the ABEV to be modified
   READ TABLE $T_BEVALLB INTO LW_/ZAK/BEVALLB
                      WITH KEY ABEVAZ = $ABEVAZ_TO.
   CHECK SY-SUBRC EQ 0.
*  this line must be modified!
   READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLO
        WITH KEY ABEVAZ  = $ABEVAZ_TO
                 ADOAZON = $ADOAZON.
   IF SY-SUBRC EQ 0.
     L_TABIX = SY-TABIX.
   ELSE.
*    Creation of tax number ABEV
     PERFORM CREATE_ADOSZ_ABEV_IN_BEVALLO TABLES $T_BEVALLO
                                          USING  LW_/ZAK/BEVALLO
                                                 LW_/ZAK/BEVALLB
                                                 $ABEVAZ_TO
                                                 $ADOAZON
                                                 L_TABIX.

   ENDIF.
*  If the ABEV is type C
   IF LW_/ZAK/BEVALLB-FIELDTYPE EQ 'C'.
     LW_/ZAK/BEVALLO-FIELD_C = $VALUE.
   ELSEIF LW_/ZAK/BEVALLB-FIELDTYPE EQ 'N'.
     CLEAR: LW_/ZAK/BEVALLO-FIELD_N,
            LW_/ZAK/BEVALLO-FIELD_NR,
            LW_/ZAK/BEVALLO-FIELD_NRK.

     LW_/ZAK/BEVALLO-FIELD_N = $VALUE.

     PERFORM CALC_FIELD_NRK USING LW_/ZAK/BEVALLO-FIELD_N
                 LW_/ZAK/BEVALLB-ROUND
                 LW_/ZAK/BEVALLO-WAERS
        CHANGING LW_/ZAK/BEVALLO-FIELD_NR
                 LW_/ZAK/BEVALLO-FIELD_NRK.
   ENDIF.

   MODIFY $T_BEVALLO FROM LW_/ZAK/BEVALLO INDEX L_TABIX.

 ENDFORM.                    " GET_AFA_M_VALUE
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_M_SZJA_1308
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_M_SZJA_1308 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                   T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                   T_ADOAZON_ALL STRUCTURE
                                                 /ZAK/ADOAZONLPSZ
                           USING   $INDEX
                                   $LAST_DATE.

   SORT T_BEVALLB BY ABEVAZ.
   SORT T_BEVALLO BY ABEVAZ ADOAZON LAPSZ.
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLB-ABEVAZ.

*  Special M calculations as a tax ID
*  M0BC0370DA M 02-370 d Combined tax base (sum of lines 360-369 "D")
*  field0 = field1+field2+...fieldN as much as is in RANGE
   REFRESH LR_ABEVAZ.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0BC0360DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0BC0361DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0BC0362DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0BC0363DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0BC0364DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0BC0365DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0BC0366DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0BC0367DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0BC0368DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0BC0369DA SPACE.

   PERFORM GET_SUM_R_M TABLES T_BEVALLO
                              T_BEVALLB
                              T_ADOAZON_ALL
                              LR_ABEVAZ
                       USING  C_ABEVAZ_M0BC0370DA.          "mező0

* M0BC0372DA
* field0 = field1-field2.
   PERFORM GET_SUB_M   TABLES T_BEVALLO
                              T_BEVALLB
                              T_ADOAZON_ALL
                       USING  C_ABEVAZ_M0BC0372DA           "mező0
                              C_ABEVAZ_M0BC0370DA           "mező1
                              C_ABEVAZ_M0BC0371DA           "mező2
*++1408 2014.02.10 BG
                              '+'.      "Az eredmény nem lehet '-'
*--1408 2014.02.10 BG

*  M0BC0373DA
*  field0 = field1+field2+...fieldN as much as is in RANGE
   REFRESH LR_ABEVAZ.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0BC0360DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0BC0361DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0BC0362DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0BC0363DA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0BC0368AA SPACE.
   M_DEF LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_M0BC0369AA SPACE.

   PERFORM GET_SUM_R_M TABLES T_BEVALLO
                              T_BEVALLB
                              T_ADOAZON_ALL
                              LR_ABEVAZ
                       USING  C_ABEVAZ_M0BC0373DA.          "mező0

 ENDFORM.                    " CALC_ABEV_M_SZJA_1308
*&---------------------------------------------------------------------*
*&      Form  GET_SUM_R_M
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*----------------------------------------------------------------------*
 FORM GET_SUM_R_M      TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                $T_ADOAZON STRUCTURE /ZAK/ADOAZONLPSZ
                                $R_ABEV    STRUCTURE /ZAK/RANGE_C17
                       USING    $ABEV_MOD.


   DATA L_INDEX_MOD LIKE SY-TABIX.

   DATA L_FIELD_SUM TYPE /ZAK/FIELDN.
   DATA L_FIELD_N   TYPE /ZAK/FIELDN.

   DEFINE LM_READ_DATA.
     CLEAR &4.
     READ TABLE $T_BEVALLO INTO W_/ZAK/BEVALLO
          WITH KEY ABEVAZ  = &1
                   ADOAZON = &2
                   LAPSZ   = &3
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       &4 = W_/ZAK/BEVALLO-FIELD_N.
     ENDIF.
   END-OF-DEFINITION.

*  ADMIT scan
   READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                        WITH KEY ABEVAZ = $ABEV_MOD.

* It must be calculated by tax number:
   LOOP AT $T_ADOAZON.
     CLEAR L_FIELD_SUM.
*   Let's read the ABEV to be modified
     READ TABLE $T_BEVALLO TRANSPORTING NO FIELDS
          WITH KEY ABEVAZ  = $ABEV_MOD
                   ADOAZON = $T_ADOAZON-ADOAZON
                   LAPSZ   = $T_ADOAZON-LAPSZ
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_INDEX_MOD.
*      Determination and summarization of value
       LOOP AT $R_ABEV WHERE SIGN   EQ 'I'
                         AND OPTION EQ 'EQ'.
         LM_READ_DATA $R_ABEV-LOW $T_ADOAZON-ADOAZON
                                  $T_ADOAZON-LAPSZ
                                  L_FIELD_N.
         ADD L_FIELD_N TO L_FIELD_SUM.
       ENDLOOP.

       W_/ZAK/BEVALLO-FIELD_N = L_FIELD_SUM.

       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                    W_/ZAK/BEVALLB-ROUND
                    W_/ZAK/BEVALLO-WAERS
           CHANGING W_/ZAK/BEVALLO-FIELD_NR
                    W_/ZAK/BEVALLO-FIELD_NRK.


       MODIFY $T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_INDEX_MOD
                                            TRANSPORTING FIELD_N
                                                         FIELD_NR
                                                         FIELD_NRK.
     ENDIF.
   ENDLOOP.

 ENDFORM.                    " GET_SUM_R_M
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_SZJA_SPECIAL_1208
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*      -->P_0408   text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SZJA_SPECIAL_1308
                                 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                          T_BEVALLB STRUCTURE
                                          /ZAK/BEVALLB
                                          T_ADOAZON STRUCTURE
                                          /ZAK/ONR_ADOAZON
                                   USING  $INDEX
                                          $DATE.


   DATA LR_COND TYPE RANGE_C2 OCCURS 0 WITH HEADER LINE.
   DATA L_TMP_BEVALLO TYPE /ZAK/BEVALLO.
   DATA L_BEVALLO TYPE /ZAK/BEVALLO.

   FIELD-SYMBOLS: <FIELD_N>, <FIELD_NR>, <FIELD_NRK>.

   DEFINE LM_GET_FIELD.
     IF &1 EQ '000'.
       ASSIGN W_/ZAK/BEVALLO-FIELD_N   TO <FIELD_N>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_NR  TO <FIELD_NR>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_NRK TO <FIELD_NRK>.
     ELSE.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ON   TO <FIELD_N>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ONR  TO <FIELD_NR>.
       ASSIGN W_/ZAK/BEVALLO-FIELD_ONRK TO <FIELD_NRK>.
     ENDIF.
     CLEAR: <FIELD_N>, <FIELD_NR>, <FIELD_NRK>.
   END-OF-DEFINITION.

   DEFINE LM_GET_SPEC_SUM1.
     LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ = &1.
*      The ABEV for the condition must be determined
*      ID value
       READ TABLE T_BEVALLO INTO L_TMP_BEVALLO
                WITH KEY ABEVAZ  = &2
                         ADOAZON = L_BEVALLO-ADOAZON
                          LAPSZ  = L_BEVALLO-LAPSZ
                          BINARY SEARCH.
       IF SY-SUBRC EQ 0.
         CONDENSE L_TMP_BEVALLO-FIELD_C.
         IF L_TMP_BEVALLO-FIELD_C IN &3.
           ADD L_BEVALLO-FIELD_N TO <FIELD_N>.
         ENDIF.
       ENDIF.
     ENDLOOP.
   END-OF-DEFINITION.

   RANGES LR_ABEVAZ     FOR /ZAK/BEVALLO-ABEVAZ.
   RANGES LR_SEL_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.


   DEFINE LM_GET_SPEC_SUM2.
     IF NOT &1[] IS INITIAL.
       LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ IN &1.
         IF $INDEX EQ '000'.
           ADD L_BEVALLO-FIELD_N TO <FIELD_N>.
         ELSE.
           ADD L_BEVALLO-FIELD_ON TO <FIELD_N>.
         ENDIF.
       ENDLOOP.
     ENDIF.
   END-OF-DEFINITION.

   SORT T_BEVALLB BY ABEVAZ.

*  Uploading selective ABEVAZ
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0081CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0082CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0083CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0084CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0085CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0091CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0092CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0093CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0094CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0DC0095CA SPACE.

   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0100CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0101CA SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0EC0102CA SPACE.

* the following abev codes can only occur once, summary v. char
   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_SEL_ABEVAZ.

     CLEAR W_/ZAK/BEVALLO.

*    this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
              BINARY SEARCH.

     CHECK SY-SUBRC EQ 0.

     V_TABIX = SY-TABIX .

*    Special calculations
     CASE W_/ZAK/BEVALLB-ABEVAZ.
*The 03-081 START card comes with a 10% social security tax
*(Code 1: line 643 ""c"")
       WHEN  C_ABEVAZ_A0DC0081CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '1' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0ID0643CA' 'M0IC007A' LR_COND.
*02-039 With the START card, there is a 20% social security tax (1
*code: line 644 "c")
       WHEN  C_ABEVAZ_A0DC0082CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '1' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0ID0644CA' 'M0IC007A' LR_COND.
*The 02-040 A START PLUSZ card comes with a 10% social security tax
*(Code 2: line 643 "c")
       WHEN  C_ABEVAZ_A0DC0083CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '2' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0ID0643CA' 'M0IC007A' LR_COND.
*The 02-041 START PLUSZ card comes with a 20% social security tax
*(Code 2: line 644 "c")
       WHEN  C_ABEVAZ_A0DC0084CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '2' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0ID0644CA' 'M0IC007A' LR_COND.
*With the 02-042 A START EXTRA card, you get a 10% social bonus
*tax (code 3: line 643 "c")
       WHEN  C_ABEVAZ_A0DC0085CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '3' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0ID0643CA' 'M0IC007A' LR_COND.
*A 03-091 He works in a position that does not require a s/zak/zak qualification
*12.5% ​​socho (code 1: line 679 "c")
       WHEN  C_ABEVAZ_A0DC0091CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '05' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0JD0679CA' 'M0JC007A' LR_COND.
*A 03-092 Under 25 years of age with more than 180 days of employment
*12,5% szocho (7-es kód:679.sor "c")
       WHEN  C_ABEVAZ_A0DC0092CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '07' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0JD0679CA' 'M0JC007A' LR_COND.
*A 03-093 Persons over 55 years of age 12.5% ​​socho (code 8: line 679 "c")
       WHEN  C_ABEVAZ_A0DC0093CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '08' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0JD0679CA' 'M0JC007A' LR_COND.
*03-094 A GYED,GYES,GYET will take 12.5% ​​socho (code 10: line 679 "c")
       WHEN  C_ABEVAZ_A0DC0094CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '10' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0JD0679CA' 'M0JC007A' LR_COND.
*A 03-095 The shoulder operating in the free shoulder zone is 12.5% ​​socho
*(Code 11: line 679 "c")
       WHEN  C_ABEVAZ_A0DC0095CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '11' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0JD0679CA' 'M0JC007A' LR_COND.
*A 03-055 The private individual's pension contribution (lines 563,603,611
*"c" fodl min NEM 25,42,81,83,92,93)
       WHEN  C_ABEVAZ_A0EC0100CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'E' 'EQ' '25' SPACE.
         M_DEF LR_COND 'E' 'EQ' '42' SPACE.
         M_DEF LR_COND 'E' 'EQ' '81' SPACE.
         M_DEF LR_COND 'E' 'EQ' '83' SPACE.
         M_DEF LR_COND 'E' 'EQ' '92' SPACE.
         M_DEF LR_COND 'E' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0GD0563CA' 'M0GC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0GF0602CA' 'M0GC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0GG0611CA' 'M0GC004A' LR_COND.
*A 03-56-c The burden of unemployment, employment pension
*(611.sorok "c" fogl min 25,42,81)
       WHEN  C_ABEVAZ_A0EC0101CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '25' SPACE.
         M_DEF LR_COND 'I' 'EQ' '42' SPACE.
         M_DEF LR_COND 'I' 'EQ' '81' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0GG0611CA' 'M0GC004A' LR_COND.
*A 03-57-c The private sector pays pension after GYED, S, T (lines 603, 611
*"c" a fogl min 83, 92, 93)
       WHEN C_ABEVAZ_A0EC0102CA.
*        Upload condition
         REFRESH LR_COND.
         M_DEF LR_COND 'I' 'EQ' '83' SPACE.
         M_DEF LR_COND 'I' 'EQ' '92' SPACE.
         M_DEF LR_COND 'I' 'EQ' '93' SPACE.
         LM_GET_FIELD $INDEX.
         LM_GET_SPEC_SUM1 'M0GF0602CA' 'M0GC004A' LR_COND.
         LM_GET_SPEC_SUM1 'M0GG0611CA' 'M0GC004A' LR_COND.
     ENDCASE.

     PERFORM CALC_FIELD_NRK USING <FIELD_N>
                  W_/ZAK/BEVALLB-ROUND
                  W_/ZAK/BEVALLO-WAERS
         CHANGING <FIELD_NR>
                  <FIELD_NRK>.
     IF $INDEX NE '000'.
       MOVE 'X' TO W_/ZAK/BEVALLO-OFLAG.
     ENDIF.
     MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

   ENDLOOP.

 ENDFORM.                    " CALC_ABEV_SZJA_SPECIAL_1308
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_SZJA_1308
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_$LAST_DATE  text
*      -->P_$INDEX  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_SZJA_1308  TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                   T_BEVALLB STRUCTURE /ZAK/BEVALLB
                            USING  $DATE
                                   $INDEX.

   DATA: L_KAM_KEZD TYPE DATUM.

   DATA: BEGIN OF LI_ADOAZON OCCURS 0,
           ADOAZON TYPE /ZAK/ADOAZON,
         END OF LI_ADOAZON.
   DATA: L_BEVALLO TYPE /ZAK/BEVALLO.

*  To define a self-check
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.
   RANGES LR_SEL_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.

************************************************************************
* Special abev fields
************************************************************************

   SORT T_BEVALLB BY ABEVAZ  .

* the following abev codes can only occur once, summary v. char

   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC039A SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC040A SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC041A SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0AC044A SPACE.
   M_DEF LR_SEL_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FC001A SPACE.


   LOOP AT T_BEVALLB INTO W_/ZAK/BEVALLB WHERE ABEVAZ IN LR_SEL_ABEVAZ.

     CLEAR W_/ZAK/BEVALLO.

*    this line must be modified!
     READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO
     WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
          BINARY SEARCH.

     CHECK SY-SUBRC EQ 0.
     V_TABIX = SY-TABIX .


     CASE W_/ZAK/BEVALLB-ABEVAZ.
*      period from first day
       WHEN C_ABEVAZ_A0AC039A.
* Havi
         IF W_/ZAK/BEVALL-BIDOSZ = 'H'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* A year old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'E'.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+4(4) = '0101'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
* He is four years old
         ELSEIF W_/ZAK/BEVALL-BIDOSZ = 'N'.

           L_KAM_KEZD = $DATE.
           IF L_KAM_KEZD+4(2) >= '01' AND
              L_KAM_KEZD+4(2) <= '03'.

             L_KAM_KEZD+4(4) = '0101'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '04' AND
              L_KAM_KEZD+4(2) <= '06'.

             L_KAM_KEZD+4(4) = '0401'.
           ENDIF.

           IF L_KAM_KEZD+4(2) >= '07' AND
              L_KAM_KEZD+4(2) <= '09'.

             L_KAM_KEZD+4(4) = '0701'.
           ENDIF.


           IF L_KAM_KEZD+4(2) >= '10' AND
              L_KAM_KEZD+4(2) <= '12'.

             L_KAM_KEZD+4(4) = '1001'.
           ENDIF.

           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ELSE.
           L_KAM_KEZD = $DATE.
           L_KAM_KEZD+6(2) = '01'.
           W_/ZAK/BEVALLO-FIELD_C = L_KAM_KEZD.
         ENDIF.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*      last day until period
       WHEN C_ABEVAZ_A0AC040A.
         W_/ZAK/BEVALLO-FIELD_C = $DATE.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*      Number of taxpayers = Tax numbers
       WHEN C_ABEVAZ_A0AC044A.

         REFRESH LI_ADOAZON.
         LOOP AT T_BEVALLO INTO L_BEVALLO.
           CHECK NOT L_BEVALLO-ADOAZON IS INITIAL.
           MOVE L_BEVALLO-ADOAZON TO LI_ADOAZON.
           COLLECT LI_ADOAZON.
         ENDLOOP.


         DESCRIBE TABLE LI_ADOAZON LINES SY-TFILL.
         IF NOT SY-TFILL IS INITIAL.
           W_/ZAK/BEVALLO-FIELD_C = SY-TFILL.
         ELSE.
           CLEAR W_/ZAK/BEVALLO-FIELD_C.
         ENDIF.

         CONDENSE W_/ZAK/BEVALLO-FIELD_C.
         MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.

*      Correction, Self-check
       WHEN C_ABEVAZ_A0AC041A.
*        Only in self-check
         IF $INDEX NE '000'.
           REFRESH LR_ABEVAZ.
*          A numerical value must be searched for in this range
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0FD0150DA
                                    C_ABEVAZ_A0FD0180DA.
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0GC0190CA
                                    C_ABEVAZ_A0GE0200CA.
           LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ IN LR_ABEVAZ
*          We monitor the rounded sum because it may be FIELD_N
*          it is not empty, but no value is added to the return because of the fkator.
*                                          AND NOT FIELD_N  IS INITIAL.
                                           AND NOT FIELD_NR IS INITIAL.
             EXIT.
           ENDLOOP.
*          There is value:
           IF SY-SUBRC EQ 0.
             W_/ZAK/BEVALLO-FIELD_C = 'O'.
*          Corrective
           ELSE.
             W_/ZAK/BEVALLO-FIELD_C = 'H'.
           ENDIF.
           CONDENSE W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.
*      Repeated self-check
       WHEN C_ABEVAZ_A0FC001A.
*        Only in self-check
         IF $INDEX > '001'.
           REFRESH LR_ABEVAZ.
*          A numerical value must be searched for in this range
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0FD0150DA
                                    C_ABEVAZ_A0FD0180DA.
           M_DEF LR_ABEVAZ 'I' 'BT' C_ABEVAZ_A0GC0190CA
                                    C_ABEVAZ_A0GE0200CA.
           LOOP AT T_BEVALLO INTO L_BEVALLO WHERE ABEVAZ IN LR_ABEVAZ
*          We monitor the rounded sum because it may be FIELD_N
*          it is not empty, but no value is added to the return because of the fkator.
*                                          AND NOT FIELD_N  IS INITIAL.
                                           AND NOT FIELD_NR IS INITIAL.
             EXIT.
           ENDLOOP.
*          There is value:
           IF SY-SUBRC EQ 0.
             W_/ZAK/BEVALLO-FIELD_C = 'X'.
           ENDIF.
           CONDENSE W_/ZAK/BEVALLO-FIELD_C.
           MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO INDEX V_TABIX.
         ENDIF.

     ENDCASE.

   ENDLOOP.

 ENDFORM.                    " CALC_ABEV_SZJA_1308
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_0_SZJA_1308
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_ADOAZON_ALL  text
*      -->P_SPACE  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_0_SZJA_1308  TABLES  T_BEVALLO STRUCTURE /ZAK/BEVALLO
                              T_ADOAZON_ALL STRUCTURE /ZAK/ADOAZONLPSZ
                              USING   $ONREV
                                      $DATE
                                      $INDEX.

   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.
   DATA   LR_VALUE  LIKE RANGE_C3 OCCURS 0 WITH HEADER LINE.
*++2011.07.11 BG
   DATA   LR_VALUE2 LIKE RANGE_C3 OCCURS 0 WITH HEADER LINE.
*--2011.07.11 BG
* So that you don't have to expand the self-revision to a global one for every FORM
* treated as a variable:
   CLEAR V_ONREV.
   IF NOT $ONREV IS INITIAL.
     MOVE $ONREV TO V_ONREV.
   ENDIF.

**  Ha mező1 >= mező2 akkor mező3 0 flag beállítás
*   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
*                                T_ADOAZON_ALL
*                         USING C_ABEVAZ_M0BC0382CA "field1
*                                C_ABEVAZ_M0BC0382BA "field2
*                                C_ABEVAZ_M0BC0382DA.        "field 3
**  Ha mező1+mező2+mező3+mező4 > 0 akkor 0 flag beállítás
*   PERFORM GET_NULL_FLAG_ASUM TABLES T_BEVALLO
*                              USING  C_ABEVAZ_A0IC0284HA
*                              "0-flag setting
*                                     C_ABEVAZ_A0IC0284CA "field1
*                                     C_ABEVAZ_A0IC0284DA "field2
*                                     C_ABEVAZ_A0IC0284EA "field3
*                                     SPACE.                 "field 4
** Ha mező1 ne 0 vagy mező2 ne 0 vagy mező3 ne 0 vagy mező4 ne 0
** vagy mező5 ne 0 akkor 0 flag beállítás
*   PERFORM GET_NULL_FLAG_INIT TABLES T_BEVALLO
*                              USING  C_ABEVAZ_A0DC0087DA    "0flag
*                                     C_ABEVAZ_A0DC0087CA "field1
*                                     SPACE "field2
*                                     SPACE "field3
*                                     SPACE "field4
*                                     SPACE "field5
*                                     SPACE.                 "field 6
*   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
*                                      T_ADOAZON_ALL
*                               USING  C_ABEVAZ_M0CC0415DA   "0flag
*                                      C_ABEVAZ_M0BC0382BA "field1
*                                      C_ABEVAZ_M0BC0386BA "field2
*                                      SPACE "field3
*                                      SPACE "field4
*                                      SPACE "field5
*                                      SPACE.                "field 6
** mező1-n 0 flag állítás
*     PERFORM GET_NULL_FLAG_0     TABLES T_BEVALLO
*                                 USING  C_ABEVAZ_A0BC50041A.
* If field1 = field2 then 0 flag is set
*   PERFORM GET_NULL_FLAG_EQM TABLES T_BEVALLO
*                                    T_ADOAZON_ALL
*                             USING C_ABEVAZ_M0FD0496AA "field1
*                                    C_ABEVAZ_M0FD0495AA "field2
*                                    C_ABEVAZ_M0FD0498BA     "0-flag
*                                    C_ABEVAZ_M0FD0497BA.    "0-flag

*  If field1 >= field2 then field3 0 flag setting
   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0361CA         "mező1
                                C_ABEVAZ_M0BC0361BA         "mező2
                                C_ABEVAZ_M0BC0361DA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0361DA         "mező1
                                C_ABEVAZ_M0BC0361BA         "mező2
                                C_ABEVAZ_M0BC0361CA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0362CA         "mező1
                                C_ABEVAZ_M0BC0362BA         "mező2
                                C_ABEVAZ_M0BC0362DA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0362DA         "mező1
                                C_ABEVAZ_M0BC0362BA         "mező2
                                C_ABEVAZ_M0BC0362CA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0365CA         "mező1
                                C_ABEVAZ_M0BC0365BA         "mező2
                                C_ABEVAZ_M0BC0365DA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0365DA         "mező1
                                C_ABEVAZ_M0BC0365BA         "mező2
                                C_ABEVAZ_M0BC0365CA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0366CA         "mező1
                                C_ABEVAZ_M0BC0366BA         "mező2
                                C_ABEVAZ_M0BC0366DA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0366DA         "mező1
                                C_ABEVAZ_M0BC0366BA         "mező2
                                C_ABEVAZ_M0BC0366CA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0367CA         "mező1
                                C_ABEVAZ_M0BC0367BA         "mező2
                                C_ABEVAZ_M0BC0367DA.        "mező3

   PERFORM GET_NULL_FLAG TABLES T_BEVALLO
                                T_ADOAZON_ALL
                         USING  C_ABEVAZ_M0BC0367DA         "mező1
                                C_ABEVAZ_M0BC0367BA         "mező2
                                C_ABEVAZ_M0BC0367CA.        "mező3
*  0 flag setting on field 1
   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0BC0370DA.

   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0BC0372DA.

   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0JD0682AA.

   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0JD0682CA.

   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0BD0400BA.

   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0BD0401BA.

   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0ID0642AA.

   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0ID0642CA.

   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0ID0645AA.

   PERFORM GET_NULL_FLAG_0_M   TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0ID0645CA.

   PERFORM GET_NULL_FLAG_INITM_C TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0GD0560CA   "0flag
                                      C_ABEVAZ_M0GC001A     "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6

   PERFORM GET_NULL_FLAG_INITM_C TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0GD0563CA   "0flag
                                      C_ABEVAZ_M0GC001A     "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6
*++1308 2013.03.08
* Self-audit supplement if self-audit
   IF $INDEX NE '000'.
     PERFORM GET_NULL_FLAG_0     TABLES T_BEVALLO
                                 USING  C_ABEVAZ_A0GC0190CA.
     PERFORM GET_NULL_FLAG_0     TABLES T_BEVALLO
                                 USING  C_ABEVAZ_A0GC0192CA.
   ENDIF.

   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0JD0678CA   "0flag
                                      C_ABEVAZ_M0JD0678AA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6
*--1308 2013.03.08
*++1308 2013.07.10
   PERFORM GET_NULL_FLAG_INITM TABLES T_BEVALLO
                                      T_ADOAZON_ALL
                               USING  C_ABEVAZ_M0EE0500AA   "0flag
                                      C_ABEVAZ_M0EE0499BA   "mező1
                                      SPACE                 "mező2
                                      SPACE                 "mező3
                                      SPACE                 "mező4
                                      SPACE                 "mező5
                                      SPACE.                "mező6
*--1308 2013.07.10
 ENDFORM.                    " CALC_ABEV_0_SZJA_1308
*&---------------------------------------------------------------------*
*&      Form  GET_LAP_SZ_1308
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*----------------------------------------------------------------------*
 FORM GET_LAP_SZ_1308  TABLES T_BEVALLO STRUCTURE  /ZAK/BEVALLALV.


   DATA L_ALV LIKE /ZAK/BEVALLALV.
   DATA L_INDEX LIKE SY-TABIX.
   DATA L_TABIX LIKE SY-TABIX.
   DATA L_NYLAP LIKE SY-TABIX.
   DATA L_BEVALLO_ALV LIKE /ZAK/BEVALLALV.
   DATA L_NULL_FLAG TYPE /ZAK/NULL.

   CLEAR L_INDEX.

*  Upload RANKS to manage retired numbers
   M_DEF R_A0AC047A 'I' 'EQ' 'M0FC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0GC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0HC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0IC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0JC003A' SPACE.
   M_DEF R_A0AC047A 'I' 'EQ' 'M0KC003A' SPACE.

*  Values
   M_DEF R_NYLAPVAL 'I' 'EQ' '7' SPACE.
   M_DEF R_NYLAPVAL 'I' 'EQ' '8' SPACE.


   REFRESH I_NYLAP.

   LOOP AT I_/ZAK/BEVALLO INTO W_/ZAK/BEVALLO.
     L_TABIX = SY-TABIX.

*   Dialog run for insurance
     PERFORM PROCESS_IND_ITEM USING '100000'
                                    L_INDEX
                                    TEXT-P01.

*   Csak SZJA-nal
     IF  W_/ZAK/BEVALL-BTYPART EQ C_BTYPART_SZJA.
*      Collection of pensioner tax numbers
       PERFORM CALL_NYLAP TABLES R_A0AC047A
                                 R_NYLAPVAL
                          USING  W_/ZAK/BEVALLO.

     ENDIF.

     READ TABLE T_BEVALLO INTO L_ALV WITH KEY
                   BUKRS   = W_/ZAK/BEVALLO-BUKRS
                   BTYPE   = W_/ZAK/BEVALLO-BTYPE
                   GJAHR   = W_/ZAK/BEVALLO-GJAHR
                   MONAT   = W_/ZAK/BEVALLO-MONAT
                   ZINDEX  = W_/ZAK/BEVALLO-ZINDEX
                   ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ
                   ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                   LAPSZ   = W_/ZAK/BEVALLO-LAPSZ
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
*  The 0 flag handling was not appropriate
*  If it is a self-revision calculation, the T_BEVALLO 0 flag is required
*  otherwise, the I_/ZAK/BEVALLO 0 flag.
       IF NOT L_ALV-OFLAG IS INITIAL.
         L_NULL_FLAG = L_ALV-NULL_FLAG.
       ELSE.
         L_NULL_FLAG = W_/ZAK/BEVALLO-NULL_FLAG.
       ENDIF.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
       L_ALV-NULL_FLAG = L_NULL_FLAG.
       IF L_ALV-OFLAG IS INITIAL.
         MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX
                         TRANSPORTING FIELD_C FIELD_N FIELD_NR FIELD_NRK
                                      NULL_FLAG WAERS
                                       .
       ELSE.
         MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX
                         TRANSPORTING FIELD_C FIELD_N  FIELD_NR
                         FIELD_NRK
                                      OFLAG   FIELD_ON FIELD_ONR
                                      FIELD_ONRK
                                      NULL_FLAG WAERS.
         PERFORM SUM_ONR TABLES T_BEVALLO
                         USING  L_ALV
                                L_ALV-FIELD_ON
                                L_ALV-FIELD_ONR
                                L_ALV-FIELD_ONRK.
       ENDIF.
     ELSE.
       READ TABLE I_/ZAK/BEVALLB INTO W_/ZAK/BEVALLB
       WITH KEY ABEVAZ = W_/ZAK/BEVALLO-ABEVAZ.
       MOVE-CORRESPONDING W_/ZAK/BEVALLB TO L_ALV.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
       SELECT SINGLE ABEVTEXT INTO L_ALV-ABEVTEXT
         FROM  /ZAK/BEVALLBT
              WHERE  LANGU   = SY-LANGU
              AND    BTYPE   = W_/ZAK/BEVALLO-BTYPE
              AND    ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ.
       L_ALV-ABEVTEXT_DISP = L_ALV-ABEVTEXT.
       APPEND L_ALV TO T_BEVALLO.
       SORT T_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ ADOAZON
            LAPSZ.
     ENDIF.
     DELETE I_/ZAK/BEVALLO.
   ENDLOOP.

*  Definition of pensioners
   IF NOT I_NYLAP[] IS INITIAL.
     DESCRIBE TABLE I_NYLAP LINES L_NYLAP.
     READ TABLE T_BEVALLO INTO L_BEVALLO_ALV
                          WITH KEY ABEVAZ  = C_ABEVAZ_A0AC045A
                          BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE L_NYLAP TO L_BEVALLO_ALV-FIELD_C.
       CONDENSE L_BEVALLO_ALV-FIELD_C.
       MODIFY T_BEVALLO FROM L_BEVALLO_ALV INDEX SY-TABIX
                             TRANSPORTING FIELD_C.
     ENDIF.
   ELSE.
     READ TABLE T_BEVALLO INTO L_BEVALLO_ALV
                          WITH KEY ABEVAZ  = C_ABEVAZ_A0AC045A
                          BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       CLEAR L_BEVALLO_ALV-FIELD_C.
       MODIFY T_BEVALLO FROM L_BEVALLO_ALV INDEX SY-TABIX
                             TRANSPORTING FIELD_C.
     ENDIF.
   ENDIF.

 ENDFORM.                    " GET_LAP_SZ_1308
*&---------------------------------------------------------------------*
*&      Form  del_esdat_field_1208
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_C_ABEVAZ_A0AC033A  text
*----------------------------------------------------------------------*
 FORM DEL_ESDAT_FIELD_1308 TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLALV
                                    $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                           USING    $ABEVAZ_JELLEG.

   DATA LW_/ZAK/BEVALLALV TYPE /ZAK/BEVALLALV.

*  We define the character:
   READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                         WITH KEY ABEVAZ = $ABEVAZ_JELLEG
                         BINARY SEARCH.
*  In this case, you do not need to fill in the due date:
   IF SY-SUBRC EQ 0 AND LW_/ZAK/BEVALLALV-FIELD_C = 'H'.
**  ESDAT_FLAG-ben megjelölt ABEV azonosító értéke
*     READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
*                         WITH KEY  ESDAT_FLAG = 'X'.
*     IF SY-SUBRC EQ 0.
*       READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
*                           WITH KEY ABEVAZ = W_/ZAK/BEVALLB-ABEVAZ
*                           BINARY SEARCH.
*       IF SY-SUBRC EQ 0.
*         V_TABIX = SY-TABIX .
*         CLEAR LW_/ZAK/BEVALLALV-FIELD_C.
*         MODIFY $T_BEVALLO FROM LW_/ZAK/BEVALLALV
*                               INDEX V_TABIX TRANSPORTING FIELD_C.
*       ENDIF.
*     ENDIF.
*  For correctors, there is no need for 0 flag in the self-check allowance either
     READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLALV
                         WITH KEY ABEVAZ = C_ABEVAZ_A0GC0190CA
                         BINARY SEARCH.
     IF SY-SUBRC EQ 0 AND NOT LW_/ZAK/BEVALLALV-NULL_FLAG IS INITIAL.
       V_TABIX = SY-TABIX .
       CLEAR LW_/ZAK/BEVALLALV-NULL_FLAG.
       MODIFY $T_BEVALLO FROM LW_/ZAK/BEVALLALV
                             INDEX V_TABIX TRANSPORTING NULL_FLAG.
     ENDIF.
   ENDIF.

 ENDFORM.                    " del_esdat_field_1308
*++1365 #3.
*&---------------------------------------------------------------------*
*&      Form  GET_AFA_M_FROM_ABEV
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_$T_BEVALLO  text
*      -->P_$T_BEVALLB  text
*      -->P_C_ABEVAZ_M0AC001A  text
*      -->P_VALUE text
*      -->P_$ADOAZON  text
*----------------------------------------------------------------------*
 FORM GET_AFA_M_FROM_ABEV  TABLES    $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                     $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                            USING    $ABEVAZ_TO
                                     $ABEVAZ_FROM
                                     $ADOAZON.

   DATA LW_/ZAK/BEVALLO TYPE /ZAK/BEVALLO.
   DATA LW_/ZAK/BEVALLO_FROM TYPE /ZAK/BEVALLO.
   DATA LW_/ZAK/BEVALLB TYPE /ZAK/BEVALLB.
   DATA L_TABIX LIKE SY-TABIX.

*  Read the ABEV to be modified
   READ TABLE $T_BEVALLB INTO LW_/ZAK/BEVALLB
                      WITH KEY ABEVAZ = $ABEVAZ_TO.
   CHECK SY-SUBRC EQ 0.
*  this line must be modified!
   READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLO
        WITH KEY ABEVAZ  = $ABEVAZ_TO
                 ADOAZON = $ADOAZON.
   IF SY-SUBRC EQ 0.
     L_TABIX = SY-TABIX.
   ELSE.
*    Creation of tax number ABEV
     PERFORM CREATE_ADOSZ_ABEV_IN_BEVALLO TABLES $T_BEVALLO
                                          USING  LW_/ZAK/BEVALLO
                                                 LW_/ZAK/BEVALLB
                                                 $ABEVAZ_TO
                                                 $ADOAZON
                                                 L_TABIX.

   ENDIF.
   READ TABLE $T_BEVALLO INTO LW_/ZAK/BEVALLO_FROM
                     WITH KEY  ADOAZON = $ADOAZON
                               ABEVAZ = $ABEVAZ_FROM.
   CHECK SY-SUBRC EQ 0.
*  If the ABEV is type C
   IF LW_/ZAK/BEVALLB-FIELDTYPE EQ 'C'.
     LW_/ZAK/BEVALLO-FIELD_C = LW_/ZAK/BEVALLO_FROM-FIELD_C.
   ELSEIF LW_/ZAK/BEVALLB-FIELDTYPE EQ 'N'.
     CLEAR: LW_/ZAK/BEVALLO-FIELD_N,
            LW_/ZAK/BEVALLO-FIELD_NR,
            LW_/ZAK/BEVALLO-FIELD_NRK.

     LW_/ZAK/BEVALLO-FIELD_N = LW_/ZAK/BEVALLO_FROM-FIELD_N.

     PERFORM CALC_FIELD_NRK USING LW_/ZAK/BEVALLO-FIELD_N
                 LW_/ZAK/BEVALLB-ROUND
                 LW_/ZAK/BEVALLO-WAERS
        CHANGING LW_/ZAK/BEVALLO-FIELD_NR
                 LW_/ZAK/BEVALLO-FIELD_NRK.
   ENDIF.

   MODIFY $T_BEVALLO FROM LW_/ZAK/BEVALLO INDEX L_TABIX.

 ENDFORM.                    " GET_AFA_M_FROM_ABEV
*--1365 #3.
*++1308 2013.03.01 BG
*&---------------------------------------------------------------------*
*&      Form  CALC_ABEV_ONREV_SZJA_1308
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*      -->P_$INDEX  text
*      -->P_$LAST_DATE  text
*----------------------------------------------------------------------*
 FORM CALC_ABEV_ONREV_SZJA_1308 TABLES T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                       T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                       T_ADOAZON STRUCTURE
                                                 /ZAK/ONR_ADOAZON
                            USING   $INDEX
                                    $LAST_DATE.

   DATA LI_LAST_BEVALLO LIKE /ZAK/BEVALLO OCCURS 0 WITH HEADER LINE.

   DATA L_LAST_INDEX LIKE /ZAK/BEVALLO-ZINDEX.
   DATA L_TABIX LIKE SY-TABIX.
   DATA L_TRUE.

   RANGES LR_ONREV_ABEVAZ FOR /ZAK/BEVALLB-ABEVAZ.
   DATA   L_ABEVAZ LIKE /ZAK/BEVALLB-ABEVAZ.

   DATA: L_KAM_KEZD TYPE DATUM,
         L_KAM_VEG  TYPE DATUM.
   DATA   L_KAMAT LIKE /ZAK/BEVALLO-FIELD_N.
   DATA   L_KAMAT_SUM LIKE /ZAK/BEVALLO-FIELD_N.

*  To upload fields to be summarized
   RANGES LR_ABEVAZ FOR /ZAK/BEVALLO-ABEVAZ.

*  If self-revision
   CHECK $INDEX NE '000'.

   SORT T_BEVALLB BY ABEVAZ.

*  Let's read the 'A' abev identifiers of the previous period
   READ TABLE T_BEVALLO INTO W_/ZAK/BEVALLO INDEX 1.
   CHECK SY-SUBRC EQ 0.
   L_LAST_INDEX = $INDEX - 1.

   CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
     EXPORTING
       INPUT  = L_LAST_INDEX
     IMPORTING
       OUTPUT = L_LAST_INDEX.


   SELECT * INTO TABLE LI_LAST_BEVALLO
                 FROM  /ZAK/BEVALLO
                WHERE  BUKRS   EQ W_/ZAK/BEVALLO-BUKRS
                  AND  BTYPE   EQ W_/ZAK/BEVALLO-BTYPE
                  AND  GJAHR   EQ W_/ZAK/BEVALLO-GJAHR
                  AND  MONAT   EQ W_/ZAK/BEVALLO-MONAT
                  AND  ZINDEX  EQ L_LAST_INDEX
                  AND  ADOAZON EQ ''.

   SORT LI_LAST_BEVALLO BY BUKRS BTYPE GJAHR MONAT ZINDEX ABEVAZ.

*  We delete records that are not in the given period
*  adtak fel.
   LOOP AT T_BEVALLO INTO W_/ZAK/BEVALLO
                     WHERE NOT ADOAZON IS INITIAL.
     READ TABLE T_ADOAZON WITH KEY ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                                   BINARY SEARCH.
*    Nem kell a rekord.
     IF SY-SUBRC NE 0.
       DELETE T_BEVALLO.
       CONTINUE.
     ENDIF.
*  M 11 Mark with an X if your declaration is considered a correction
     IF W_/ZAK/BEVALLO-ABEVAZ EQ C_ABEVAZ_M0AE003A.
       MOVE 'H' TO W_/ZAK/BEVALLO-FIELD_C.
       MODIFY T_BEVALLO FROM W_/ZAK/BEVALLO TRANSPORTING FIELD_C.
     ENDIF.
   ENDLOOP.

*  A0FD0150DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0150DA   "Módosított mező
                                 C_ABEVAZ_A0BC0001CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*  A0FD0152DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0152DA   "Módosított mező
                                 C_ABEVAZ_A0DC0075CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0152CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0152CA   "Módosított mező
                                C_ABEVAZ_A0FD0152DA
                                '0.16'.
*  A0FD0153DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0153DA   "Módosított mező
                                 C_ABEVAZ_A0BC0007CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0154DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0154DA   "Módosított mező
                                 C_ABEVAZ_A0DC0076CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0154CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0154CA   "Módosított mező
                                C_ABEVAZ_A0FD0154DA
                                '0.98'.

*  A0FD0155DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0155DA   "Módosított mező
                                 C_ABEVAZ_A0CC0042CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0156DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0156DA   "Módosított mező
                                 C_ABEVAZ_A0EC0097CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5
*  A0FD0156CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0156CA   "Módosított mező
                                C_ABEVAZ_A0FD0156DA
                                '0.27'.

*  A0FD0157DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0157DA   "Módosított mező
                                 C_ABEVAZ_A0EC0096CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0158DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0158DA   "Módosított mező
                                 C_ABEVAZ_A0EC0103CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0158CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0158CA   "Módosított mező
                                C_ABEVAZ_A0FD0158DA
                                '0.10'.

*  A0FD0159DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0159DA   "Módosított mező
                                 C_ABEVAZ_A0EC0105CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0159CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0159CA   "Módosított mező
                                C_ABEVAZ_A0FD0159DA
                                '0.15'.

*  A0FD0160DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0160DA   "Módosított mező
                                 C_ABEVAZ_A0EC0110CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0161DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0161DA   "Módosított mező
                                 C_ABEVAZ_A0EC0111CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0161CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0161CA   "Módosított mező
                                C_ABEVAZ_A0FD0161DA
                                '0.14'.

*  A0FD0163DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0163DA   "Módosított mező
                                 C_ABEVAZ_A0EC0112CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0163CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0163CA   "Módosított mező
                                C_ABEVAZ_A0FD0163DA
                                '0.27'.

*  A0FD0164DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0164DA   "Módosított mező
                                 C_ABEVAZ_A0BC0015CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0165DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0165DA   "Módosított mező
                                 C_ABEVAZ_A0BC0014CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0166DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0166DA   "Módosított mező
                                 C_ABEVAZ_A0BC0016CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0168DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0168DA   "Módosított mező
                                 C_ABEVAZ_A0EC0113CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0169DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0169DA   "Módosított mező
                                 C_ABEVAZ_A0EC0114CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0171DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0171DA   "Módosított mező
                                 C_ABEVAZ_A0EC0120CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0171CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0171CA   "Módosított mező
                                C_ABEVAZ_A0FD0171DA
                                '0.04'.

*  A0FD0172DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0172DA   "Módosított mező
                                 C_ABEVAZ_A0EC0121CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0172CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0172CA   "Módosított mező
                                C_ABEVAZ_A0FD0172DA
                                '0.03'.

*  A0FD0173DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0173DA   "Módosított mező
                                 C_ABEVAZ_A0EC0122CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0173CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0173CA   "Módosított mező
                                C_ABEVAZ_A0FD0173DA
                                '0.015'.

*  A0FD0174DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0174DA   "Módosított mező
                                 C_ABEVAZ_A0EC0124CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0174CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0174CA   "Módosított mező
                                C_ABEVAZ_A0FD0174DA
                                '0.095'.

*  A0FD0175DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0175DA   "Módosított mező
                                 C_ABEVAZ_A0EC0125CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0175CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0175CA   "Módosított mező
                                C_ABEVAZ_A0FD0175DA
                                '0.20'.

*  A0FD0176DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0176DA   "Módosított mező
                                 C_ABEVAZ_A0EC0126CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0176CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0176CA   "Módosított mező
                                C_ABEVAZ_A0FD0176DA
                                '0.111'.

*  A0FD0177DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0177DA   "Módosított mező
                                 C_ABEVAZ_A0EC0127CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0177CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0177CA   "Módosított mező
                                C_ABEVAZ_A0FD0177DA
                                '0.15'.

*  A0FD0178AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0178AA   "Módosított mező
                                 C_ABEVAZ_A0EC0128CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0179AA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0179AA   "Módosított mező
                                 C_ABEVAZ_A0EC0129CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0180DA
   PERFORM GET_ONREV_CALC TABLES T_BEVALLO
                                 LI_LAST_BEVALLO
                                 T_BEVALLB
                          USING  C_ABEVAZ_A0FD0180DA   "Módosított mező
                                 C_ABEVAZ_A0EC0104CA        "Forrás 1
                                 SPACE                      "Forrás 2
                                 SPACE                      "Forrás 3
                                 SPACE                      "Forrás 4
                                 SPACE.                     "Forrás 5

*  A0FD0180CA
   PERFORM GET_ONREV_DIV TABLES T_BEVALLO
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0180CA   "Módosított mező
                                C_ABEVAZ_A0FD0180DA
                                '0.13'.

*COMPOUNDS
* A0FD0151DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FD0152DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FD0153DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0151DA.

* A0FD0162DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FD0163DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FD0164DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FD0165DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FD0166DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0162DA.

* A0FD0167DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FD0168DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FD0169DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0167DA.

* A0FD0170DA
   REFRESH LR_ABEVAZ.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FD0171DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FD0172DA SPACE.
   M_DEF  LR_ABEVAZ 'I' 'EQ' C_ABEVAZ_A0FD0173DA SPACE.

   PERFORM GET_ONREV_SUM TABLES T_BEVALLO
                                LR_ABEVAZ
                                T_BEVALLB
                         USING  C_ABEVAZ_A0FD0170DA.


 ENDFORM. "CALC_ABEV_ONREV_SZJA_1308
*++1308 2013.03.01 BG
*++1508 #01. 2015.02.02
*&---------------------------------------------------------------------*
*&      Form  GET_SUB_R_M
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON_ALL  text
*      -->P_LR_ABEVAZ  text
*      -->P_C_ABEVAZ_M0BC0373DA  text
*      -->P_2187   text
*----------------------------------------------------------------------*
 FORM GET_SUB_R_M       TABLES   $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                                 $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                                 $T_ADOAZON STRUCTURE /ZAK/ADOAZONLPSZ
                                 $R_ABEV    STRUCTURE /ZAK/RANGE_C17
                        USING    $ABEV_MOD
                                 $SIGN.

   DATA L_INDEX_MOD    LIKE SY-TABIX.
   DATA L_FIELD_SUB    TYPE /ZAK/FIELDN.
   DATA L_FIELD_N      TYPE /ZAK/FIELDN.
   DATA LW_BEVALLB     TYPE /ZAK/BEVALLB.
*++1608 #01. 2015.02.08
   DATA L_FIRST.
*--1608 #01. 2015.02.08


   DEFINE LM_READ_DATA.
     CLEAR &4.
     READ TABLE $T_BEVALLO INTO W_/ZAK/BEVALLO
          WITH KEY ABEVAZ  = &1
                   ADOAZON = &2
                   LAPSZ   = &3
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       &4 = W_/ZAK/BEVALLO-FIELD_N.
     ENDIF.
   END-OF-DEFINITION.

*  ADMIT scan
   READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                        WITH KEY ABEVAZ = $ABEV_MOD.

* It must be calculated by tax number:
   LOOP AT $T_ADOAZON.
     CLEAR L_FIELD_SUB.
*++1608 #01. 2015.02.08
     CLEAR L_FIRST.
*--1608 #01. 2015.02.08
*   Let's read the ABEV to be modified
     READ TABLE $T_BEVALLO TRANSPORTING NO FIELDS
          WITH KEY ABEVAZ  = $ABEV_MOD
                   ADOAZON = $T_ADOAZON-ADOAZON
                   LAPSZ   = $T_ADOAZON-LAPSZ
                   BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE SY-TABIX TO L_INDEX_MOD.
       LOOP AT $T_BEVALLB INTO LW_BEVALLB WHERE ABEVAZ IN $R_ABEV.
*      Determination and summarization of value
         LM_READ_DATA LW_BEVALLB-ABEVAZ
                      $T_ADOAZON-ADOAZON
                      $T_ADOAZON-LAPSZ
                      L_FIELD_N.
*++1608 #01. 2015.02.08
*         IF L_FIELD_SUB IS INITIAL.
         IF L_FIRST IS INITIAL.
*--1608 #01. 2015.02.08
           L_FIELD_SUB = L_FIELD_N.
*++1608 #01. 2015.02.08
           L_FIRST = 'X'.
*--1608 #01. 2015.02.08
         ELSE.
           L_FIELD_SUB = L_FIELD_SUB - L_FIELD_N.
         ENDIF.
       ENDLOOP.

       IF $SIGN EQ '+' AND L_FIELD_SUB < 0.
         L_FIELD_SUB = 0.
       ENDIF.

       IF NOT L_FIELD_SUB IS INITIAL.

         W_/ZAK/BEVALLO-FIELD_N = L_FIELD_SUB.

         PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                      W_/ZAK/BEVALLB-ROUND
                      W_/ZAK/BEVALLO-WAERS
             CHANGING W_/ZAK/BEVALLO-FIELD_NR
                      W_/ZAK/BEVALLO-FIELD_NRK.


         MODIFY $T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_INDEX_MOD
                                              TRANSPORTING FIELD_N
                                                           FIELD_NR
                                                           FIELD_NRK.
       ENDIF.
     ENDIF.
   ENDLOOP.

 ENDFORM.                    " GET_SUB_R_M
*--1508 #01. 2015.02.02
*++1665 #08.
*&---------------------------------------------------------------------*
*&      Form  ADD_MESSAGE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_RETURN  text
*      -->P_1267   text
*      -->P_1268   text
*      -->P_LW_ANALITIKA_BUKRS  text
*      -->P_LW_ANALITIKA_BSEG_BELNR  text
*      -->P_LW_ANALITIKA_BSEG_GJAHR  text
*      -->P_1272   text
*----------------------------------------------------------------------*
 FORM ADD_MESSAGE  TABLES   $T_RETURN STRUCTURE BAPIRET2
                   USING    &1 "ID
                            &2 "TYPE
                            &3 "NUMBER
                            &4 "V1
                            &5 "V2
                            &6 "V3
                            &7."V4

   DATA LW_RETURN TYPE BAPIRET2.

   CLEAR LW_RETURN.
   LW_RETURN-TYPE   = &2.
   LW_RETURN-ID     = &1.
   LW_RETURN-NUMBER = &3.
   MESSAGE ID &1 TYPE &2 NUMBER &3 WITH &4 &5 &6 &7
           INTO LW_RETURN-MESSAGE.
   LW_RETURN-MESSAGE_V1 = &4.
   LW_RETURN-MESSAGE_V2 = &5.
   LW_RETURN-MESSAGE_V3 = &6.
   LW_RETURN-MESSAGE_V4 = &7.
   APPEND LW_RETURN TO $T_RETURN.

 ENDFORM.                    " ADD_MESSAGE
*--1665 #08.
*++2308 #09.
*&---------------------------------------------------------------------*
*&      Form  GET_DEF_VALUE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*----------------------------------------------------------------------*
 FORM GET_DEF_VALUE  TABLES T_BEVALLO STRUCTURE  /ZAK/BEVALLALV.

   DATA L_ALV LIKE /ZAK/BEVALLALV.
   DATA L_INDEX LIKE SY-TABIX.
   DATA L_TABIX LIKE SY-TABIX.


   LOOP AT I_/ZAK/BEVALLO INTO W_/ZAK/BEVALLO.
     L_TABIX = SY-TABIX.
     READ TABLE T_BEVALLO INTO L_ALV WITH KEY
                           BUKRS   = W_/ZAK/BEVALLO-BUKRS
                           BTYPE   = W_/ZAK/BEVALLO-BTYPE
                           GJAHR   = W_/ZAK/BEVALLO-GJAHR
                           MONAT   = W_/ZAK/BEVALLO-MONAT
                           ZINDEX  = W_/ZAK/BEVALLO-ZINDEX
                           ABEVAZ  = W_/ZAK/BEVALLO-ABEVAZ
                           ADOAZON = W_/ZAK/BEVALLO-ADOAZON
                           LAPSZ   = W_/ZAK/BEVALLO-LAPSZ
                           BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       MOVE-CORRESPONDING W_/ZAK/BEVALLO TO L_ALV.
       MODIFY T_BEVALLO FROM L_ALV INDEX SY-TABIX.
     ENDIF.
     DELETE I_/ZAK/BEVALLO.
   ENDLOOP.
 ENDFORM.
*--2308 #09.
*++2508 #14.
*&---------------------------------------------------------------------*
*&      Form  GET_M_ONREV_CALC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_BEVALLO  text
*      -->P_LI_LAST_BEVALLO  text
*      -->P_T_BEVALLB  text
*      -->P_T_ADOAZON  text
*      -->P_1128   text
*      -->P_1129   text
*      -->P_1130   text
*      -->P_SPACE  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*----------------------------------------------------------------------*
 FORM GET_M_ONREV_CALC  TABLES $T_BEVALLO STRUCTURE /ZAK/BEVALLO
                               $T_LAST_BEVALLO STRUCTURE /ZAK/BEVALLO
                               $T_BEVALLB STRUCTURE /ZAK/BEVALLB
                               $T_ADOAZON STRUCTURE /ZAK/ONR_ADOAZON
                      USING    $ABEV_MOD
                               $ABEV_F1
                               $ABEV_F2
                               $ABEV_F3
                               $ABEV_F4
                               $ABEV_F5.

   DATA L_SUM       LIKE /ZAK/BEVALLO-FIELD_NRK.
   DATA L_SUM_LAST  LIKE /ZAK/BEVALLO-FIELD_NRK.
   DATA L_FIELD_NRK LIKE /ZAK/BEVALLO-FIELD_NRK.
   DATA L_TABIX LIKE SY-TABIX.
   DATA LW_ADOAZON TYPE /ZAK/ONR_ADOAZON.

   DEFINE M_BEVALLO_READ.
*     READ TABLE &1 INTO W_/ZAK/BEVALLO
*                           WITH KEY ABEVAZ = &2
*                           BINARY SEARCH.
*     IF SY-SUBRC EQ 0.
*       ADD W_/ZAK/BEVALLO-FIELD_NRK TO &3.
*     ENDIF.
     LOOP AT $T_ADOAZON INTO LW_ADOAZON.
       LOOP AT &1 INTO W_/ZAK/BEVALLO WHERE ABEVAZ  = &2
                                       AND ADOAZON = LW_ADOAZON-ADOAZON.
         ADD W_/ZAK/BEVALLO-FIELD_NRK TO &3.
       ENDLOOP.
     ENDLOOP.
   END-OF-DEFINITION.


*  Reading a current tax return
   IF NOT $ABEV_F1 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F1 L_SUM.
   ENDIF.

   IF NOT $ABEV_F2 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F2 L_SUM.
   ENDIF.

   IF NOT $ABEV_F3 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F3 L_SUM.
   ENDIF.

   IF NOT $ABEV_F4 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F4 L_SUM.
   ENDIF.

   IF NOT $ABEV_F5 IS INITIAL.
     M_BEVALLO_READ $T_BEVALLO $ABEV_F5 L_SUM.
   ENDIF.

* Read previous period
   IF NOT $ABEV_F1 IS INITIAL.
     M_BEVALLO_READ $T_LAST_BEVALLO $ABEV_F1 L_SUM_LAST.
   ENDIF.

   IF NOT $ABEV_F2 IS INITIAL.
     M_BEVALLO_READ $T_LAST_BEVALLO $ABEV_F2 L_SUM_LAST.
   ENDIF.

   IF NOT $ABEV_F3 IS INITIAL.
     M_BEVALLO_READ $T_LAST_BEVALLO $ABEV_F3 L_SUM_LAST.
   ENDIF.

   IF NOT $ABEV_F4 IS INITIAL.
     M_BEVALLO_READ $T_LAST_BEVALLO $ABEV_F4 L_SUM_LAST.
   ENDIF.

   IF NOT $ABEV_F5 IS INITIAL.
     M_BEVALLO_READ $T_LAST_BEVALLO $ABEV_F5 L_SUM_LAST.
   ENDIF.

*  Calculation of difference
   L_FIELD_NRK = L_SUM - L_SUM_LAST.

*  Modify a calculated field
   READ TABLE $T_BEVALLO INTO W_/ZAK/BEVALLO
                         WITH KEY ABEVAZ = $ABEV_MOD.
   IF SY-SUBRC EQ 0.
     MOVE SY-TABIX TO L_TABIX.
     MOVE L_FIELD_NRK TO W_/ZAK/BEVALLO-FIELD_N.
     READ TABLE $T_BEVALLB INTO W_/ZAK/BEVALLB
                           WITH KEY ABEVAZ = $ABEV_MOD
                           BINARY SEARCH.
     IF SY-SUBRC EQ 0.
       PERFORM CALC_FIELD_NRK USING W_/ZAK/BEVALLO-FIELD_N
                    W_/ZAK/BEVALLB-ROUND
                    W_/ZAK/BEVALLO-WAERS
           CHANGING W_/ZAK/BEVALLO-FIELD_NR
                    W_/ZAK/BEVALLO-FIELD_NRK.
     ENDIF.

     MODIFY $T_BEVALLO FROM W_/ZAK/BEVALLO INDEX L_TABIX.

   ENDIF.

 ENDFORM.
*--2508 #14.
